<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@100;200;300;400;500;600;700&family=Sarabun:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        /* --- MINIMALIST THEME VARIABLES --- */
        :root {
            /* Backgrounds */
            --bg-body: #ffffff;           /* ขาวบริสุทธิ์ */
            --bg-light: #f8f9fa;          /* เทาจางๆ สำหรับพื้นที่รอง */
            --bg-card: #ffffff;

            /* Text Colors */
            --text-main: #2c3e50;         /* สีกรมท่าเข้มเกือบดำ อ่านง่าย */
            --text-muted: #95a5a6;        /* สีเทากลาง */
            
            /* Accent Colors (สีสันสดใสสำหรับปุ่ม/องค์ประกอบ) */
            --color-primary: #6c5ce7;     /* ม่วง Iris (สีหลัก) */
            --color-success: #00b894;     /* เขียว Mint */
            --color-warning: #fdcb6e;     /* เหลืองมัสตาร์ด */
            --color-danger: #ff7675;      /* แดงปะการัง (Coral) */
            --color-info: #74b9ff;        /* ฟ้าสดใส */
            --color-dark: #2d3436;        /* ดำด้าน */

            /* Borders & Shadows */
            --border-color: #dfe6e9;
            --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.05); /* เงานุ่ม ลอยตัว */
            --shadow-btn: 0 4px 15px rgba(0, 0, 0, 0.1);    /* เงาปุ่มให้เด้ง */
        }

        /* --- Global Styles --- */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 800;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        .view { display: none; }

        /* --- Custom Alert Styles (เพิ่มใหม่: Minimal Modern Alerts) --- */
        .alert {
            border: 1px solid transparent;
            border-radius: 12px; /* ขอบมนเข้ากับ Card */
            padding: 1rem 1.5rem;
            font-weight: 600; /* ตัวหนาขึ้นนิดหน่อยให้อ่านง่าย */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center; /* จัดกึ่งกลางแนวนอน */
            margin-bottom: 1rem;
        }
        
        /* Alert: Primary (Purple) */
        .alert-primary {
            background-color: rgba(108, 92, 231, 0.1); /* สีม่วงจางๆ 10% */
            border-color: rgba(108, 92, 231, 0.2);
            color: var(--color-primary);
        }
        
        /* Alert: Secondary (Gray) */
        .alert-secondary {
            background-color: #f1f2f6;
            border-color: #dfe6e9;
            color: var(--text-main);
        }
        
        /* Alert: Success (Green) */
        .alert-success {
            background-color: rgba(0, 184, 148, 0.1);
            border-color: rgba(0, 184, 148, 0.2);
            color: #009476; /* เขียวเข้มกว่าปกตินิดหน่อยให้อ่านง่าย */
        }
        
        /* Alert: Danger (Red) */
        .alert-danger {
            background-color: rgba(255, 118, 117, 0.1);
            border-color: rgba(255, 118, 117, 0.2);
            color: #d63031; /* แดงเข้ม */
        }
        
        /* Alert: Warning (Yellow/Orange) */
        .alert-warning {
            background-color: rgba(253, 203, 110, 0.15);
            border-color: rgba(253, 203, 110, 0.3);
            color: #d35400; /* ส้มอิฐ (ถ้าใช้เหลืองจะอ่านยาก) */
        }
        
        /* Alert: Info (Blue) */
        .alert-info {
            background-color: rgba(116, 185, 255, 0.1);
            border-color: rgba(116, 185, 255, 0.2);
            color: #0984e3; /* ฟ้าเข้ม */
        }
        
        /* Alert: Light (White/Gray) */
        .alert-light {
            background-color: #ffffff;
            border-color: var(--border-color);
            color: var(--text-muted);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        
        /* Alert: Dark (Black) */
        .alert-dark {
            background-color: var(--color-dark);
            border-color: var(--color-dark);
            color: #dfe6e9;
        }
        
        /* จัดการไอคอนใน Alert ให้สวยงาม */
        .alert i {
            font-size: 1.2em;
            margin-right: 10px; /* บังคับระยะห่างไอคอน */
        }

        /* --- Form & Input Styles --- */
        .form-label {
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }

        .form-control {
            border: 1px solid var(--border-color);
            background-color: #fff;
            color: var(--text-main);
            border-radius: 8px; /* Default radius */
            padding: 0.6rem 1rem;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .form-control:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1); /* เงาสีม่วงจางๆ */
            outline: none;
        }

        /* ปรับ Input Group (File Upload) ให้เป็นทรงแคปซูล */
        .input-group .form-control {
            border-top-left-radius: 50px !important;
            border-bottom-left-radius: 50px !important;
            border-right: none; /* ลบเส้นขวาเพื่อให้เชื่อมกับปุ่ม */
        }

        /* ปรับปุ่มแทรกรูปใน Input Group */
        .input-group .btn-outline-secondary {
            border-top-right-radius: 50px !important;
            border-bottom-right-radius: 50px !important;
            border-color: var(--border-color);
            color: var(--text-muted);
            border-left: none; /* ลบเส้นซ้าย */
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        .input-group .btn-outline-secondary:hover {
            background-color: var(--bg-light);
            color: var(--color-primary);
            border-color: var(--color-primary); /* Hover แล้วขอบม่วง */
        }
        
        /* แก้ไข Editor Container ให้เข้าธีม */
        #edit-exam-info-editor, #add-exam-info-editor {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }

        /* --- Navbar Minimal & Clean --- */
        .navbar {
            background-color: #ffffff !important;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            box-shadow: 0 2px 15px rgba(0,0,0,0.03) !important;
        }
        .navbar-brand {
            color: var(--color-primary) !important;
            font-weight: 900;
            font-size: 1.6rem;
            letter-spacing: -1px;
        }
        .navbar-brand i {
            color: var(--color-warning); /* ไอคอนโลโก้สีเหลืองตัดกัน */
        }
        .nav-link {
            color: var(--text-main) !important;
            font-weight: 600;
            margin: 0 5px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .nav-link:hover, .nav-link.active {
            background-color: var(--bg-light);
            color: var(--color-primary) !important;
        }

        /* --- Card Style (Clean White) --- */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color); /* มีขอบบางๆ */
            border-radius: 16px;
            box-shadow: var(--shadow-card);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
            border-color: var(--color-primary); /* Hover แล้วขอบเปลี่ยนสี */
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            font-weight: 700;
            padding: 1.2rem 1.5rem;
        }

        /* --- Colorful Buttons (Pill Shape) --- */
        .btn {
            border-radius: 50px; /* ทรงแคปซูล */
            font-weight: 700;
            padding: 0.5rem 1.5rem;
            border: none; /* Reset border สำหรับปุ่มสี */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            letter-spacing: 0.3px;
        }
        
        /* Button Colors */
        .btn-primary { 
            background-color: var(--color-primary); 
            color: #fff; 
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); /* เงาสีม่วง */
        }
        .btn-primary:hover { background-color: #5849be; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(108, 92, 231, 0.4); }

        .btn-success { 
            background-color: var(--color-success); 
            color: #fff; 
            box-shadow: 0 4px 10px rgba(0, 184, 148, 0.3); 
        }
        .btn-success:hover { background-color: #00a383; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 184, 148, 0.4); }

        .btn-warning { 
            background-color: var(--color-warning); 
            color: var(--text-main); /* สีเหลืองใช้ตัวหนังสือดำจะอ่านง่ายกว่า */
            box-shadow: 0 4px 10px rgba(253, 203, 110, 0.3);
        }
        .btn-warning:hover { background-color: #eebb4d; transform: translateY(-2px); }

        .btn-danger { 
            background-color: var(--color-danger); 
            color: #fff; 
            box-shadow: 0 4px 10px rgba(255, 118, 117, 0.3);
        }
        .btn-danger:hover { background-color: #e66767; transform: translateY(-2px); }

        .btn-info { background-color: var(--color-info); color: #fff; }
        .btn-info:hover { background-color: #5ca8ff; transform: translateY(-2px); }
        
        .btn-dark { background-color: var(--color-dark); color: #fff; }
        .btn-dark:hover { background-color: #000; transform: translateY(-2px); }

        /* Outline Buttons */
        .btn-outline-dark {
            color: var(--text-main);
            border: 2px solid var(--border-color);
            background: transparent;
        }
        .btn-outline-dark:hover {
            border-color: var(--text-main);
            background-color: var(--text-main);
            color: #fff;
        }
        
        /* เพิ่มสไตล์สำหรับ btn-outline-secondary ให้มี border */
        .btn-outline-secondary {
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            background: transparent;
        }

        /* --- Table Style --- */
        .table thead th {
            background-color: var(--bg-light); /* หัวตารางสีเทาอ่อน */
            color: var(--text-main);
            border-bottom: none;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            padding: 1rem;
        }
        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0,0,0,0.01); /* ลายทางจางมากๆ */
        }

        /* --- Offcanvas (Admin Menu) --- */
        .offcanvas {
            background-color: #fff !important;
        }
        .offcanvas-header {
            background-color: var(--color-primary); /* หัวเมนูแอดมินสีม่วงเด่น */
            color: #fff;
        }
        .offcanvas-title { color: #fff !important; }
        .btn-close { filter: invert(1); } /* ปุ่มปิดสีขาว */

        .list-group-item {
            border: none !important;
            border-left: 4px solid transparent !important; /* เส้นแถบด้านซ้ายซ่อนอยู่ */
            margin-bottom: 2px;
            color: var(--text-main) !important;
            font-weight: 500;
        }
        .list-group-item:hover {
            background-color: var(--bg-light) !important;
            color: var(--color-primary) !important;
            border-left-color: var(--color-primary) !important; /* Hover แล้วมีแถบสีม่วงขึ้น */
        }
        .list-group-item i {
            width: 25px;
            text-align: center;
        }
        
        /* Timeline */
        ul.timeline:before { background: var(--border-color); }
        ul.timeline > li:before { 
            border: 3px solid #fff; 
            background-color: var(--color-primary); /* จุด Timeline สีม่วง */
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }

        /* Overrides */
        .bg-dark { background-color: #fff !important; color: var(--text-main) !important; }
        .text-white { color: var(--text-main) !important; }
        .text-white-50 { color: var(--text-muted) !important; }
        .navbar-dark .navbar-toggler-icon { filter: invert(1); }

        footer {
            background-color: var(--bg-light) !important;
            border-top: 1px solid var(--border-color);
            margin-top: 4rem;
            padding: 3rem 0;
        }

        /* --- Question Navigation Custom Styles --- */
        .q-nav-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            margin: 4px;
            border-radius: 50%; /* ปรับเป็นวงกลมเพื่อให้ดูสวยงามขึ้น (หรือลบออกถ้าชอบทรงแคปซูล) */
            font-weight: 700;
            transition: all 0.2s;
            
            /* สถานะ: ยังไม่ตอบ (Unanswered) -> สีเทา */
            background-color: var(--bg-light); 
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .q-nav-btn:hover {
            background-color: #e2e6ea;
        }

        /* สถานะ: ตอบแล้ว (Answered) -> สีเขียว */
        .q-nav-btn.answered {
            background-color: var(--color-success) !important;
            color: #ffffff !important;
            border-color: var(--color-success) !important;
            box-shadow: 0 4px 10px rgba(0, 184, 148, 0.3);
        }

        /* สถานะ: ข้อปัจจุบัน (Current) -> เพิ่มขอบสีม่วงให้รู้ว่าอยู่ที่ข้อไหน */
        .q-nav-btn.current {
            border: 2px solid var(--color-primary) !important;
            transform: scale(1.1); /* ขยายใหญ่ขึ้นนิดนึง */
        }
        /* ปรับแต่งให้รูปภาพใน Modal ไม่ล้นจอ */
        #exam-info-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        /* ความสูงของ Editor ในหน้า Admin */
        .ql-container {
            height: 200px !important; 
            font-family: 'Sarabun', sans-serif;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        .ql-toolbar {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            background-color: var(--bg-light);
            border-color: var(--border-color) !important;
        }
        .ql-container.ql-snow {
            border-color: var(--border-color) !important;
        }

        /* --- Custom File Input Styling --- */
        
        /* 1. ปรับกล่องรวม (Input Group) ให้ดูคลีน */
        .input-group {
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border-radius: 50px;
            background: #fff;
            padding: 3px; /* เพิ่ม padding นิดหน่อยเพื่อให้ปุ่มลอยอยู่ข้างใน */
            border: 1px solid var(--border-color);
        }

        /* 2. ปรับตัว Input File หลัก */
        .form-control[type="file"] {
            border: none !important; /* ลบขอบเดิม */
            background-color: transparent !important;
            box-shadow: none !important;
            padding-left: 10px;
            color: var(--text-muted); /* สีข้อความ "ไม่ได้เลือกไฟล์ใด" */
            font-size: 0.9rem;
            align-self: center;
        }

        /* 3. ไฮไลท์สำคัญ: ปรับปุ่ม "เลือกไฟล์" (Choose File) ที่อยู่ข้างใน Input */
        .form-control[type="file"]::file-selector-button {
            background-color: var(--bg-light);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 0.3rem 1rem;
            border-radius: 50px;
            margin-right: 15px;
            font-weight: 600;
            font-family: 'Sarabun', sans-serif;
            transition: all 0.2s;
            cursor: pointer;
        }

        .form-control[type="file"]:hover::file-selector-button {
            background-color: #e2e6ea;
            color: var(--color-primary);
        }

        /* 4. ปรับปุ่ม "แทรกรูป" (ปุ่มขวาสุด) */
        .input-group .btn-outline-secondary {
            border: none !important;
            background-color: var(--color-primary); /* เปลี่ยนเป็นสีม่วงเพื่อให้เด่น */
            color: white;
            border-radius: 50px !important; /* บังคับให้กลม */
            padding: 0.4rem 1.2rem;
            margin-left: 5px;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(108, 92, 231, 0.3);
        }

        .input-group .btn-outline-secondary:hover {
            background-color: #5849be; /* ม่วงเข้มเมื่อ Hover */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(108, 92, 231, 0.4);
        }

        /* ปรับไอคอนในปุ่ม */
        .input-group .btn i {
            margin-right: 5px;
        }

        /* --- Video Player Custom Styles --- */

        /* 1. Container: จัดการอัตราส่วน 16:9 และมุมโค้ง */
        #player-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* อัตราส่วน 16:9 (Height/Width * 100) */
            height: 0;
            background-color: #000; /* พื้นหลังดำระหว่างโหลด */
            border-radius: 16px; /* มุมโค้งเท่ากับ Card */
            overflow: hidden; /* ตัดส่วนเกินของ Video ออก */
            box-shadow: var(--shadow-card);
            margin-bottom: 2rem;
            group: player; /* สำหรับ Hover effect */
        }

        /* 2. Youtube Iframe & Overlay: ขยายเต็มพื้นที่ */
        #youtube-player, #player-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Overlay โปร่งใสเอาไว้กันการคลิกที่ตัว Video โดยตรง (ถ้าต้องการ custom click events) */
        #player-overlay {
            z-index: 5;
            background: transparent;
            /* cursor: pointer; */ /* เปิดบรรทัดนี้ถ้าอยากให้คลิกที่วิดีโอเพื่อหยุดได้ (ต้องเขียน JS เพิ่ม) */
        }

        /* 3. Custom Controls Bar: แถบควบคุมด้านล่าง */
        .custom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px; /* ความสูงแถบควบคุม */
            background: rgba(0, 0, 0, 0.6); /* สีดำโปร่งแสง */
            backdrop-filter: blur(10px); /* เอฟเฟกต์เบลอพื้นหลัง (Glassmorphism) */
            z-index: 10;
            display: flex;
            align-items: center;
            padding: 0 20px;
            opacity: 0; /* ซ่อนปกติ */
            transition: opacity 0.3s ease;
        }

        /* แสดงแถบควบคุมเมื่อนำเมาส์ไปวางที่ Player Container */
        #player-container:hover .custom-controls {
            opacity: 1;
        }

        /* 4. Play/Pause Button */
        #play-pause-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.8rem;
            margin-right: 15px;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        #play-pause-btn:hover {
            color: var(--color-primary); /* เปลี่ยนเป็นสีม่วงเมื่อ Hover */
            transform: scale(1.1);
        }

        /* 5. Volume Control */
        .custom-controls i.bi-volume-down-fill,
        .custom-controls i.bi-volume-up-fill {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            margin: 0 8px;
        }

        /* ปรับแต่ง Slider เสียง */
        .volume-slider {
            width: 100px; /* ความกว้างแถบเสียง */
            margin-right: 15px;
            cursor: pointer;
            accent-color: var(--color-primary); /* สีของตัวเลื่อนเป็นสีม่วงธีมหลัก */
        }
        
        /* ปรับแต่ง Slider สำหรับ Webkit (Chrome/Safari) ให้สวยขึ้น */
        .volume-slider::-webkit-slider-runnable-track {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 6px;
        }

        /* 6. Speed Dropdown Button */
        #speed-btn {
            border-color: rgba(255, 255, 255, 0.5);
            color: #fff;
            border-radius: 50px;
            font-weight: 600;
        }
        #speed-btn:hover {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: #fff;
        }

        /* Dropdown Menu styling */
        #speed-options {
            background-color: rgba(30, 30, 30, 0.95); /* เมนูสีเข้ม */
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 80px;
        }
        
        #speed-options .dropdown-item {
            color: #ccc;
            text-align: center;
            cursor: pointer;
        }
        
        #speed-options .dropdown-item:hover {
            background-color: var(--color-primary);
            color: #fff;
        }
        
        /* Mobile Responsive: ปรับแถบเสียงให้เล็กลงในจอมือถือ */
        @media (max-width: 576px) {
            .volume-slider {
                width: 60px;
            }
            .custom-controls {
                opacity: 1; /* ในมือถือให้แสดงตลอด เพราะไม่มีเมาส์ Hover */
                padding: 0 10px;
            }
        }

        /* เพิ่ม CSS นี้เข้าไป */
        .alert-icon i {
            color: #ffffff !important;
        }

        /* เพิ่มใน <style> */
        .result-section .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .result-section .card:hover {
            transform: translateY(-3px); /* ลอยขึ้นนิดนึงเมื่อเอาเมาส์ชี้ */
            box-shadow: 0 10px 20px rgba(0,0,0,0.05) !important;
        }

        /* เพิ่ม Effect ให้การ์ดวิชาสอบ */
        #exam-subject-list .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.08) !important;
        }

        /* จัดการชื่อวิชาที่ยาวเกินไปให้ตัดคำสวยๆ */
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Access Denied Custom Styles */
        .denied-wrapper {
            display: flex !important;
            flex-direction: column !important; /* บังคับเรียงจากบนลงล่างเป็นแถว */
            align-items: center !important;    /* จัดกึ่งกลางแนวนอน */
            justify-content: center !important; /* จัดกึ่งกลางแนวตั้ง */
            text-align: center;
            width: 100%;
            min-height: 60vh; /* ให้มีความสูงพอสมควรเพื่อให้ดูอยู่กลางจอ */
            gap: 1.5rem;      /* ระยะห่างระหว่างแถวที่ 1, 2, และ 3 */
        }

        .denied-row {
            width: 100%;
            max-width: 500px; /* จำกัดความกว้างไม่ให้ตัวหนังสือยาวเกินไป */
        }

        /* Course Card Hover Effect */
        .course-card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1) !important;
            border-color: var(--color-primary) !important; /* ถ้าอยากให้มีขอบสีม่วงขึ้นตอน hover */
        }

        .card-hover-effect {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
        }

        .hover-bg-light:hover {
            background-color: #f8f9fa; /* สีเทาจางๆ เมื่อ Hover */
        }
        .transition-fast {
            transition: all 0.2s ease-in-out;
        }

        /* =========================================
          MINIMALIST MODAL OVERRIDES (เพิ่มส่วนนี้)
          ========================================= */

        /* 1. ปรับพื้นหลัง Backdrop ให้ดู Modern (เบลอพื้นหลัง) */
        .modal-backdrop.show {
            opacity: 0.85; /* ทึบขึ้นนิดนึงเพื่อให้โฟกัส */
            background-color: rgba(255, 255, 255, 0.8); /* สีขาวจางๆ */
            backdrop-filter: blur(8px); /* เบลอฉากหลัง */
            -webkit-backdrop-filter: blur(8px);
        }

        /* 2. ปรับตัวกล่อง Modal ทั่วไป */
        .modal-content {
            border: none; /* ลบเส้นขอบแข็งๆ */
            border-radius: 24px; /* มุมโค้งมนกว่า Card ปกติ */
            box-shadow: 0 20px 60px rgba(0,0,0,0.08); /* เงาฟุ้งลอยตัว */
            background-color: var(--bg-card);
        }

        .modal-header {
            border-bottom: 1px solid var(--bg-light); /* เส้นแบ่งจางๆ หรือลบออกก็ได้ */
            padding: 1.5rem 2rem;
        }

        .modal-footer {
            border-top: none; /* ลบเส้นแบ่งด้านล่าง */
            padding: 1.5rem 2rem;
            background-color: var(--bg-body); /* สีเดียวกับ body หรือ bg-light */
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
        }

        /* =========================================
          SPECIFIC: CHEAT LOCK MODAL (หน้าจอถูกล็อค)
          ========================================= */
        
        #cheatLockModal .modal-content {
            text-align: center;
            padding: 2rem;
        }

        /* ไอคอนกุญแจ */
        #cheatLockModal i.bi-shield-lock-fill {
            font-size: 4rem;
            color: var(--color-danger); /* ใช้สีแดง Coral ตามธีม */
            display: inline-block;
            margin-bottom: 1rem;
            text-shadow: 0 10px 20px rgba(255, 118, 117, 0.3); /* เงาสีแดงจางๆ */
            animation: pulseLock 2s infinite;
        }

        /* Input รหัสปลดล็อค */
        #unlock-pin-input {
            background-color: var(--bg-light);
            border: 2px solid transparent;
            font-size: 1.5rem;
            letter-spacing: 0.5rem; /* เว้นระยะตัวเลข */
            font-weight: 800;
            color: var(--text-main);
            height: 60px;
            border-radius: 16px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }

        #unlock-pin-input:focus {
            background-color: #fff;
            border-color: var(--color-danger); /* โฟกัสเป็นสีแดง */
            box-shadow: 0 0 0 4px rgba(255, 118, 117, 0.15);
        }

        #unlock-pin-input::placeholder {
            font-size: 1rem;
            letter-spacing: normal;
            font-weight: 400;
            color: var(--text-muted);
        }

        /* Animation ให้ไอคอนขยับเบาๆ */
        @keyframes pulseLock {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* =========================================
          SPECIFIC: IMAGE MODAL (ดูรูปขยาย)
          ========================================= */
        
        #imageModal .modal-dialog {
            max-width: 90vw; /* กว้างเกือบเต็มจอ */
        }

        #imageModal .modal-content {
            background-color: transparent; /* พื้นหลังใส */
            box-shadow: none; /* ลบเงากล่อง (ไปใส่ที่รูปแทน) */
        }

        #imageModal .modal-header {
            border: none;
            padding: 0;
            position: relative;
            z-index: 1060;
        }

        /* ปุ่มปิดแบบลอย (Floating Close Button) */
        #imageModal .btn-close {
            position: absolute;
            right: 0;
            top: -40px; /* ลอยอยู่เหนือรูป */
            background-color: #fff;
            opacity: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%232c3e50'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e"); /* เปลี่ยนสีไอคอนกากบาทเป็นสีเข้ม */
            transition: transform 0.2s;
        }

        #imageModal .btn-close:hover {
            transform: rotate(90deg) scale(1.1);
        }

        #imageModalContent {
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); /* เงารูปภาพ */
            max-height: 85vh;
            object-fit: contain;
            background-color: #fff; /* รองรับรูป PNG โปร่งแสง */
        }

        /* Styling เฉพาะสำหรับ PIN Input */
        #pin-modal-input {
            transition: all 0.3s ease;
        }

        #pin-modal-input:focus {
            background-color: #fff;
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.15) !important; /* เงาสีม่วงจางๆ */
            border: 1px solid var(--color-primary) !important;
        }

        #pin-modal-input::placeholder {
            letter-spacing: 4px; /* ระยะห่างของ Placeholder ปกติ */
            color: #cbd5e0;
            font-size: 1.2rem;
            vertical-align: middle;
        }

        /* เอฟเฟกต์ปุ่มลอยเมื่อ Hover (ถ้าใน CSS เก่ายังไม่มี class นี้) */
        .hover-elevate {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .hover-elevate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3) !important;
        }
    </style>
    <title>ระบบเรียนออนไลน์</title>
</head>
<body>

    <nav id="main-navbar" class="navbar navbar-expand-lg navbar-light sticky-top bg-light shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold text-primary" href="#" onclick="event.preventDefault(); handleNavHomeClick()">
                <i class="bi bi-mortarboard-fill me-2"></i>E-Learning
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                
                <ul id="nav-student" class="navbar-nav me-auto mb-2 mb-lg-0 d-none">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="event.preventDefault(); showView('home-view')">หน้าหลัก</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="event.preventDefault(); fetchAllCourses()">คอร์สเรียน</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="event.preventDefault(); fetchMyCourses()">คอร์สของฉัน</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="event.preventDefault(); fetchExamSubjects()">สอบออนไลน์</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="event.preventDefault(); fetchHistory()">ประวัติเรียน</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="event.preventDefault(); fetchExamHistory()">ประวัติสอบ</a></li>
                </ul>

                <div id="nav-admin" class="me-auto d-none mb-3 mb-lg-0">
                    <button class="btn btn-warning w-100 w-lg-auto" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminOffcanvas">
                        <i class="bi bi-grid-fill me-1"></i> เมนูผู้ดูแล
                    </button>
                </div>

                <div id="nav-loggedOut" class="ms-auto d-flex flex-column flex-lg-row gap-2 mt-3 mt-lg-0">
                    <button class="btn btn-outline-dark" onclick="showView('home-view')">หน้าหลัก</button>
                    <button class="btn btn-outline-dark" onclick="showView('login-view')">เข้าสู่ระบบ</button>
                    <button class="btn btn-primary" onclick="showView('register-view')">ลงทะเบียน</button>
                </div>
                
                <div id="nav-userInfo" class="ms-auto d-none align-items-center mt-3 mt-lg-0 border-top border-lg-0 pt-2 pt-lg-0">
                    <div class="dropdown w-100 text-end text-lg-start">
                        <a href="#" class="nav-link dropdown-toggle text-dark fw-bold d-flex align-items-center justify-content-end justify-content-lg-start" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1 display-6 display-lg-1 fs-4" style="color: var(--color-primary);"></i>
                            <span id="welcome-message" class="ms-2"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg mt-2" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); openEditProfileModal()"><i class="bi bi-gear me-2 text-muted"></i>แก้ไขข้อมูล</a></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); fetchMyLoginHistoryView()"><i class="bi bi-clock-history me-2 text-muted"></i>ประวัติเข้าใช้งาน</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item text-danger" onclick="handleLogout()"><i class="bi bi-box-arrow-right me-2"></i>ออกจากระบบ</button></li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </nav>

    <!-- Offcanvas (เมนูแอดมิน - ปรับให้หัวเป็นสีหลัก) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="adminOffcanvas" style="width: 280px;">
        
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title fw-bold" style="color: var(--color-primary);">
                <i class="bi bi-shield-lock-fill me-2"></i>Admin Panel
            </h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="offcanvas-body p-0"> <div class="list-group list-group-flush border-0 mt-2">
                
                <a href="#" class="list-group-item list-group-item-action border-0 py-3 px-4 d-flex align-items-center" 
                  onclick="event.preventDefault(); showView('admin-dashboard-view')" data-bs-dismiss="offcanvas">
                    <i class="bi bi-house-door-fill text-muted" style="width: 24px;"></i> 
                    <span class="ms-3 fw-medium">แดชบอร์ด</span>
                </a>

                <a href="#" class="list-group-item list-group-item-action border-0 py-3 px-4 d-flex align-items-center" 
                  onclick="event.preventDefault(); fetchUserManagement()" data-bs-dismiss="offcanvas">
                    <i class="bi bi-people-fill text-muted" style="width: 24px;"></i>
                    <span class="ms-3 fw-medium">จัดการผู้ใช้</span>
                </a>

                <a class="list-group-item list-group-item-action border-0 py-3 px-4 d-flex justify-content-between align-items-center" 
                  data-bs-toggle="collapse" href="#collapseCourses" role="button">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-book-fill text-muted" style="width: 24px;"></i>
                        <span class="ms-3 fw-medium">จัดการคอร์ส</span>
                    </div>
                    <i class="bi bi-chevron-down small text-muted"></i>
                </a>
                <div class="collapse bg-light" id="collapseCourses">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action border-0 py-2 ps-5 bg-transparent text-muted" 
                          onclick="event.preventDefault(); fetchCourseManagement()" data-bs-dismiss="offcanvas">
                          <i class="bi bi-dot me-2"></i>รายวิชาทั้งหมด
                        </a>
                    </div>
                </div>

                <a class="list-group-item list-group-item-action border-0 py-3 px-4 d-flex justify-content-between align-items-center" 
                  data-bs-toggle="collapse" href="#collapseExams" role="button">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-pencil-square text-muted" style="width: 24px;"></i>
                        <span class="ms-3 fw-medium">จัดการการสอบ</span>
                    </div>
                    <i class="bi bi-chevron-down small text-muted"></i>
                </a>
                <div class="collapse bg-light" id="collapseExams">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action border-0 py-2 ps-5 bg-transparent text-muted" 
                          onclick="event.preventDefault(); fetchExamSubjectManagement()" data-bs-dismiss="offcanvas">
                          <i class="bi bi-dot me-2"></i>รายวิชาสอบ
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0 py-2 ps-5 bg-transparent text-muted" 
                          onclick="event.preventDefault(); fetchExamProgressView()" data-bs-dismiss="offcanvas">
                          <i class="bi bi-dot me-2"></i>ความคืบหน้า
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0 py-2 ps-5 bg-transparent text-muted" 
                          onclick="event.preventDefault(); fetchExamAnalysisView()" data-bs-dismiss="offcanvas">
                          <i class="bi bi-dot me-2"></i>วิเคราะห์ข้อสอบ
                        </a>
                    </div>
                </div>
                
                <a href="#" class="list-group-item list-group-item-action border-0 py-3 px-4 d-flex align-items-center" 
                  onclick="event.preventDefault(); fetchAnnouncementManagement()" data-bs-dismiss="offcanvas">
                    <i class="bi bi-megaphone-fill text-muted" style="width: 24px;"></i>
                    <span class="ms-3 fw-medium">จัดการประกาศ</span>
                </a>

                <a href="#" class="list-group-item list-group-item-action border-0 py-3 px-4 d-flex align-items-center" 
                  onclick="event.preventDefault(); showView('admin-cheating-monitor-view'); setupCheatingMonitorView();" data-bs-dismiss="offcanvas">
                    <i class="bi bi-shield-shaded text-muted" style="width: 24px;"></i>
                    <span class="ms-3 fw-medium">Cheating Monitor</span>
                </a>

                <a class="list-group-item list-group-item-action border-0 py-3 px-4 d-flex justify-content-between align-items-center" 
                  data-bs-toggle="collapse" href="#collapseReports" role="button">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-bar-chart-fill text-muted" style="width: 24px;"></i>
                        <span class="ms-3 fw-medium">รายงานข้อมูล</span>
                    </div>
                    <i class="bi bi-chevron-down small text-muted"></i>
                </a>
                <div class="collapse bg-light" id="collapseReports">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action border-0 py-2 ps-5 bg-transparent text-muted" 
                          onclick="event.preventDefault(); fetchCourseReportsView()" data-bs-dismiss="offcanvas">
                          <i class="bi bi-dot me-2"></i>รายงานคอร์ส
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0 py-2 ps-5 bg-transparent text-muted" 
                          onclick="event.preventDefault(); fetchExamReportsView()" data-bs-dismiss="offcanvas">
                          <i class="bi bi-dot me-2"></i>รายงานสอบ
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0 py-2 ps-5 bg-transparent text-muted" 
                          onclick="event.preventDefault(); fetchSystemLogsView()" data-bs-dismiss="offcanvas">
                          <i class="bi bi-dot me-2"></i>Logs ระบบ
                        </a>
                    </div>
                </div>

                <a href="#" class="list-group-item list-group-item-action border-0 py-3 px-4 d-flex align-items-center" 
                  onclick="event.preventDefault(); fetchSystemSettingsPage()" data-bs-dismiss="offcanvas">
                    <i class="bi bi-gear-fill text-muted" style="width: 24px;"></i>
                    <span class="ms-3 fw-medium">ตั้งค่าระบบ</span>
                </a>

            </div>
        </div>
    </div>

    <main class="container py-4">

        <div id="home-view" class="view bg-body">
            
            <div class="container mt-4">
                <div id="carouselExampleIndicators" class="carousel slide mb-5 shadow-card" data-bs-ride="carousel" 
                    style="border-radius: 24px; overflow: hidden;">
                    <div class="carousel-indicators">
                        <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active"></button>
                        <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1"></button>
                        <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2"></button>
                    </div>
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <img src="https://raw.githubusercontent.com/LogicsDevStudio/EBS-RTNMU/refs/heads/main/images/webexambanner_4.png" class="d-block w-100" style="object-fit: cover; min-height: 300px;" alt="Banner 1">
                        </div>
                        <div class="carousel-item">
                            <img src="https://raw.githubusercontent.com/LogicsDevStudio/EBS-RTNMU/refs/heads/main/images/webexambanner_5.png" class="d-block w-100" style="object-fit: cover; min-height: 300px;" alt="Banner 2">
                        </div>
                        <div class="carousel-item">
                            <img src="https://raw.githubusercontent.com/LogicsDevStudio/EBS-RTNMU/refs/heads/main/images/webexambanner_6.png" class="d-block w-100" style="object-fit: cover; min-height: 300px;" alt="Banner 3">
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    </button>
                </div>
            </div>

            <div class="container mb-5">
                <div class="row align-items-center g-5">
                    <div class="col-lg-6 text-center text-lg-start">
                        <div class="d-inline-flex align-items-center px-3 py-1 rounded-pill bg-primary bg-opacity-10 text-primary border border-primary-subtle mb-3 small fw-bold">
                            <i class="bi bi-info-circle-fill me-2"></i>รู้จักกับระบบของเรา
                        </div>
                        <h1 class="display-5 fw-bold mb-3" style="color: var(--text-main);">เปลี่ยนการสอบให้เป็นเรื่องง่าย<br>ด้วยเทคโนโลยีทันสมัย</h1>
                        <p class="fs-5 text-muted mb-4" style="line-height: 1.8;">
                            ระบบบริหารจัดการการสอบออนไลน์ (E-Testing) ที่ถูกออกแบบมาเพื่อ<b>ลดความซับซ้อน</b>ในการจัดสอบ ช่วยให้ผู้สอนสร้างข้อสอบได้รวดเร็ว และผู้เรียนทราบผลคะแนนได้ทันที พร้อมระบบวิเคราะห์จุดแข็งจุดอ่อนเพื่อการพัฒนาที่ตรงจุด
                        </p>
                    </div>

                    <div class="col-lg-6">
                        <div class="d-flex flex-column gap-3">
                            <div class="card border-0 shadow-sm p-3 course-card-hover" style="border-radius: 20px;">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 p-3 rounded-4 bg-success bg-opacity-10 text-success">
                                        <i class="bi bi-lightning-charge-fill fs-3"></i>
                                    </div>
                                    <div class="ms-3">
                                        <h5 class="fw-bold mb-1">ประมวลผลแม่นยำ รวดเร็ว</h5>
                                        <p class="text-muted small mb-0">ระบบตรวจข้อสอบอัตโนมัติ ลดความผิดพลาดจากมนุษย์ (Human Error) ทราบผลทันทีที่ส่งข้อสอบ</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card border-0 shadow-sm p-3 course-card-hover" style="border-radius: 20px;">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 p-3 rounded-4 bg-warning bg-opacity-10 text-warning">
                                        <i class="bi bi-bar-chart-fill fs-3"></i>
                                    </div>
                                    <div class="ms-3">
                                        <h5 class="fw-bold mb-1">วิเคราะห์ผลเชิงลึก</h5>
                                        <p class="text-muted small mb-0">ไม่ได้บอกแค่คะแนน แต่ช่วยวิเคราะห์พัฒนาการและเปรียบเทียบค่าสถิติเพื่อยกระดับมาตรฐานการเรียนรู้</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card border-0 shadow p-3" style="border-radius: 20px; background: linear-gradient(45deg, #6c5ce7 0%, #a29bfe 100%);">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 p-3 rounded-4 bg-white text-primary">
                                        <i class="bi bi-clock-history fs-3"></i>
                                    </div>
                                    <div class="ms-3">
                                        <h5 class="fw-bold mb-1" style="color: #ffffff;">เข้าถึงได้ตลอด 24/7</h5>
                                        
                                        <p class="small mb-0" style="color: #ffffff;">
                                            ระบบเสถียร รองรับการใช้งานพร้อมกันจำนวนมาก เปิดให้เข้าทบทวนบทเรียนและทำแบบทดสอบได้ทุกที่ ทุกเวลา
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="container mt-5 mb-5">
                <div class="text-center mb-4">
                    <div class="d-inline-flex align-items-center px-3 py-1 rounded-pill bg-danger bg-opacity-10 text-danger border border-danger-subtle mb-3 small fw-bold">
                        <i class="bi bi-megaphone-fill me-2"></i>ประชาสัมพันธ์
                    </div>
                    <h2 class="fw-bold" style="color: var(--text-main);">ประกาศข่าวสารและกิจกรรม</h2>
                    <p class="text-muted">ติดตามข้อมูลข่าวสารและกำหนดการล่าสุดจากทางระบบ</p>
                </div>
                
                <div id="announcements-container"></div>
            </div>
            <div id="section-security" class="py-5 bg-light rounded-4 mb-5">
              <div class="container">
                    <div class="row align-items-center">
                        <div class="col-lg-5 mb-4 mb-lg-0">
                            <div class="d-flex align-items-center mb-3">
                                <div class="rounded-pill me-2" style="width: 4px; height: 24px; background-color: var(--color-danger);"></div>
                                <h5 class="fw-bold m-0 text-uppercase text-danger small ls-1">High Security</h5>
                            </div>
                            <h2 class="fw-bold mb-3" style="color: var(--text-main);">ระบบคุมสอบอัจฉริยะ<br>ป้องกันการทุจริต</h2>
                            <p class="text-muted mb-4" style="line-height: 1.8;">
                                มั่นใจในความโปร่งใสของการสอบด้วยเทคโนโลยี Cheating Monitor ที่ตรวจสอบพฤติกรรมผู้สอบแบบ Real-time และแจ้งเตือนทันทีเมื่อมีความผิดปกติ
                            </p>
                            
                            <div class="d-flex flex-column gap-3">
                                <div class="d-flex align-items-center p-3 bg-white rounded-3 shadow-sm">
                                    <div class="rounded-circle bg-danger bg-opacity-10 text-danger d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="bi bi-window-x fs-5"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-0">Browser Locking</h6>
                                        <small class="text-muted">แจ้งเตือนเมื่อมีการสลับหน้าจอหรือออกจากหน้าสอบ</small>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center p-3 bg-white rounded-3 shadow-sm">
                                    <div class="rounded-circle bg-warning bg-opacity-10 text-warning d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="bi bi-activity fs-5"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-0">Real-time Monitoring</h6>
                                        <small class="text-muted">ผู้คุมสอบสามารถดูสถานะของผู้สอบทุกคนได้สดๆ</small>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center p-3 bg-white rounded-3 shadow-sm">
                                    <div class="rounded-circle bg-success bg-opacity-10 text-success d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="bi bi-file-earmark-spreadsheet fs-5"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-0">Detailed Logs</h6>
                                        <small class="text-muted">บันทึกประวัติเหตุการณ์ทุจริตเพื่อตรวจสอบย้อนหลัง</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 offset-lg-1">
                            <div class="row g-3">
                                <div class="col-6"> <div class="card border-0 shadow-sm h-100 text-center p-4 course-card-hover d-flex flex-column justify-content-center" 
                                        style="border-radius: 20px; background-color: #fff; min-height: 260px;"> <div class="mb-3 mx-auto d-flex align-items-center justify-content-center rounded-circle bg-light" style="width: 60px; height: 60px;">
                                            <i class="bi bi-eye-slash-fill fs-2 text-secondary"></i>
                                        </div>
                                        <h6 class="fw-bold">Anti-Peeking</h6>
                                        <p class="text-muted small mb-0">ลดความเสี่ยงการลอกข้อสอบ</p>
                                    </div>
                                </div>

                                <div class="col-6">
                                    <div class="card border-0 shadow-sm h-100 text-center p-4 course-card-hover d-flex flex-column justify-content-center" 
                                        style="border-radius: 20px; background-color: #fff; min-height: 260px;">
                                        <div class="mb-3 mx-auto d-flex align-items-center justify-content-center rounded-circle bg-light" style="width: 60px; height: 60px;">
                                            <i class="bi bi-shield-lock-fill fs-2 text-danger"></i>
                                        </div>
                                        <h6 class="fw-bold">Secure Access</h6>
                                        <p class="text-muted small mb-0">รหัสผ่านเข้าสอบเฉพาะบุคคล</p>
                                    </div>
                                </div>

                                <div class="col-6"> <div class="card border-0 shadow-sm h-100 text-center p-4 course-card-hover d-flex flex-column justify-content-center" 
                                        style="border-radius: 20px; background-color: #fff; min-height: 260px;">
                                        <div class="mb-3 mx-auto d-flex align-items-center justify-content-center rounded-circle bg-light" style="width: 60px; height: 60px;">
                                            <i class="bi bi-stopwatch-fill fs-2 text-warning"></i>
                                        </div>
                                        <h6 class="fw-bold">Auto Submit</h6>
                                        <p class="text-muted small mb-0">ส่งข้อสอบอัตโนมัติเมื่อหมดเวลา</p>
                                    </div>
                                </div>

                                <div class="col-6">
                                    <div class="card border-0 shadow-sm h-100 text-center p-4 course-card-hover d-flex flex-column justify-content-center" 
                                        style="border-radius: 20px; background-color: #fff; min-height: 260px;">
                                        <div class="mb-3 mx-auto d-flex align-items-center justify-content-center rounded-circle bg-light" style="width: 60px; height: 60px;">
                                            <i class="bi bi-graph-up fs-2 text-success"></i>
                                        </div>
                                        <h6 class="fw-bold">Instant Score</h6>
                                        <p class="text-muted small mb-0">ประมวลผลคะแนนทันที</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container py-5 my-4">
                <div class="row align-items-center mb-5">
                    <div class="col-lg-5">
                        <h2 class="fw-bold mb-4" style="color: var(--text-main);">เริ่มต้นใช้งานง่ายๆ<br>ใน 3 ขั้นตอน</h2>
                        <div class="d-flex flex-column gap-4">
                            <div class="d-flex">
                                <div class="flex-shrink-0 me-3">
                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center fw-bold fs-5 shadow-sm" 
                                        style="width: 45px; height: 45px; color: #ffffff !important;">
                                        1
                                    </div>
                                </div>
                                <div>
                                    <h5 class="fw-bold mt-1">ลงทะเบียนเข้าสู่ระบบ</h5>
                                    <p class="text-muted small">กรอกข้อมูลส่วนตัวและยืนยันตัวตนเพื่อสร้างบัญชีผู้ใช้งานในระบบ</p>
                                </div>
                            </div>
                            <div class="d-flex">
                                <div class="flex-shrink-0 me-3">
                                    <div class="rounded-circle bg-white border border-primary text-primary d-flex align-items-center justify-content-center fw-bold fs-5 shadow-sm" style="width: 45px; height: 45px;">2</div>
                                </div>
                                <div>
                                    <h5 class="fw-bold mt-1">เลือกรายวิชาที่ต้องการ</h5>
                                    <p class="text-muted small">ค้นหาคอร์สเรียนหรือวิชาสอบที่เปิดให้ลงทะเบียนตามชั้นปีของคุณ</p>
                                </div>
                            </div>
                            <div class="d-flex">
                                <div class="flex-shrink-0 me-3">
                                    <div class="rounded-circle bg-white border border-primary text-primary d-flex align-items-center justify-content-center fw-bold fs-5 shadow-sm" style="width: 45px; height: 45px;">3</div>
                                </div>
                                <div>
                                    <h5 class="fw-bold mt-1">เริ่มสอบและดูผลลัพธ์</h5>
                                    <p class="text-muted small">ทำแบบทดสอบในเวลาที่กำหนด และดูผลวิเคราะห์คะแนนได้ทันทีหลังส่ง</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 offset-lg-1 mt-4 mt-lg-0 text-center">
                        <img src="https://cdni.iconscout.com/illustration/premium/thumb/online-exam-4439227-3726932.png" alt="Steps Illustration" class="img-fluid" style="width: 100%; max-width: 400px; height: auto;">
                    </div>
                </div>
            </div>

            <div class="py-5" style="background-color: var(--bg-light);">
                <div class="container">
                    <div class="text-center mb-5">
                        <div class="d-inline-flex align-items-center px-3 py-1 rounded-pill bg-white border shadow-sm mb-3 small fw-bold text-muted">
                            <i class="bi bi-heart-fill text-danger me-2"></i>ความประทับใจ
                        </div>
                        <h2 class="fw-bold" style="color: var(--text-main);">เสียงตอบรับจากผู้ใช้งาน</h2>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="card h-100 border-0 shadow-sm p-4 course-card-hover" style="border-radius: 20px;">
                                <div class="card-body">
                                    <div class="mb-4 text-warning">
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                    </div>
                                    <p class="text-muted mb-4" style="line-height: 1.6;">"ระบบใช้งานง่ายมากครับ หน้าตาทันสมัย ไม่ซับซ้อน ทำให้โฟกัสกับการทำข้อสอบได้เต็มที่โดยไม่ต้องกังวลเรื่องการใช้งาน"</p>
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-secondary bg-opacity-25 me-3" style="width: 50px; height: 50px; background-image: url('https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&q=80&w=100'); background-size: cover;"></div>
                                        <div>
                                            <h6 class="fw-bold mb-0">ธีรภัทร ส.</h6>
                                            <small class="text-muted" style="font-size: 0.8rem;">นักศึกษาชั้นปีที่ 3</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card h-100 border-0 shadow-sm p-4 course-card-hover" style="border-radius: 20px;">
                                <div class="card-body">
                                    <div class="mb-4 text-warning">
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                    </div>
                                    <p class="text-muted mb-4" style="line-height: 1.6;">"ชอบระบบวิเคราะห์คะแนนหลังสอบมากค่ะ ช่วยให้รู้จุดอ่อนของตัวเองทันที และระบบเสถียรมาก ไม่เคยเจอเว็บล่มเลย"</p>
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-secondary bg-opacity-25 me-3" style="width: 50px; height: 50px; background-image: url('https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&q=80&w=100'); background-size: cover;"></div>
                                        <div>
                                            <h6 class="fw-bold mb-0">ณัฐนิชา ว.</h6>
                                            <small class="text-muted" style="font-size: 0.8rem;">นักศึกษาชั้นปีที่ 4</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card h-100 border-0 shadow-sm p-4 course-card-hover" style="border-radius: 20px;">
                                <div class="card-body">
                                    <div class="mb-4 text-warning">
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-half"></i>
                                    </div>
                                    <p class="text-muted mb-4" style="line-height: 1.6;">"สะดวกมากครับ สามารถเข้าสอบผ่านแท็บเล็ตได้ ทำให้ไม่ต้องพกโน้ตบุ๊กหนักๆ ไปมหาลัย ระบบ Responsive ดีเยี่ยม"</p>
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-secondary bg-opacity-25 me-3" style="width: 50px; height: 50px; background-image: url('https://images.unsplash.com/photo-1599566150163-29194dcaad36?auto=format&fit=crop&q=80&w=100'); background-size: cover;"></div>
                                        <div>
                                            <h6 class="fw-bold mb-0">ธนดล พ.</h6>
                                            <small class="text-muted" style="font-size: 0.8rem;">นักศึกษาชั้นปีที่ 2</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container py-5 my-4">
                <div class="card border-0 shadow-card overflow-hidden" style="border-radius: 24px; background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);">
                    <div class="card-body p-5 text-white text-center position-relative">
                        
                        <div class="position-absolute top-0 start-0 bg-white rounded-circle" style="width: 200px; height: 200px; transform: translate(-50%, -50%); opacity: 0.1;"></div>
                        <div class="position-absolute bottom-0 end-0 bg-white rounded-circle" style="width: 300px; height: 300px; transform: translate(30%, 30%); opacity: 0.1;"></div>

                        <h2 class="fw-bold mb-4 position-relative z-1" style="color: #ffffff;">ต้องการความช่วยเหลือ?</h2>
                        <p class="mb-5 position-relative z-1" style="font-size: 1.1rem; color: #ffffff;">ทีมงาน Support พร้อมดูแลและแก้ไขปัญหาการใช้งานระบบตลอดเวลาทำการ</p>

                        <div class="row justify-content-center g-4 position-relative z-1">
                            <div class="col-md-3">
                                <div class="p-3 rounded-4 bg-white bg-opacity-10 border border-white border-opacity-25 h-100">
                                    <i class="bi bi-telephone-fill fs-2 mb-3 d-block" style="color: #ffffff;"></i>
                                    <h6 class="fw-bold" style="color: #ffffff;">Call Center</h6>
                                    <p class="small mb-0" style="color: #ffffff;">02-XXX-XXXX</p>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="p-3 rounded-4 bg-white bg-opacity-10 border border-white border-opacity-25 h-100">
                                    <i class="bi bi-envelope-fill fs-2 mb-3 d-block" style="color: #ffffff;"></i>
                                    <h6 class="fw-bold" style="color: #ffffff;">Email Support</h6>
                                    <p class="small mb-0" style="color: #ffffff;">support@exam.com</p>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="p-3 rounded-4 bg-white bg-opacity-10 border border-white border-opacity-25 h-100">
                                    <i class="bi bi-line fs-2 mb-3 d-block" style="color: #ffffff;"></i>
                                    <h6 class="fw-bold" style="color: #ffffff;">Line Official</h6>
                                    <p class="small mb-0" style="color: #ffffff;">@ExamSystem</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="py-5" style="background-color: #f8f9fa;">
                <div class="container">
                    <div class="text-center mb-5">
                        <h2 class="fw-bold" style="color: var(--text-main);">คำถามที่พบบ่อย (FAQ)</h2>
                        <p class="text-muted">ไขข้อข้องใจการใช้งานระบบ</p>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="accordion accordion-flush shadow-sm rounded-4 bg-white overflow-hidden" id="accordionFAQ">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                            ลืมรหัสผ่านต้องทำอย่างไร?
                                        </button>
                                    </h2>
                                    <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#accordionFAQ">
                                        <div class="accordion-body text-muted small">
                                            สามารถกดที่ลิงก์ "ลืมรหัสผ่าน" ในหน้าเข้าสู่ระบบ และกรอกอีเมลที่ลงทะเบียนไว้ ระบบจะส่งรหัสผ่านใหม่ไปให้ทางอีเมลทันที
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                            ระบบรองรับอุปกรณ์ใดบ้าง?
                                        </button>
                                    </h2>
                                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#accordionFAQ">
                                        <div class="accordion-body text-muted small">
                                            ระบบรองรับทั้ง PC, Notebook, Tablet และ Smartphone ผ่านเว็บบราวเซอร์ (แนะนำ Google Chrome เพื่อประสิทธิภาพสูงสุด)
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                            หากอินเทอร์เน็ตหลุดระหว่างสอบทำอย่างไร?
                                        </button>
                                    </h2>
                                    <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#accordionFAQ">
                                        <div class="accordion-body text-muted small">
                                            ไม่ต้องกังวล ระบบมีการบันทึกคำตอบอัตโนมัติ ท่านสามารถเชื่อมต่ออินเทอร์เน็ตและเข้าสู่ระบบใหม่เพื่อทำข้อสอบต่อได้ทันทีภายในเวลาที่กำหนด
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="admin-dashboard-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="d-flex justify-content-between align-items-end mb-4">
                    <div>
                        <h6 class="text-uppercase text-primary fw-bold mb-1" style="letter-spacing: 1px;">Admin Control Panel</h6>
                        <h2 class="fw-bold mb-0" style="color: var(--text-main);">แดชบอร์ดภาพรวม</h2>
                    </div>
                    <div class="d-none d-md-block text-end">
                        <span class="text-muted small" id="current-date-display">
                            </span>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-4 position-relative overflow-hidden" 
                    style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-left: 6px solid var(--color-primary) !important;">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-lg-8">
                                <h4 class="fw-bold mb-2" style="color: var(--text-main);">
                                    ยินดีต้อนรับผู้ดูแลระบบ
                                </h4>
                                <p class="text-muted mb-0">
                                    ระบบพร้อมใช้งานเต็มรูปแบบ ตรวจสอบความเรียบร้อยและจัดการข้อมูลได้จากที่นี่
                                </p>
                            </div>
                            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                                <button class="btn btn-primary rounded-pill px-4 py-2 shadow-btn fw-bold" onclick="fetchSystemSettingsPage()">
                                    <i class="bi bi-sliders me-2"></i>ตั้งค่าระบบหลัก
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-5">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-pill me-2" style="width: 4px; height: 24px; background-color: var(--color-danger);"></div>
                        <h5 class="fw-bold m-0 text-secondary">จุดเด่นและระบบความปลอดภัย (System Core Features)</h5>
                    </div>

                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-white">
                        <div class="card-body p-0">
                            <div class="row g-0">
                                <div class="col-md-6 col-lg-3 border-end border-light">
                                    <div class="p-4 text-center h-100 hover-bg-light transition-fast">
                                        <div class="mb-3 d-inline-flex align-items-center justify-content-center rounded-circle bg-primary bg-opacity-10 text-primary" style="width: 60px; height: 60px;">
                                            <i class="bi bi-shield-lock-fill fs-3"></i>
                                        </div>
                                        <h6 class="fw-bold mb-2">Secure PIN Access</h6>
                                        <p class="text-muted small mb-0">
                                            ระบบล็อค 2 ชั้น ผู้สอบต้องกรอก <strong>รหัสผ่าน (PIN)</strong> เฉพาะของวิชานั้นๆ ก่อนเริ่มทำข้อสอบ เพื่อป้องกันผู้ไม่มีสิทธิ์
                                        </p>
                                    </div>
                                </div>

                                <div class="col-md-6 col-lg-3 border-end border-light">
                                    <div class="p-4 text-center h-100 hover-bg-light transition-fast">
                                        <div class="mb-3 d-inline-flex align-items-center justify-content-center rounded-circle bg-danger bg-opacity-10 text-danger" style="width: 60px; height: 60px;">
                                            <i class="bi bi-window-x fs-3"></i>
                                        </div>
                                        <h6 class="fw-bold mb-2">Anti-Tab Switching</h6>
                                        <p class="text-muted small mb-0">
                                            ระบบตรวจจับการ <strong>สลับหน้าจอ</strong> หรือออกจากแท็บข้อสอบ หากพบจะแจ้งเตือนและบันทึก Log การทุจริตทันที
                                        </p>
                                    </div>
                                </div>

                                <div class="col-md-6 col-lg-3 border-end border-light">
                                    <div class="p-4 text-center h-100 hover-bg-light transition-fast">
                                        <div class="mb-3 d-inline-flex align-items-center justify-content-center rounded-circle bg-warning bg-opacity-10 text-warning" style="width: 60px; height: 60px;">
                                            <i class="bi bi-activity fs-3"></i>
                                        </div>
                                        <h6 class="fw-bold mb-2">Live Monitoring</h6>
                                        <p class="text-muted small mb-0">
                                            แดชบอร์ดแสดงสถานะผู้สอบแบบ <strong>Real-time</strong> เห็นทันทีใครกำลังสอบ ใครส่งแล้ว หรือใครทำผิดกฎ
                                        </p>
                                    </div>
                                </div>

                                <div class="col-md-6 col-lg-3">
                                    <div class="p-4 text-center h-100 hover-bg-light transition-fast">
                                        <div class="mb-3 d-inline-flex align-items-center justify-content-center rounded-circle bg-success bg-opacity-10 text-success" style="width: 60px; height: 60px;">
                                            <i class="bi bi-stopwatch-fill fs-3"></i>
                                        </div>
                                        <h6 class="fw-bold mb-2">Auto-Submission</h6>
                                        <p class="text-muted small mb-0">
                                            ระบบนับเวลาถอยหลังและ <strong>ส่งข้อสอบอัตโนมัติ</strong> เมื่อหมดเวลา ป้องกันการทำข้อสอบเกินเวลาที่กำหนด
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-0 p-3 text-center">
                            <small class="text-muted"><i class="bi bi-info-circle me-1"></i> ระบบบันทึกทุกเหตุการณ์ใน Log เพื่อการตรวจสอบย้อนหลังได้อย่างแม่นยำ</small>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-pill me-2" style="width: 4px; height: 24px; background-color: var(--color-primary);"></div>
                        <h5 class="fw-bold m-0 text-secondary">เมนูลัด (Quick Actions)</h5>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-6 col-lg-3">
                            <div class="card h-100 border-0 shadow-sm rounded-4 card-hover-effect" 
                                style="cursor: pointer;" onclick="showView('admin-cheating-monitor-view'); setupCheatingMonitorView();">
                                <div class="card-body p-4 text-center">
                                    <div class="d-inline-flex justify-content-center align-items-center rounded-circle mb-3 bg-danger bg-opacity-10 text-danger" 
                                        style="width: 60px; height: 60px;">
                                        <i class="bi bi-shield-shaded fs-3"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">Cheating Monitor</h6>
                                    <p class="text-muted small mb-0">ตรวจสอบการทุจริต</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <div class="card h-100 border-0 shadow-sm rounded-4 card-hover-effect" 
                                style="cursor: pointer;" onclick="fetchExamSubjectManagement()">
                                <div class="card-body p-4 text-center">
                                    <div class="d-inline-flex justify-content-center align-items-center rounded-circle mb-3 bg-primary bg-opacity-10 text-primary" 
                                        style="width: 60px; height: 60px;">
                                        <i class="bi bi-pencil-square fs-3"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">รายวิชาสอบ</h6>
                                    <p class="text-muted small mb-0">สร้างและแก้ไขข้อสอบ</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <div class="card h-100 border-0 shadow-sm rounded-4 card-hover-effect" 
                                style="cursor: pointer;" onclick="fetchAnnouncementManagement()">
                                <div class="card-body p-4 text-center">
                                    <div class="d-inline-flex justify-content-center align-items-center rounded-circle mb-3 bg-success bg-opacity-10 text-success" 
                                        style="width: 60px; height: 60px;">
                                        <i class="bi bi-megaphone-fill fs-3"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">ประกาศข่าวสาร</h6>
                                    <p class="text-muted small mb-0">แจ้งเตือนผู้ใช้งาน</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <div class="card h-100 border-0 shadow-sm rounded-4 card-hover-effect" 
                                style="cursor: pointer;" onclick="fetchUserManagement()">
                                <div class="card-body p-4 text-center">
                                    <div class="d-inline-flex justify-content-center align-items-center rounded-circle mb-3 bg-info bg-opacity-10 text-info" 
                                        style="width: 60px; height: 60px;">
                                        <i class="bi bi-people-fill fs-3"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">จัดการผู้ใช้งาน</h6>
                                    <p class="text-muted small mb-0">รายชื่อและสิทธิ์</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

        <div id="admin-user-management-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                    <div>
                        <h2 class="fw-bold mb-1" style="color: var(--text-main);">จัดการผู้ใช้งาน</h2>
                        <p class="text-muted mb-0 small">ดูรายชื่อ ตรวจสอบสถานะ และจัดการสิทธิ์ผู้ใช้งาน</p>
                    </div>
                    <div>
                        <button class="btn btn-success rounded-pill px-4 shadow-sm fw-bold" onclick="openAddUserModal()">
                            <i class="bi bi-person-plus-fill me-2"></i>เพิ่มผู้ใช้ใหม่
                        </button>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-5">
                        <div class="input-group rounded-pill border bg-white shadow-sm" style="overflow: hidden; border-color: var(--border-color) !important;">
                            <span class="input-group-text bg-transparent border-0 ps-3">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 shadow-none bg-transparent" id="user-search-input" 
                                  placeholder="ค้นหา (ชื่อ, อีเมล, รหัสนักศึกษา)..." oninput="fetchUserManagement(1)">
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="input-group rounded-pill border bg-white shadow-sm" style="overflow: hidden; border-color: var(--border-color) !important;">
                            <span class="input-group-text bg-transparent border-0 ps-3 text-muted small fw-bold">
                                <i class="bi bi-funnel me-2"></i>บทบาท
                            </span>
                            <select id="user-role-filter" class="form-select border-0 shadow-none bg-transparent" 
                                    style="cursor: pointer;" onchange="fetchUserManagement(1)">
                                <option value="">ทั้งหมด (All)</option>
                                <option value="Student">Student</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-4 d-flex justify-content-md-end align-items-center">
                        <div class="d-flex align-items-center bg-white px-3 py-1 rounded-pill border shadow-sm">
                            <label for="user-limit-select" class="form-label mb-0 me-2 small text-muted fw-bold">แสดง:</label>
                            <select id="user-limit-select" class="form-select form-select-sm border-0 bg-transparent shadow-none" 
                                    style="width: 70px; cursor: pointer;" onchange="fetchUserManagement(1)"> 
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ชื่อ-นามสกุล</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">Email</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">รหัสนักศึกษา</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">Role</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">สถานะ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end" style="min-width: 150px;">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="bg-white"></tbody>
                        </table>
                    </div>
                    
                    <div class="card-footer bg-white border-top-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="user-pagination-info"></small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="user-pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-user-history-view" class="view">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="user-history-title">ประวัติของ: [User Name]</h2>
                <button class="btn btn-outline-secondary" onclick="fetchUserManagement()">&laquo; กลับไปหน้าจัดการผู้ใช้</button>
            </div>
            <ul class="nav nav-tabs" id="historyTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="admin-learning-history-tab" data-bs-toggle="tab" data-bs-target="#admin-learning-history-pane" type="button" role="tab">ประวัติการเรียน</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="admin-exam-history-tab" data-bs-toggle="tab" data-bs-target="#admin-exam-history-pane" type="button" role="tab">ประวัติการสอบ</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="admin-exam-topic-history-tab" data-bs-toggle="tab" data-bs-target="#admin-exam-topic-history-pane" type="button" role="tab">ประวัติการทำข้อสอบย่อย</button>
                </li>
            </ul>
            <div class="tab-content border border-top-0 p-3">
                <div class="tab-pane fade show active" id="admin-learning-history-pane" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr><th>#</th><th>ชื่อคอร์สเรียน</th><th>เวลาที่ลงทะเบียน</th><th>เวลาที่เรียนจบ</th><th>ระยะเวลาที่ใช้</th></tr>
                            </thead>
                            <tbody id="admin-learning-history-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="admin-exam-history-pane" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr><th>#</th><th>ชื่อรายวิชาสอบ</th><th>เวลาที่เข้าสอบ</th><th>เวลาที่ส่งข้อสอบ</th><th>ระยะเวลาที่ใช้</th></tr>
                            </thead>
                            <tbody id="admin-exam-history-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="admin-exam-topic-history-pane" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>รายวิชา</th>
                                    <th>หัวข้อ</th>
                                    <th>เวลาที่เข้าทำ</th>
                                    <th>เวลาที่ส่ง</th>
                                    <th>ระยะเวลา</th>
                                </tr>
                            </thead>
                            <tbody id="admin-exam-topic-history-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-course-management-view" class="view bg-body">
            <div class="container py-4">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                    <div>
                        <h2 class="fw-bold mb-1" style="color: var(--text-main);">จัดการคอร์สเรียน</h2>
                        <p class="text-muted mb-0 small">เพิ่ม ลบ หรือแก้ไขรายวิชาทั้งหมดในระบบ</p>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3B86qQZRHSuQ9sM11FVLpvc7l3f1rnImEByvvJZ6aToyTOlfO-AM6FNnjCxavCPtz8KLnLOXpQh76/pub?gid=0&single=true&output=csv" 
                          target="_blank" class="btn btn-outline-secondary rounded-pill btn-sm px-3">
                            <i class="bi bi-download me-1"></i> Template
                        </a>
                        <button class="btn btn-success rounded-pill btn-sm px-3 shadow-sm" onclick="openImportModal('Courses')">
                            <i class="fa-solid fa-file-import me-1"></i> Import CSV
                        </button>
                        <button class="btn btn-primary rounded-pill btn-sm px-3 shadow-btn fw-bold" onclick="openAddCourseModal()">
                            <i class="bi bi-plus-lg me-1"></i> เพิ่มคอร์สใหม่
                        </button>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-5 col-lg-4">
                        <div class="input-group rounded-pill border bg-white shadow-sm" style="overflow: hidden; border-color: var(--border-color) !important;">
                            <span class="input-group-text bg-transparent border-0 ps-3">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 shadow-none bg-transparent" id="course-search-input" 
                                  placeholder="ค้นหาคอร์ส..." oninput="fetchCourseManagement(1)">
                        </div>
                    </div>
                    <div class="col-md-7 col-lg-8 d-flex justify-content-md-end align-items-center">
                        <div class="d-flex align-items-center bg-white px-3 py-1 rounded-pill border shadow-sm">
                            <label for="course-limit-select" class="form-label mb-0 me-2 small text-muted fw-bold">แสดง:</label>
                            <select id="course-limit-select" class="form-select form-select-sm border-0 bg-transparent shadow-none" 
                                    style="width: 70px; cursor: pointer;" onchange="fetchCourseManagement(1)">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ID</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ชื่อคอร์ส</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">หมวดหมู่</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">คำอธิบาย</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="course-table-body" class="bg-white">
                                </tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-white border-top-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="course-pagination-info"></small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="course-pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-lesson-management-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="mb-4">
                    <button class="btn btn-link text-decoration-none text-muted p-0 mb-2 d-flex align-items-center" 
                            onclick="fetchCourseManagement(1)">
                        <i class="bi bi-arrow-left me-1"></i> กลับไปหน้าคอร์ส
                    </button>
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
                        <div>
                            <h2 class="fw-bold mb-1" id="lesson-mg-title" style="color: var(--text-main);">จัดการบทเรียน</h2>
                            <p class="text-muted mb-0 small">เพิ่มเนื้อหาและบทเรียนสำหรับรายวิชานี้</p>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3B86qQZRHSuQ9sM11FVLpvc7l3f1rnImEByvvJZ6aToyTOlfO-AM6FNnjCxavCPtz8KLnLOXpQh76/pub?gid=280938483&single=true&output=csv" 
                              target="_blank" class="btn btn-outline-secondary rounded-pill btn-sm px-3">
                                <i class="bi bi-download me-1"></i> Template
                            </a>
                            <button class="btn btn-success rounded-pill btn-sm px-3 shadow-sm" onclick="openImportModal('Lessons')">
                                <i class="fa-solid fa-file-import me-1"></i> Import CSV
                            </button>
                            <button class="btn btn-primary rounded-pill btn-sm px-3 shadow-btn fw-bold" onclick="openAddLessonModal()">
                                <i class="bi bi-plus-lg me-1"></i> เพิ่มบทเรียน
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-5 col-lg-4">
                        <div class="input-group rounded-pill border bg-white shadow-sm" style="overflow: hidden; border-color: var(--border-color) !important;">
                            <span class="input-group-text bg-transparent border-0 ps-3">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 shadow-none bg-transparent" id="lesson-search-input" 
                                  placeholder="ค้นหาบทเรียน..." oninput="fetchLessonManagement(1)">
                        </div>
                    </div>
                    <div class="col-md-7 col-lg-8 d-flex justify-content-md-end align-items-center">
                        <div class="d-flex align-items-center bg-white px-3 py-1 rounded-pill border shadow-sm">
                            <label for="lesson-limit-select" class="form-label mb-0 me-2 small text-muted fw-bold">แสดง:</label>
                            <select id="lesson-limit-select" class="form-select form-select-sm border-0 bg-transparent shadow-none" 
                                    style="width: 70px; cursor: pointer;" onchange="fetchLessonManagement(1)">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ID</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ชื่อบทเรียน</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="lesson-table-body" class="bg-white"></tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-white border-top-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="lesson-pagination-info"></small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="lesson-pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-question-management-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="mb-4">
                    <button class="btn btn-link text-decoration-none text-muted p-0 mb-2 d-flex align-items-center" 
                            onclick="fetchLessonManagement(currentManagingCourse.id, currentManagingCourse.name)">
                        <i class="bi bi-arrow-left me-1"></i> กลับไปหน้าบทเรียน
                    </button>
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
                        <div>
                            <h2 class="fw-bold mb-1" id="question-mg-title" style="color: var(--text-main);">จัดการคำถาม</h2>
                            <p class="text-muted mb-0 small">สร้างข้อสอบและคำถามสำหรับบทเรียนนี้</p>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3B86qQZRHSuQ9sM11FVLpvc7l3f1rnImEByvvJZ6aToyTOlfO-AM6FNnjCxavCPtz8KLnLOXpQh76/pub?gid=1455787018&single=true&output=csv" 
                              target="_blank" class="btn btn-outline-secondary rounded-pill btn-sm px-3">
                                <i class="bi bi-download me-1"></i> Template
                            </a>
                            <button class="btn btn-success rounded-pill btn-sm px-3 shadow-sm" onclick="openImportModal('Questions')">
                                <i class="fa-solid fa-file-import me-1"></i> Import CSV
                            </button>
                            <button class="btn btn-primary rounded-pill btn-sm px-3 shadow-btn fw-bold" onclick="openAddQuestionModal()">
                                <i class="bi bi-plus-lg me-1"></i> เพิ่มคำถาม
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-5 col-lg-4">
                        <div class="input-group rounded-pill border bg-white shadow-sm" style="overflow: hidden; border-color: var(--border-color) !important;">
                            <span class="input-group-text bg-transparent border-0 ps-3">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 shadow-none bg-transparent" id="question-search-input"
                                  placeholder="ค้นหาคำถาม..." oninput="fetchQuestionManagement(1)">
                        </div>
                    </div>
                    <div class="col-md-7 col-lg-8 d-flex justify-content-md-end align-items-center">
                        <div class="d-flex align-items-center bg-white px-3 py-1 rounded-pill border shadow-sm">
                            <label for="question-limit-select" class="form-label mb-0 me-2 small text-muted fw-bold">แสดง:</label>
                            <select id="question-limit-select" class="form-select form-select-sm border-0 bg-transparent shadow-none" 
                                    style="width: 70px; cursor: pointer;" onchange="fetchQuestionManagement(1)">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ID</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">Type</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom" style="min-width: 200px;">คำถาม</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">คำตอบถูก</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">อธิบาย</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="question-table-body" class="bg-white"></tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-white border-top-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="question-pagination-info"></small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="question-pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-system-settings-view" class="view">
            <h2 class="mb-4">ตั้งค่าระบบ</h2>
            
            <div id="system-settings-content">
                </div> 
        </div>

        <div id="admin-course-reports-view" class="view">
            <h2 class="mb-4">รายงานคอร์สเรียน</h2>
            
            <ul class="nav nav-tabs" id="courseDataTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="enroll-tab" data-bs-toggle="tab" data-bs-target="#enroll-pane" type="button">Enrollments</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="scores-tab" data-bs-toggle="tab" data-bs-target="#scores-pane" type="button">Course Scores</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-pane" type="button">Course Logs</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="learning-history-tab" data-bs-toggle="tab" data-bs-target="#learning-history-pane" type="button">Learning History</button>
                </li>
            </ul>

            <div class="tab-content" id="courseDataTabsContent">
                <div class="tab-pane fade show active p-3 border border-top-0" id="enroll-pane">
                  <h5>เพิ่มการลงทะเบียน</h5>
                  <form class="row g-3 align-items-center mb-4" onsubmit="handleAddNewEnrollment(event)">
                    <div class="col-sm-5"><input type="email" class="form-control" id="add-enroll-email" placeholder="User Email" required>
                    </div>
                    <div class="col-sm-5"><input type="text" class="form-control" id="add-enroll-courseId" placeholder="Course ID" required>
                    </div>
                    <div class="col-sm-2"><button type="submit" class="btn btn-success w-100">เพิ่ม</button></div>
                  </form>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Timestamp</th>
                          <th>ชื่อ-นามสกุล</th>
                          <th>User Email</th>
                          <th>ชื่อคอร์ส</th>
                          <th>Course ID</th>
                          <th>จัดการ</th>
                        </tr>
                      </thead>
                      <tbody id="enrollment-table-body"></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                      <div id="enroll-limit-selector-container" class="d-flex align-items-center">
                          </div>
                      <nav>
                          <ul class="pagination pagination-sm mb-0" id="enroll-pagination-controls">
                              </ul>
                      </nav>
                  </div>
                </div>

                <div class="tab-pane fade p-3 border border-top-0" id="scores-pane">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Timestamp</th>
                          <th>ชื่อ-นามสกุล</th>
                          <th>User Email</th>
                          <th>ชื่อบทเรียน</th>
                          <th>Lesson ID</th>
                          <th>ประเภท</th>
                          <th>คะแนน</th>
                          <th>จัดการ</th>
                        </tr>
                      </thead>
                      <tbody id="score-table-body"></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                      <div id="scores-limit-selector-container" class="d-flex align-items-center">
                      </div>
                      <nav>
                          <ul class="pagination pagination-sm mb-0" id="scores-pagination-controls">
                          </ul>
                      </nav>
                  </div>
                </div>

                <div class="tab-pane fade p-3 border border-top-0" id="logs-pane">
                  <div class="alert alert-warning small"><strong>หมายเหตุ:</strong> ข้อมูลในส่วนนี้เป็น Log การกระทำ ควรใช้เพื่อการตรวจสอบเท่านั้น การลบข้อมูลอาจส่งผลต่อการวิเคราะห์ข้อมูลในภาพรวม</div>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Timestamp</th>
                          <th>ชื่อ-นามสกุล</th>
                          <th>User Email</th>
                          <th>ชื่อบทเรียน</th>
                          <th>Lesson ID</th>
                          <th style="min-width: 200px;">Question Text</th>
                          <th>Question ID</th>
                          <th>ประเภท</th>
                          <th>คำตอบ</th>
                          <th>จัดการ</th>
                        </tr>
                      </thead>
                      <tbody id="log-table-body"></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                      <div id="logs-limit-selector-container" class="d-flex align-items-center">
                      </div>
                      <nav>
                          <ul class="pagination pagination-sm mb-0" id="logs-pagination-controls">
                          </ul>
                      </nav>
                  </div>
                </div>
                
                <div class="tab-pane fade p-3 border border-top-0" id="learning-history-pane">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>ชื่อ-นามสกุล</th>
                          <th>User Email</th>
                          <th>ชื่อคอร์ส</th>
                          <th>เวลาลงทะเบียน</th>
                          <th>เวลาเรียนจบ</th>
                          <th>ระยะเวลา</th>
                        </tr>
                      </thead>
                      <tbody id="learning-history-report-body"></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                      <div id="learning-history-limit-selector-container" class="d-flex align-items-center">
                      </div>
                      <nav>
                          <ul class="pagination pagination-sm mb-0" id="learning-history-pagination-controls">
                          </ul>
                      </nav>
                  </div>
                </div>
            </div>
        </div>

        <div id="admin-exam-reports-view" class="view">
            <h2 class="mb-4">รายงานการสอบออนไลน์</h2>
            
            <ul class="nav nav-tabs" id="examDataTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="exam-sub-tab" data-bs-toggle="tab" data-bs-target="#exam-sub-pane" type="button">Exam Submissions</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="final-sub-tab" data-bs-toggle="tab" data-bs-target="#final-sub-pane" type="button">Final Submissions</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="exam-logs-tab" data-bs-toggle="tab" data-bs-target="#exam-logs-pane" type="button">Exam Logs</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="exam-history-tab" data-bs-toggle="tab" data-bs-target="#exam-history-pane" type="button">Exam History</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="exam-topic-history-tab" data-bs-toggle="tab" data-bs-target="#exam-topic-history-pane" type="button">Exam Topic History</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pin-logs-tab" data-bs-toggle="tab" data-bs-target="#pin-logs-pane" type="button">PIN Entry Logs</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cheating-logs-tab" data-bs-toggle="tab" data-bs-target="#cheating-logs-pane" type="button">Cheating Logs</button>
                </li>
            </ul>

            <div class="tab-content" id="examDataTabsContent">
                <div class="tab-pane fade show active p-3 border border-top-0" id="exam-sub-pane">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Timestamp</th>
                          <th>ชื่อ-นามสกุล</th>
                          <th>User Email</th>
                          <th>ชื่อหัวข้อ</th>
                          <th>Topic ID</th>
                          <th>คะแนน</th>
                          <th>จัดการ</th>
                        </tr>
                      </thead>
                      <tbody id="exam-submission-table-body"></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                      <div id="exam-sub-limit-selector-container" class="d-flex align-items-center">
                      </div>
                      <nav>
                          <ul class="pagination pagination-sm mb-0" id="exam-sub-pagination-controls">
                          </ul>
                      </nav>
                  </div>
                </div>
                
                <div class="tab-pane fade p-3 border border-top-0" id="final-sub-pane">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Timestamp</th>
                          <th>ชื่อ-นามสกุล</th>
                          <th>User Email</th>
                          <th>ชื่อรายวิชา</th>
                          <th>Subject ID</th>
                          <th>จัดการ</th>
                        </tr>
                      </thead>
                      <tbody id="final-submission-table-body"></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                      <div id="final-sub-limit-selector-container" class="d-flex align-items-center">
                      </div>
                      <nav>
                          <ul class="pagination pagination-sm mb-0" id="final-sub-pagination-controls">
                          </ul>
                      </nav>
                  </div>
                </div>

                <div class="tab-pane fade p-3 border border-top-0" id="exam-logs-pane">
                  <div class="alert alert-warning small"><strong>หมายเหตุ:</strong> ข้อมูลนี้เป็น Log การกระทำ
                    ควรใช้เพื่อการตรวจสอบเท่านั้น</div>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Timestamp</th>
                          <th>ชื่อ-นามสกุล</th>
                          <th>User Email</th>
                          <th>ชื่อหัวข้อ</th>
                          <th>Topic ID</th>
                          <th style="min-width: 200px;">Question Text</th>
                          <th>Question ID</th>
                          <th>คำตอบ</th>
                          <th>จัดการ</th>
                        </tr>
                      </thead>
                      <tbody id="exam-log-table-body"></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                      <div id="exam-logs-limit-selector-container" class="d-flex align-items-center">
                      </div>
                      <nav>
                          <ul class="pagination pagination-sm mb-0" id="exam-logs-pagination-controls">
                          </ul>
                      </nav>
                  </div>
                </div>
                
                <div class="tab-pane fade p-3 border border-top-0" id="exam-history-pane">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>ชื่อ-นามสกุล</th>
                          <th>User Email</th>
                          <th>ชื่อรายวิชา</th>
                          <th>เวลาเข้าสอบ</th>
                          <th>เวลาส่งสอบ</th>
                          <th>ระยะเวลา</th>
                        </tr>
                      </thead>
                      <tbody id="exam-history-report-body"></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                      <div id="exam-history-limit-selector-container" class="d-flex align-items-center">
                      </div>
                      <nav>
                          <ul class="pagination pagination-sm mb-0" id="exam-history-pagination-controls">
                          </ul>
                      </nav>
                  </div>
                </div>
                
                <div class="tab-pane fade p-3 border border-top-0" id="exam-topic-history-pane">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>ชื่อ-นามสกุล</th>
                          <th>User Email</th>
                          <th>รายวิชา</th>
                          <th>หัวข้อ</th>
                          <th>เวลาเข้าทำ</th>
                          <th>เวลาส่ง</th>
                          <th>ระยะเวลา</th>
                        </tr>
                      </thead>
                      <tbody id="exam-topic-history-report-body"></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                      <div id="exam-topic-history-limit-selector-container" class="d-flex align-items-center">
                      </div>
                      <nav>
                          <ul class="pagination pagination-sm mb-0" id="exam-topic-history-pagination-controls">
                          </ul>
                      </nav>
                  </div>
                </div>
                
                <div class="tab-pane fade p-3 border border-top-0" id="pin-logs-pane">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>ชื่อ-นามสกุล</th>
                                    <th>User Email</th>
                                    <th>รายวิชาสอบ</th>
                                    <th>รหัสที่กรอก</th>
                                    <th>สถานะ</th>
                                    <th>จัดการ</th> </tr>
                            </thead>
                            <tbody id="pin-log-table-body">
                                </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="pin-logs-limit-selector-container" class="d-flex align-items-center">
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="pin-logs-pagination-controls">
                            </ul>
                        </nav>
                    </div>
                </div>
                
                <div class="tab-pane fade p-3 border border-top-0" id="cheating-logs-pane">
                    <div class="alert alert-danger small"><strong>ข้อควรระวัง:</strong> ข้อมูลในส่วนนี้เป็น Log การกระทำที่น่าสงสัยว่าอาจเป็นการทุจริต ควรใช้เพื่อการตรวจสอบและประกอบการพิจารณาเท่านั้น</div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>ชื่อ-นามสกุล</th>
                                    <th>User Email</th>
                                    <th>รายวิชาสอบ</th>
                                    <th>Action</th>
                                    <th style="min-width: 250px;">Details</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="cheating-log-table-body">
                                </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="cheating-logs-limit-selector-container" class="d-flex align-items-center">
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="cheating-logs-pagination-controls">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-system-logs-view" class="view">
            <h2 class="mb-4">Logs ระบบ</h2>
            
            <ul class="nav nav-tabs" id="logDataTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="admin-logs-tab" data-bs-toggle="tab" data-bs-target="#admin-logs-pane" type="button">Admin Logs</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="student-logs-tab" data-bs-toggle="tab" data-bs-target="#student-logs-pane" type="button">Student Logs</button>
                </li>
            </ul>

            <div class="tab-content" id="logDataTabsContent">
                <div class="tab-pane fade show active p-3 border border-top-0" id="admin-logs-pane">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>ชื่อ-นามสกุล</th>
                                    <th>User Email</th>
                                    <th>Action</th>
                                    <th>IP Address</th>
                                    <th>Browser</th>
                                    <th>OS</th>
                                </tr>
                            </thead>
                            <tbody id="admin-log-table-body"></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="admin-logs-limit-selector-container" class="d-flex align-items-center">
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="admin-logs-pagination-controls">
                            </ul>
                        </nav>
                    </div>
                </div>

                <div class="tab-pane fade p-3 border border-top-0" id="student-logs-pane">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>ชื่อ-นามสกุล</th>
                                    <th>User Email</th>
                                    <th>Action</th>
                                    <th>IP Address</th>
                                    <th>Browser</th>
                                    <th>OS</th>
                                </tr>
                            </thead>
                            <tbody id="student-log-table-body"></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="student-logs-limit-selector-container" class="d-flex align-items-center">
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="student-logs-pagination-controls">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-exam-progress-view" class="view">
            <div class="container py-4">
                <h2 class="mb-4">ติดตามความคืบหน้าการทำข้อสอบ (Real-time)</h2>
                
                <div class="mb-3">
                    <label for="progress-subject-select" class="form-label">เลือกรายวิชาที่ต้องการติดตาม:</label>
                    <select id="progress-subject-select" class="form-select" onchange="handleProgressSubjectSelect_Grid()">
                        <option value="">-- กรุณาเลือกรายวิชา --</option>
                    </select>
                </div>
                
                <div id="progress-topic-filter-container" class="mb-3" style="display: none;">
                    <label for="progress-topic-select" class="form-label">เลือกหัวข้อที่ต้องการแสดง:</label>
                    <select id="progress-topic-select" class="form-select" onchange="handleProgressTopicSelect_Grid()">
                        <option value="all">-- แสดงทุกหัวข้อ --</option>
                    </select>
                </div>
                <div id="progress-table-container" class="mt-4">
                    <p class="text-center text-muted">กรุณาเลือกรายวิชาเพื่อดูความคืบหน้า</p>
                </div>
            </div>
        </div>

        <div id="admin-announcement-management-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                    <div>
                        <h2 class="fw-bold mb-1" style="color: var(--text-main);">จัดการประกาศ</h2>
                        <p class="text-muted mb-0 small">สร้างและแก้ไขข่าวสารประชาสัมพันธ์ในระบบ</p>
                    </div>
                    <div>
                        <button class="btn btn-success rounded-pill px-4 shadow-sm fw-bold" onclick="openAddAnnouncementModal()">
                            <i class="bi bi-megaphone-fill me-2"></i>เพิ่มประกาศใหม่
                        </button>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="input-group rounded-pill border bg-white shadow-sm" style="overflow: hidden; border-color: var(--border-color) !important;">
                            <span class="input-group-text bg-transparent border-0 ps-3">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 shadow-none bg-transparent" id="announcement-search-input" 
                                  placeholder="ค้นหา (หัวข้อ, ผู้ประกาศ, เนื้อหา)..." oninput="fetchAnnouncementManagement(1)"> 
                        </div>
                    </div>
                    <div class="col-md-6 d-flex justify-content-md-end align-items-center">
                        <div class="d-flex align-items-center bg-white px-3 py-1 rounded-pill border shadow-sm">
                            <label for="announcement-limit-select" class="form-label mb-0 me-2 small text-muted fw-bold">แสดง:</label>
                            <select id="announcement-limit-select" class="form-select form-select-sm border-0 bg-transparent shadow-none" 
                                    style="width: 70px; cursor: pointer;" onchange="fetchAnnouncementManagement(1)"> 
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom" style="min-width: 300px;">หัวข้อประกาศ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ผู้ประกาศ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">สถานะ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="announcement-table-body" class="bg-white"></tbody>
                        </table>
                    </div>

                    <div class="card-footer bg-white border-top-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="announcement-pagination-info"></small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="announcement-pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="exam-analysis-view" class="view">
            <h2 class="mb-4">วิเคราะห์ข้อสอบ</h2>
            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="subject-analysis-select" class="form-label">เลือกรายวิชาที่ต้องการวิเคราะห์:</label>
                    <select id="subject-analysis-select" class="form-select" onchange="handleSubjectSelectionForAnalysis()">
                        <option selected>กำลังโหลดรายวิชา...</option>
                    </select>
                </div>
            </div>

            <div id="analysis-results-container">
                <div class="alert alert-info text-center" style="font-size: 20px;">
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    กรุณาเลือกรายวิชาเพื่อดูผลการวิเคราะห์
                </div>
            </div>
        </div>

        <div id="login-view" class="view bg-body">
            <div class="container d-flex flex-column justify-content-center align-items-center" style="min-height: 85vh;">
                
                <div class="card border-0 shadow-card p-4" style="max-width: 450px; width: 100%; border-radius: 24px;">
                    <div class="card-body">
                        
                        <div class="text-center mb-4">
                            <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 text-primary rounded-circle mb-3" 
                                style="width: 80px; height: 80px;">
                                <i class="bi bi-person-circle fs-1"></i>
                            </div>
                            <h2 class="fw-bold" style="color: var(--text-main);">ยินดีต้อนรับ</h2>
                            <p class="text-muted small">เข้าสู่ระบบเพื่อเริ่มการเรียนรู้</p>
                        </div>

                        <form id="login-form" onsubmit="handleLogin(event)">
                            <div id="login-error" class="alert alert-danger border-0 rounded-4 d-none mb-4 text-center"></div>
                            
                            <div class="mb-3">
                                <label for="login-email" class="form-label ms-2 small fw-bold text-muted">อีเมล</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-envelope text-muted"></i>
                                    </span>
                                    <input type="email" class="form-control border-0 shadow-none" id="login-email" required placeholder="name@example.com">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="login-password" class="form-label ms-2 small fw-bold text-muted">รหัสผ่าน</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-key text-muted"></i>
                                    </span>
                                    <input type="password" class="form-control border-0 shadow-none" id="login-password" required placeholder="••••••••">
                                </div>
                            </div>

                            <div class="text-end mb-4">
                                <a href="#" class="text-decoration-none small text-muted" onclick="event.preventDefault(); showView('forgot-password-view')">
                                    ลืมรหัสผ่าน?
                                </a>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-btn">
                                เข้าสู่ระบบ
                            </button>
                        </form>

                        <div class="text-center mt-4">
                            <p class="text-muted small">ยังไม่มีบัญชีใช่ไหม? 
                                <a href="#" class="text-primary fw-bold text-decoration-none" onclick="event.preventDefault(); showView('register-view')">ลงทะเบียนที่นี่</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="forgot-password-view" class="view bg-body">
            <div class="container d-flex flex-column justify-content-center align-items-center" style="min-height: 85vh;">
                
                <div class="card border-0 shadow-card p-4" style="max-width: 450px; width: 100%; border-radius: 24px;">
                    <div class="card-body text-center">
                        
                        <div class="mb-4">
                            <div class="d-inline-flex align-items-center justify-content-center bg-warning bg-opacity-10 text-warning rounded-circle" 
                                style="width: 70px; height: 70px;">
                                <i class="bi bi-shield-lock-fill fs-2"></i>
                            </div>
                        </div>

                        <h3 class="fw-bold mb-2" style="color: var(--text-main);">ลืมรหัสผ่าน?</h3>
                        <p class="text-muted small mb-4 px-3">
                            ไม่ต้องกังวล กรุณากรอกอีเมลที่ลงทะเบียนไว้<br>ระบบจะส่งรหัสผ่านใหม่ไปให้คุณทางอีเมล
                        </p>
                        
                        <form onsubmit="handleForgotPassword(event)">
                            <div class="mb-4 text-start">
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-envelope-at text-muted"></i>
                                    </span>
                                    <input type="email" class="form-control border-0 shadow-none" id="forgot-email" required placeholder="ระบุอีเมลของคุณ">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-warning w-100 rounded-pill py-2 fw-bold shadow-btn mb-3 text-dark">
                                ส่งรหัสผ่านใหม่
                            </button>
                            
                            <button type="button" class="btn btn-light w-100 rounded-pill py-2 text-muted fw-bold" onclick="showView('login-view')">
                                <i class="bi bi-arrow-left me-2"></i>กลับไปหน้าเข้าสู่ระบบ
                            </button>
                        </form>

                    </div>
                </div>
            </div>
        </div>

        <div id="register-view" class="view bg-body">
            <div class="container py-5">
                <div class="row justify-content-center">
                    <div class="col-md-10 col-lg-7">
                        
                        <div class="text-center mb-4">
                            <h2 class="fw-bold" style="color: var(--text-main);">สร้างบัญชีผู้ใช้ใหม่</h2>
                            <p class="text-muted">กรอกข้อมูลเพื่อลงทะเบียนเข้าใช้งานระบบ</p>
                        </div>

                        <div class="card border-0 shadow-card p-3 p-md-4" style="border-radius: 24px;">
                            <div class="card-body">
                                <form id="register-form" onsubmit="handleRegister(event)">
                                    <div id="register-error" class="alert alert-danger border-0 rounded-4 d-none mb-4 text-center"></div>

                                    <h6 class="text-uppercase text-muted fw-bold small mb-3 ls-1">
                                        <i class="bi bi-person-vcard me-2"></i>ข้อมูลส่วนตัว
                                    </h6>
                                    
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-4">
                                            <label for="reg-prefix" class="form-label ms-2 small fw-bold text-muted">คำนำหน้า</label>
                                            <select id="reg-prefix" class="form-select rounded-pill shadow-none border" style="background-color: #fff;" required>
                                                <option value="นาย">นาย</option>
                                                <option value="นาง">นาง</option>
                                                <option value="นางสาว">นางสาว</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="reg-firstName" class="form-label ms-2 small fw-bold text-muted">ชื่อ</label>
                                            <input type="text" id="reg-firstName" class="form-control rounded-pill shadow-none" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="reg-lastName" class="form-label ms-2 small fw-bold text-muted">นามสกุล</label>
                                            <input type="text" id="reg-lastName" class="form-control rounded-pill shadow-none" required>
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label for="reg-studentId" class="form-label ms-2 small fw-bold text-muted">รหัสนักศึกษา</label>
                                            <input type="text" id="reg-studentId" class="form-control rounded-pill shadow-none" required placeholder="เช่น 6xxxxxxxx">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="reg-classYear" class="form-label ms-2 small fw-bold text-muted">ชั้นปี</label>
                                            <input type="number" id="reg-classYear" class="form-control rounded-pill shadow-none" min="1" max="8" required>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <label for="reg-phone" class="form-label ms-2 small fw-bold text-muted">เบอร์โทรศัพท์</label>
                                        <input type="tel" id="reg-phone" class="form-control rounded-pill shadow-none" required>
                                    </div>
                                    
                                    <hr class="my-4 opacity-10">
                                    
                                    <h6 class="text-uppercase text-primary fw-bold small mb-3 ls-1">
                                        <i class="bi bi-shield-lock me-2"></i>ข้อมูลเข้าสู่ระบบ
                                    </h6>

                                    <div class="mb-3">
                                        <label for="reg-email" class="form-label ms-2 small fw-bold text-muted">อีเมล</label>
                                        <div class="input-group rounded-pill border bg-white overflow-hidden p-1">
                                            <input type="email" id="reg-email" class="form-control border-0 shadow-none ps-3" placeholder="email@example.com" required>
                                            <button class="btn btn-primary rounded-pill px-4 fw-bold" type="button" onclick="requestRegistrationOTP(event)">
                                                ส่ง OTP
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="reg-otp-reference-container" class="alert alert-light border d-none mb-3 py-2 px-3 rounded-4">
                                        <small class="text-muted">รหัสอ้างอิง: <strong id="reg-otp-reference-code" class="text-primary"></strong> (กรุณาตรวจสอบอีเมล)</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="reg-otp" class="form-label ms-2 small fw-bold text-muted">รหัส OTP</label>
                                        <input type="text" id="reg-otp" class="form-control rounded-pill shadow-none text-center letter-spacing-2" placeholder="XXXXXX" maxlength="6" required>
                                    </div>

                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <label for="reg-password" class="form-label ms-2 small fw-bold text-muted">รหัสผ่าน</label>
                                            <input type="password" id="reg-password" class="form-control rounded-pill shadow-none" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="reg-confirm-password" class="form-label ms-2 small fw-bold text-muted">ยืนยันรหัสผ่าน</label>
                                            <input type="password" id="reg-confirm-password" class="form-control rounded-pill shadow-none" required>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-btn fs-5">
                                        ลงทะเบียน
                                    </button>
                                </form>

                                <div class="text-center mt-4">
                                    <p class="text-muted">มีบัญชีอยู่แล้ว? 
                                        <a href="#" class="text-primary fw-bold text-decoration-none" onclick="event.preventDefault(); showView('login-view')">เข้าสู่ระบบ</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="all-courses-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="d-flex align-items-center mb-4">
                    <div class="rounded-pill me-3" style="width: 5px; height: 35px; background-color: var(--color-primary);"></div>
                    <div>
                        <h2 class="fw-bold m-0" style="color: var(--text-main);">คอร์สเรียนทั้งหมด</h2>
                        <p class="text-muted small mb-0">ค้นหาและลงทะเบียนคอร์สเรียนที่คุณสนใจ</p>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-5 overflow-hidden">
                    <div class="card-body p-4">
                        <div class="row g-3 align-items-end">
                            
                            <div class="col-lg-4 col-md-6">
                                <label for="all-course-search" class="form-label ms-2 small fw-bold text-muted">ค้นหาคอร์สเรียน</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 shadow-none bg-transparent" id="all-course-search" 
                                          placeholder="ชื่อคอร์ส, รหัสวิชา..." oninput="fetchAllCourses(1)">
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <label for="all-course-category-filter" class="form-label ms-2 small fw-bold text-muted">หมวดหมู่</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-tags text-muted"></i>
                                    </span>
                                    <select id="all-course-category-filter" class="form-select border-0 shadow-none bg-transparent" 
                                            style="cursor: pointer;" onchange="fetchAllCourses(1)">
                                        <option value="all">ทุกหมวดหมู่</option>
                                        </select>
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <label for="all-course-status-filter" class="form-label ms-2 small fw-bold text-muted">สถานะ</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-toggle-on text-muted"></i>
                                    </span>
                                    <select id="all-course-status-filter" class="form-select border-0 shadow-none bg-transparent" 
                                            style="cursor: pointer;" onchange="fetchAllCourses(1)">
                                        <option value="all">ทั้งหมด</option>
                                        <option value="open">เปิดลงทะเบียน</option>
                                        <option value="closed">ปิดลงทะเบียน</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-lg-2 col-md-6">
                                <label for="all-course-limit" class="form-label ms-2 small fw-bold text-muted">แสดงผล</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-list-ul text-muted"></i>
                                    </span>
                                    <select id="all-course-limit" class="form-select border-0 shadow-none bg-transparent" 
                                            style="cursor: pointer;" onchange="fetchAllCourses(1)">
                                        <option value="9">9 รายการ</option>
                                        <option value="12" selected>12 รายการ</option>
                                        <option value="24">24 รายการ</option>
                                        <option value="36">36 รายการ</option>
                                    </select>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div id="all-courses-list" class="row g-4">
                    </div>

                <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top" id="all-courses-pagination-container">
                    <span class="text-muted small" id="all-courses-pagination-info"></span>
                    <nav>
                        <ul class="pagination pagination-sm mb-0 gap-1" id="all-courses-pagination-controls"></ul>
                    </nav>
                </div>

            </div>
        </div>
        
        <div id="my-courses-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="d-flex align-items-center mb-4">
                    <div class="rounded-pill me-3" style="width: 5px; height: 35px; background-color: var(--color-primary);"></div>
                    <div>
                        <h2 class="fw-bold m-0" style="color: var(--text-main);">คอร์สเรียนของฉัน</h2>
                        <p class="text-muted small mb-0">ติดตามความคืบหน้าและเข้าเรียนในคอร์สที่คุณลงทะเบียนไว้</p>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-5 overflow-hidden">
                    <div class="card-body p-4">
                        <div class="row g-3 align-items-end">
                            
                            <div class="col-lg-5">
                                <label for="my-course-search" class="form-label ms-2 small fw-bold text-muted">ค้นหาคอร์ส</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 shadow-none bg-transparent" id="my-course-search" 
                                          placeholder="ชื่อคอร์ส..." oninput="fetchMyCourses(1)">
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <label for="my-course-status-filter" class="form-label ms-2 small fw-bold text-muted">สถานะการเรียน</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-mortarboard text-muted"></i>
                                    </span>
                                    <select id="my-course-status-filter" class="form-select border-0 shadow-none bg-transparent" 
                                            style="cursor: pointer;" onchange="fetchMyCourses(1)">
                                        <option value="all">ทั้งหมด</option>
                                        <option value="in-progress">กำลังเรียน</option>
                                        <option value="completed">เรียนจบแล้ว</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-lg-3">
                                <label for="my-course-limit" class="form-label ms-2 small fw-bold text-muted">แสดงผล</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-list-ul text-muted"></i>
                                    </span>
                                    <select id="my-course-limit" class="form-select border-0 shadow-none bg-transparent" 
                                            style="cursor: pointer;" onchange="fetchMyCourses(1)">
                                        <option value="9">9 รายการ</option>
                                        <option value="12" selected>12 รายการ</option>
                                        <option value="24">24 รายการ</option>
                                    </select>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div id="my-courses-list" class="row g-4">
                    </div>

                <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top" id="my-courses-pagination-container">
                    <span class="text-muted small" id="my-courses-pagination-info"></span>
                    <nav>
                        <ul class="pagination pagination-sm mb-0 gap-1" id="my-courses-pagination-controls"></ul>
                    </nav>
                </div>

            </div>
        </div>

        <div id="lesson-list-view" class="view">
            <div class="container-fluid px-0">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <div>
                        <h6 class="text-muted text-uppercase small ls-2 mb-1">Course Content</h6>
                        <h2 id="lesson-list-title" class="fw-bold display-6" style="color: var(--text-main);"></h2>
                    </div>
                    <button class="btn btn-outline-secondary rounded-pill px-4" onclick="fetchMyCourses()">
                        <i class="bi bi-arrow-left me-2"></i>กลับหน้าหลัก
                    </button>
                </div>
                
                <div id="lessons-container" class="d-flex flex-column gap-3">
                    </div>

                <div id="course-completion-container" class="mt-5 text-center">
                    </div>
            </div>
        </div>

        <div id="test-view" class="view">
            <div class="container-fluid px-0" style="max-width: 900px; margin: 0 auto;">
                
                <h3 id="test-title" class="mb-4 fw-bold"></h3>
                
                <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white">
                    <div class="card-body p-4">
                        <p class="text-muted small fw-bold text-uppercase mb-3">Question Navigator</p>
                        <div id="test-question-nav" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div id="test-current-question-display" class="card border-0 shadow-card rounded-4 mb-4">
                    <div class="card-body p-4 p-md-5">
                        </div>
                </div>

                <div id="test-navigation-btns" class="d-flex justify-content-between align-items-center mt-4 pb-5">
                    </div>
                
                <div id="test-alert-incomplete" class="alert alert-danger border-0 rounded-3 shadow-sm mt-3 d-none d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>กรุณาตอบคำถามให้ครบทุกข้อก่อนส่ง</div>
                </div>
            </div>
        </div>

        <div id="admin-exam-subject-management-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                    <div>
                        <h2 class="fw-bold mb-1" style="color: var(--text-main);">จัดการรายวิชาสอบ</h2>
                        <p class="text-muted mb-0 small">กำหนดรายวิชาที่เปิดสอบและตั้งค่าพื้นฐาน</p>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3B86qQZRHSuQ9sM11FVLpvc7l3f1rnImEByvvJZ6aToyTOlfO-AM6FNnjCxavCPtz8KLnLOXpQh76/pub?gid=1858255512&single=true&output=csv" 
                          target="_blank" class="btn btn-outline-secondary rounded-pill btn-sm px-3">
                            <i class="bi bi-download me-1"></i> Template
                        </a>
                        <button class="btn btn-success rounded-pill btn-sm px-3 shadow-sm" onclick="openImportModal('ExamSubjects')">
                            <i class="fa-solid fa-file-import me-1"></i> Import CSV
                        </button>
                        <button class="btn btn-primary rounded-pill btn-sm px-3 shadow-btn fw-bold" onclick="openAddExamSubjectModal()">
                            <i class="bi bi-plus-lg me-1"></i> เพิ่มรายวิชา
                        </button>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-5 col-lg-4">
                        <div class="input-group rounded-pill border bg-white shadow-sm" style="overflow: hidden; border-color: var(--border-color) !important;">
                            <span class="input-group-text bg-transparent border-0 ps-3">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 shadow-none bg-transparent" id="exam-subject-search-input"
                                  placeholder="ค้นหา (ID, รหัสวิชา, ชื่อวิชา)..." oninput="fetchExamSubjectManagement(1)">
                        </div>
                    </div>
                    <div class="col-md-7 col-lg-8 d-flex justify-content-md-end align-items-center">
                        <div class="d-flex align-items-center bg-white px-3 py-1 rounded-pill border shadow-sm">
                            <label for="exam-subject-limit-select" class="form-label mb-0 me-2 small text-muted fw-bold">แสดง:</label>
                            <select id="exam-subject-limit-select" class="form-select form-select-sm border-0 bg-transparent shadow-none" 
                                    style="width: 70px; cursor: pointer;" onchange="fetchExamSubjectManagement(1)">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ID</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">รหัสวิชา</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ชื่อรายวิชา</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ชั้นปี</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">สถานะ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="exam-subject-table-body" class="bg-white"></tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-white border-top-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="exam-subject-pagination-info"></small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="exam-subject-pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-exam-topic-management-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="mb-4">
                    <button class="btn btn-link text-decoration-none text-muted p-0 mb-2 d-flex align-items-center" 
                            onclick="fetchExamSubjectManagement(1)">
                        <i class="bi bi-arrow-left me-1"></i> กลับไปหน้ารายวิชาสอบ
                    </button>
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
                        <div>
                            <h2 class="fw-bold mb-1" id="exam-topic-mg-title" style="color: var(--text-main);">จัดการหัวข้อสอบ</h2>
                            <p class="text-muted mb-0 small">กำหนดหัวข้อและสัดส่วนคะแนนในรายวิชา</p>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3B86qQZRHSuQ9sM11FVLpvc7l3f1rnImEByvvJZ6aToyTOlfO-AM6FNnjCxavCPtz8KLnLOXpQh76/pub?gid=1972190133&single=true&output=csv" 
                              target="_blank" class="btn btn-outline-secondary rounded-pill btn-sm px-3">
                                <i class="bi bi-download me-1"></i> Template
                            </a>
                            <button class="btn btn-success rounded-pill btn-sm px-3 shadow-sm" onclick="openImportModal('ExamTopics')">
                                <i class="fa-solid fa-file-import me-1"></i> Import CSV
                            </button>
                            <button class="btn btn-primary rounded-pill btn-sm px-3 shadow-btn fw-bold" onclick="openAddExamTopicModal()">
                                <i class="bi bi-plus-lg me-1"></i> เพิ่มหัวข้อ
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-5 col-lg-4">
                        <div class="input-group rounded-pill border bg-white shadow-sm" style="overflow: hidden; border-color: var(--border-color) !important;">
                            <span class="input-group-text bg-transparent border-0 ps-3">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 shadow-none bg-transparent" id="exam-topic-search-input" 
                                  placeholder="ค้นหา (ID, ชื่อหัวข้อ)..." oninput="fetchExamTopicManagement(null, null, 1)">
                        </div>
                    </div>
                    <div class="col-md-7 col-lg-8 d-flex justify-content-md-end align-items-center">
                        <div class="d-flex align-items-center bg-white px-3 py-1 rounded-pill border shadow-sm">
                            <label for="exam-topic-limit-select" class="form-label mb-0 me-2 small text-muted fw-bold">แสดง:</label>
                            <select id="exam-topic-limit-select" class="form-select form-select-sm border-0 bg-transparent shadow-none" 
                                    style="width: 70px; cursor: pointer;" onchange="fetchExamTopicManagement(null, null, 1)">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ID</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ชื่อหัวข้อ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="exam-topic-table-body" class="bg-white"></tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-white border-top-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="exam-topic-pagination-info"></small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="exam-topic-pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="admin-exam-question-management-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="mb-4">
                    <button class="btn btn-link text-decoration-none text-muted p-0 mb-2 d-flex align-items-center" 
                            onclick="fetchExamTopicManagement(currentManagingSubject.id, currentManagingSubject.name, 1)">
                        <i class="bi bi-arrow-left me-1"></i> กลับไปหน้าหัวข้อ
                    </button>
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
                        <div>
                            <h2 class="fw-bold mb-1" id="exam-question-mg-title" style="color: var(--text-main);">จัดการข้อสอบ</h2>
                            <p class="text-muted mb-0 small">สร้างและแก้ไขคำถามสำหรับหัวข้อนี้</p>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3B86qQZRHSuQ9sM11FVLpvc7l3f1rnImEByvvJZ6aToyTOlfO-AM6FNnjCxavCPtz8KLnLOXpQh76/pub?gid=1745726829&single=true&output=csv" 
                              target="_blank" class="btn btn-outline-secondary rounded-pill btn-sm px-3">
                                <i class="bi bi-download me-1"></i> Template
                            </a>
                            <button class="btn btn-success rounded-pill btn-sm px-3 shadow-sm" onclick="openImportModal('ExamQuestions')">
                                <i class="fa-solid fa-file-import me-1"></i> Import CSV
                            </button>
                            <button class="btn btn-primary rounded-pill btn-sm px-3 shadow-btn fw-bold" onclick="openAddExamQuestionModal()">
                                <i class="bi bi-plus-lg me-1"></i> เพิ่มคำถาม
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-5 col-lg-4">
                        <div class="input-group rounded-pill border bg-white shadow-sm" style="overflow: hidden; border-color: var(--border-color) !important;">
                            <span class="input-group-text bg-transparent border-0 ps-3">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 shadow-none bg-transparent" id="exam-question-search-input" 
                                  placeholder="ค้นหา (ID, คำถาม)..." oninput="fetchExamQuestionManagement(null, null, 1)">
                        </div>
                    </div>
                    <div class="col-md-7 col-lg-8 d-flex justify-content-md-end align-items-center">
                        <div class="d-flex align-items-center bg-white px-3 py-1 rounded-pill border shadow-sm">
                            <label for="exam-question-limit-select" class="form-label mb-0 me-2 small text-muted fw-bold">แสดง:</label>
                            <select id="exam-question-limit-select" class="form-select form-select-sm border-0 bg-transparent shadow-none" 
                                    style="width: 70px; cursor: pointer;" onchange="fetchExamQuestionManagement(null, null, 1)">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ID</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom" style="min-width: 250px;">คำถาม</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">คำตอบถูก</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="exam-question-table-body" class="bg-white"></tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-white border-top-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="exam-question-pagination-info"></small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="exam-question-pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-exam-score-report-view" class="view">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <button class="btn btn-outline-secondary mb-2" onclick="fetchExamSubjectManagement(1)">
                        &laquo; กลับไปหน้ารายวิชาสอบ
                    </button>
                    <h2 id="score-report-title">รายงานคะแนน</h2>
                </div>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-success" onclick="exportReportToCSV()">
                        <i class="bi bi-file-earmark-arrow-down-fill"></i> ดาวน์โหลด CSV
                    </button>
                    <button id="export-to-sheet-btn" class="btn btn-success" onclick="exportScoreReportToSheet()">
                        <i class="bi bi-file-earmark-spreadsheet-fill"></i> Export to Sheet
                    </button>
                </div>
            </div>
            
            <div class="alert alert-info" role="alert">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="alert-heading mb-0">คะแนนเต็ม: <span id="score-report-max-score">N/A</span> คะแนน</h4>
                    <span class="text-muted">จำนวนผู้ทำข้อสอบ: <span id="stat-count">0</span> คน</span>
                </div>
                <hr>
                <h5 class="mb-3">สรุปค่าสถิติ (จากผู้ที่ทำข้อสอบ)</h5>
                <div class="row text-center">
                    <div class="col-6 col-md-3">
                        <div class="stat-box p-2 border rounded">
                            <span class="text-muted d-block small">คะแนนสูงสุด (Max)</span>
                            <strong class="fs-4" id="stat-max">0.00</strong>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                         <div class="stat-box p-2 border rounded">
                            <span class="text-muted d-block small">คะแนนต่ำสุด (Min)</span>
                            <strong class="fs-4" id="stat-min">0.00</strong>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mt-2 mt-md-0">
                         <div class="stat-box p-2 border rounded">
                            <span class="text-muted d-block small">ค่าเฉลี่ย (Mean)</span>
                            <strong class="fs-4" id="stat-mean">0.00</strong>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mt-2 mt-md-0">
                         <div class="stat-box p-2 border rounded">
                            <span class="text-muted d-block small">ส่วนเบี่ยงเบน (SD)</span>
                            <strong class="fs-4" id="stat-sd">0.00</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>อันดับ</th>
                            <th>รหัสนักศึกษา</th>
                            <th>ชื่อ - นามสกุล</th>
                            <th>อีเมล</th>
                            <th>คะแนนที่ได้</th>
                            <th>สถานะการส่ง</th>
                        </tr>
                    </thead>
                    <tbody id="score-report-table-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="video-view" class="view">
            <h2 id="video-lesson-title"></h2>
            <p>กรุณาดูวิดีโอให้จบ เพื่อทำแบบทดสอบหลังเรียน</p>
            
            <div id="player-container" class="shadow">
                <div id="player-overlay"></div>
                <div id="youtube-player"></div>
                <div class="custom-controls">
                    <button id="play-pause-btn" onclick="togglePlayPause()"><i class="bi bi-play-fill"></i></button>
                    <i class="bi bi-volume-down-fill"></i>
                    <input type="range" class="form-range volume-slider" id="volume-control" min="0" max="100" value="100" oninput="setVolume(this.value)">
                    <i class="bi bi-volume-up-fill"></i>

                    <div class="btn-group ms-auto">
                        <button type="button" class="btn btn-outline-light btn-sm dropdown-toggle" id="speed-btn" data-bs-toggle="dropdown" aria-expanded="false" style="min-width: 60px;">
                            1x
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" id="speed-options">
                            </ul>
                    </div>
                </div>
            </div>

            <div id="doc-links-container" class="mt-3"></div>
            
            <button id="post-test-btn" class="btn btn-primary mt-3 w-100" onclick="startTest('post')" disabled>
                เริ่มทำแบบทดสอบหลังเรียน &raquo;
            </button>
        </div>

        <div id="results-view" class="view">
            <h2>สรุปผลการเรียน</h2>
            <div id="score-display" class="alert alert-info"></div>
            <div id="results-details"></div>
            <hr>
            <button class="btn btn-secondary" onclick="fetchLessonsForCourse(currentCourse.CourseID, currentCourse.CourseName)">กลับไปหน้าเลือกบทเรียน</button>
        </div>

        <div id="history-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="d-flex align-items-center mb-4">
                    <div class="rounded-pill me-3" style="width: 5px; height: 35px; background-color: var(--color-success);"></div>
                    <div>
                        <h2 class="fw-bold m-0" style="color: var(--text-main);">ประวัติการเรียน</h2>
                        <p class="text-muted small mb-0">รายการคอร์สเรียนที่คุณเรียนจบและผ่านการทดสอบแล้ว</p>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-5 overflow-hidden">
                    <div class="card-body p-4">
                        <div class="row g-3 align-items-end">
                            
                            <div class="col-lg-8">
                                <label for="history-search" class="form-label ms-2 small fw-bold text-muted">ค้นหาประวัติ</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 shadow-none bg-transparent" id="history-search" 
                                          placeholder="ชื่อคอร์สเรียน..." oninput="fetchHistory(1)">
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <label for="history-limit" class="form-label ms-2 small fw-bold text-muted">แสดงผล</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-list-ol text-muted"></i>
                                    </span>
                                    <select id="history-limit" class="form-select border-0 shadow-none bg-transparent" 
                                            style="cursor: pointer;" onchange="fetchHistory(1)">
                                        <option value="10" selected>10 รายการ</option>
                                        <option value="25">25 รายการ</option>
                                        <option value="50">50 รายการ</option>
                                    </select>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-center" style="width: 50px;">#</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom" style="min-width: 250px;">ชื่อคอร์สเรียน</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ลงทะเบียนเมื่อ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">เรียนจบเมื่อ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-center">ระยะเวลา</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="bg-white">
                                </tbody>
                        </table>
                    </div>

                    <div class="card-footer bg-white border-top-0 py-3" id="history-pagination-container">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small" id="history-pagination-info"></span>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="history-pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="answer-review-view" class="view">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-5">
                <div>
                    <h2 id="answer-review-title" class="fw-bold mb-1" style="color: var(--text-main);"></h2>
                    <p class="text-muted mb-0">ตรวจสอบประวัติการตอบคำถามย้อนหลัง</p>
                </div>
                <button class="btn btn-outline-secondary rounded-pill px-4 mt-3 mt-md-0" onclick="fetchHistory()">
                    <i class="bi bi-arrow-left me-2"></i> กลับไปหน้าประวัติ
                </button>
            </div>

            <div id="answer-review-container" class="pb-5">
                </div>
        </div>

        <div id="exam-history-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="d-flex align-items-center mb-4">
                    <div class="rounded-pill me-3" style="width: 5px; height: 35px; background-color: var(--color-warning);"></div>
                    <div>
                        <h2 class="fw-bold m-0" style="color: var(--text-main);">ประวัติการสอบ</h2>
                        <p class="text-muted small mb-0">ตรวจสอบผลคะแนนและรายละเอียดการสอบย้อนหลัง</p>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-5 overflow-hidden">
                    <div class="card-body p-4">
                        <div class="row g-3 align-items-end">
                            
                            <div class="col-lg-8">
                                <label for="exam-history-search" class="form-label ms-2 small fw-bold text-muted">ค้นหาประวัติสอบ</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 shadow-none bg-transparent" id="exam-history-search" 
                                          placeholder="ชื่อรายวิชาสอบ..." oninput="fetchExamHistory(1)">
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <label for="exam-history-limit" class="form-label ms-2 small fw-bold text-muted">แสดงผล</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-list-ol text-muted"></i>
                                    </span>
                                    <select id="exam-history-limit" class="form-select border-0 shadow-none bg-transparent" 
                                            style="cursor: pointer;" onchange="fetchExamHistory(1)">
                                        <option value="10" selected>10 รายการ</option>
                                        <option value="25">25 รายการ</option>
                                        <option value="50">50 รายการ</option>
                                    </select>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-center" style="width: 50px;">#</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom" style="min-width: 250px;">ชื่อรายวิชาสอบ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">เวลาที่เข้าสอบ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">เวลาที่ส่งข้อสอบ</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-center">ระยะเวลา</th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="exam-history-table-body" class="bg-white">
                                </tbody>
                        </table>
                    </div>

                    <div class="card-footer bg-white border-top-0 py-3" id="exam-history-pagination-container">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small" id="exam-history-pagination-info"></span>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="exam-history-pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="exam-score-announcement-view" class="view">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 pt-3">
                <div>
                    <h2 id="score-announcement-header" class="fw-bold mb-1" style="color: var(--text-main);">ผลการสอบ</h2>
                    <p class="text-muted mb-0">รายละเอียดคะแนนและสถิติการสอบของคุณ</p>
                </div>
                <button class="btn btn-outline-secondary rounded-pill px-4 mt-3 mt-md-0" onclick="fetchExamHistory()">
                    <i class="bi bi-arrow-left me-2"></i> กลับไปหน้าประวัติ
                </button>
            </div>

            <div id="score-announcement-container" class="pb-5"></div>
        </div>

        <div id="exam-subject-list-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="d-flex align-items-center mb-4">
                    <div class="rounded-pill me-3" style="width: 5px; height: 35px; background-color: var(--color-danger);"></div>
                    <div>
                        <h2 class="fw-bold m-0" style="color: var(--text-main);">รายวิชาที่เปิดสอบ</h2>
                        <p class="text-muted small mb-0">เลือกรายวิชาเพื่อเข้าทำแบบทดสอบตามกำหนดการ</p>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-5 overflow-hidden">
                    <div class="card-body p-4">
                        <div class="row g-3 align-items-end">
                            
                            <div class="col-lg-5">
                                <label for="exam-subject-search" class="form-label ms-2 small fw-bold text-muted">ค้นหารายวิชา</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 shadow-none bg-transparent" id="exam-subject-search" 
                                          placeholder="ชื่อวิชา, รหัสวิชา..." oninput="fetchExamSubjects(1)">
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <label for="exam-subject-status-filter" class="form-label ms-2 small fw-bold text-muted">สถานะ</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-filter-circle text-muted"></i>
                                    </span>
                                    <select id="exam-subject-status-filter" class="form-select border-0 shadow-none bg-transparent" 
                                            style="cursor: pointer;" onchange="fetchExamSubjects(1)">
                                        <option value="all">ทั้งหมด</option>
                                        <option value="available">พร้อมสอบ</option>
                                        <option value="submitted">สอบเสร็จแล้ว</option>
                                        <option value="unavailable">ยังไม่เปิด/หมดเวลา</option>
                                        <option value="not_allowed">ไม่มีสิทธิ์สอบ</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-lg-3">
                                <label for="exam-subject-limit" class="form-label ms-2 small fw-bold text-muted">แสดงผล</label>
                                <div class="input-group rounded-pill border bg-white overflow-hidden">
                                    <span class="input-group-text bg-transparent border-0 ps-3">
                                        <i class="bi bi-list-ul text-muted"></i>
                                    </span>
                                    <select id="exam-subject-limit" class="form-select border-0 shadow-none bg-transparent" 
                                            style="cursor: pointer;" onchange="fetchExamSubjects(1)">
                                        <option value="9">9 รายการ</option>
                                        <option value="12" selected>12 รายการ</option>
                                        <option value="24">24 รายการ</option>
                                    </select>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div id="exam-subject-list" class="row g-4">
                    </div>

                <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top" id="exam-subject-pagination-container">
                    <span class="text-muted small" id="exam-subject-pagination-info"></span>
                    <nav>
                        <ul class="pagination pagination-sm mb-0 gap-1" id="exam-subject-pagination-controls"></ul>
                    </nav>
                </div>

            </div>
        </div>

        <div id="exam-instructions-view" class="view bg-body">
            <div class="container py-5 d-flex flex-column align-items-center justify-content-center" style="min-height: 80vh;">
                
                <div class="card border-0 shadow-card p-4 p-md-5 rounded-4 w-100" style="max-width: 800px;">
                    
                    <div class="text-center mb-4">
                        <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 text-primary rounded-circle mb-3" 
                            style="width: 70px; height: 70px;">
                            <i class="bi bi-file-text-fill fs-2"></i>
                        </div>
                        <h3 id="exam-title" class="fw-bold" style="color: var(--text-main);"></h3>
                        <p class="text-muted">กรุณาอ่านคำชี้แจงให้ครบถ้วนก่อนเริ่มทำแบบทดสอบ</p>
                    </div>

                    <div class="bg-light rounded-4 p-4 mb-4 border border-light-subtle">
                        <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-info-circle me-2"></i>ข้อตกลงในการสอบ</h6>
                        <div id="exam-description" class="text-muted small" style="line-height: 1.8;"></div>
                    </div>

                    <div class="form-check d-flex align-items-center justify-content-center p-3 rounded-3 border mb-4 cursor-pointer hover-bg-light">
                        <input class="form-check-input me-3" type="checkbox" value="" id="exam-agree-checkbox" 
                              onchange="toggleExamStartButton()" style="width: 1.3em; height: 1.3em; cursor: pointer;">
                        <label class="form-check-label fw-medium cursor-pointer" for="exam-agree-checkbox" style="color: var(--text-main);">
                            ข้าพเจ้ารับทราบและยอมรับข้อตกลงในการสอบทุกประการ
                        </label>
                    </div>

                    <div class="d-flex gap-3 justify-content-center">
                        <button class="btn btn-light rounded-pill px-4 fw-bold text-muted" onclick="showView('exam-subject-list-view')">
                            <i class="bi bi-arrow-left me-2"></i>ย้อนกลับ
                        </button>
                        <button id="exam-start-btn" class="btn btn-primary rounded-pill px-5 fw-bold shadow-btn" onclick="fetchExamTopics()" disabled>
                            เข้าสู่ห้องสอบ <i class="bi bi-door-open-fill ms-2"></i>
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <div id="exam-topic-list-view" class="view bg-body">
            <div class="container py-4" style="max-width: 900px;">
                
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                    <div>
                        <h6 class="text-uppercase text-muted fw-bold small ls-1 mb-1">รายวิชาสอบ</h6>
                        <h2 id="exam-topic-title" class="fw-bold mb-0" style="color: var(--text-main);"></h2>
                    </div>
                    
                    <div class="d-flex align-items-center bg-danger bg-opacity-10 text-danger px-4 py-2 rounded-pill border border-danger-subtle">
                        <i class="bi bi-stopwatch-fill fs-4 me-2"></i>
                        <div>
                            <small class="d-block text-uppercase fw-bold" style="font-size: 0.65rem; line-height: 1;">Time Remaining</small>
                            <span id="topic-list-timer" class="fs-5 fw-bold font-monospace">00:00:00</span>
                        </div>
                    </div>
                </div>

                <div id="exam-total-score-summary" class="d-none mb-4"></div>

                <div class="mb-3">
                    <p class="text-muted small mb-3"><i class="bi bi-list-task me-2"></i>เลือกหัวข้อเพื่อเริ่มทำข้อสอบ (สามารถทำหัวข้อใดก่อนก็ได้)</p>
                    <div id="exam-topic-list" class="d-flex flex-column gap-3">
                        </div>
                </div>

                <div id="exam-final-submission-container" class="mt-5 pt-3 border-top text-center">
                    </div>
            </div>
        </div>

        <div id="exam-taking-view" class="view bg-body">
            <div class="container py-4" style="max-width: 1000px;">
                
                <div class="card border-0 shadow-sm rounded-pill mb-4 px-4 py-2 bg-white d-none d-md-flex"> <div class="d-flex justify-content-between align-items-center">
                        <div id="exam-title-container" class="d-flex align-items-center text-truncate">
                            <div class="badge bg-primary rounded-pill me-2">Q</div>
                            <span class="fw-bold text-truncate" style="color: var(--text-main);">กำลังทำข้อสอบ...</span>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="vr"></div>
                            <div class="d-flex align-items-center text-danger">
                                <i class="bi bi-alarm-fill me-2"></i>
                                <span id="exam-timer" class="fw-bold font-monospace fs-5">00:00</span>
                            </div>
                            <button id="exam-info-btn" class="btn btn-sm btn-light rounded-circle d-none" onclick="showExamInfoModal()" title="คำชี้แจง">
                                <i class="bi bi-info-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="d-md-none d-flex justify-content-between align-items-center mb-3 px-2">
                    <span class="badge bg-light text-dark border">Question Mode</span>
                    <div class="text-danger fw-bold font-monospace"><i class="bi bi-alarm me-1"></i><span id="exam-timer-mobile"></span></div> </div>

                <div class="row g-4">
                    <div class="col-lg-3 order-lg-2">
                        <div class="card border-0 shadow-sm rounded-4 h-100 bg-white">
                            <div class="card-header bg-white border-0 pt-3 pb-0">
                                <h6 class="fw-bold m-0 text-secondary"><i class="bi bi-grid-3x3-gap-fill me-2"></i>ข้อสอบทั้งหมด</h6>
                            </div>
                            <div class="card-body">
                                <div id="exam-question-nav" class="d-flex flex-wrap justify-content-center gap-1">
                                    </div>
                                
                                <div class="mt-4 pt-3 border-top">
                                    <div class="d-flex align-items-center justify-content-center gap-3 small text-muted">
                                        <div class="d-flex align-items-center"><span class="d-inline-block rounded-circle bg-success me-1" style="width: 10px; height: 10px;"></span>ทำแล้ว</div>
                                        <div class="d-flex align-items-center"><span class="d-inline-block rounded-circle border me-1" style="width: 10px; height: 10px; background: var(--bg-light);"></span>ยังไม่ทำ</div>
                                        <div class="d-flex align-items-center"><span class="d-inline-block rounded-circle border border-primary me-1" style="width: 10px; height: 10px;"></span>ปัจจุบัน</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-9 order-lg-1">
                        <div class="card border-0 shadow-card rounded-4 overflow-hidden">
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="question-progress-bar"></div>
                            </div>
                            
                            <div class="card-body p-4 p-md-5">
                                <div id="exam-current-question-display">
                                    </div>
                            </div>
                            
                            <div class="card-footer bg-white border-top-0 p-4">
                                <div id="exam-navigation-btns" class="d-flex justify-content-between align-items-center">
                                    </div>
                            </div>
                        </div>

                        <div id="exam-alert-incomplete" class="alert alert-danger border-0 shadow-sm rounded-pill mt-3 d-none text-center" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>กรุณาตอบคำถามให้ครบทุกข้อก่อนส่ง
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="exam-submitted-view" class="view bg-body">
            <div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
                
                <div class="card border-0 shadow-card p-4 p-md-5 text-center" style="max-width: 500px; width: 100%; border-radius: 24px;">
                    
                    <div class="mb-4">
                        <div class="mb-3 d-inline-flex align-items-center justify-content-center rounded-circle bg-success bg-opacity-10" 
                            style="width: 120px; height: 120px;">
                            <i class="bi bi-check-lg" style="font-size: 5rem; color: var(--color-success);"></i>
                        </div>
                        <h2 class="fw-bold mb-1" style="color: var(--text-main);">ส่งข้อสอบเรียบร้อย!</h2>
                        <p class="text-muted small">ระบบได้บันทึกคำตอบของคุณแล้ว</p>
                    </div>

                    <div class="mb-5">
                        <div class="d-inline-flex align-items-center px-4 py-2 rounded-pill bg-light border">
                            <i class="bi bi-clock-history me-2 text-secondary"></i>
                            <span class="text-secondary fw-medium me-2 small">ยืนยันเวลา:</span>
                            <span id="submission-time" class="fw-bold text-primary small">
                                </span>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-btn" onclick="fetchExamTopics()">
                        <i class="bi bi-arrow-left me-2"></i>กลับไปหน้าหัวข้อการสอบ
                    </button>

                </div>
            </div>
        </div>

        <div id="admin-cheating-monitor-view" class="view" style="background-color: var(--bg-body);">
            <div class="container py-5">
                
                <div class="row mb-5">
                    <div class="col-md-12 text-center">
                        <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 text-primary rounded-circle mb-3" style="width: 60px; height: 60px;">
                            <i class="bi bi-shield-lock-fill fs-3"></i>
                        </div>
                        <h2 class="fw-bold mb-2" style="color: var(--text-main);">แดชบอร์ดตรวจสอบการทุจริต</h2>
                        <p class="text-muted">Monitor การเข้าสอบและเหตุการณ์ความปลอดภัยแบบ Real-time</p>
                    </div>
                </div>

                <div class="row justify-content-center mb-5">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm rounded-4 p-4 bg-white">
                            <label for="subject-monitor-select" class="form-label fw-bold text-muted small text-uppercase mb-2">
                                เลือกรายวิชาที่ต้องการตรวจสอบ
                            </label>
                            
                            <div id="monitor-loading-subjects" style="display: none;" class="text-center py-3">
                                <div class="spinner-border text-primary spinner-border-sm me-2" role="status"></div>
                                <span class="text-muted small">กำลังโหลดรายวิชา...</span>
                            </div>

                            <div class="input-group">
                                <span class="input-group-text bg-light border-0 rounded-start-pill ps-3">
                                    <i class="bi bi-journal-bookmark-fill text-muted"></i>
                                </span>
                                <select class="form-select form-select-lg border-0 bg-light rounded-end-pill shadow-none" 
                                        id="subject-monitor-select" disabled style="font-size: 1rem;">
                                    <option selected disabled value="">--- กรุณาเลือกรายวิชา ---</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dashboard-details-container" class="d-none">

                    <div class="card border-0 shadow-sm rounded-4 mb-5 overflow-hidden">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-md-6 border-end border-light">
                                    <small class="text-muted text-uppercase fw-bold">วิชาที่เลือก</small>
                                    <h4 class="fw-bold text-primary mb-0 mt-1 text-truncate" id="subject-name-display">...</h4>
                                </div>
                                <div class="col-md-3 text-center text-md-start mt-3 mt-md-0">
                                    <small class="text-muted d-block">เวลาเริ่มสอบ</small>
                                    <span id="subject-start-time-display" class="fw-bold text-success fs-5">...</span>
                                </div>
                                <div class="col-md-3 text-center text-md-start mt-3 mt-md-0">
                                    <small class="text-muted d-block">เวลาสิ้นสุด</small>
                                    <span id="subject-end-time-display" class="fw-bold text-danger fs-5">...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-pill me-2" style="width: 4px; height: 24px; background-color: var(--color-primary);"></div>
                        <h5 class="fw-bold m-0" style="color: var(--text-main);">สรุปเหตุการณ์สำคัญ</h5>
                    </div>

                    <div class="row g-3 mb-5">
                        <div class="col-md-3 col-sm-6">
                            <div class="card border-0 shadow-sm h-100 rounded-4" style="border-left: 5px solid var(--color-primary) !important;">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p class="text-muted small mb-1 text-uppercase fw-bold">ผู้เริ่มสอบ</p>
                                            <h2 class="fw-bold mb-0" id="kpi-total-starts" style="color: var(--color-primary);">0</h2>
                                        </div>
                                        <div class="bg-primary bg-opacity-10 p-2 rounded-3 text-primary">
                                            <i class="bi bi-play-circle-fill fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 col-sm-6">
                            <div class="card border-0 shadow-sm h-100 rounded-4" style="border-left: 5px solid var(--color-danger) !important;">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p class="text-muted small mb-1 text-uppercase fw-bold">แจ้งเตือนทุจริต</p>
                                            <h2 class="fw-bold mb-0" id="kpi-cheating-events" style="color: var(--color-danger);">0</h2>
                                        </div>
                                        <div class="bg-danger bg-opacity-10 p-2 rounded-3 text-danger">
                                            <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 col-sm-6">
                            <div class="card border-0 shadow-sm h-100 rounded-4" style="border-left: 5px solid var(--color-warning) !important;">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p class="text-muted small mb-1 text-uppercase fw-bold">ปลดล็อคพลาด</p>
                                            <h2 class="fw-bold mb-0" id="kpi-failed-unlocks" style="color: var(--color-warning);">0</h2>
                                        </div>
                                        <div class="bg-warning bg-opacity-10 p-2 rounded-3 text-warning">
                                            <i class="bi bi-key-fill fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 col-sm-6">
                            <div class="card border-0 shadow-sm h-100 rounded-4" style="border-left: 5px solid var(--color-success) !important;">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p class="text-muted small mb-1 text-uppercase fw-bold">ส่งแล้ว (รวม)</p>
                                            <h2 class="fw-bold mb-0" id="kpi-total-submissions" style="color: var(--color-success);">0</h2>
                                        </div>
                                        <div class="bg-success bg-opacity-10 p-2 rounded-3 text-success">
                                            <i class="bi bi-check-circle-fill fs-4"></i>
                                        </div>
                                    </div>
                                    <div class="mt-2 pt-2 border-top border-light" id="kpi-submissions-breakdown">
                                        <small class="text-muted d-flex justify-content-between" style="font-size: 0.75rem;">
                                            <span>ส่งเอง: 0</span>
                                            <span>ออโต้: 0</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4 mb-5">
                        <div class="col-md-6">
                            <div class="accordion" id="accordionCheating">
                                <div class="accordion-item border-0 shadow-sm rounded-4 overflow-hidden">
                                    <h2 class="accordion-header" id="headingCheatingUsers">
                                        <button class="accordion-button collapsed bg-white text-danger fw-bold" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#collapseCheatingUsers" 
                                                style="box-shadow: none; border-left: 5px solid var(--color-danger);">
                                            <i class="bi bi-person-x-fill me-2"></i> ผู้ใช้ที่พบการทุจริต
                                            <span class="badge rounded-pill bg-danger ms-auto" id="cheat-users-count">0</span>
                                        </button>
                                    </h2>
                                    <div id="collapseCheatingUsers" class="accordion-collapse collapse" data-bs-parent="#accordionCheating">
                                        <div class="accordion-body bg-light">
                                            <div class="d-flex flex-wrap gap-2" id="cheat-users-list" style="display: none;"></div>
                                            <div id="cheat-users-placeholder" class="text-center py-3">
                                                <i class="bi bi-emoji-smile text-muted fs-4"></i>
                                                <p class="text-muted small mb-0">ไม่พบผู้ทุจริต</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="accordion" id="accordionFailedUnlock">
                                <div class="accordion-item border-0 shadow-sm rounded-4 overflow-hidden">
                                    <h2 class="accordion-header" id="headingFailedUnlockUsers">
                                        <button class="accordion-button collapsed bg-white text-warning fw-bold" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#collapseFailedUnlockUsers" 
                                                style="box-shadow: none; border-left: 5px solid var(--color-warning); color: #d35400 !important;">
                                            <i class="bi bi-person-slash-fill me-2"></i> ปลดล็อคล้มเหลว
                                            <span class="badge rounded-pill bg-warning text-dark ms-auto" id="failed-unlock-users-count">0</span>
                                        </button>
                                    </h2>
                                    <div id="collapseFailedUnlockUsers" class="accordion-collapse collapse" data-bs-parent="#accordionFailedUnlock">
                                        <div class="accordion-body bg-light">
                                            <div class="d-flex flex-wrap gap-2" id="failed-unlock-users-list" style="display: none;"></div>
                                            <div id="failed-unlock-placeholder" class="text-center py-3">
                                                <i class="bi bi-check2-circle text-muted fs-4"></i>
                                                <p class="text-muted small mb-0">ปกติ</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="accordion" id="accordionLiveStatus">
                                <div class="accordion-item border-0 shadow-sm rounded-4 overflow-hidden">
                                    <h2 class="accordion-header" id="headingLiveStatus">
                                        <button class="accordion-button bg-white text-primary fw-bold" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#collapseLiveStatus" 
                                                style="box-shadow: none; border-left: 5px solid var(--color-primary);">
                                            <i class="bi bi-activity me-2"></i> สถานะผู้เข้าสอบ (Live Status)
                                            <span class="badge rounded-pill bg-primary ms-auto" id="live-status-count">0</span>
                                        </button>
                                    </h2>
                                    <div id="collapseLiveStatus" class="accordion-collapse collapse show" data-bs-parent="#accordionLiveStatus">
                                        <div class="accordion-body p-0">
                                            <div class="list-group list-group-flush" id="live-status-list"></div>
                                            <div id="live-status-placeholder" class="text-center py-4">
                                                <p class="text-muted small mb-0">ยังไม่มีข้อมูล Real-time</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-5 opacity-10">

                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <div>
                            <h5 class="fw-bold mb-1" style="color: var(--text-main);">
                                <i class="bi bi-clipboard-data me-2 text-muted"></i>ลำดับเหตุการณ์ (Event Log)
                            </h5>
                            <p class="text-muted small mb-0">แสดงเหตุการณ์ทั้งหมดเรียงตามเวลา</p>
                        </div>
                        <div class="d-flex align-items-center bg-white p-1 rounded-pill border shadow-sm">
                            <label for="monitor-limit-select" class="form-label mb-0 ms-3 me-2 small fw-bold text-muted">แสดง:</label>
                            <select id="monitor-limit-select" class="form-select form-select-sm border-0 bg-transparent shadow-none" 
                                    style="width: 70px; cursor: pointer;" onchange="fetchMonitorData(1)">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="500">All</option>
                            </select>
                        </div>
                    </div>

                    <div id="monitor-loading-logs" style="display: none;" class="text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p class="text-muted small">กำลังดึงข้อมูลเหตุการณ์...</p>
                    </div>

                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead style="background-color: var(--bg-light);">
                                    <tr>
                                        <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">เวลา</th>
                                        <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">ผู้ใช้งาน</th>
                                        <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">เหตุการณ์</th>
                                        <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">รายละเอียด</th>
                                    </tr>
                                </thead>
                                <tbody id="event-log-table-body">
                                    <tr>
                                        <td colspan="4" class="text-center py-5 text-muted">
                                            <i class="bi bi-mouse me-2"></i>กรุณาเลือกรายวิชาก่อน...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="monitor-pagination-container" class="card-footer bg-white border-top-0 py-3 d-none">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="monitor-pagination-info"></small>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0 gap-1" id="monitor-pagination-controls"></ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                </div> </div>
        </div>

        <div id="student-login-history-view" class="view bg-body">
            <div class="container py-4">
                
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                    <div class="d-flex align-items-center">
                        <div class="rounded-pill me-3" style="width: 5px; height: 35px; background-color: var(--color-info);"></div>
                        <div>
                            <h2 class="fw-bold m-0" style="color: var(--text-main);">ประวัติการเข้าสู่ระบบ</h2>
                            <p class="text-muted small mb-0">ตรวจสอบรายการการเข้าใช้งานระบบล่าสุดของคุณ</p>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-secondary rounded-pill px-4 fw-bold shadow-sm" onclick="handleBackFromHistory()">
                        <i class="bi bi-arrow-left me-2"></i>กลับหน้าหลัก
                    </button>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--bg-light);">
                                <tr>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom" style="min-width: 160px;">
                                        <i class="bi bi-calendar-event me-1"></i> วัน/เวลา
                                    </th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">
                                        <i class="bi bi-laptop me-1"></i> อุปกรณ์ (OS)
                                    </th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">
                                        <i class="bi bi-globe me-1"></i> เบราว์เซอร์
                                    </th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom">
                                        <i class="bi bi-hdd-network me-1"></i> IP Address
                                    </th>
                                    <th class="py-3 px-4 text-secondary small fw-bold text-uppercase border-bottom text-end">
                                        สถานะ
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="my-login-history-body" class="bg-white">
                                </tbody>
                        </table>
                    </div>

                    <div class="card-footer bg-white border-top-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span id="my-login-history-info" class="text-muted small"></span>
                            <nav>
                                <ul class="pagination pagination-sm mb-0 gap-1" id="my-login-history-pagination"></ul>
                            </nav>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="admin-cheat-dashboard-view" class="view p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="bi bi-shield-exclamation"></i> แดชบอร์ดตรวจสอบการทุจริต</h2>
                <div class="d-flex align-items-center">
                    <label for="cheat-dashboard-subject-select" class="form-label me-2 mb-0">เลือกรายวิชา:</label>
                    <select id="cheat-dashboard-subject-select" class="form-select" style="min-width: 300px;" onchange="handleCheatSubjectSelect(1)">
                    <option value="">-- กรุณาเลือกรายวิชาที่จะตรวจสอบ --</option>
                    </select>
                </div>
            </div>

            <div id="cheat-dashboard-session-info" class="card bg-light mb-4 d-none">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title mb-1">กำลังตรวจสอบ: <span id="session-info-name" class="text-primary">[ชื่อรายวิชา]</span></h5>
                            <p class="card-text mb-0">
                                <small class="text-muted" id="session-info-id">[SubjectID]</small>
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end mt-2 mt-md-0">
                            <strong><i class="bi bi-calendar-check"></i> เวลาสอบ:</strong>
                            <span id="session-info-time" class="d-block">[เวลาเริ่ม - เวลาสิ้นสุด]</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="cheat-dashboard-controls" class="row g-3 mb-3 d-none">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="cheat-search-input" 
                               placeholder="ค้นหา (อีเมล, ชื่อ, รายละเอียด)..." 
                               oninput="handleCheatSubjectSelect(1)">
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-center justify-content-md-end">
                    <label for="cheat-limit-select" class="form-label mb-0 me-2">แสดง:</label>
                    <select id="cheat-limit-select" class="form-select form-select-sm" style="width: 80px;" 
                            onchange="handleCheatSubjectSelect(1)">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <div id="cheat-dashboard-timeline-container">
                <div class="text-center p-5">
                    <i class="bi bi-search fs-1 text-muted"></i>
                    <p class="text-muted mt-2">กรุณาเลือกรายวิชาเพื่อเริ่มการตรวจสอบ</p>
                </div>
            </div>

            <div id="cheat-pagination-container" class="d-flex justify-content-between align-items-center mt-3 d-none">
                <span id="cheat-pagination-info"></span>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="cheat-pagination-controls">
                    </ul>
                </nav>
            </div>
        </div>

    </main>

    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="add-user-form" onsubmit="handleAddNewUser(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addUserModalLabel">เพิ่มผู้ใช้ใหม่</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="add-user-error" class="alert alert-danger d-none"></div>
                        
                        <div class="mb-3">
                            <label for="add-prefix" class="form-label">คำนำหน้า</label>
                            <select id="add-prefix" class="form-select" required>
                                <option value="นาย">นาย</option>
                                <option value="นาง">นาง</option>
                                <option value="นางสาว">นางสาว</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="add-firstName" class="form-label">ชื่อ</label>
                                <input type="text" id="add-firstName" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="add-lastName" class="form-label">นามสกุล</label>
                                <input type="text" id="add-lastName" class="form-control" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="add-studentId" class="form-label">รหัสนักศึกษา</label>
                            <input type="text" id="add-studentId" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="add-classYear" class="form-label">ชั้นปี</label>
                            <input type="number" id="add-classYear" class="form-control" min="1" max="8" required>
                        </div>
                        <div class="mb-3">
                            <label for="add-phone" class="form-label">เบอร์โทรศัพท์</label>
                            <input type="tel" id="add-phone" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="add-email" class="form-label">Email</label>
                            <input type="email" id="add-email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="add-role" class="form-label">Role</label>
                            <select id="add-role" class="form-select" required>
                                <option value="Student">Student</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="add-password" class="form-label">Password</label>
                                <input type="password" id="add-password" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="add-confirm-password" class="form-label">Confirm Password</label>
                                <input type="password" id="add-confirm-password" class="form-control" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-success">สร้างบัญชี</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">แก้ไขข้อมูลผู้ใช้</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="edit-user-form" onsubmit="handleUpdateUser(event)">
                    <div class="modal-body">
                        <input type="hidden" id="edit-userId-hidden">

                        <div class="mb-3">
                            <label for="edit-email" class="form-label">Email (ไม่สามารถแก้ไขได้)</label>
                            <input type="email" class="form-control" id="edit-email" readonly disabled>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-firstName" class="form-label">ชื่อ</label>
                                <input type="text" class="form-control" id="edit-firstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-lastName" class="form-label">นามสกุล</label>
                                <input type="text" class="form-control" id="edit-lastName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-studentId" class="form-label">รหัสนักศึกษา</label>
                            <input type="text" class="form-control" id="edit-studentId">
                        </div>
                        <div class="mb-3">
                            <label for="edit-role" class="form-label">Role</label>
                            <select class="form-select" id="edit-role" required>
                                <option value="Student">Student</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        
                        <hr>

                        <div class="mb-3">
                            <label class="form-label ms-2 small fw-bold text-primary">
                                <i class="bi bi-shield-lock me-1"></i>เปลี่ยนรหัสผ่าน <span class="text-muted fw-normal">(เว้นว่างไว้หากไม่ต้องการเปลี่ยน)</span>
                            </label>
                            
                            <div class="input-group rounded-pill border bg-white overflow-hidden mb-3">
                                <span class="input-group-text bg-transparent border-0 ps-3">
                                    <i class="bi bi-key text-muted"></i>
                                </span>
                                <input type="password" class="form-control border-0 shadow-none" 
                                      id="edit-password" placeholder="รหัสผ่านใหม่">
                            </div>

                            <div class="input-group rounded-pill border bg-white overflow-hidden">
                                <span class="input-group-text bg-transparent border-0 ps-3">
                                    <i class="bi bi-check-circle text-muted"></i>
                                </span>
                                <input type="password" class="form-control border-0 shadow-none" 
                                      id="edit-confirm-password" placeholder="ยืนยันรหัสผ่านใหม่">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึกการเปลี่ยนแปลง</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addCourseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">เพิ่มคอร์สใหม่</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <form id="add-course-form" onsubmit="handleAddNewCourse(event)">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="add-courseId" class="form-label">Course ID</label>
                            <!-- [แก้ไข] ปิดการแก้ไขและแสดงข้อความ -->
                            <input type="text" class="form-control text-muted" id="add-courseId" value="ระบบสร้างให้อัตโนมัติ" disabled readonly>
                        </div>
                        <div class="mb-3"><label for="add-courseName" class="form-label">ชื่อคอร์ส</label><input type="text" class="form-control" id="add-courseName" required></div>
                        <div class="mb-3">
                            <label for="add-course-category" class="form-label">หมวดหมู่ (เช่น การเงิน, เทคโนโลยี)</label>
                            <input type="text" class="form-control" id="add-course-category" placeholder="เว้นว่างหากเป็น 'ทั่วไป'">
                        </div>
                        <div class="mb-3"><label for="add-description" class="form-label">คำอธิบาย</label><textarea class="form-control" id="add-description" rows="3"></textarea></div>
                        <div class="mb-3"><label for="add-coverImageUrl" class="form-label">Cover Image URL</label><input type="url" class="form-control" id="add-coverImageUrl"></div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="add-course-registration-open" checked>
                            <label class="form-check-label" for="add-course-registration-open">เปิดรับการลงทะเบียน</label>
                        </div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-success">สร้างคอร์ส</button></div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editCourseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">แก้ไขข้อมูลคอร์ส</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <form id="edit-course-form" onsubmit="handleUpdateCourse(event)">
                    <div class="modal-body">
                        <div class="mb-3"><label for="edit-courseId" class="form-label">Course ID (ไม่สามารถแก้ไขได้)</label><input type="text" class="form-control" id="edit-courseId" disabled></div>
                        <div class="mb-3"><label for="edit-courseName" class="form-label">ชื่อคอร์ส</label><input type="text" class="form-control" id="edit-courseName" required></div>
                        <div class="mb-3">
                            <label for="edit-course-category" class="form-label">หมวดหมู่</label>
                            <input type="text" class="form-control" id="edit-course-category">
                        </div>
                        <div class="mb-3"><label for="edit-description" class="form-label">คำอธิบาย</label><textarea class="form-control" id="edit-description" rows="3"></textarea></div>
                        <div class="mb-3"><label for="edit-coverImageUrl" class="form-label">Cover Image URL</label><input type="url" class="form-control" id="edit-coverImageUrl"></div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="edit-course-registration-open">
                            <label class="form-check-label" for="edit-course-registration-open">เปิดรับการลงทะเบียน</label>
                        </div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-primary">บันทึก</button></div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addLessonModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">เพิ่มบทเรียนใหม่</h5>
          </div>
          <form onsubmit="handleAddNewLesson(event)">
            <div class="modal-body">
              <div class="mb-3">
                  <label class="form-label">Lesson ID</label>
                  <!-- [แก้ไข] ปิดการแก้ไข -->
                  <input type="text" class="form-control text-muted" id="add-lessonId" value="ระบบสร้างให้อัตโนมัติ" disabled readonly>
              </div>
              <div class="mb-3">
                  <label class="form-label">ชื่อบทเรียน</label>
                  <input type="text" class="form-control" id="add-lessonName" required>
              </div>
              <div class="mb-3">
                  <label class="form-label">Video URL</label>
                  <input type="url" class="form-control" id="add-videoUrl" required>
              </div>
              <div class="mb-3">
                  <label for="add-docLinks" class="form-label">ลิงก์เอกสารประกอบ (ใส่ลิงก์ละ 1 บรรทัด)</label>
                  <textarea class="form-control" id="add-docLinks" rows="4"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-success">สร้าง</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editLessonModal" tabindex="-1" aria-labelledby="editLessonModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editLessonModalLabel">แก้ไขบทเรียน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="edit-lesson-form" onsubmit="handleUpdateLesson(event)">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="edit-lessonId" class="form-label">Lesson ID (ไม่สามารถแก้ไขได้)</label>
                            <input type="text" class="form-control" id="edit-lessonId" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="edit-lessonName" class="form-label">ชื่อบทเรียน</label>
                            <input type="text" class="form-control" id="edit-lessonName" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-videoUrl" class="form-label">Video URL</label>
                            <input type="url" class="form-control" id="edit-videoUrl" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-docLinks" class="form-label">ลิงก์เอกสารประกอบ (ใส่ลิงก์ละ 1 บรรทัด)</label>
                            <textarea class="form-control" id="edit-docLinks" rows="4"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึกการเปลี่ยนแปลง</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="addQuestionModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">เพิ่มคำถามใหม่</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="add-question-form" onsubmit="handleAddNewQuestion(event)">
            <div class="modal-body" id="add-question-modal-body"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-success">สร้าง</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" id="editQuestionModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">แก้ไขคำถาม</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="edit-question-form" onsubmit="handleUpdateQuestion(event)">
            <div class="modal-body" id="edit-question-modal-body"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-primary">บันทึก</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editScoreModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">แก้ไขคะแนน</h5>
          </div>
          <form onsubmit="handleUpdateScore(event)">
            <div class="modal-body">
              <p><strong>User:</strong> <span id="edit-score-user"></span></p>
              <p><strong>Lesson:</strong> <span id="edit-score-lesson"></span></p><input type="hidden" id="edit-score-identifier">
              <div class="mb-3"><label for="edit-score-value" class="form-label">คะแนนใหม่ (รูปแบบ: x/y)</label><input type="text" class="form-control" id="edit-score-value" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-primary">บันทึก</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addExamSubjectModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">เพิ่มรายวิชาสอบใหม่</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form onsubmit="handleAddNewExamSubject(event)">
            <div class="modal-body">
              <div class="mb-3">
                  <label class="form-label">Subject ID</label>
                  <input type="text" class="form-control text-muted" id="add-subjectId" value="ระบบสร้างให้อัตโนมัติ (Auto)" disabled>
              </div>
              <div class="mb-3">
                  <label class="form-label">รหัสวิชา (เช่น RAD401)</label>
                  <input type="text" class="form-control" id="add-subject-code">
              </div>
              <div class="mb-3"><label class="form-label">ชื่อรายวิชา</label><input type="text" class="form-control" id="add-subjectName" required></div>
              <div class="mb-3"><label class="form-label">คำอธิบาย (สำหรับหน้าข้อตกลง)</label><textarea class="form-control" id="add-subject-description" rows="3"></textarea></div>
              <div class="mb-3">
                  <label class="form-label">ชั้นปีที่สอบได้ (เลือกได้มากกว่า 1)</label>
                  <div id="add-allowedYears-checkboxes" class="d-flex flex-wrap gap-3"></div>
              </div>
              <div class="row">
                  <div class="col-md-6 mb-3">
                      <label for="add-startTime" class="form-label">เวลาเริ่มสอบ (ไม่บังคับ)</label>
                      <input type="datetime-local" class="form-control" id="add-startTime">
                  </div>
                  <div class="col-md-6 mb-3">
                      <label for="add-endTime" class="form-label">เวลาสิ้นสุดสอบ (ไม่บังคับ)</label>
                      <input type="datetime-local" class="form-control" id="add-endTime">
                  </div>
              </div>
              <div class="mb-3">
                  <label for="add-exam-pin" class="form-label">PIN สำหรับเข้าสอบ (4-6 หลัก)</label>
                  <input type="text" class="form-control" id="add-exam-pin" maxlength="6" placeholder="เว้นว่าง ถ้าไม่ต้องการรหัสผ่าน">
              </div>
              <div class="mb-3">
                  <label for="add-unlock-pin" class="form-label">PIN สำหรับปลดล็อคหน้าจอ (แนะนำ 6 หลัก)</label>
                  <input type="text" class="form-control" id="add-unlock-pin" maxlength="6" placeholder="เว้นว่าง ถ้าไม่ต้องการ">
              </div>

              <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" role="switch" id="add-subject-announce-scores">
                  <label class="form-check-label" for="add-subject-announce-scores">ประกาศคะแนนหลังสอบเสร็จสิ้น</label>
              </div>

              <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" role="switch" id="add-subject-show-answers">
                  <label class="form-check-label" for="add-subject-show-answers">อนุญาตให้ดูเฉลยคำตอบ</label>
                  <div class="form-text">หากปิดไว้ นักศึกษาจะเห็นแค่คะแนนรวม แต่ไม่เห็นว่าข้อไหนถูก/ผิด</div>
              </div>
              <div class="border rounded p-3 mb-3 bg-light">
                  <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" role="switch" id="add-subject-show-info" onchange="toggleExamInfoEditor('add', this.checked)">
                      <label class="form-check-label fw-bold" for="add-subject-show-info">แสดงปุ่มข้อมูลเพิ่มเติมในหน้าสอบ</label>
                  </div>
                  
                  <div id="add-exam-info-container" class="d-none">
                      <label class="form-label small text-muted">เนื้อหาข้อมูลเพิ่มเติม:</label>
                      
                      <div class="input-group mb-2">
                          <input type="file" class="form-control form-control-sm" id="add-image-upload" accept="image/*">
                          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="handleImageUpload('add')">
                              <i class="bi bi-image"></i> แทรกรูป
                          </button>
                      </div>

                      <div id="add-exam-info-editor" style="background: white;"></div>
                  </div>
              </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-success">สร้างรายวิชา</button>
            </div>
          </form>
        </div>
      </div>
    </div>
        
    <div class="modal fade" id="editExamSubjectModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">แก้ไขข้อมูลรายวิชาสอบ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form onsubmit="handleUpdateExamSubject(event)">
            <div class="modal-body">
              <div class="mb-3"><label class="form-label">Subject ID</label><input type="text" class="form-control" id="edit-subjectId" disabled></div>
              <div class="mb-3">
                  <label class="form-label">รหัสวิชา</label>
                  <input type="text" class="form-control" id="edit-subject-code">
              </div>
              <div class="mb-3"><label class="form-label">ชื่อรายวิชา</label><input type="text" class="form-control" id="edit-subjectName" required></div>
              <div class="mb-3"><label class="form-label">คำอธิบาย</label><textarea class="form-control" id="edit-subject-description" rows="3"></textarea></div>
              <div class="mb-3">
                  <label class="form-label">ชั้นปีที่สอบได้ (เลือกได้มากกว่า 1)</label>
                  <div id="edit-allowedYears-checkboxes" class="d-flex flex-wrap gap-3"></div>
              </div>
              <div class="row">
                  <div class="col-md-6 mb-3">
                      <label for="edit-startTime" class="form-label">เวลาเริ่มสอบ (ไม่บังคับ)</label>
                      <input type="datetime-local" class="form-control" id="edit-startTime">
                  </div>
                  <div class="col-md-6 mb-3">
                      <label for="edit-endTime" class="form-label">เวลาสิ้นสุดสอบ (ไม่บังคับ)</label>
                      <input type="datetime-local" class="form-control" id="edit-endTime">
                  </div>
              </div>
              <div class="mb-3">
                  <label for="edit-exam-pin" class="form-label">PIN สำหรับเข้าสอบ (4-6 หลัก)</label>
                  <input type="text" class="form-control" id="edit-exam-pin" maxlength="6" placeholder="เว้นว่าง ถ้าไม่ต้องการรหัสผ่าน">
              </div>
              <div class="mb-3">
                  <label for="edit-unlock-pin" class="form-label">PIN สำหรับปลดล็อคหน้าจอ (แนะนำ 6 หลัก)</label>
                  <input type="text" class="form-control" id="edit-unlock-pin" maxlength="6" placeholder="เว้นว่าง ถ้าไม่ต้องการ">
              </div>
              <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" role="switch" id="edit-subject-announce-scores">
                  <label class="form-check-label" for="edit-subject-announce-scores">ประกาศคะแนนหลังสอบเสร็จสิ้น</label>
              </div>

              <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" role="switch" id="edit-subject-show-answers">
                  <label class="form-check-label" for="edit-subject-show-answers">อนุญาตให้ดูเฉลยคำตอบ</label>
                  <div class="form-text">หากปิดไว้ นักศึกษาจะเห็นแค่คะแนนรวม แต่ไม่เห็นว่าข้อไหนถูก/ผิด</div>
              </div>
              <div class="border rounded p-3 mb-3 bg-light">
                  <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" role="switch" id="edit-subject-show-info" onchange="toggleExamInfoEditor('edit', this.checked)">
                      <label class="form-check-label fw-bold" for="edit-subject-show-info">แสดงปุ่มข้อมูลเพิ่มเติมในหน้าสอบ</label>
                  </div>
                  
                  <div id="edit-exam-info-container" class="d-none">
                      <label class="form-label small text-muted">เนื้อหาข้อมูลเพิ่มเติม:</label>
                      
                      <div class="input-group mb-2">
                          <input type="file" class="form-control form-control-sm" id="edit-image-upload" accept="image/*">
                          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="handleImageUpload('edit')">
                              <i class="bi bi-image"></i> แทรกรูป
                          </button>
                      </div>

                      <div id="edit-exam-info-editor" style="background: white;"></div>
                  </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-primary">บันทึก</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="examPinModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4 p-3">
                
                <div class="position-absolute top-0 end-0 m-3" style="z-index: 10;">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body text-center pt-4">
                    <form onsubmit="handlePinSubmit(event)">
                        
                        <div class="mb-3 text-primary opacity-75">
                            <i class="bi bi-lock-fill display-4"></i>
                        </div>

                        <h5 class="fw-bold mb-1">ยืนยันตัวตน</h5>
                        <p class="text-muted small mb-3">กรุณากรอก PIN เพื่อเข้าสอบวิชา</p>
                        
                        <div class="bg-light rounded-3 p-3 mb-4 border border-light">
                            <p id="pin-modal-subject-name" class="fw-bold text-primary mb-0 text-truncate px-2"></p>
                        </div>

                        <input type="hidden" id="pin-modal-subject-data">

                        <div class="form-group mb-4 position-relative">
                            <input type="password" 
                                  class="form-control form-control-lg text-center fw-bold border-0 bg-light" 
                                  id="pin-modal-input" 
                                  maxlength="6" 
                                  placeholder="• • • •" 
                                  required
                                  style="letter-spacing: 8px; font-size: 1.5rem; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03);">
                            <div id="pin-modal-error" class="text-danger small mt-2 d-none">
                                <i class="bi bi-exclamation-circle-fill me-1"></i> PIN ไม่ถูกต้อง
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-2 rounded-pill shadow-sm hover-elevate">
                            เข้าสู่ห้องสอบ
                        </button>

                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addExamTopicModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">เพิ่มหัวข้อสอบใหม่</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form onsubmit="handleAddNewExamTopic(event)">
            <div class="modal-body">
              <div class="mb-3">
                  <label class="form-label">Topic ID</label>
                  <input type="text" class="form-control text-muted" id="add-topicId" value="ระบบสร้างให้อัตโนมัติ (Auto)" disabled>
              </div>
              <div class="mb-3"><label class="form-label">ชื่อหัวข้อสอบ</label><input type="text" class="form-control" id="add-topicName" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-success">สร้าง</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editExamTopicModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">แก้ไขหัวข้อสอบ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form onsubmit="handleUpdateExamTopic(event)">
            <div class="modal-body">
              <div class="mb-3"><label class="form-label">Topic ID</label><input type="text" class="form-control" id="edit-topicId" disabled>
              </div>
              <div class="mb-3"><label class="form-label">ชื่อหัวข้อสอบ</label><input type="text" class="form-control" id="edit-topicName" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-primary">บันทึก</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addExamQuestionModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">เพิ่มคำถามใหม่</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form onsubmit="handleAddNewExamQuestion(event)">
            <div class="modal-body" id="add-exam-question-modal-body"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-success">สร้าง</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editExamQuestionModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">แก้ไขคำถาม</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form onsubmit="handleUpdateExamQuestion(event)">
            <div class="modal-body" id="edit-exam-question-modal-body"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-primary">บันทึก</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editExamScoreModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">แก้ไขคะแนนสอบ</h5>
          </div>
          <form onsubmit="handleUpdateExamScore(event)">
            <div class="modal-body">
              <p><strong>Submission ID:</strong> <span id="edit-exam-score-subId"></span></p>
              <input type="hidden" id="edit-exam-score-identifier">
              <div class="mb-3">
                <label for="edit-exam-score-value" class="form-label">คะแนนใหม่ (รูปแบบ: x/y)</label>
                <input type="text" class="form-control" id="edit-exam-score-value" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="submit" class="btn btn-primary">บันทึก</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addAnnouncementModal" tabindex="-1" aria-labelledby="addAnnouncementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAnnouncementModalLabel">เพิ่มประกาศใหม่</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form onsubmit="handleAddNewAnnouncement(event)">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="add-ann-title" class="form-label">หัวข้อ</label>
                            <input type="text" class="form-control" id="add-ann-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="add-ann-content" class="form-label">เนื้อหา</label>
                            <textarea class="form-control" id="add-ann-content" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="add-ann-type" class="form-label">ประเภทประกาศ</label>
                            <select id="add-ann-type" class="form-select">
                                <option value="Info" selected>Info (ข้อมูลทั่วไป)</option>
                                <option value="Success">Success (ข่าวดี/สำเร็จ)</option>
                                <option value="Warning">Warning (แจ้งเตือน)</option>
                                <option value="Error">Error (ข้อผิดพลาด/เรื่องด่วน)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="add-ann-author" class="form-label">ผู้ประกาศ</label>
                            <select class="form-select" id="add-ann-author" required>
                                <option value="Admin">Admin</option>
                                <option value="System">System</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-success">สร้างประกาศ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editAnnouncementModal" tabindex="-1" aria-labelledby="editAnnouncementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAnnouncementModalLabel">แก้ไขประกาศ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form onsubmit="handleUpdateAnnouncement(event)">
                    <div class="modal-body">
                        <input type="hidden" id="edit-ann-id">
                        <div class="mb-3">
                            <label for="edit-ann-title" class="form-label">หัวข้อ</label>
                            <input type="text" class="form-control" id="edit-ann-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-ann-content" class="form-label">เนื้อหา</label>
                            <textarea class="form-control" id="edit-ann-content" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-ann-type" class="form-label">ประเภทประกาศ</label>
                            <select id="edit-ann-type" class="form-select">
                                <option value="Info">Info (ข้อมูลทั่วไป)</option>
                                <option value="Success">Success (ข่าวดี/สำเร็จ)</option>
                                <option value="Warning">Warning (แจ้งเตือน)</option>
                                <option value="Error">Error (ข้อผิดพลาด/เรื่องด่วน)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-ann-author" class="form-label">ผู้ประกาศ</label>
                            <select class="form-select" id="edit-ann-author" required>
                                <option value="Admin">Admin</option>
                                <option value="System">System</option>
                            </select>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="edit-ann-isActive">
                            <label class="form-check-label" for="edit-ann-isActive">แสดงประกาศนี้ (Active)</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึกการเปลี่ยนแปลง</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">แก้ไขข้อมูลส่วนตัว</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form onsubmit="handleUpdateProfile(event)">
                    <div class="modal-body">

                        <div class="mb-3">
                            <label class="form-label">อีเมล</label>
                            <input type="email" class="form-control" id="edit-profile-email" disabled>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="edit-profile-prefix" class="form-label">คำนำหน้า</label>
                                    <select class="form-select" id="edit-profile-prefix" required>
                                        <option value="นาย">นาย</option>
                                        <option value="นาง">นาง</option>
                                        <option value="นางสาว">นางสาว</option>
                                        <option value="อื่นๆ">อื่นๆ</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="edit-profile-firstname" class="form-label">ชื่อ</label>
                                    <input type="text" class="form-control" id="edit-profile-firstname" required>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="mb-3">
                                    <label for="edit-profile-lastname" class="form-label">นามสกุล</label>
                                    <input type="text" class="form-control" id="edit-profile-lastname" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="edit-profile-phone" class="form-label">เบอร์โทรศัพท์</label>
                            <input type="tel" class="form-control" id="edit-profile-phone">
                        </div>

                        <div id="student-only-fields">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit-profile-studentid" class="form-label">รหัสนักศึกษา</label>
                                        <input type="text" class="form-control" id="edit-profile-studentid">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit-profile-year" class="form-label">ชั้นปี</label>
                                        <select class="form-select" id="edit-profile-year">
                                            <option value="1">ปี 1</option>
                                            <option value="2">ปี 2</option>
                                            <option value="3">ปี 3</option>
                                            <option value="4">ปี 4</option>
                                            <option value="5">ปี 5</option>
                                            <option value="6">ปี 6</option>
                                            <option value="other">อื่นๆ</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div id="password-change-section">
                            <h6 class="mb-3">เปลี่ยนรหัสผ่าน</h6>
                            <div class="mb-3">
                                <label for="edit-profile-new-password" class="form-label">รหัสผ่านใหม่</label>
                                <input type="password" class="form-control" id="edit-profile-new-password" placeholder="กรอกรหัสผ่านใหม่ (ถ้าต้องการเปลี่ยน)">
                            </div>
                            <div class="mb-3">
                                <label for="edit-profile-confirm-password" class="form-label">ยืนยันรหัสผ่านใหม่</label>
                                <input type="password" class="form-control" id="edit-profile-confirm-password" placeholder="กรอกรหัสผ่านใหม่อีกครั้ง">
                            </div>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="edit-profile-otp" placeholder="กรอก OTP 6 หลัก" aria-label="OTP">
                                <!-- [แก้ไข] เพิ่ม 'this' ในวงเล็บ -->
                                <button class="btn btn-outline-secondary" type="button" onclick="requestPasswordChangeOTP(this)">ส่ง OTP</button>
                            </div>

                            <div id="otp-reference-container" class="form-text d-none">
                                กรุณาตรวจสอบรหัสอ้างอิงในอีเมลให้ตรงกับ: <strong id="otp-reference-code" class="text-danger"></strong>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึกการเปลี่ยนแปลง</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cheatLockModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4 p-4">
                <div class="modal-body text-center">
                    
                    <div class="mb-4 text-danger opacity-75">
                        <i class="bi bi-shield-lock-fill display-1"></i>
                    </div>

                    <h4 class="fw-bold mb-3">หน้าจอถูกล็อค</h4>
                    <p class="text-muted mb-4 small">
                        ระบบตรวจพบการสลับหน้าจอ<br>
                        กรุณาติดต่อผู้คุมสอบเพื่อปลดล็อค
                    </p>

                    <div class="mb-3">
                        <input type="password" 
                              id="unlock-pin-input" 
                              class="form-control form-control-lg text-center bg-light border-0 rounded-3" 
                              placeholder="Enter PIN" 
                              style="letter-spacing: 4px;">
                        <div id="unlock-error" class="text-danger small mt-2 d-none">
                            <i class="bi bi-exclamation-circle me-1"></i> รหัสไม่ถูกต้อง
                        </div>
                    </div>

                    <button type="button" class="btn btn-dark w-100 py-3 rounded-3 mt-2 transition-btn" onclick="handleUnlockSubmit()">
                        ปลดล็อค
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-transparent border-0 shadow-none">
                
                <div class="position-absolute top-0 end-0 m-3" style="z-index: 1056;">
                    <button type="button" class="btn-close btn-close-white bg-white p-3 rounded-circle shadow" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-0 text-center">
                    <img id="imageModalContent" src="" class="img-fluid rounded-3 shadow-lg" alt="Enlarged Image" style="max-height: 85vh;">
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adminDeletePasswordModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px; overflow: hidden;">
                
                <div class="position-absolute top-0 end-0 m-3 z-3">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4 p-md-5 text-center">
                    
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-4" 
                        style="width: 80px; height: 80px; background-color: rgba(255, 118, 117, 0.1);">
                        <i class="bi bi-shield-lock-fill" style="font-size: 2.5rem; color: var(--color-danger);"></i>
                    </div>

                    <h4 class="fw-bold mb-2" style="color: var(--text-main);">ยืนยันการลบ Admin</h4>
                    <p class="text-muted mb-4">
                        คุณกำลังพยายามลบผู้ใช้งานระดับ <span class="badge rounded-pill bg-danger bg-opacity-10 text-danger px-2 border border-danger-subtle">Admin</span><br>
                        เพื่อความปลอดภัย กรุณากรอกรหัสผ่านหลัก
                    </p>

                    <input type="hidden" id="admin-delete-email-hidden">

                    <div class="text-start mb-4 mx-auto" style="max-width: 350px;">
                        <label for="admin-delete-password-input" class="form-label ms-2 small fw-bold text-secondary">
                            System Password
                        </label>
                        <div class="input-group rounded-pill border bg-light overflow-hidden">
                            <span class="input-group-text bg-transparent border-0 ps-3">
                                <i class="bi bi-key text-muted"></i>
                            </span>
                            <input type="password" class="form-control bg-transparent border-0 shadow-none" 
                                  id="admin-delete-password-input" 
                                  placeholder="กรอกรหัสผ่านหลัก..." required>
                        </div>
                    </div>

                    <div id="admin-delete-error" class="alert alert-danger border-0 rounded-4 py-2 mb-4 d-none text-center" role="alert">
                        <i class="bi bi-exclamation-circle-fill me-2"></i> รหัสผ่านไม่ถูกต้อง!
                    </div>

                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-light rounded-pill px-4 fw-bold text-muted" data-bs-dismiss="modal">
                            ยกเลิก
                        </button>
                        <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold shadow-btn" onclick="handleAdminPasswordSubmit()">
                            <i class="bi bi-trash-fill me-2"></i>ยืนยันการลบ
                        </button>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="importStatusModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px; overflow: hidden;">
                
                <div class="modal-header border-bottom-0 pb-0 pt-4 px-4">
                    <h5 class="modal-title fw-bold" id="import-modal-title" style="color: var(--text-main);">กำลังนำเข้าข้อมูล...</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4 text-center">
                    
                    <div id="import-status-loading">
                        <div class="py-4">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <h6 class="fw-bold text-secondary">กำลังประมวลผลไฟล์</h6>
                        <p class="text-muted small mb-0">ระบบกำลังอัปโหลดและตรวจสอบข้อมูล<br>โปรดอย่าปิดหน้านี้จนกว่าจะเสร็จสิ้น</p>
                    </div>

                    <div id="import-status-result" class="d-none mt-2">
                        </div>
                </div>

                <div class="modal-footer border-top-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold text-muted" data-bs-dismiss="modal">ปิดหน้าต่าง</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="csv-file-input" accept=".csv, text/csv" style="display: none;" onchange="handleFileUpload(event)">

    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detailsModalLabel">ดูรายละเอียด</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="detailsModalBody">
            </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="examInfoModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title"><i class="bi bi-info-circle-fill"></i> ข้อมูลรายวิชา</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="exam-info-content" class="ql-editor"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
          </div>
        </div>
      </div>
    </div>

    <footer id="main-footer" class="bg-dark text-white p-4 mt-auto">
        <div class="container">
            <div id="full-footer-content">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <h5>เกี่ยวกับ E-Learning System</h5>
                        <p class="text-white-50">
                            แพลตฟอร์มการเรียนรู้และทดสอบออนไลน์ที่ออกแบบมาเพื่อเสริมสร้างทักษะและความรู้ของผู้เรียนในทุกระดับ
                        </p>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h5>คณะผู้จัดทำ</h5>
                        <ul class="list-unstyled text-white-50">
                            <li>นายหล่อ พิลึก (ผู้จัดทำ)</li>
                            <li>นางสาวปลาร้าหอม เขย่าไห (ผู้จัดทำ)</li>
                            <br>
                            <li>นายเกิดใหม่ รวยจริงนะ (อาจารย์ที่ปรึกษา)</li>
                        </ul>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h5>ติดตามเรา</h5>
                        <a href="#" class="text-white text-decoration-none me-3"><i class="bi bi-facebook" style="font-size: 1.5rem;"></i></a>
                        <a href="#" class="text-white text-decoration-none me-3"><i class="bi bi-twitter" style="font-size: 1.5rem;"></i></a>
                        <a href="#" class="text-white text-decoration-none"><i class="bi bi-instagram" style="font-size: 1.5rem;"></i></a>
                    </div>
                </div>
                <hr class="my-4">
            </div>
            <div class="row">
                <div class="col-md-12 text-center">
                    <p class="text-white-50">&copy; 2025 E-Learning System. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>

    Chart.register(ChartDataLabels);

    let ytPlayer;
    // --- GLOBAL STATE ---
    let currentUser = null;
    let currentLesson = null;
    let currentTestType = null;
    let currentQuestions = [];
    let preTestResult = null;
    let allLessonsCache = {};
    let currentManagingCourse = null;
    let currentManagingLesson = null;

    // [ใหม่] State สำหรับระบบแบบทดสอบ
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let currentQuizPrefix = ''; // <-- เพิ่มบรรทัดนี้

    // --- [ใหม่] Admin Exam Topic & Question Management ---
    let currentManagingSubject = null;
    let currentManagingTopic = null;

    // --- [ใหม่] Global State สำหรับระบบสอบ ---
    let currentExamSubject = null;
    let currentExamTopic = null;
    let isFinalExamMode = false;
    let progressInterval = null;
    let examTimerInterval = null;

    let cheatAttempts = 0;
    let isAntiCheatActive = false; // [ใหม่] ตัวแปรสำหรับตรวจสอบว่าระบบตรวจจับทำงานหรือยัง
    let isScreenLocked = false; // [ใหม่] ตัวแปรสำหรับเช็คสถานะล็อคหน้าจอ

    let dashboardRefreshInterval = null;

    let activeCharts = [];

    let _allCoursesCache = []; // สำหรับเก็บคอร์สทั้งหมด
    let _userEnrollmentsCache = []; // ใช้สำหรับตรวจสอบปุ่มในหน้า All Courses
    let _hasLoadedCourseFilters = false; // ใช้เพื่อป้องกันการโหลดตัวกรองซ้ำ

    // [ใหม่] ตัวแปรสำหรับเก็บ Modal และประเภทการ Import
    let importStatusModal = null;
    let currentImportType = '';

    // [ใหม่] เพิ่ม State สำหรับจัดการ Pagination ของแต่ละแท็บ
    let paginationState = {
        enrollments: { currentPage: 1, limit: 10 },
        scores: { currentPage: 1, limit: 10 },
        logs: { currentPage: 1, limit: 10 },
        learningHistory: { currentPage: 1, limit: 10 },
        examSubmissions: { currentPage: 1, limit: 10 },
        finalSubmissions: { currentPage: 1, limit: 10 },
        examLogs: { currentPage: 1, limit: 10 },
        examHistory: { currentPage: 1, limit: 10 },
        examTopicHistory: { currentPage: 1, limit: 10 },
        pinLogs: { currentPage: 1, limit: 10 },
        cheatingLogs: { currentPage: 1, limit: 10 },
        adminLogs: { currentPage: 1, limit: 10 },
        myLoginHistory: { currentPage: 1, limit: 10 }, // [ใหม่]
        studentLogs: { currentPage: 1, limit: 10 }
    };

    let courseTabListenerAdded = false;
    let examTabListenerAdded = false;
    let logTabListenerAdded = false;

    let currentReportSubjectId = null; // เก็บ ID วิชานี้ไว้เผื่อใช้ Export

    // [เพิ่ม] ตัวแปรสำหรับเก็บข้อมูลรายงานในหน้า (สำหรับ CSV Export)
    let _currentReportDataCache = [];
    let _currentReportMaxScore = 0;

    let cheatDashboardRefreshInterval = null; // ตัวแปรสำหรับคุมการรีเฟรช

    // [เพิ่ม] ตัวแปรสำหรับเก็บข้อมูลวิเคราะห์ (สำหรับ CSV Export)
    let _currentAnalysisData = null;

    // ประกาศตัวแปร Global ไว้ด้านบนสุดเพื่อให้ทุกฟังก์ชันเรียกใช้ได้
    var quillAddInfo;
    var quillEditInfo;
    var detailsModalInstance;

    // (ฟังก์ชัน checkActiveExamSession และอื่นๆ ของคุณ...)
    (function checkActiveExamSession() {
        const storedSubject = sessionStorage.getItem('activeExamSubject');
        if (storedSubject) {
            currentExamSubject = JSON.parse(storedSubject);
            if (currentExamSubject && currentExamSubject.EndTime) {
                startCountdown(currentExamSubject.EndTime, ['topic-list-timer', 'exam-timer']);
            }
        }
    })();

    /**
     * [อัปเกรด] แสดง View, จัดการ UI, จัดการการอัปเดตอัตโนมัติ และหยุดวิดีโอ
     * @param {string} viewId - ID ของ div ที่ต้องการแสดง
     */
    // function showView(viewId) {
    //     // --- [ส่วนที่เพิ่มใหม่] สั่งหยุดวิดีโอ YouTube เมื่อเปลี่ยนหน้า ---
    //     // ตรวจสอบว่ามีตัวแปร ytPlayer และฟังก์ชัน stopVideo หรือไม่
    //     if (typeof ytPlayer !== 'undefined' && ytPlayer && typeof ytPlayer.stopVideo === 'function') {
    //         try {
    //             ytPlayer.stopVideo(); // สั่งหยุดวิดีโอ
    //         } catch (e) {
    //             console.log("Error stopping video: " + e.message);
    //         }
    //     }
    //     // --- [สิ้นสุดส่วนที่เพิ่มใหม่] ---

    //     // --- [จุดแก้ไขเดิม] ---
    //     // หยุดการอัปเดตแดชบอร์ดอัตโนมัติถ้าผู้ใช้ออกจากหน้านั้น
    //     if (viewId !== 'admin-cheat-dashboard-view' && typeof dashboardRefreshInterval !== 'undefined' && dashboardRefreshInterval) {
    //         clearInterval(dashboardRefreshInterval);
    //         dashboardRefreshInterval = null; // รีเซ็ตตัวแปร
    //         console.log("Dashboard auto-refresh stopped.");
    //     }
    //     // --- [สิ้นสุดจุดแก้ไขเดิม] ---

    //     // --- ส่วนจัดการ UI (Navbar/Footer) ทำงานเหมือนเดิม ---
    //     const navbar = document.getElementById('main-navbar');
    //     const footerContent = document.getElementById('full-footer-content');

    //     const focusModeViews = [
    //         'exam-instructions-view',
    //         'exam-topic-list-view',
    //         'exam-taking-view',
    //         'exam-submitted-view'
    //     ];

    //     if (navbar) {
    //         if (focusModeViews.includes(viewId)) {
    //             navbar.classList.add('d-none');
    //         } else {
    //             navbar.classList.remove('d-none');
    //         }
    //     }

    //     if (footerContent) {
    //         if (focusModeViews.includes(viewId)) {
    //             footerContent.classList.add('d-none');
    //         } else {
    //             footerContent.classList.remove('d-none');
    //         }
    //     }
        
    //     // --- ส่วนแสดง/ซ่อน View ทำงานเหมือนเดิม ---
    //     document.querySelectorAll('.view').forEach(view => {
    //         view.style.display = 'none';
    //     });

    //     const activeView = document.getElementById(viewId);
    //     if (activeView) {
    //         activeView.style.display = 'block';
    //     }
    //     window.scrollTo(0, 0);
    // }

    /**
     * [อัปเกรด] แสดง View, จัดการ UI, จัดการการอัปเดตอัตโนมัติ และหยุดวิดีโอ
     * @param {string} viewId - ID ของ div ที่ต้องการแสดง
     */
    function showView(viewId) {
        // --- [ส่วนที่เพิ่มใหม่] สั่งหยุดวิดีโอ YouTube เมื่อเปลี่ยนหน้า ---
        if (typeof ytPlayer !== 'undefined' && ytPlayer && typeof ytPlayer.stopVideo === 'function') {
            try {
                ytPlayer.stopVideo();
            } catch (e) {
                console.log("Error stopping video: " + e.message);
            }
        }
        // --- [สิ้นสุดส่วนที่เพิ่มใหม่] ---

        // --- [จุดแก้ไขเดิม] หยุดการอัปเดตแดชบอร์ด ---
        if (viewId !== 'admin-cheat-dashboard-view' && typeof dashboardRefreshInterval !== 'undefined' && dashboardRefreshInterval) {
            clearInterval(dashboardRefreshInterval);
            dashboardRefreshInterval = null;
            console.log("Dashboard auto-refresh stopped.");
        }

        // --- ส่วนจัดการ UI (Navbar/Footer) ---
        const navbar = document.getElementById('main-navbar');
        const footerContent = document.getElementById('full-footer-content');

        // 1. จัดการ Navbar (ใช้ตรรกะเดิม คือซ่อนเฉพาะตอนทำข้อสอบ)
        const focusModeViews = [
            'exam-instructions-view',
            'exam-topic-list-view',
            'exam-taking-view',
            'exam-submitted-view'
        ];

        if (navbar) {
            if (focusModeViews.includes(viewId)) {
                navbar.classList.add('d-none');
            } else {
                navbar.classList.remove('d-none');
            }
        }

        // 2. [แก้ไขใหม่] จัดการ Footer (แสดงเฉพาะหน้าที่กำหนด)
        // รายชื่อหน้าที่ต้องการให้แสดง Footer
        const footerAllowedViews = [
            'admin-dashboard-view',
            'home-view',
            'login-view',
            'register-view'
        ];

        if (footerContent) {
            // เช็คว่า viewId ปัจจุบัน อยู่ในรายชื่อที่อนุญาตหรือไม่
            if (footerAllowedViews.includes(viewId)) {
                footerContent.classList.remove('d-none'); // แสดง
            } else {
                footerContent.classList.add('d-none');    // ซ่อน (สำหรับหน้าอื่นๆ ทั้งหมด)
            }
        }
        
        // --- ส่วนแสดง/ซ่อน View ทำงานเหมือนเดิม ---
        document.querySelectorAll('.view').forEach(view => {
            view.style.display = 'none';
        });

        const activeView = document.getElementById(viewId);
        if (activeView) {
            activeView.style.display = 'block';
        }
        window.scrollTo(0, 0);
    }

    function updateNavbar() {
        const navStudent = document.getElementById('nav-student');
        const navAdmin = document.getElementById('nav-admin');
        const navLoggedOut = document.getElementById('nav-loggedOut');
        const navUserInfo = document.getElementById('nav-userInfo');

        // ซ่อนทุกเมนูก่อน
        navStudent.classList.add('d-none');
        navAdmin.classList.add('d-none');
        navLoggedOut.classList.add('d-none');
        navUserInfo.classList.add('d-none');

        if (currentUser) {
            navUserInfo.classList.remove('d-none');
            
            // [แก้ไข] เปลี่ยนจาก currentUser.name เป็น currentUser.fullName
            // และปรับข้อความให้แสดงแค่ชื่อ เพื่อความสวยงามใน Dropdown
            document.getElementById('welcome-message').textContent = currentUser.fullName;
            
            if (currentUser.role === 'Admin') {
                navAdmin.classList.remove('d-none'); // แสดงเมนู Admin
            } else {
                navStudent.classList.remove('d-none'); // แสดงเมนู Student
            }
        } else {
            navLoggedOut.classList.remove('d-none'); // แสดงเมนูสำหรับคนยังไม่ Login
        }
    }

    // --- DATA FETCHING & DISPLAY ---

    /**
     * [ใหม่] ฟังก์ชันสำหรับเรียก Backend ให้ส่ง OTP สำหรับการลงทะเบียน
     */
    function requestRegistrationOTP(event) {
      const email = document.getElementById('reg-email').value;
      if (!email) {
        // [เดิม] alert('กรุณากรอกอีเมลก่อนกดส่ง OTP');
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        Swal.fire({
          title: 'ข้อมูลไม่ครบถ้วน',
          text: 'กรุณากรอกอีเมลก่อนกดส่ง OTP',
          icon: 'warning',
          allowOutsideClick: false,
          allowEscapeKey: false
        });
        return;
      }

      // --- ส่วนของการจัดการปุ่ม (เหมือนเดิม) ---
      const sendButton = event.target;
      sendButton.disabled = true;
      sendButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> กำลังส่ง...';

      document.getElementById('reg-otp-reference-container').classList.add('d-none');
      // --- จบส่วนของการจัดการปุ่ม ---

      google.script.run.withSuccessHandler(response => {
        // [เดิม] alert(response.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 โดยใช้ response.success เพื่อเปลี่ยนไอคอน
        Swal.fire({
          title: response.success ? 'ดำเนินการสำเร็จ' : 'เกิดข้อผิดพลาด',
          text: response.message,
          icon: response.success ? 'success' : 'error',
          allowOutsideClick: false,
          allowEscapeKey: false
        });

        if (response.success && response.referenceCode) {
          document.getElementById('reg-otp-reference-code').textContent = response.referenceCode;
          document.getElementById('reg-otp-reference-container').classList.remove('d-none');
        }

        // --- คืนค่าปุ่ม (เหมือนเดิม) ---
        sendButton.disabled = false;
        sendButton.textContent = 'ส่ง OTP ยืนยัน';
      }).generateAndSendOTP(email);
    }

    /**
     * [ปรับปรุง] จัดการการลงทะเบียนพร้อมส่ง OTP ไปตรวจสอบ
     */
    function handleRegister(event) {
      event.preventDefault();
      const errorDiv = document.getElementById('register-error');
      // ซ่อน error div เดิมไปก่อน (เผื่อมีการใช้งาน)
      errorDiv.classList.add('d-none');

      const password = document.getElementById('reg-password').value;
      const confirm = document.getElementById('reg-confirm-password').value;

      if (password !== confirm) {
        // [เปลี่ยนจาก errorDiv เป็น Swal]
        Swal.fire({
          title: 'ข้อมูลไม่ถูกต้อง',
          text: 'รหัสผ่านไม่ตรงกัน',
          icon: 'warning',
          allowOutsideClick: false,
          allowEscapeKey: false
        });
        return;
      }

      // รวบรวมข้อมูลจากฟอร์มทั้งหมด รวมถึง OTP
      const userData = {
        prefix: document.getElementById('reg-prefix').value,
        firstName: document.getElementById('reg-firstName').value,
        lastName: document.getElementById('reg-lastName').value,
        studentId: document.getElementById('reg-studentId').value,
        classYear: document.getElementById('reg-classYear').value,
        phone: document.getElementById('reg-phone').value,
        email: document.getElementById('reg-email').value,
        password: password,
        role: 'Student',
        otp: document.getElementById('reg-otp').value // [ใหม่] ส่ง OTP ไปด้วย
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังลงทะเบียน',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading(); // แสดง animation loading
        }
      });

      google.script.run.withSuccessHandler(res => {
        // SweetAlert (loading) จะปิดอัตโนมัติเมื่อ Server ตอบกลับ
        if (res.success) {
          // [เปลี่ยนจาก alert เป็น Swal]
          Swal.fire({
            title: 'ลงทะเบียนสำเร็จ!',
            text: 'กรุณาเข้าสู่ระบบ',
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });

          document.getElementById('register-form').reset();
          errorDiv.classList.add('d-none'); // เคลียร์ error div เดิม
          showView('login-view');
        } else {
          // [เปลี่ยนจาก errorDiv เป็น Swal]
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message, // แสดงข้อความ error จาก Backend
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });

          // [เดิม] โค้ดที่ใช้ errorDiv (ตอนนี้ใช้ Swal แทนแล้ว)
          // errorDiv.textContent = res.message;
          // errorDiv.classList.remove('d-none');
        }
      }).registerUser(userData);
    }

    function handleLogin(event) {
      event.preventDefault();
      const loginForm = document.getElementById('login-form');

      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังเข้าสู่ระบบ',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading(); // แสดง animation loading
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [ใหม่] เมื่อ Server ตอบกลับ SweetAlert (loading) จะถูกปิดอัตโนมัติ
        if (res.success) {
          // [ใหม่] ปิด Swal loading ทันที (เผื่อกรณีที่การทำงานฝั่ง Client ช้า)
          Swal.close();

          currentUser = res.user;

          // --- [จุดแก้ไข] ---
          // ตรวจสอบ Role ก่อนบันทึกเซสชัน
          if (currentUser.role === 'Admin') {
            try {
              sessionStorage.setItem('activeUserSession', JSON.stringify(currentUser));
            } catch (e) {
              console.error("ไม่สามารถบันทึกเซสชันได้:", e);
            }
          } else {
            // ถ้าเป็น Student หรือ Role อื่น ให้เคลียร์เซสชันทิ้ง
            sessionStorage.removeItem('activeUserSession');
          }
          // --- [สิ้นสุดจุดแก้ไข] ---

          // --- ส่วนบันทึก Log (ทำงานถูกต้องอยู่แล้ว) ---
          const clientInfo = getClientInfo();
          google.script.run.recordUserLog({
            userEmail: currentUser.email,
            role: currentUser.role,
            action: 'LOGIN',
            ip: '',
            browser: clientInfo.browser,
            os: clientInfo.os
          });
          // ------------------------------------------

          updateNavbar();
          handleNavHomeClick(); // เปลี่ยนหน้าจอ

          loginForm.reset();
          document.getElementById('login-error').classList.add('d-none');
        } else {
          // [เดิม] ใช้ login-error
          // [ใหม่] เปลี่ยนเป็น SweetAlert2
          Swal.fire({
            title: 'เข้าสู่ระบบไม่สำเร็จ',
            text: res.message, // แสดงข้อความ error จาก Backend
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });

          // [เดิม] document.getElementById('login-error').textContent = res.message;
          // [เดิม] document.getElementById('login-error').classList.remove('d-none');
        }
      }).loginUser(email, password);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับรวบรวมข้อมูล Browser และ OS ของผู้ใช้
     * @return {object} อ็อบเจกต์ที่ประกอบด้วยชื่อ Browser และ OS
     */
    function getClientInfo() {
        const ua = navigator.userAgent;
        let browser = "Unknown";
        let os = "Unknown";

        // ตรวจสอบ OS
        if (ua.indexOf("Win") != -1) os = "Windows";
        if (ua.indexOf("Mac") != -1) os = "MacOS";
        if (ua.indexOf("Linux") != -1) os = "Linux";
        if (ua.indexOf("Android") != -1) os = "Android";
        if (ua.indexOf("like Mac") != -1) os = "iOS"; // For iPhone/iPad

        // ตรวจสอบ Browser
        if (ua.indexOf("Firefox") > -1) {
            browser = "Firefox";
        } else if (ua.indexOf("SamsungBrowser") > -1) {
            browser = "Samsung Browser";
        } else if (ua.indexOf("Opera") > -1 || ua.indexOf("OPR") > -1) {
            browser = "Opera";
        } else if (ua.indexOf("Trident") > -1) {
            browser = "Internet Explorer";
        } else if (ua.indexOf("Edge") > -1) {
            browser = "Edge";
        } else if (ua.indexOf("Chrome") > -1) {
            browser = "Chrome";
        } else if (ua.indexOf("Safari") > -1) {
            browser = "Safari";
        }
        
        return { browser, os };
    }

    function handleNavHomeClick() {
        if (!currentUser) {
            showView('login-view');
            return;
        }
        if (currentUser.role === 'Admin') {
            showView('admin-dashboard-view');
        } else {
            showView('home-view');
            fetchAnnouncements();
        }
    }

    function handleLogout() {
      // [ใหม่] แสดงหน้าต่าง "ยืนยัน" ก่อนออกจากระบบ
      Swal.fire({
        title: 'ยืนยันการออกจากระบบ',
        text: "คุณต้องการออกจากระบบใช่หรือไม่?",
        icon: 'warning',
        allowOutsideClick: false, // ตามที่คุณกำหนด
        allowEscapeKey: false,  // ตามที่คุณกำหนด

        showCancelButton: true,      // ตามที่คุณกำหนด
        confirmButtonColor: "#198754", // ตามที่คุณกำหนด
        cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
        confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
        cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

      }).then((result) => {
        // ถ้าผู้ใช้กดยืนยัน (ตกลง)
        if (result.isConfirmed) {

          // [ใหม่] แสดงหน้าต่าง Loading ระหว่างรอ Server บันทึก Log
          Swal.fire({
            title: 'กำลังออกจากระบบ',
            text: 'กรุณารอสักครู่',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });

          // ฟังก์ชันสำหรับเคลียร์ข้อมูลฝั่ง Client (จะถูกเรียกหลัง Server ตอบกลับ)
          const cleanupClientSession = () => {
            // --- [เพิ่มส่วนนี้] ---
            // 3. [สำคัญ] เคลียร์เซสชันออกจาก Storage
            sessionStorage.removeItem('activeUserSession');
            // --- [สิ้นสุดส่วนที่เพิ่ม] ---

            currentUser = null;
            updateNavbar();
            showView('home-view'); // (แสดงหน้า Home ตามโค้ดเดิมของคุณ)
            // (ย้าย fetchAnnouncements() มาไว้หลัง showView)

            // --- ส่วนเคลียร์ข้อมูลใน View ต่างๆ ---
            const publicAnnouncements = document.getElementById('public-announcements-container');
            if (publicAnnouncements) publicAnnouncements.innerHTML = '';

            const announcements = document.getElementById('announcements-container');
            if (announcements) announcements.innerHTML = '';

            const myCourses = document.getElementById('my-courses');
            if (myCourses) myCourses.innerHTML = '';

            const lessonContent = document.getElementById('lesson-content');
            if (lessonContent) lessonContent.innerHTML = '';

            fetchAnnouncements(); // (เรียก fetchAnnouncements() หลังจากเคลียร์และเปลี่ยน View แล้ว)

            Swal.close(); // [ใหม่] ปิดหน้าต่าง Loading
          };


          if (currentUser) {
            // --- [ปรับปรุง] บันทึก Log พร้อมข้อมูล Client ---
            const clientInfo = getClientInfo();
            // [ใหม่] เพิ่ม withSuccessHandler/withFailureHandler เพื่อรอให้ Server ตอบกลับ
            google.script.run
              .withSuccessHandler(cleanupClientSession) // เมื่อ Log สำเร็จ ให้เคลียร์ Client
              .withFailureHandler(cleanupClientSession) // แม้ Log จะล้มเหลว ก็ต้องเคลียร์ Client
              .recordUserLog({
                userEmail: currentUser.email,
                role: currentUser.role,
                action: 'LOGOUT',
                ip: '',
                browser: clientInfo.browser,
                os: clientInfo.os
              });
          } else {
            // ถ้าไม่มี currentUser (เช่น Session หมดอายุไปแล้ว)
            // ก็ให้ทำการ cleanupClientSession เลย
            cleanupClientSession();
          }
          // ------------------------------------
        }
        // (ถ้าผู้ใช้กด "ยกเลิก" (result.isDismissed) ก็ไม่ต้องทำอะไร)
      });
    }

    function handleEnroll(courseId) {
        if (!currentUser) {
            Swal.fire({
                title: 'ลงทะเบียนไม่สำเร็จ',
                text: 'กรุณาเข้าสู่ระบบก่อนลงทะเบียน',
                icon: 'warning',
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then(() => {
                showView('login-view');
            });
            return;
        }

        Swal.fire({
            title: 'กำลังดำเนินการ',
            text: 'กำลังลงทะเบียนคอร์สเรียน...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                Swal.fire({
                    title: 'ลงทะเบียนสำเร็จ!',
                    text: res.message,
                    icon: 'success',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then(() => {
                    // --- [จุดที่แก้ไข] ---
                    // สั่งให้โหลดหน้าคอร์สทั้งหมดใหม่ เพื่ออัปเดตสถานะปุ่ม
                    fetchAllCourses(1); 
                    
                    // (ทางเลือก) ถ้าต้องการอัปเดตหน้าคอร์สของฉันด้วย (เผื่อผู้ใช้กดเปลี่ยนหน้าทันที)
                    // fetchMyCourses(1); 
                    // ------------------
                });
            } else {
                Swal.fire({
                    title: 'ลงทะเบียนไม่สำเร็จ',
                    text: res.message,
                    icon: 'error',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            }
        }).enrollCourse(courseId, currentUser.email);
    }

    /**
     * [อัปเกรด V3] ดึงข้อมูลคอร์สทั้งหมด (แบบแบ่งหน้า)
     * @param {number} page - เลขหน้าที่ต้องการ
     */
    function fetchAllCourses(page = 1) {
        showView('all-courses-view');
        
        // แสดงสถานะ "กำลังโหลด..."
        const listContainer = document.getElementById('all-courses-list');
        listContainer.innerHTML = '<div class="col-12"><p class="text-center text-muted p-5">กำลังโหลดคอร์สเรียน...</p></div>';

        // [ใหม่] ดึงข้อมูลตัวกรอง (หมวดหมู่) แค่ครั้งแรก
        if (!_hasLoadedCourseFilters) {
            google.script.run.withSuccessHandler(populateCategoryFilter).getCourseFilters();
            _hasLoadedCourseFilters = true;
        }

        // [ใหม่] รวบรวม options จาก UI
        const options = {
            page: page,
            limit: document.getElementById('all-course-limit').value,
            searchTerm: document.getElementById('all-course-search').value,
            category: document.getElementById('all-course-category-filter').value,
            status: document.getElementById('all-course-status-filter').value
        };

        // [ใหม่] เรียกใช้ฟังก์ชัน Backend ตัวใหม่
        google.script.run.withSuccessHandler(displayAllCoursesPage)
            .getPaginatedCourses(currentUser.email, options);
    }

    /**
     * [อัปเกรด V3] ดึงข้อมูลคอร์สที่ลงทะเบียนแล้ว (แบบแบ่งหน้า)
     * @param {number} page - เลขหน้าที่ต้องการ
     */
    function fetchMyCourses(page = 1) {
        if (!currentUser) { return; }
        showView('my-courses-view');
        const container = document.getElementById('my-courses-list');
        container.innerHTML = `<div class="col-12"><p class="text-center text-muted p-5">กำลังโหลดคอร์สเรียนของคุณ...</p></div>`;
        
        // [ใหม่] รวบรวม options จาก UI
        const options = {
            page: page,
            limit: document.getElementById('my-course-limit').value,
            searchTerm: document.getElementById('my-course-search').value,
            status: document.getElementById('my-course-status-filter').value
        };

        // [ใหม่] เรียกใช้ฟังก์ชัน Backend ที่อัปเกรดแล้ว
        google.script.run.withSuccessHandler(displayMyCoursesPage)
            .getMyCoursesWithCompletionStatus(currentUser.email, options);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้า "คอร์สของฉัน"
     * @param {Object} response - อ็อบเจกต์ pagination ที่ได้จาก GAS
     */
    function displayMyCoursesPage(response) {
        const { data, totalItems, totalPages, currentPage, limit } = response;

        // 1. แสดงผลการ์ด (ใช้ฟังก์ชันเดิมของคุณ)
        displayMyCourses(data);

        // 2. สร้าง Pagination
        buildPaginationControls('my-courses', currentPage, totalPages, totalItems, limit, 'fetchMyCourses');
    }

    /**
     * [ปรับปรุง] ฟังก์ชันสำหรับแสดงผลการ์ด "คอร์สของฉัน"
     * (ฟังก์ชันเดิมของคุณ ไม่แก้ไขตรรกะหลัก)
     * @param {Array} myCourses - อาร์เรย์ของคอร์ส (เฉพาะหน้าที่แสดง)
     */
    function displayMyCourses(myCourses) {
        const container = document.getElementById('my-courses-list');
        if (!myCourses || myCourses.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-center text-muted p-5">ไม่พบคอร์สเรียนที่ตรงกับเงื่อนไข</p></div>';
            return;
        }

        const placeholderImg = 'https://media.istockphoto.com/id/1449580178/vector/under-construction-sign-vector-for-banner-website-ig.jpg?s=612x612&w=0&k=20&c=Eqa3KodRrtCGvMAd0Iay7K5bsNIH37zBbnLCLDPPARQ=';

        container.innerHTML = myCourses.map(course => {
            let buttonHtml = '';
            let cardClass = 'card-course-hover';
            let badgeHtml = '';

            if (course.hasCompleted) {
                buttonHtml = `
                    <button class="btn btn-outline-success w-100" onclick="fetchLessonsForCourse('${course.CourseID}', '${course.CourseName}')">
                        <i class="bi bi-clock-history"></i> ดูประวัติ/เรียนซ้ำ
                    </button>`;
                badgeHtml = `<span class="badge rounded-pill bg-success-subtle text-success-emphasis position-absolute top-0 end-0 m-2" style="font-size: 0.75rem;">เรียนจบแล้ว</span>`;
            } else {
                buttonHtml = `
                    <button class="btn btn-primary w-100" onclick="fetchLessonsForCourse('${course.CourseID}', '${course.CourseName}')">
                        <i class="bi bi-play-circle"></i> เข้าเรียน
                    </button>`;
            }

            return `
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 shadow-sm ${cardClass}">
                        ${badgeHtml}
                        <img src="${course.CoverImageURL || placeholderImg}" class="card-img-top" alt="${course.CourseName}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title h6">${course.CourseName}</h5>
                            <p class="card-text text-muted small flex-grow-1">${(course.Description || '').substring(0, 100) + (course.Description.length > 100 ? '...' : '')}</p>
                        </div>
                        <div class="card-footer bg-transparent border-0 p-3 pt-0">
                            ${buttonHtml}
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    /**
     * [อัปเกรด] รับข้อมูล, สร้างตัวกรอง, และเรียกแสดงผลครั้งแรก
     */
    function displayCourses(data) {
        // 1. บันทึกข้อมูลที่ดึงมาลงใน Cache
        _allCoursesCache = data.allCourses || [];
        _userEnrollmentsCache = data.userEnrollments || [];

        // 2. สร้างตัวเลือกใน Dropdown หมวดหมู่
        populateCategoryFilter(data.categories || []);

        // 3. แสดงผลคอร์สตามตัวกรอง (ครั้งแรกจะแสดง "ทุกหมวดหมู่")
        renderFilteredCourses();
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้า "คอร์สทั้งหมด"
     * @param {Object} response - อ็อบเจกต์ที่ได้จาก GAS ({ allCoursesPage, userEnrollments })
     */
    function displayAllCoursesPage(response) {
        const { allCoursesPage, userEnrollments } = response;
        const { data, totalItems, totalPages, currentPage, limit } = allCoursesPage;

        // 1. อัปเดต Cache การลงทะเบียน (จำเป็นสำหรับสร้างปุ่ม)
        _userEnrollmentsCache = userEnrollments || [];

        // 2. แสดงผลการ์ดคอร์สเรียน (ฟังก์ชันใหม่)
        displayAllCourseCards(data);

        // 3. สร้าง Pagination
        buildPaginationControls('all-courses', currentPage, totalPages, totalItems, limit, 'fetchAllCourses');
    }

    /**
     * [ใหม่] (ฟังก์ชันเดิมคือ populateCategoryFilter)
     * สร้างตัวเลือกใน Dropdown หมวดหมู่
     */
    function populateCategoryFilter(categories) {
        const select = document.getElementById('all-course-category-filter');
        if (!select) return; // ป้องกัน Error
        
        // เคลียร์ตัวเลือกเก่า (เหลือแค่ "ทุกหมวดหมู่")
        select.innerHTML = '<option value="all">-- ทุกหมวดหมู่ --</option>'; 
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            select.appendChild(option);
        });
    }

    /**
     * [ใหม่] ฟังก์ชันหลักในการกรองและแสดงผลคอร์ส
     * (ดึงตรรกะเดิมของ displayCourses มาไว้ที่นี่)
     */
    function renderFilteredCourses() {
        const selectedCategory = document.getElementById('course-category-filter').value;
        
        // 1. กรองคอร์สจาก Cache ตามหมวดหมู่ที่เลือก
        const filteredCourses = (selectedCategory === 'all')
            ? _allCoursesCache // ถ้าเลือก "ทุกหมวดหมู่" ให้ใช้ทั้งหมด
            : _allCoursesCache.filter(course => course.Category === selectedCategory); // กรองตามหมวดหมู่

        // 2. แบ่งคอร์สตาม `RegistrationOpen`
        const openCourses = filteredCourses.filter(course => course.RegistrationOpen);
        const closedCourses = filteredCourses.filter(course => !course.RegistrationOpen);

        const openContainer = document.getElementById('open-courses-list');
        const closedContainer = document.getElementById('closed-courses-list');
        const placeholderImg = 'https://media.istockphoto.com/id/1449580178/vector/under-construction-sign-vector-for-banner-website-ig.jpg?s=612x612&w=0&k=20&c=Eqa3KodRrtCGvMAd0Iay7K5bsNIH37zBbnLCLDPPARQ=';

        // 3. ฟังก์ชันผู้ช่วยสำหรับสร้างการ์ด (ตรรกะเหมือนเดิมเป๊ะ)
        const createCourseCard = (course, isRegistrationOpen) => {
            const isEnrolled = _userEnrollmentsCache.some(e => String(e.CourseID) === String(course.CourseID));
            let buttonHtml = '';

            if (isRegistrationOpen) {
                if (isEnrolled) {
                    buttonHtml = `<button class="btn btn-sm btn-success w-100" disabled><i class="bi bi-check-lg"></i> ลงทะเบียนแล้ว</button>`;
                } else {
                    buttonHtml = `<button class="btn btn-sm btn-primary w-100" onclick="handleEnroll('${course.CourseID}')">ลงทะเบียนเรียน</button>`;
                }
            } else {
                buttonHtml = `<button class="btn btn-sm btn-secondary w-100" disabled>บทเรียนนี้ปิดการลงทะเบียน</button>`;
            }

            return `
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm card-course">
                        <img src="${course.CoverImageURL || placeholderImg}" class="card-img-top" alt="${course.CourseName}">
                        <div class="card-body d-flex flex-column">
                            <span class="badge bg-primary align-self-start mb-2">${course.Category || 'ทั่วไป'}</span>
                            <h5 class="card-title">${course.CourseName}</h5>
                            <p class="card-text text-muted small flex-grow-1">${course.Description || ''}</p>
                            <div class="mt-auto">${buttonHtml}</div>
                        </div>
                    </div>
                </div>`;
        };

        // 4. แสดงผลคอร์สที่เปิด (ที่กรองแล้ว)
        if (openCourses.length > 0) {
            openContainer.innerHTML = openCourses.map(course => createCourseCard(course, true)).join('');
        } else {
            openContainer.innerHTML = '<p class="text-muted">ไม่พบคอร์สเรียนที่เปิดลงทะเบียนในหมวดหมู่นี้</p>';
        }

        // 5. แสดงผลคอร์สที่ปิด (ที่กรองแล้ว)
        if (closedCourses.length > 0) {
            closedContainer.innerHTML = closedCourses.map(course => createCourseCard(course, false)).join('');
        } else {
            closedContainer.innerHTML = '<p class="text-muted">ไม่พบคอร์สเรียนที่ไม่เปิดลงทะเบียนในหมวดหมู่นี้</p>';
        }
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับสร้างการ์ดคอร์สเรียนทั้งหมด
     * (ดัดแปลงจาก renderFilteredCourses เดิม)
     */
    function displayAllCourseCards(courses) {
        const container = document.getElementById('all-courses-list');
        if (!courses || courses.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-center text-muted p-5">ไม่พบคอร์สเรียนที่ตรงกับเงื่อนไขของคุณ</p></div>';
            return;
        }

        const placeholderImg = 'https://media.istockphoto.com/id/1449580178/vector/under-construction-sign-vector-for-banner-website-ig.jpg?s=612x612&w=0&k=20&c=Eqa3KodRrtCGvMAd0Iay7K5bsNIH37zBbnLCLDPPARQ=';

        // ฟังก์ชันผู้ช่วยสำหรับสร้างการ์ด
        const createCourseCard = (course) => {
            const isEnrolled = _userEnrollmentsCache.some(e => String(e.CourseID) === String(course.CourseID));
            let buttonHtml = '';

            if (course.RegistrationOpen) {
                if (isEnrolled) {
                    buttonHtml = `<button class="btn btn-success w-100" disabled><i class="bi bi-check-lg"></i> ลงทะเบียนแล้ว</button>`;
                } else {
                    buttonHtml = `<button class="btn btn-primary w-100" onclick="handleEnroll('${course.CourseID}')">ลงทะเบียนเรียน</button>`;
                }
            } else {
                buttonHtml = `<button class="btn btn-secondary w-100" disabled>ปิดการลงทะเบียน</button>`;
            }

            return `
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 shadow-sm card-course-hover">
                        <img src="${course.CoverImageURL || placeholderImg}" class="card-img-top" alt="${course.CourseName}">
                        <div class="card-body d-flex flex-column">
                            <span class="badge bg-primary-subtle text-primary-emphasis align-self-start mb-2">${course.Category || 'ทั่วไป'}</span>
                            <h5 class="card-title h6">${course.CourseName}</h5>
                            <p class="card-text text-muted small flex-grow-1">${(course.Description || '').substring(0, 100) + (course.Description.length > 100 ? '...' : '')}</p>
                        </div>
                        <div class="card-footer bg-transparent border-0 p-3 pt-0">
                            ${buttonHtml}
                        </div>
                    </div>
                </div>`;
        };

        container.innerHTML = courses.map(createCourseCard).join('');
    }

    // --- [ใหม่] LEARNING WORKFLOW FUNCTIONS ---

    function fetchLessonsForCourse(courseId, courseName) {
        currentCourse = { CourseID: courseId, CourseName: courseName };
        showView('lesson-list-view');
        document.getElementById('lesson-list-title').textContent = courseName;
        const container = document.getElementById('lessons-container');
        container.innerHTML = `<p class="text-center">กำลังโหลดบทเรียน...</p>`;
        
        // **เปลี่ยนจาก getLessons เป็น getLessonsWithScores และส่ง currentUser.email ไปด้วย**
        google.script.run.withSuccessHandler(displayLessons)
            .getLessonsWithScores(courseId, currentUser.email);
    }

    function displayLessons(result) {
        const lessons = result.lessons;
        const allPostTestsDone = result.allPostTestsDone;
        const hasConfirmedCompletion = result.hasConfirmedCompletion;

        const lessonContainer = document.getElementById('lessons-container');
        const completionContainer = document.getElementById('course-completion-container');

        // 2. แสดงผลรายการบทเรียน (Minimal Card Style)
        if (!lessons || lessons.length === 0) {
            lessonContainer.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-journal-x fs-1 opacity-50"></i>
                    <p class="mt-2">ยังไม่มีบทเรียนในคอร์สนี้</p>
                </div>`;
        } else {
            lessonContainer.innerHTML = lessons.map((lesson, index) => {
                if (lesson.hasPostTest) {
                    // Case: เรียนจบแล้ว (Finished) -> Card สีจาง + Icon Check
                    return `
                        <div class="card border-0 bg-light rounded-4 opacity-75">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                                        <i class="bi bi-check-lg fs-5" style="color: #ffffff !important;"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0 fw-bold text-muted text-decoration-line-through">${lesson.LessonName}</h5>
                                        <small class="text-muted">เรียนแล้ว</small>
                                    </div>
                                </div>
                                <span class="badge bg-secondary rounded-pill fw-normal px-3">Completed</span>
                            </div>
                        </div>`;
                } else {
                    // Case: ยังไม่เรียน/กำลังเรียน -> Card ขาว + Shadow + Hover Effect
                    return `
                        <div class="card border-0 shadow-sm rounded-4 mb-0 transition-fast card-hover-effect" 
                            style="cursor: pointer;" 
                            onclick='selectLesson(${JSON.stringify(lesson)})'>
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                                        <i class="bi bi-play-fill fs-4 ps-1"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0 fw-bold" style="color: var(--text-main);">${lesson.LessonName}</h5>
                                        <small class="text-muted">บทที่ ${index + 1}</small>
                                    </div>
                                </div>
                                <i class="bi bi-chevron-right text-muted"></i>
                            </div>
                        </div>`;
                }
            }).join('');
        }

        // 3. แสดงปุ่มจบการศึกษา
        if (hasConfirmedCompletion) {
            completionContainer.innerHTML = `
                <div class="alert alert-success border-0 shadow-sm rounded-4 d-inline-flex align-items-center px-5 py-3">
                    <i class="bi bi-patch-check-fill fs-3 me-3"></i>
                    <span class="fw-bold fs-5">คุณเรียนจบคอร์สนี้เรียบร้อยแล้ว</span>
                </div>`;
        } else if (allPostTestsDone) {
            completionContainer.innerHTML = `
                <div class="card border-0 shadow-card rounded-4 p-4 bg-success text-center" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);">
                    
                    <h4 class="fw-bold mb-2" style="color: #ffffff !important;">🎉 ยินดีด้วย! คุณเรียนครบทุกบทเรียนแล้ว</h4>
                    
                    <p class="mb-4 opacity-75" style="color: #ffffff !important;">กรุณายืนยันการจบหลักสูตรเพื่อบันทึกผลการเรียน</p>
                    
                    <button class="btn btn-light text-success fw-bold rounded-pill px-5 py-3 shadow-lg" onclick="handleCourseCompletion()">
                        ยืนยันจบหลักสูตร
                    </button>
                </div>`;
        } else {
            completionContainer.innerHTML = '';
        }
    }

    /** [ใหม่] ฟังก์ชันสำหรับจัดการเมื่อผู้ใช้กดยืนยันการเรียนจบคอร์ส */
    function handleCourseCompletion() {
        // [เดิม] if (confirm(`คุณแน่ใจว่า...`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการจบหลักสูตร',
            text: `คุณแน่ใจว่าต้องการยืนยันว่าเรียนจบคอร์ส "${currentCourse.CourseName}" แล้วใช่หรือไม่?`,
            icon: 'warning',
            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {
                
                // [ใหม่] แสดงหน้าต่าง Loading ขณะบันทึกข้อมูล
                Swal.fire({
                    title: 'กำลังบันทึกข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // (ส่วนนี้เหมือนเดิม)
                const completionInfo = {
                    userEmail: currentUser.email,
                    courseId: currentCourse.CourseID,
                    courseName: currentCourse.CourseName
                };

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message);
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if (res.success) {
                        Swal.fire({
                            title: 'ดำเนินการสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        // โหลดหน้าบทเรียนใหม่เพื่อแสดงสถานะ "เรียนจบแล้ว"
                        fetchLessonsForCourse(currentCourse.CourseID, currentCourse.CourseName);
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).recordCourseCompletion(completionInfo);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    function selectLesson(lesson) {
        currentLesson = lesson;
        preTestResult = null;
        startTest('pre');
    }

    function startTest(testType) {
        currentTestType = testType;
        isFinalExamMode = false;
        
        showView('test-view');
        
        // Header
        document.getElementById('test-title').innerHTML = `
            <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3 py-2 me-2">
                ${testType === 'pre' ? 'Pre-test' : 'Post-test'}
            </span>
            <span style="color: var(--text-main);">แบบทดสอบ${testType === 'pre' ? 'ก่อน' : 'หลัง'}เรียน: ${currentLesson.LessonName}</span>
        `;
        
        document.getElementById('test-current-question-display').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-3">กำลังโหลดข้อสอบ...</p>
            </div>`;
        document.getElementById('test-alert-incomplete').classList.add('d-none');
        
        google.script.run.withSuccessHandler(quizData => {
            setupQuiz(quizData, 'test');
        }).getQuizData(currentUser.email, currentLesson.LessonID, testType);
    }

    // ฟังก์ชันนี้อาจไม่ได้ใช้แล้วถ้าใช้ setupQuiz แต่คงไว้เผื่อ legacy code
    function displayQuestions(questions) {
        // ... (คงเดิม หรือจะลบออกก็ได้ถ้าไม่ได้ใช้)
    }

    function displayQuestions(questions) {
        currentQuestions = questions;
        const container = document.getElementById('question-container');
        container.innerHTML = '';
        if (!questions || questions.length === 0) { container.innerHTML = "<p>ไม่พบชุดข้อสอบ</p>"; return; }
        container.innerHTML = questions.map((q, i) => `
            <div class="mb-3">
                <p><b>${i + 1}. ${q.QuestionText}</b></p>
                <div class="form-check"><input class="form-check-input" type="radio" name="q${i}" id="q${i}_a" value="A"><label class="form-check-label" for="q${i}_a">${q.OptionA}</label></div>
                <div class="form-check"><input class="form-check-input" type="radio" name="q${i}" id="q${i}_b" value="B"><label class="form-check-label" for="q${i}_b">${q.OptionB}</label></div>
                <div class="form-check"><input class="form-check-input" type="radio" name="q${i}" id="q${i}_c" value="C"><label class="form-check-label" for="q${i}_c">${q.OptionC}</label></div>
                <div class="form-check"><input class="form-check-input" type="radio" name="q${i}" id="q${i}_d" value="D"><label class="form-check-label" for="q${i}_d">${q.OptionD}</label></div>
            </div>
        `).join('');
    }

    /** [ใหม่] ฟังก์ชันสำหรับตั้งค่าและเริ่มแสดงผล UI ของแบบทดสอบ */
    function setupQuiz(quizData, viewPrefix) {
        currentQuizPrefix = viewPrefix;
        currentQuestions = quizData.questions;

        if (!currentQuestions || currentQuestions.length === 0) {
            const display = document.getElementById(`${currentQuizPrefix}-current-question-display`);
            const nav = document.getElementById(`${currentQuizPrefix}-question-nav`);
            const btns = document.getElementById(`${currentQuizPrefix}-navigation-btns`);
            
            if(display) display.innerHTML = `
                <div class="alert alert-light text-center border rounded-4 py-5">
                    <i class="bi bi-file-earmark-x text-muted fs-1"></i>
                    <p class="text-muted mt-3">ไม่พบชุดข้อสอบในระบบ</p>
                </div>`;
            if(nav) nav.innerHTML = '';
            if(btns) btns.innerHTML = '';
            return;
        }

        currentQuestionIndex = 0;
        
        const latestAnswers = quizData.latestAnswers || {}; 
        userAnswers = currentQuestions.map(q => latestAnswers[q.QuestionID] || null);
        
        renderQuizUI();
    }

    /** [ใหม่] ฟังก์ชันหลักในการวาด UI ของแบบทดสอบทั้งหมด */
    function renderQuizUI() {
        renderQuestionNavigation();
        renderCurrentQuestion();
        renderNavigationButtons();
    }

    /** [ปรับปรุง] ฟังก์ชันวาด Question Navigation */
    function renderQuestionNavigation() {
        const navContainer = document.getElementById(`${currentQuizPrefix}-question-nav`); 
        
        navContainer.innerHTML = currentQuestions.map((q, index) => {
            // Logic เช็คสถานะ
            const isAnswered = userAnswers[index] !== null ? 'answered' : '';
            const isCurrent = index === currentQuestionIndex ? 'current' : '';
            
            // ใช้ CSS class .q-nav-btn ที่เราเตรียมไว้ใน Minimalist Theme
            return `<button class="q-nav-btn ${isAnswered} ${isCurrent}" onclick="jumpToQuestion(${index})">${index + 1}</button>`;
        }).join('');
    }

    /** * [อัปเกรด] ฟังก์ชันวาดคำถามปัจจุบัน (เพิ่ม Lightbox ให้รูปภาพ) 
     */
    function renderCurrentQuestion() {
        const q = currentQuestions[currentQuestionIndex];
        const container = document.getElementById(`${currentQuizPrefix}-current-question-display`);
        const savedAnswer = userAnswers[currentQuestionIndex];

        // 1. Image Handling (เหมือนเดิม)
        let imageHtml = '';
        if (q.ImageURL && q.ImageURL.trim() !== '-') {
            imageHtml = `
                <div class="mb-3 text-center">
                    <img src="${q.ImageURL}" 
                        class="img-fluid rounded-3 shadow-sm border" 
                        alt="Question Image" 
                        style="max-height: 250px; object-fit: contain; cursor: zoom-in;"
                        onclick="showImageModal('${q.ImageURL}')">
                </div>`;
        }

        // 2. Options Rendering (Compact Style)
        let optionsHtml = '';
        ['A', 'B', 'C', 'D', 'E'].forEach(opt => {
            const optionText = q['Option' + opt];
            if (optionText || (isFinalExamMode && opt === 'E')) {
                if (!optionText && opt !== 'E') return;

                const isChecked = savedAnswer === opt;
                
                // Design Logic:
                // - Active: สีม่วงพื้นจาง
                // - Inactive: พื้นขาว ขอบบาง
                const activeClass = isChecked 
                    ? 'border-primary bg-primary bg-opacity-10' 
                    : 'border-light bg-white hover-bg-light';
                
                // ปรับสีตัวอักษร
                const textClass = isChecked ? 'text-primary fw-bold' : 'text-secondary';

                optionsHtml += `
                    <div class="d-flex align-items-center px-3 py-2 mb-2 rounded-3 border ${activeClass} transition-fast" 
                        style="cursor: pointer; position: relative;"
                        onclick="selectAnswer('${opt}')">
                        
                        <div class="flex-shrink-0 me-3 d-flex align-items-center justify-content-center rounded-circle border ${isChecked ? 'border-primary bg-primary text-white' : 'border-secondary bg-light text-muted'}" 
                            style="width: 28px; height: 28px; transition: all 0.2s;">
                            ${isChecked 
                                ? '<i class="bi bi-check" style="font-size: 1.2rem; color: #ffffff !important;"></i>' 
                                : `<span style="font-size: 0.8rem; font-weight: 700;">${opt}</span>`
                            }
                        </div>

                        <input class="form-check-input d-none" type="radio" name="q_option" 
                              id="q_${opt}" value="${opt}" 
                              ${isChecked ? 'checked' : ''}>
                        
                        <label class="form-check-label w-100 cursor-pointer ${textClass}" for="q_${opt}" style="line-height: 1.4; font-size: 0.95rem;">
                            ${optionText || ''}
                        </label>
                    </div>
                `;
            }
        });

        // 3. Render Container
        if(container.querySelector('.card-body')) { 
            // กรณี Re-render ให้แทนที่เฉพาะเนื้อหาข้างในเพื่อความเนียน
            container.querySelector('.card-body').innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-light text-secondary border rounded-pill px-3">
                        ข้อที่ ${currentQuestionIndex + 1} / ${currentQuestions.length}
                    </span>
                </div>

                ${imageHtml}
                
                <h5 class="fw-bold mb-4" style="line-height: 1.6; color: var(--text-main); font-size: 1.1rem;">
                    ${q.QuestionText}
                </h5>
                
                <div class="d-flex flex-column">
                    ${optionsHtml}
                </div>
            `;
        } else {
            // กรณี Render ครั้งแรก (สร้าง Card Wrapper)
            container.innerHTML = `
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-light text-secondary border rounded-pill px-3">
                            ข้อที่ ${currentQuestionIndex + 1} / ${currentQuestions.length}
                        </span>
                    </div>

                    ${imageHtml}
                    
                    <h5 class="fw-bold mb-4" style="line-height: 1.6; color: var(--text-main); font-size: 1.1rem;">
                        ${q.QuestionText}
                    </h5>
                    
                    <div class="d-flex flex-column">
                        ${optionsHtml}
                    </div>
                </div>`;
        }
    }
    
    function selectAnswer(selectedOpt) {
        // 1. อัปเดตตัวแปร
        saveAnswer(selectedOpt); 
        
        // 2. อัปเดต UI (Re-render เพื่อเปลี่ยนสีกล่องทันที)
        renderCurrentQuestion();
        renderQuestionNavigation();
    }
    
    /** [ปรับปรุง] วาดปุ่ม Navigation (Pill Shape & Shadows) */
    function renderNavigationButtons() {
        const btnsContainer = document.getElementById(`${currentQuizPrefix}-navigation-btns`);
        
        let backBtnHtml = '';
        if (currentQuestionIndex > 0) {
            backBtnHtml = `
                <button class="btn btn-outline-secondary rounded-pill px-4 fw-bold" onclick="prevQuestion()">
                    <i class="bi bi-arrow-left me-2"></i>ย้อนกลับ
                </button>`;
        }

        let nextBtnHtml = '';
        if (currentQuestionIndex < currentQuestions.length - 1) {
            nextBtnHtml = `
                <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-btn" onclick="nextQuestion()">
                    ถัดไป <i class="bi bi-arrow-right ms-2"></i>
                </button>`;
        } else {
            // ปุ่มส่งข้อสอบ
            nextBtnHtml = `
                <button class="btn btn-success rounded-pill px-4 fw-bold shadow-btn" onclick="submitTest()">
                    <i class="bi bi-check-circle-fill me-2"></i>ส่งข้อสอบ
                </button>`;
        }
        
        btnsContainer.innerHTML = `
            <div class="d-flex justify-content-between w-100">
                <div>${backBtnHtml}</div>
                <div>${nextBtnHtml}</div>
            </div>`;
    }

    /** [ใหม่] ฟังก์ชันสำหรับบันทึกคำตอบ */
    function saveAnswer(answer) {
        // 1. บันทึกคำตอบลงใน State ของ Frontend (เหมือนเดิม)
        userAnswers[currentQuestionIndex] = answer;
        renderQuestionNavigation(); // อัปเดตสีของปุ่ม nav

        // 2. [แก้ไข] ตรวจสอบโหมดเพื่อส่ง Log ไปยังฟังก์ชันที่ถูกต้อง
        if (isFinalExamMode) {
            // --- โหมดสอบออนไลน์ ---
            const currentQuestion = currentQuestions[currentQuestionIndex];
            const logData = {
                userEmail: currentUser.email,
                topicId: currentExamTopic.TopicID, // <-- ใช้ TopicID
                questionId: currentQuestion.QuestionID,
                selectedAnswer: answer
            };
            google.script.run.logExamAnswer(logData); // <-- เรียกฟังก์ชันใหม่
        } else {
            // --- โหมดแบบทดสอบในบทเรียน (เหมือนเดิม) ---
            const currentQuestion = currentQuestions[currentQuestionIndex];
            const logData = {
                userEmail: currentUser.email,
                lessonId: currentLesson.LessonID, // <-- ใช้ LessonID (ปลอดภัยเพราะ isFinalExamMode = false)
                questionId: currentQuestion.QuestionID,

                testType: currentTestType,
                selectedAnswer: answer
            };
            google.script.run.logAnswer(logData); // <-- เรียกฟังก์ชันเดิม
        }
    }

    /** [ใหม่] ฟังก์ชันสำหรับควบคุมปุ่ม */
    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            renderQuizUI();
        }
    }
    function nextQuestion() {
        if (currentQuestionIndex < currentQuestions.length - 1) {
            currentQuestionIndex++;
            renderQuizUI();
        }
    }
    function jumpToQuestion(index) {
        currentQuestionIndex = index;
        renderQuizUI();
    }
    
    /**
     * [อัปเกรด] ส่งข้อสอบ + SweetAlert2 + Loading
     * @param {boolean} isAutoSubmit - true = หมดเวลาส่งออโต้, false = ผู้ใช้กดส่งเอง
     */
    function submitTest(isAutoSubmit = false) {
        
        // 1. ตรวจสอบกรณีผู้ใช้กดส่งเอง (Manual Submit)
        if (!isAutoSubmit) {
            const allAnswered = userAnswers.every(answer => answer !== null);
            
            // 1.1 ถ้าตอบไม่ครบ
            if (!allAnswered) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ยังทำข้อสอบไม่ครบ',
                    text: 'กรุณาตอบคำถามให้ครบทุกข้อก่อนส่งคำตอบครับ',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    confirmButtonColor: "#198754",
                    confirmButtonText: "ตกลง"
                });
                return; // หยุดการทำงานตรงนี้ (นาฬิกายังเดินต่อ)
            }

            // 1.2 ถ้าตอบครบแล้ว -> ให้ยืนยันก่อนส่ง
            Swal.fire({
                title: 'ยืนยันการส่งข้อสอบ?',
                text: "ตรวจสอบคำตอบเรียบร้อยแล้วใช่หรือไม่?",
                icon: 'question',
                showCancelButton: true,
                allowOutsideClick: false,
                allowEscapeKey: false,
                confirmButtonColor: "#198754",
                cancelButtonColor: "#dc3545",
                confirmButtonText: "ตกลง (ส่งข้อสอบ)",
                cancelButtonText: "ยกเลิก"
            }).then((result) => {
                if (result.isConfirmed) {
                    processSubmission(); // ผู้ใช้ยืนยัน -> สั่งทำงานฟังก์ชันส่ง
                }
            });

        } else {
            // 2. กรณีหมดเวลา (Auto Submit) -> ส่งเลยไม่ต้องถาม
            processSubmission();
        }

        // --- ฟังก์ชันภายในสำหรับจัดการ Logic การส่งและ Loading ---
        function processSubmission() {
            // หยุดนาฬิกาทันทีเมื่อเริ่มกระบวนการส่ง
            if (examTimerInterval) clearInterval(examTimerInterval);

            // แสดง Loading
            Swal.fire({
                title: 'กำลังส่งคำตอบ...',
                text: 'กรุณารอสักครู่ ระบบกำลังบันทึกผลสอบ',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // แยกการทำงานตามโหมด (Final Exam / Lesson Test)
            if (isFinalExamMode) {
                // --- A. โหมดสอบจริง (Final Exam) ---
                const submissionData = {
                    userEmail: currentUser.email,
                    topicId: currentExamTopic.TopicID,
                    userAnswersArray: userAnswers
                };
                
                google.script.run
                    .withSuccessHandler(res => {
                        Swal.close(); // ปิด Loading
                        showExamSubmissionResult(res); // ไปหน้าแสดงผล
                    })
                    .withFailureHandler(error => {
                        showErrorAlert(error);
                    })
                    .submitExam(submissionData);

            } else {
                // --- B. โหมดแบบทดสอบในบทเรียน (Lesson Test) ---
                let score = 0;
                const answersForReview = currentQuestions.map((q, index) => {
                    const userAnswer = userAnswers[index];
                    if (userAnswer === q.CorrectAnswer) {
                        score++;
                    }
                    return { question: q, userAnswer: userAnswer };
                });

                // ส่งไปบันทึก Score
                google.script.run
                    .withSuccessHandler(() => {
                        // บันทึกเสร็จแล้วค่อยแสดงผล
                        Swal.close(); // ปิด Loading

                        if (currentTestType === 'pre') {
                            preTestResult = { score, total: currentQuestions.length, answers: answersForReview };
                            
                            // แจ้งเตือนคะแนนก่อนเข้าเรียน (Optional)
                            Swal.fire({
                                icon: 'success',
                                title: 'ส่งแบบทดสอบเรียบร้อย',
                                text: `คุณได้คะแนน ${score}/${currentQuestions.length}`,
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                showLessonVideo();
                            });

                        } else {
                            const postTestResult = { score, total: currentQuestions.length, answers: answersForReview };
                            displayAllResults(preTestResult, postTestResult);
                        }
                    })
                    .withFailureHandler(error => {
                        showErrorAlert(error);
                    })
                    .saveScore({
                        userId: currentUser.email, 
                        lessonId: currentLesson.LessonID,
                        testType: currentTestType, 
                        score: score, 
                        total: currentQuestions.length
                    });
            }
        }

        // Helper สำหรับแสดง Error ถ้าเน็ตหลุดหรือ Script พัง
        function showErrorAlert(error) {
            Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่สามารถส่งคำตอบได้: ' + error.message,
                confirmButtonColor: "#198754",
                confirmButtonText: "ตกลง"
            });
        }
    }

    /**
     * [ปรับปรุง] ฟังก์ชันนี้จะถูกเรียกโดยอัตโนมัติเมื่อ YouTube API พร้อมใช้งาน
     * เราจะสร้าง Player ต่อเมื่อผู้ใช้กดดูวิดีโอจริงๆ ในฟังก์ชัน showLessonVideo
     */
    function onYouTubeIframeAPIReady() {
      // API is ready
    }

    /**
     * [ปรับปรุง UI V2.1] แสดงผลเอกสารประกอบการเรียน (Smart Filename & Icons)
     */
    function showLessonVideo() {
        showView('video-view');
        document.getElementById('video-lesson-title').innerText = currentLesson.LessonName;
        
        document.getElementById('post-test-btn').disabled = true;
        document.getElementById('play-pause-btn').innerHTML = '<i class="bi bi-play-fill"></i>';

        // --- ส่วนสร้าง Card Grid ของเอกสารประกอบการเรียน ---
        const docLinksContainer = document.getElementById('doc-links-container');
        docLinksContainer.innerHTML = ''; 

        if (currentLesson.DocumentLinks && typeof currentLesson.DocumentLinks === 'string') {
            const links = currentLesson.DocumentLinks.split('\n').filter(link => link.trim() !== '');

            if (links.length > 0) {
                let cardsHtml = '<h5 class="mb-3"><i class="bi bi-paperclip"></i> เอกสารประกอบการเรียน:</h5>';
                cardsHtml += '<div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">'; // ปรับ Grid ให้เล็กลงหน่อยเพื่อให้ดูแลง่าย

                links.forEach((linkString) => {
                    const link = linkString.trim();
                    let fileName = 'เปิดดูเอกสาร';
                    let fileIcon = 'bi bi-link-45deg'; // ไอคอนเริ่มต้น (ลิ้งก์)
                    let iconColor = 'text-secondary';

                    try {
                        const url = new URL(link);
                        const hostname = url.hostname;
                        const pathname = url.pathname;
                        
                        // 1. ตรวจสอบว่าเป็น Google Drive/Docs หรือไม่
                        if (hostname.includes('drive.google.com') || hostname.includes('docs.google.com')) {
                            if (pathname.includes('/spreadsheets')) {
                                fileName = 'Google Sheets';
                                fileIcon = 'bi bi-file-earmark-spreadsheet-fill';
                                iconColor = 'text-success';
                            } else if (pathname.includes('/presentation')) {
                                fileName = 'Google Slides';
                                fileIcon = 'bi bi-file-earmark-slides-fill';
                                iconColor = 'text-warning';
                            } else if (pathname.includes('/document')) {
                                fileName = 'Google Docs';
                                fileIcon = 'bi bi-file-earmark-word-fill';
                                iconColor = 'text-primary';
                            } else {
                                fileName = 'Google Drive File';
                                fileIcon = 'bi bi-google-drive'; // ต้องการ Bootstrap Icons ที่รองรับ หรือใช้ bi-hdd-fill
                                iconColor = 'text-primary';
                            }
                        } 
                        // 2. ถ้าไม่ใช่ Google Apps ให้พยายามแกะชื่อไฟล์จาก URL
                        else {
                            // ดึงส่วนสุดท้ายของ Path
                            const rawFileName = pathname.substring(pathname.lastIndexOf('/') + 1);
                            
                            if (rawFileName && rawFileName.length > 2) {
                                fileName = decodeURIComponent(rawFileName);
                                
                                // หา Extension
                                const extension = fileName.split('.').pop().toLowerCase();
                                
                                switch (extension) {
                                    case 'pdf': 
                                        fileIcon = 'bi bi-file-earmark-pdf-fill'; iconColor = 'text-danger'; break;
                                    case 'doc': case 'docx': 
                                        fileIcon = 'bi bi-file-earmark-word-fill'; iconColor = 'text-primary'; break;
                                    case 'xls': case 'xlsx': case 'csv': 
                                        fileIcon = 'bi bi-file-earmark-excel-fill'; iconColor = 'text-success'; break;
                                    case 'ppt': case 'pptx': 
                                        fileIcon = 'bi bi-file-earmark-ppt-fill'; iconColor = 'text-warning'; break;
                                    case 'jpg': case 'jpeg': case 'png': case 'gif': 
                                        fileIcon = 'bi bi-file-earmark-image-fill'; iconColor = 'text-info'; break;
                                    case 'zip': case 'rar': 
                                        fileIcon = 'bi bi-file-earmark-zip-fill'; iconColor = 'text-dark'; break;
                                    default: 
                                        fileIcon = 'bi bi-file-earmark-text-fill'; iconColor = 'text-secondary';
                                }
                            }
                        }
                    } catch (e) {
                        console.log("Error parsing URL:", e);
                    }

                    // สร้าง HTML Card
                    cardsHtml += `
                        <div class="col">
                            <div class="card h-100 shadow-sm border-0 bg-light">
                                <a href="${link}" target="_blank" class="text-decoration-none text-dark">
                                    <div class="card-body text-center p-3 d-flex flex-column align-items-center">
                                        <i class="${fileIcon} fs-1 mb-2 ${iconColor}"></i>
                                        <h6 class="card-title small w-100 text-truncate mb-0" title="${fileName}">
                                            ${fileName}
                                        </h6>
                                        <small class="text-muted" style="font-size: 0.7rem;">คลิกเพื่อดาวน์โหลด/ดู</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                    `;
                });
                cardsHtml += '</div>';
                docLinksContainer.innerHTML = cardsHtml;
            }
        }

        // --- ส่วนของ YouTube Player (คงเดิม) ---
        if (ytPlayer) { ytPlayer.destroy(); }
        try {
            const urlParts = currentLesson.VideoURL.split('/');
            const videoId = urlParts[urlParts.length - 1].split('?')[0];
            ytPlayer = new YT.Player('youtube-player', {
                height: '100%', width: '100%', videoId: videoId,
                playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        } catch (e) {
            console.error("Invalid Video URL");
        }
    }

    /**
     * [ใหม่] ฟังก์ชันนี้จะถูกเรียกเมื่อ Player พร้อมใช้งาน
     * ทำหน้าที่ดึงค่าความเร็วที่วิดีโอรองรับมาสร้างเป็นตัวเลือก
     */
    function onPlayerReady(event) {
        const availableRates = event.target.getAvailablePlaybackRates();
        populateSpeedOptions(availableRates);
    }

    /**
     * [ใหม่] สร้างตัวเลือกความเร็วใน Dropdown menu
     */
    function populateSpeedOptions(rates) {
        const speedOptionsContainer = document.getElementById('speed-options');
        speedOptionsContainer.innerHTML = ''; // เคลียร์ตัวเลือกเก่าทิ้ง
        
        rates.forEach(rate => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.href = '#';
            a.textContent = `${rate}x`;
            a.onclick = (e) => {
                e.preventDefault();
                setPlaybackSpeed(rate);
            };
            li.appendChild(a);
            speedOptionsContainer.appendChild(li);
        });
    }

    /**
     * [ใหม่] สั่งให้ Player เปลี่ยนความเร็วและอัปเดตข้อความบนปุ่ม
     */
    function setPlaybackSpeed(rate) {
        if (ytPlayer) {
            ytPlayer.setPlaybackRate(rate);
            document.getElementById('speed-btn').textContent = `${rate}x`;
        }
    }

    /**
     * [ใหม่] ฟังก์ชันจัดการเมื่อสถานะของวิดีโอเปลี่ยน (เล่น, หยุด, จบ)
     */
    function onPlayerStateChange(event) {
        const playPauseBtn = document.getElementById('play-pause-btn');
        
        // อัปเดตไอคอนปุ่ม Play/Pause
        if (event.data == YT.PlayerState.PLAYING) {
            playPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
        } else {
            playPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        }
        
        // เปิดใช้งานปุ่ม Post-Test เมื่อวิดีโอจบ
        if (event.data == YT.PlayerState.ENDED) {
            document.getElementById('post-test-btn').disabled = false;
        }
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับปุ่ม Play/Pause ที่สร้างขึ้นเอง
     */
    function togglePlayPause() {
        if (!ytPlayer || typeof ytPlayer.getPlayerState !== 'function') return;
        
        const playerState = ytPlayer.getPlayerState();
        if (playerState == YT.PlayerState.PLAYING) {
            ytPlayer.pauseVideo();
        } else {
            ytPlayer.playVideo();
        }
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับปรับระดับเสียง
     */
    function setVolume(volumeLevel) {
        if (ytPlayer && typeof ytPlayer.setVolume === 'function') {
            ytPlayer.setVolume(volumeLevel);
        }
    }

    /**
     * [ใหม่] ฟังก์ชันสั่งหยุดวิดีโอและเคลียร์ Player
     * ใช้เรียกเมื่อมีการเปลี่ยนหน้าจอออกจากหน้าเรียน
     */
    function stopVideoPlayback() {
        // ตรวจสอบว่ามีตัวแปร ytPlayer และฟังก์ชัน stopVideo หรือไม่
        if (typeof ytPlayer !== 'undefined' && ytPlayer && typeof ytPlayer.stopVideo === 'function') {
            try {
                ytPlayer.stopVideo(); // สั่งหยุดวิดีโอทันที
                // ytPlayer.destroy(); // (ทางเลือก) ถ้าต้องการทำลาย Player ทิ้งเพื่อคืน Ram ให้เปิดบรรทัดนี้
            } catch (e) {
                console.log("Error stopping video: " + e.message);
            }
        }
    }

    function displayAllResults(preResult, postResult) {
        showView('results-view');

        // 1. คำนวณส่วนต่างของคะแนน
        const scoreDiff = postResult.score - preResult.score;
        
        // ตั้งค่าตัวแปรสำหรับการแสดงผล (สี, ไอคอน, ข้อความ)
        let diffClass = 'alert-secondary'; // สีเทา (เท่าเดิม)
        let diffIcon = 'bi-dash-circle-fill';
        let diffText = 'คะแนนเท่าเดิม';
        let diffTextColor = 'var(--text-muted)';

        if (scoreDiff > 0) {
            diffClass = 'alert-success'; // สีเขียว (ดีขึ้น)
            diffIcon = 'bi-trophy-fill';
            diffText = `ยอดเยี่ยม! พัฒนาขึ้น +${scoreDiff} คะแนน`;
            diffTextColor = '#009476';
        } else if (scoreDiff < 0) {
            diffClass = 'alert-danger'; // สีแดง (ลดลง)
            diffIcon = 'bi-exclamation-triangle-fill';
            diffText = `คะแนนลดลง ${Math.abs(scoreDiff)} คะแนน (ทบทวนอีกนิดนะ)`;
            diffTextColor = '#d63031';
        }

        // 2. สร้าง HTML ตาม Layout 3 แถว
        document.getElementById('score-display').className = ''; // ลบคลาสเดิมของ container ออกเพื่อจัด Layout เอง
        document.getElementById('score-display').innerHTML = `
            
            <div class="text-center mb-4">
                <h3 style="color: var(--text-main);">สรุปผลการประเมิน</h3>
                <p class="text-muted">เปรียบเทียบผลคะแนนสอบก่อนและหลังเรียน</p>
            </div>

            <div class="row g-4 justify-content-center align-items-stretch mb-4">
                
                <div class="col-5 col-md-4">
                    <div class="h-100 p-4 rounded-4 text-center" 
                        style="background-color: var(--bg-light); border: 1px solid var(--border-color);">
                        <div class="text-uppercase fw-bold text-muted mb-2" style="font-size: 0.8rem; letter-spacing: 1px;">
                            คะแนนก่อนเรียน
                        </div>
                        <div class="display-3 fw-bold text-secondary mb-0">
                            ${preResult.score}
                        </div>
                        <span class="badge bg-secondary bg-opacity-25 text-secondary rounded-pill fw-normal px-3">
                            เต็ม ${preResult.total}
                        </span>
                    </div>
                </div>

                <div class="col-1 d-flex align-items-center justify-content-center">
                    <i class="bi bi-arrow-right d-none d-md-block text-muted fs-2 opacity-50"></i>
                    <i class="bi bi-arrow-down d-md-none text-muted fs-2 opacity-50"></i>
                </div>

                <div class="col-5 col-md-4">
                    <div class="h-100 p-4 rounded-4 text-center position-relative" 
                        style="background-color: #fff; 
                                border: 2px solid var(--color-primary); 
                                box-shadow: 0 10px 30px rgba(108, 92, 231, 0.15);">
                        
                        <div class="position-absolute top-0 start-50 translate-middle">
                            <span class="badge rounded-pill px-3 py-1" style="background-color: var(--color-primary);">
                                ล่าสุด
                            </span>
                        </div>

                        <div class="text-uppercase fw-bold mb-2 mt-2" style="color: var(--color-primary); font-size: 0.8rem; letter-spacing: 1px;">
                            คะแนนหลังเรียน
                        </div>
                        <div class="display-3 fw-bold mb-0" style="color: var(--text-main);">
                            ${postResult.score}
                        </div>
                        <span class="badge bg-primary bg-opacity-10 rounded-pill fw-normal px-3" style="color: var(--color-primary);">
                            เต็ม ${postResult.total}
                        </span>
                    </div>
                </div>
            </div>

            <div class="alert ${diffClass} text-center shadow-sm border-0" role="alert">
                <i class="bi ${diffIcon} fs-5 me-2"></i>
                <span class="fs-5 fw-bold">${diffText}</span>
            </div>
            
            <hr class="my-5" style="border-color: var(--border-color); opacity: 0.5;">
        `;

        // 3. แสดงเฉลย (ส่วนนี้คงเดิม หรือปรับตามต้องการ)
        const detailsContainer = document.getElementById('results-details');
        detailsContainer.innerHTML = createResultDetailSection('เฉลยแบบทดสอบก่อนเรียน', preResult.answers) +
                                    createResultDetailSection('เฉลยแบบทดสอบหลังเรียน', postResult.answers);
    }
    
    function createResultDetailSection(title, answers) {
        if (!answers || answers.length === 0) return '';

        // ส่วนหัวข้อ (Header)
        let html = `
            <div class="mt-5 result-section">
                <div class="d-flex align-items-center mb-4">
                    <div class="rounded-pill me-3" style="width: 5px; height: 30px; background-color: var(--color-primary);"></div>
                    <h4 class="fw-bold m-0" style="color: var(--text-main);">${title}</h4>
                </div>
                
                <div class="row g-3">
        `;

        answers.forEach((ans, index) => {
            // 1. ตรวจสอบความถูกต้อง
            const isCorrect = ans.userAnswer === ans.question.CorrectAnswer;
            
            // 2. ดึงข้อมูลคำอธิบาย (สมมติว่าอยู่ใน ans.question.Explanation)
            // ถ้าใน Database คุณใช้ชื่อฟิลด์อื่น ให้แก้ตรง .Explanation เป็นชื่อนั้นครับ
            const explanationText = ans.question.Explanation || ""; 
            const hasExplanation = explanationText && explanationText.trim() !== "";
            
            // 3. สร้าง ID สำหรับปุ่ม Collapse (ต้องไม่ซ้ำกัน)
            // ใช้ Math.random ช่วยเพื่อให้ ID ไม่ชนกันแม้เรียกฟังก์ชันนี้ 2 รอบ (Pre/Post)
            const uniqueId = `expl-${index}-${Math.floor(Math.random() * 10000)}`;

            // 4. ตั้งค่าสีและไอคอน
            const borderColor = isCorrect ? 'var(--color-success)' : 'var(--color-danger)';
            const icon = isCorrect 
                ? '<i class="bi bi-check-circle-fill" style="color: var(--color-success); font-size: 1.5rem;"></i>' 
                : '<i class="bi bi-x-circle-fill" style="color: var(--color-danger); font-size: 1.5rem;"></i>';
            
            const userAnswerBg = isCorrect ? 'rgba(0, 184, 148, 0.05)' : 'rgba(255, 118, 117, 0.05)';
            const userAnswerColor = isCorrect ? 'var(--color-success)' : 'var(--color-danger)';

            // 5. สร้าง HTML การ์ด
            html += `
                <div class="col-12 col-md-6">
                    <div class="card h-100 border-0 shadow-sm d-flex flex-column" 
                        style="background: #fff; border-radius: 12px; border-left: 6px solid ${borderColor} !important;">
                        
                        <div class="card-body p-4 flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="badge rounded-pill text-muted bg-light border border-light-subtle px-3 py-2" 
                                      style="font-weight: 600;">
                                    ข้อที่ ${index + 1}
                                </span>
                                ${icon}
                            </div>

                            <h6 class="card-title fw-bold mb-4" style="line-height: 1.6; color: var(--text-main);">
                                ${ans.question.QuestionText}
                            </h6>

                            <div class="d-flex flex-column gap-2 mb-3">
                                <div class="p-3 rounded-3 d-flex justify-content-between align-items-center"
                                    style="background-color: ${userAnswerBg};">
                                    <div class="small text-muted fw-bold me-2" style="min-width: 60px;">ตอบ:</div>
                                    <div class="text-end fw-bold" style="color: ${userAnswerColor};">
                                        ${ans.userAnswer}
                                    </div>
                                </div>

                                ${!isCorrect ? `
                                    <div class="p-3 rounded-3 d-flex justify-content-between align-items-center"
                                        style="background-color: rgba(0, 184, 148, 0.1);">
                                        <div class="small text-muted fw-bold me-2" style="min-width: 60px;">เฉลย:</div>
                                        <div class="text-end fw-bold" style="color: var(--color-success);">
                                            ${ans.question.CorrectAnswer}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            ${hasExplanation ? `
                                <button class="btn btn-sm btn-light w-100 rounded-pill py-2 text-primary fw-bold border-0 mt-auto" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#${uniqueId}" 
                                        aria-expanded="false" 
                                        style="background-color: var(--bg-light); transition: all 0.2s;">
                                    <i class="bi bi-lightbulb-fill me-2"></i>ดูคำอธิบาย
                                </button>
                                
                                <div class="collapse mt-2" id="${uniqueId}">
                                    <div class="p-3 rounded-3 bg-white border border-light-subtle shadow-sm d-flex align-items-start">
                                        
                                        <i class="bi bi-info-circle-fill text-primary fs-5 me-3 flex-shrink-0 mt-1"></i>
                                        
                                        <div class="text-muted" style="font-size: 0.9rem; line-height: 1.6;">
                                            ${explanationText}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                        </div>
                    </div>
                </div>
            `;
        });

        html += `
                </div> </div> `;

        return html;
    }

    /**
     * [แก้ไข] ดึงข้อมูลประวัติการเรียน (แบบแบ่งหน้า)
     * @param {number} page - เลขหน้าที่ต้องการ
     */
    function fetchHistory(page = 1) {
        if (!currentUser) { return; }
        showView('history-view');
        const container = document.getElementById('history-table-body');
        container.innerHTML = `<tr><td colspan="6" class="text-center">กำลังโหลดประวัติ...</td></tr>`;
        
        // [ใหม่] รวบรวม options จาก UI
        const options = {
            page: page,
            limit: document.getElementById('history-limit').value,
            searchTerm: document.getElementById('history-search').value
        };
        
        // [แก้ไข] เรียกใช้ฟังก์ชัน Backend ที่อัปเกรดแล้ว และส่ง options ไปด้วย
        google.script.run.withSuccessHandler(displayHistoryPage)
            .getHistoryDetails(currentUser.email, options);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้า "ประวัติการเรียน" (ตาราง + pagination)
     * @param {Object} response - อ็อบเจกต์ pagination ที่ได้จาก GAS
     */
    function displayHistoryPage(response) {
        const { data, totalItems, totalPages, currentPage, limit } = response;

        // 1. คำนวณลำดับเริ่มต้น
        const startItemIndex = (currentPage - 1) * limit;

        // 2. แสดงตาราง (ส่งลำดับเริ่มต้นไปด้วย)
        displayHistoryTable(data, startItemIndex);

        // 3. สร้าง Pagination
        buildPaginationControls('history', currentPage, totalPages, totalItems, limit, 'fetchHistory');
    }

    /**
     * [แก้ไข] แสดงผลประวัติการเรียนในรูปแบบตาราง
     * @param {Array} historyData - ข้อมูลประวัติ (เฉพาะหน้านี้)
     * @param {number} startItemIndex - ลำดับเริ่มต้นของรายการ (เช่น 0, 10, 20)
     */
    function displayHistoryTable(historyData, startItemIndex = 0) {
        const container = document.getElementById('history-table-body');
        if (!historyData || historyData.length === 0) {
            container.innerHTML = `<tr><td colspan="6" class="text-center">ไม่พบข้อมูลประวัติการเรียน</td></tr>`;
            return;
        }

        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };

        container.innerHTML = historyData.map((item, index) => {
            const itemNumber = startItemIndex + index + 1; // [แก้ไข] คำนวณลำดับที่ถูกต้อง
            const enrollmentDate = item.enrollmentTimestamp ? new Date(item.enrollmentTimestamp).toLocaleString('th-TH', options) : 'N/A';
            const completionDate = item.completionTimestamp ? new Date(item.completionTimestamp).toLocaleString('th-TH', options) : 'N/A';

            return `
                <tr>
                    <th scope="row">${itemNumber}</th> <td>${item.courseName}</td>
                    <td>${enrollmentDate}</td>
                    <td>${completionDate}</td>
                    <td>${item.totalTime}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showAnswerReview('${item.courseId}', '${item.courseName}')">
                            <i class="bi bi-search"></i> ดูเฉลย
                        </button>
                    </td>
                </tr>`;
        }).join('');
    }

    /**
     * [ใหม่] เริ่มกระบวนการแสดงหน้าเฉลย
     */
    function showAnswerReview(courseId, courseName) {
        showView('answer-review-view');
        document.getElementById('answer-review-title').textContent = `เฉลย: ${courseName}`;
        
        const container = document.getElementById('answer-review-container');
        // Loading State แบบ Minimal
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <p class="text-muted">กำลังดึงข้อมูลเฉลย...</p>
            </div>
        `;
        
        google.script.run.withSuccessHandler(displayAnswerReview).getCourseAnswerReview(currentUser.email, courseId);
    }

    /**
     * [อัปเกรด] แสดงผลเฉลยคำตอบโดยแบ่งเป็น Pre-test และ Post-test
     */
    function displayAnswerReview(reviewData) {
        const container = document.getElementById('answer-review-container');
        
        if (!reviewData || reviewData.length === 0) {
            container.innerHTML = `
                <div class="alert alert-light text-center border rounded-4 py-5">
                    <i class="bi bi-folder-x text-muted fs-1 mb-3 d-block"></i>
                    <p class="text-muted mb-0">ไม่พบข้อมูลเฉลยสำหรับคอร์สนี้</p>
                </div>
            `;
            return;
        }

        // --- [จุดที่แก้ไข] ---
        // เพิ่มเงื่อนไข || q.TestType === 'both' เพื่อดึงข้อสอบที่เป็น both มาแสดงด้วย
        
        // 1. ให้ข้อสอบ both ไปแสดงใน Pre-test ด้วย
        const preTestQuestions = reviewData.filter(q => q.TestType === 'pre' || q.TestType === 'both');
        
        // 2. ให้ข้อสอบ both ไปแสดงใน Post-test ด้วย
        const postTestQuestions = reviewData.filter(q => q.TestType === 'post' || q.TestType === 'both');
        // ------------------

        // 2. สร้าง HTML Helper สำหรับหัวข้อ Section
        const createSectionHeader = (title, colorVar) => `
            <div class="d-flex align-items-center mb-4 mt-5">
                <div class="rounded-pill me-3" style="width: 5px; height: 30px; background-color: var(${colorVar});"></div>
                <h4 class="fw-bold m-0" style="color: var(--text-main);">${title}</h4>
            </div>
        `;

        let htmlContent = '';

        // 3. ประกอบร่าง Pre-test
        if (preTestQuestions.length > 0) {
            htmlContent += createSectionHeader('แบบทดสอบก่อนเรียน (Pre-test)', '--text-muted');
            // ส่ง 'pre' ไปเพื่อใช้สร้าง ID ของ Accordion ไม่ให้ชนกัน
            htmlContent += renderReviewCards(preTestQuestions, 'pre');
        }

        // 4. ประกอบร่าง Post-test
        if (postTestQuestions.length > 0) {
            htmlContent += createSectionHeader('แบบทดสอบหลังเรียน (Post-test)', '--color-primary');
            // ส่ง 'post' ไปเพื่อใช้สร้าง ID ของ Accordion ไม่ให้ชนกัน
            htmlContent += renderReviewCards(postTestQuestions, 'post');
        }

        container.innerHTML = htmlContent;
    }

    /**
     * [ใหม่] ฟังก์ชันผู้ช่วยสำหรับสร้าง HTML ของการ์ดเฉลยแต่ละข้อ
     * @param {Array} questions - อาร์เรย์ของคำถาม (ที่กรองแล้ว)
     * @returns {string} - โค้ด HTML
     */
    function renderReviewCards(questions, typeSuffix) {
        if (!questions || questions.length === 0) return '';

        return `<div class="row g-4">` + questions.map((q, index) => {
            const isCorrect = q.UserAnswer === q.CorrectAnswer;
            const options = ['A', 'B', 'C', 'D'];
            
            // กำหนดสี Theme ของการ์ด
            const borderColor = isCorrect ? 'var(--color-success)' : 'var(--color-danger)';
            const statusIcon = isCorrect 
                ? '<i class="bi bi-check-circle-fill text-success fs-4"></i>' 
                : '<i class="bi bi-x-circle-fill text-danger fs-4"></i>';

            // ID สำหรับ Collapse
            const collapseId = `review-explain-${typeSuffix}-${index}`;
            const hasExplanation = q.Explanation && q.Explanation.trim() !== '';

            // สร้าง HTML ของตัวเลือก (Options)
            const optionsHtml = options.map(opt => {
                const optText = q['Option' + opt];
                let optClass = "border border-light-subtle bg-light text-muted"; // Default style
                let iconHtml = "";

                // Logic การใส่สีตัวเลือก
                if (opt === q.CorrectAnswer) {
                    // ข้อที่ถูก (สีเขียวเสมอ)
                    optClass = "border-success bg-success bg-opacity-10 text-success fw-bold";
                    iconHtml = '<i class="bi bi-check-lg ms-auto"></i>';
                } 
                
                if (opt === q.UserAnswer && opt !== q.CorrectAnswer) {
                    // ข้อที่ตอบผิด (สีแดง)
                    optClass = "border-danger bg-danger bg-opacity-10 text-danger fw-bold";
                    iconHtml = '<i class="bi bi-x-lg ms-auto"></i>';
                } else if (opt === q.UserAnswer && opt === q.CorrectAnswer) {
                    // ข้อที่ตอบถูก (เน้นเขียวอีกนิด)
                    optClass = "border-success bg-success bg-opacity-10 text-success fw-bold"; // Highlight เต็มๆ
                    iconHtml = '<i class="bi bi-check-circle-fill ms-auto"></i>';
                }

                return `
                    <div class="d-flex align-items-center p-3 rounded-3 mb-2 ${optClass}" style="transition: all 0.2s;">
                        <span class="me-3" style="min-width: 25px;">${opt}.</span>
                        <span class="flex-grow-1">${optText}</span>
                        ${iconHtml}
                    </div>
                `;
            }).join('');

            return `
                <div class="col-12 col-lg-10 mx-auto"> <div class="card border-0 shadow-sm h-100" 
                        style="border-radius: 16px; border-left: 6px solid ${borderColor} !important;">
                        
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <span class="badge rounded-pill bg-light text-secondary border mb-2">ข้อที่ ${index + 1}</span>
                                    <h5 class="card-title fw-bold" style="line-height: 1.6;">${q.QuestionText}</h5>
                                </div>
                                <div class="ps-3">${statusIcon}</div>
                            </div>

                            <div class="mb-3">
                                ${optionsHtml}
                            </div>

                            ${hasExplanation ? `
                                <button class="btn btn-sm btn-light w-100 rounded-pill py-2 text-primary fw-bold border-0" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#${collapseId}" 
                                        style="background-color: var(--bg-light);">
                                    <i class="bi bi-lightbulb-fill me-2"></i>ดูคำอธิบาย
                                </button>
                                
                                <div class="collapse mt-2" id="${collapseId}">
                                    <div class="p-3 rounded-3 bg-white border border-light-subtle shadow-sm d-flex align-items-start">
                                        
                                        <i class="bi bi-info-circle-fill text-primary fs-5 me-3 flex-shrink-0 mt-1"></i>
                                        
                                        <div class="text-muted small" style="line-height: 1.6;">
                                            ${q.Explanation}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('') + `</div>`;
    }

    /**
     * [แก้ไข] ดึงข้อมูลผู้ใช้ทั้งหมด (แบบมี Pagination + Role Filter)
     * @param {number} page - เลขหน้าที่ต้องการ
     */
    function fetchUserManagement(page = 1) {
        showView('admin-user-management-view');
        const tbody = document.getElementById('user-table-body');
        
        // ใส่ Loading เฉพาะตอนโหลดหน้าแรก หรือถ้าตารางว่างอยู่
        if (page === 1 || tbody.innerHTML.trim() === "") {
             tbody.innerHTML = '<tr><td colspan="6" class="text-center">กำลังโหลดข้อมูลผู้ใช้...</td></tr>';
        }
        
        // [ใหม่] ดึงค่า settings จาก UI
        const searchTerm = document.getElementById('user-search-input').value;
        const limit = document.getElementById('user-limit-select').value;
        const roleFilter = document.getElementById('user-role-filter').value; // [เพิ่ม] ดึงค่า Role Filter

        // [แก้ไข] รวม roleFilter เข้าไปใน options
        const options = { 
            page: page, 
            limit: limit, 
            searchTerm: searchTerm,
            roleFilter: roleFilter // ส่งไปที่ GAS
        };

        // [แก้ไข] ส่ง options ไปยัง GAS และเรียกฟังก์ชัน displayUserPage
        google.script.run.withSuccessHandler(displayUserPage).getAllUsers(options);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้าผู้ใช้งาน (ตาราง + pagination)
     * @param {Object} response - อ็อบเจกต์ที่ได้จาก GAS (มี data, totalItems, totalPages, ...)
     */
    function displayUserPage(response) {
      const { data, totalItems, totalPages, currentPage, limit } = response;
      
      // 1. แสดงตาราง (ใช้ฟังก์ชันเดิม)
      displayUserTable(data);
      
      // 2. สร้าง Pagination
      buildPaginationControls('user', currentPage, totalPages, totalItems, limit, 'fetchUserManagement');
    }

    /**
     * (ฟังก์ชันเดิม) แสดงตารางผู้ใช้
     * @param {Array} users - ข้อมูลผู้ใช้ (เฉพาะหน้านี้)
     */
    function displayUserTable(users) {
        const tbody = document.getElementById('user-table-body');
        if (!users || users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">ไม่พบข้อมูลผู้ใช้</td></tr>';
            return;
        }

        tbody.innerHTML = users.map(user => {
            // [แก้ไข] ตรวจสอบ IsActive ที่ส่งมาจาก GAS
            const statusBadge = user.IsActive 
                ? `<span class="badge bg-success">Active</span>` 
                : `<span class="badge bg-secondary">Inactive</span>`;

            return `
                <tr>
                    <td>${user.FirstName} ${user.LastName}</td>
                    <td>${user.Email}</td>
                    <td>${user.StudentID || '-'}</td>
                    <td><span class="badge bg-${user.Role === 'Admin' ? 'warning' : 'info'}">${user.Role}</span></td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="fetchUserHistory('${user.Email}', '${user.FirstName} ${user.LastName}')">ดูประวัติ</button>
                        <button class="btn btn-sm btn-primary me-1" onclick='openEditUserModal(${JSON.stringify(user)})'>แก้ไข</button>
                        <button class="btn btn-sm btn-danger" onclick='initiateDeleteUser(${JSON.stringify(user)})' ${currentUser.email === user.Email ? 'disabled' : ''}>ลบ</button>
                    </td>
                </tr>`;
        }).join('');
    }

    /** [ใหม่] ฟังก์ชันเปิด Modal สำหรับเพิ่มผู้ใช้ */
    function openAddUserModal() {
        // เคลียร์ฟอร์มเก่าและซ่อนข้อความ error (ถ้ามี)
        document.getElementById('add-user-form').reset();
        document.getElementById('add-user-error').classList.add('d-none');

        const addModal = new bootstrap.Modal(document.getElementById('addUserModal'));
        addModal.show();
    }

    /** [แก้ไข] ฟังก์ชันจัดการการ submit ฟอร์มเพิ่มผู้ใช้ใหม่ */
    function handleAddNewUser(event) {
        event.preventDefault();
        const addUserForm = document.getElementById('add-user-form');
        const errorDiv = document.getElementById('add-user-error');
        
        // ซ่อน error เก่าถ้ามี
        if(errorDiv) errorDiv.classList.add('d-none'); 

        const password = document.getElementById('add-password').value;
        const confirm = document.getElementById('add-confirm-password').value;

        // ตรวจสอบรหัสผ่าน
        if (password !== confirm) {
            Swal.fire({
                title: 'ข้อมูลไม่ถูกต้อง',
                text: 'รหัสผ่านไม่ตรงกัน',
                icon: 'warning',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
            return;
        }

        // รวบรวมข้อมูลจากฟอร์ม
        const userData = {
            prefix: document.getElementById('add-prefix').value,
            firstName: document.getElementById('add-firstName').value,
            lastName: document.getElementById('add-lastName').value,
            studentId: document.getElementById('add-studentId').value,
            classYear: document.getElementById('add-classYear').value,
            phone: document.getElementById('add-phone').value,
            email: document.getElementById('add-email').value,
            role: document.getElementById('add-role').value, // รับค่า Role ที่เลือก
            password: password,
        };

        // แสดง Loading
        Swal.fire({
            title: 'กำลังเพิ่มผู้ใช้',
            text: 'กรุณารอสักครู่',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // [จุดที่แก้ไข] เปลี่ยนจาก registerUser เป็น createUserByAdmin
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                Swal.fire({
                    title: 'ดำเนินการสำเร็จ!',
                    text: res.message,
                    icon: 'success',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });

                // ปิด Modal
                const modalEl = document.getElementById('addUserModal');
                const addModal = bootstrap.Modal.getInstance(modalEl);
                addModal.hide();
                
                // เคลียร์ค่าและโหลดตารางใหม่
                addUserForm.reset();
                fetchUserManagement(1); // รีโหลดหน้า 1
            } else {
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: res.message,
                    icon: 'error',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            }
        }).createUserByAdmin(userData); // <-- เรียกฟังก์ชันใหม่
    }

    /** [ใหม่] ฟังก์ชันเปิด Modal และเติมข้อมูลผู้ใช้เดิม */
    function openEditUserModal(user) {
        document.getElementById('edit-userId-hidden').value = user.UserID;
        document.getElementById('edit-email').value = user.Email;
        document.getElementById('edit-firstName').value = user.FirstName;
        document.getElementById('edit-lastName').value = user.LastName;
        document.getElementById('edit-studentId').value = user.StudentID;
        document.getElementById('edit-role').value = user.Role;

        // [ใหม่] เคลียร์ช่องรหัสผ่าน
        document.getElementById('edit-password').value = '';
        document.getElementById('edit-confirm-password').value = '';

        new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }

    /** [ใหม่] ฟังก์ชันจัดการการ submit ฟอร์มแก้ไขข้อมูล */
    function handleUpdateUser(event) {
        event.preventDefault();

        // [ใหม่] ดึงค่ารหัสผ่าน
        const newPassword = document.getElementById('edit-password').value;
        const confirmPassword = document.getElementById('edit-confirm-password').value;

        // [ใหม่] ตรวจสอบรหัสผ่าน (ถ้ามีการกรอก)
        if (newPassword && newPassword !== confirmPassword) {
            Swal.fire({
                title: 'ข้อมูลไม่ถูกต้อง',
                text: 'รหัสผ่านใหม่และการยืนยันไม่ตรงกัน',
                icon: 'warning',
                allowOutsideClick: false
            });
            return;
        }

        const userData = {
            userId: document.getElementById('edit-userId-hidden').value,
            firstName: document.getElementById('edit-firstName').value,
            lastName: document.getElementById('edit-lastName').value,
            studentId: document.getElementById('edit-studentId').value,
            role: document.getElementById('edit-role').value,
            password: newPassword // [ใหม่] ส่งรหัสผ่านไป (ถ้าว่าง Backend จะข้ามเอง)
        };

        Swal.fire({
            title: 'กำลังอัปเดตข้อมูล',
            text: 'กรุณารอสักครู่',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => { Swal.showLoading(); }
        });

        google.script.run.withSuccessHandler(res => {
            // ... (โค้ดเดิมของคุณ - การแสดงผล Swal.fire success/error) ...
            if (res.success) {
                Swal.fire({ title: 'อัปเดตสำเร็จ!', text: res.message, icon: 'success' });
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                fetchUserManagement();
            } else {
                Swal.fire({ title: 'เกิดข้อผิดพลาด', text: res.message, icon: 'error' });
            }
        }).updateUser(userData);
    }
    
    // [Frontend] ใน index.html

    /**
    * [ใหม่] ฟังก์ชันตัวกลางสำหรับตรวจสอบ Role ก่อนลบ
    * (ฟังก์ชันนี้จะถูกเรียกจากปุ่ม "ลบ" ในตาราง)
    * @param {object} user - อ็อบเจกต์ของผู้ใช้ (ต้องมี Email และ Role)
    */
    function initiateDeleteUser(user) {
        // ล้างสถานะ Error เก่า (ถ้ามี) (ส่วนนี้สำหรับ Bootstrap Modal)
        document.getElementById('admin-delete-password-input').value = '';
        document.getElementById('admin-delete-error').classList.add('d-none');

        if (user.Role === 'Admin') {
            // [กรณีเป็น Admin] -> เปิด Modal ยืนยันรหัสผ่าน (เหมือนเดิม)
            document.getElementById('admin-delete-email-hidden').value = user.Email;
            const deleteModal = new bootstrap.Modal(document.getElementById('adminDeletePasswordModal'));
            deleteModal.show();
        } else {
            // [กรณีเป็น Role อื่น] -> ใช้การยืนยันแบบ SweetAlert2
            // [เดิม] if (confirm(`...`)) { ... }
            // [ใหม่]
            Swal.fire({
                title: 'ยืนยันการลบผู้ใช้',
                text: `คุณต้องการลบผู้ใช้งาน ${user.Email} (Role: ${user.Role}) ใช่หรือไม่?`,
                icon: 'warning',
                
                allowOutsideClick: false, // ตามที่คุณกำหนด
                allowEscapeKey: false,  // ตามที่คุณกำหนด

                showCancelButton: true,      // ตามที่คุณกำหนด
                confirmButtonColor: "#198754", // ตามที่คุณกำหนด
                cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
                confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
                cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

            }).then((result) => {
                // ถ้าผู้ใช้กดยืนยัน (ตกลง)
                if (result.isConfirmed) {

                    // [ใหม่] แสดงหน้าต่าง Loading ก่อนเรียก Server
                    Swal.fire({
                        title: 'กำลังลบผู้ใช้',
                        text: 'กรุณารอสักครู่',
                        icon: 'info',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // ส่ง null เป็นพารามิเตอร์รหัสผ่าน
                    google.script.run.withSuccessHandler(handleDeleteUserResponse).deleteUser(user.Email, null);
                }
                // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
            });
        }
    }

    /**
     * [แก้ไข] ฟังก์ชันสำหรับจัดการการส่งรหัสผ่านจาก Modal
     */
    function handleAdminPasswordSubmit() {
        const email = document.getElementById('admin-delete-email-hidden').value;
        const password = document.getElementById('admin-delete-password-input').value;
        const errorDiv = document.getElementById('admin-delete-error');

        // ตรวจสอบว่ากรอกรหัสหรือไม่
        if (!password) {
            Swal.fire({
                icon: 'warning',
                text: 'กรุณากรอกรหัสผ่าน',
                confirmButtonColor: "#198754",
                confirmButtonText: "ตกลง"
            });
            return;
        }

        // ซ่อนข้อความ Error เดิม
        if(errorDiv) errorDiv.classList.add('d-none');

        // แสดง Loading
        Swal.fire({
            title: 'กำลังตรวจสอบ...',
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // ส่งอีเมลและรหัสผ่านไปให้ Backend ตรวจสอบ
        google.script.run
            .withSuccessHandler(handleDeleteUserResponse) // กรณีสำเร็จ
            .withFailureHandler((error) => {              // <--- [สำคัญ] เพิ่มกรณี Error จาก Server
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message,
                    confirmButtonColor: "#198754",
                    confirmButtonText: "ตกลง"
                });
            })
            .deleteUser(email, password);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับรับผลลัพธ์การลบจาก Backend
     */
    function handleDeleteUserResponse(response) {
        // 1. สั่งปิด Modal ของ Bootstrap ก่อนเลย (ไม่ว่าผลจะเป็นอย่างไร)
        try {
            const modalEl = document.getElementById('adminDeletePasswordModal');
            // ตรวจสอบว่ามี Modal นี้อยู่จริงและถูกเปิดไว้หรือไม่
            if (modalEl) {
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
        } catch (e) {
            console.log("Modal might be already closed");
        }

        // 2. แสดงผลลัพธ์ด้วย SweetAlert2 
        // (การเรียก Swal.fire ครั้งนี้จะไปปิดตัว Loading ที่หมุนอยู่โดยอัตโนมัติ)
        Swal.fire({
            title: response.success ? 'สำเร็จ!' : 'แจ้งเตือน',
            text: response.message,
            icon: response.success ? 'success' : 'error',
            allowOutsideClick: false,
            allowEscapeKey: false,
            confirmButtonColor: "#198754",
            confirmButtonText: "ตกลง"
        }).then((result) => {
            // 3. เมื่อผู้ใช้กดปุ่ม "ตกลง"
            if (result.isConfirmed) {
                if (response.success) {
                    // ถ้าลบสำเร็จ -> โหลดตารางใหม่
                    fetchUserManagement(); 
                } else {
                    // ถ้าลบไม่สำเร็จ (เช่น รหัสผิด) -> ล้างช่องรหัสผ่านให้
                    const passwordInput = document.getElementById('admin-delete-password-input');
                    if (passwordInput) passwordInput.value = '';
                }
            }
        });
        
        // ล้างข้อความ Error ใน html (ถ้ามีค้างไว้) เพื่อความสะอาด
        const errorDiv = document.getElementById('admin-delete-error');
        if (errorDiv) errorDiv.classList.add('d-none');
    }

    // --- [ใหม่] Admin User History Functions ---
    let currentViewingUser = {};

    function fetchUserHistory(userEmail, userName) {
        currentViewingUser = { email: userEmail, name: userName };
        showView('admin-user-history-view');
        document.getElementById('user-history-title').textContent = `ประวัติของ: ${userName}`;

        // ทำให้ Tab แรกเป็น Active และโหลดข้อมูลทั้งหมด
        new bootstrap.Tab(document.getElementById('admin-learning-history-tab')).show();
        fetchAdminLearningHistory(userEmail);
        fetchAdminExamHistory(userEmail);
        fetchAdminExamTopicHistory(userEmail); // [ใหม่] โหลดข้อมูลใหม่นี้ด้วย
    }

    // --- [เพิ่มฟังก์ชันใหม่ 2 ตัวนี้] ---

    /** ดึงข้อมูลประวัติการทำข้อสอบย่อยของผู้ใช้ที่เลือก */
    function fetchAdminExamTopicHistory(userEmail) {
        const container = document.getElementById('admin-exam-topic-history-body');
        container.innerHTML = `<tr><td colspan="6" class="text-center">กำลังโหลด...</td></tr>`;
        google.script.run.withSuccessHandler(displayAdminExamTopicHistory).getExamTopicHistoryDetails(userEmail);
    }

    /** แสดงผลประวัติการทำข้อสอบย่อย */
    function displayAdminExamTopicHistory(historyData) {
        const container = document.getElementById('admin-exam-topic-history-body');
        if (!historyData || historyData.length === 0) {
            container.innerHTML = `<tr><td colspan="6" class="text-center">ไม่พบประวัติการทำข้อสอบย่อย</td></tr>`;
            return;
        }
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        container.innerHTML = historyData.map((item, index) => {
            const startDate = item.startTimestamp ? new Date(item.startTimestamp).toLocaleString('th-TH', options) : 'N/A';
            const endDate = item.endTimestamp ? new Date(item.endTimestamp).toLocaleString('th-TH', options) : 'N/A';
            return `
                <tr>
                    <th>${index + 1}</th>
                    <td>${item.subjectName}</td>
                    <td>${item.topicName}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td>${item.totalTime}</td>
                </tr>`;
        }).join('');
    }

    function fetchAdminLearningHistory(userEmail) {
        const container = document.getElementById('admin-learning-history-body');
        container.innerHTML = `<tr><td colspan="5" class="text-center">กำลังโหลด...</td></tr>`;
        google.script.run.withSuccessHandler(displayAdminLearningHistory).getHistoryDetails(userEmail);
    }

    function displayAdminLearningHistory(historyObject) { // <-- เปลี่ยนชื่อพารามิเตอร์เพื่อความชัดเจน
        const container = document.getElementById('admin-learning-history-body');

        // 1. ดึง Array จริงๆ ออกมาจาก Object ที่ได้รับ
        const historyData = historyObject.data; 

        // 2. ตรวจสอบ Array (historyData) แทน historyObject
        if (!historyData || historyData.length === 0) {
            container.innerHTML = `<tr><td colspan="5" class="text-center">ไม่พบประวัติการเรียนที่จบแล้ว</td></tr>`; 
            return;
        }

        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        
        // 3. ใช้ .map() กับ Array (historyData) เหมือนเดิม
        container.innerHTML = historyData.map((item, index) => {
            const enrollmentDate = item.enrollmentTimestamp ? new Date(item.enrollmentTimestamp).toLocaleString('th-TH', options) : 'N/A';
            const completionDate = item.completionTimestamp ? new Date(item.completionTimestamp).toLocaleString('th-TH', options) : 'N/A';
            return `<tr><th>${index + 1}</th><td>${item.courseName}</td><td>${enrollmentDate}</td><td>${completionDate}</td><td>${item.totalTime}</td></tr>`;
        }).join('');

        // หมายเหตุ: หลังจากนี้ คุณจะต้องเพิ่มโค้ดสำหรับสร้างปุ่ม Pagination
        // โดยใช้ข้อมูลจาก historyObject.totalPages, historyObject.currentPage ด้ว
    }

    function fetchAdminExamHistory(userEmail) {
        const container = document.getElementById('admin-exam-history-body');
        container.innerHTML = `<tr><td colspan="5" class="text-center">กำลังโหลด...</td></tr>`;
        google.script.run.withSuccessHandler(displayAdminExamHistory).getExamHistoryDetails(userEmail);
    }

    function displayAdminExamHistory(historyObject) { // <-- เปลี่ยนชื่อพารามิเตอร์เพื่อความชัดเจน
        const container = document.getElementById('admin-exam-history-body');

        // 1. ดึง Array ที่แท้จริงออกมาจาก Object
        const historyData = historyObject.data;

        // 2. ตรวจสอบ Array (historyData) แทน
        if (!historyData || historyData.length === 0) {
            container.innerHTML = `<tr><td colspan="5" class="text-center">ไม่พบประวัติการสอบ</td></tr>`; 
            return;
        }

        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        
        // 3. ใช้ .map() กับ Array (historyData)
        container.innerHTML = historyData.map((item, index) => {
            const startDate = item.startTimestamp ? new Date(item.startTimestamp).toLocaleString('th-TH', options) : 'N/A';
            const endDate = item.endTimestamp ? new Date(item.endTimestamp).toLocaleString('th-TH', options) : 'N/A';
            return `<tr><th>${index + 1}</th><td>${item.subjectName}</td><td>${startDate}</td><td>${endDate}</td><td>${item.totalTime}</td></tr>`;
        }).join('');

        // หมายเหตุ: คุณจะต้องเพิ่มโค้ดสำหรับสร้างปุ่ม Pagination (ปุ่มเปลี่ยนหน้า)
        // โดยใช้ข้อมูลจาก historyObject.totalPages และ historyObject.currentPage ที่จุดนี้
    }

    /**
     * [ใหม่] ฟังก์ชันตัวช่วยสร้างปุ่ม Pagination
     * @param {string} prefix - 'course', 'lesson', 'question'
     * @param {number} currentPage - หน้าปัจจุบัน
     * @param {number} totalPages - จำนวนหน้าทั้งหมด
     * @param {number} totalItems - จำนวนรายการทั้งหมด
     * @param {number} limit - จำนวนรายการต่อหน้า
     * @param {string} fetchFunctionName - ชื่อฟังก์ชันที่จะเรียกเมื่อคลิก (เช่น 'fetchCourseManagement')
     */
    function buildPaginationControls(prefix, currentPage, totalPages, totalItems, limit, fetchFunctionName) {
      const infoEl = document.getElementById(`${prefix}-pagination-info`);
      const controlsEl = document.getElementById(`${prefix}-pagination-controls`);

      if (totalItems === 0) {
        infoEl.textContent = 'ไม่พบข้อมูล';
        controlsEl.innerHTML = '';
        return;
      }

      const startItem = (currentPage - 1) * limit + 1;
      const endItem = Math.min(startItem + limit - 1, totalItems);
      infoEl.textContent = `แสดง ${startItem} - ${endItem} จากทั้งหมด ${totalItems} รายการ`;

      let html = '';
      const maxVisiblePages = 5; // แสดงปุ่มตัวเลขสูงสุด 5 ปุ่ม
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      // ปรับแก้กรณีอยู่ใกล้หน้าสุดท้าย
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      // ปุ่ม "หน้าแรก" และ "ก่อนหน้า"
      html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="${currentPage > 1 ? `${fetchFunctionName}(1)` : 'return false;'}">&laquo;</a>
              </li>`;
      html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="${currentPage > 1 ? `${fetchFunctionName}(${currentPage - 1})` : 'return false;'}">&lsaquo;</a>
              </li>`;

      // ปุ่มตัวเลข
      if (startPage > 1) {
        html += '<li class="page-item disabled"><a class="page-link" href="#">...</a></li>';
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                  <a class="page-link" href="#" onclick="${i !== currentPage ? `${fetchFunctionName}(${i})` : 'return false;'}">${i}</a>
                </li>`;
      }
      
      if (endPage < totalPages) {
        html += '<li class="page-item disabled"><a class="page-link" href="#">...</a></li>';
      }

      // ปุ่ม "ถัดไป" และ "หน้าสุดท้าย"
      html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="${currentPage < totalPages ? `${fetchFunctionName}(${currentPage + 1})` : 'return false;'}">&rsaquo;</a>
              </li>`;
      html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="${currentPage < totalPages ? `${fetchFunctionName}(${totalPages})` : 'return false;'}">&raquo;</a>
              </li>`;

      controlsEl.innerHTML = html;
    }

    // --- Course Management Functions [แก้ไข] ---

    /**
     * [แก้ไข] ดึงข้อมูลคอร์สแบบมี Pagination
     * @param {number} page - เลขหน้าที่ต้องการ
     */
    function fetchCourseManagement(page = 1) {
      showView('admin-course-management-view');
      const tbody = document.getElementById('course-table-body');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">กำลังโหลดข้อมูลคอร์ส...</td></tr>';
      
      // [ใหม่] ดึงค่า settings จาก UI
      const searchTerm = document.getElementById('course-search-input').value;
      const limit = document.getElementById('course-limit-select').value;
      const options = { page: page, limit: limit, searchTerm: searchTerm };

      // [แก้ไข] ส่ง options ไปยัง GAS
      google.script.run.withSuccessHandler(displayCoursePage)
        .getCourses(currentUser.email, options);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้าคอร์ส (ตาราง + pagination)
     * @param {Object} response - อ็อบเจกต์ที่ได้จาก GAS (มี data, totalItems, totalPages, ...)
     */
    function displayCoursePage(response) {
      const { data, totalItems, totalPages, currentPage, limit } = response;
      
      // 1. แสดงตาราง (ใช้ฟังก์ชันเดิมของคุณ)
      displayCourseTable(data);
      
      // 2. สร้าง Pagination
      buildPaginationControls('course', currentPage, totalPages, totalItems, limit, 'fetchCourseManagement');
    }

    /**
     * (ฟังก์ชันเดิม) แสดงตารางคอร์ส
     * @param {Array} courses - ข้อมูลคอร์ส (เฉพาะหน้านี้)
     */
    function displayCourseTable(courses) {
      const tbody = document.getElementById('course-table-body');
      let rowsHtml = '';
      if (courses && courses.length > 0) {
        rowsHtml = courses.map(course => `
              <tr>
                  <td><strong>${course.CourseID}</strong></td>
                  <td>${course.CourseName}</td>
                  <td><span class="badge bg-secondary">${course.Category || 'N/A'}</span></td>
                  <td>${course.Description || ''}</td>
                  <td>
                      <button class="btn btn-sm btn-info me-2" onclick="fetchLessonManagement('${course.CourseID}', '${course.CourseName}', 1)">จัดการบทเรียน</button>
                      <button class="btn btn-sm btn-primary me-2" onclick='openEditCourseModal(${JSON.stringify(course)})'>แก้ไข</button>
                      <button class="btn btn-sm btn-danger" onclick="confirmDeleteCourse('${course.CourseID}')">ลบ</button>
                  </td>
              </tr>
          `).join('');
      } else {
        rowsHtml = '<tr><td colspan="5" class="text-center">ไม่พบข้อมูลคอร์ส</td></tr>';
      }
      tbody.innerHTML = rowsHtml;
    }

    function openAddCourseModal() {
        document.getElementById('add-course-form').reset();
        const addModal = new bootstrap.Modal(document.getElementById('addCourseModal'));
        addModal.show();
    }

    function handleAddNewCourse(event) {
      event.preventDefault();
      const courseData = {
        // courseId: document.getElementById('add-courseId').value,
        courseName: document.getElementById('add-courseName').value,
        category: document.getElementById('add-course-category').value, // <-- [เพิ่ม]
        description: document.getElementById('add-description').value,
        coverImageUrl: document.getElementById('add-coverImageUrl').value,
        registrationOpen: document.getElementById('add-course-registration-open').checked
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังเพิ่มคอร์ส',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'เพิ่มคอร์สสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
          bootstrap.Modal.getInstance(document.getElementById('addCourseModal')).hide();
          fetchCourseManagement();
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).addCourse(courseData, currentUser.email);
    }

    function openEditCourseModal(course) {
        document.getElementById('edit-courseId').value = course.CourseID;
        document.getElementById('edit-courseName').value = course.CourseName;
        document.getElementById('edit-course-category').value = course.Category || ''; // <-- [เพิ่ม]
        document.getElementById('edit-description').value = course.Description;
        document.getElementById('edit-coverImageUrl').value = course.CoverImageURL;

        document.getElementById('edit-course-registration-open').checked = course.RegistrationOpen;

        const editModal = new bootstrap.Modal(document.getElementById('editCourseModal'));
        editModal.show();
    }

    function handleUpdateCourse(event) {
      event.preventDefault();
      const courseData = {
        courseId: document.getElementById('edit-courseId').value,
        courseName: document.getElementById('edit-courseName').value,
        category: document.getElementById('edit-course-category').value, // <-- [เพิ่ม]
        description: document.getElementById('edit-description').value,
        coverImageUrl: document.getElementById('edit-coverImageUrl').value,
        registrationOpen: document.getElementById('edit-course-registration-open').checked
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังอัปเดตคอร์ส',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'อัปเดตสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
          bootstrap.Modal.getInstance(document.getElementById('editCourseModal')).hide();
          fetchCourseManagement();
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).updateCourse(courseData, currentUser.email);
    }

    function confirmDeleteCourse(courseId) {
        // [เดิม] if (confirm(`คุณแน่ใจว่า...`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: `คุณแน่ใจว่าต้องการลบคอร์ส ID: ${courseId}? การกระทำนี้จะลบเฉพาะตัวคอร์ส แต่จะไม่ลบบทเรียนหรือคำถามที่เกี่ยวข้อง`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message);
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if (res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        fetchCourseManagement();
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteCourse(courseId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    /**
     * [แก้ไข] ดึงข้อมูลบทเรียนแบบมี Pagination
     * @param {string | null} courseId - ID คอร์ส (ถ้ามี คือการเปลี่ยนหน้า)
     * @param {string | null} courseName - ชื่อคอร์ส (ถ้ามี คือการเปลี่ยนหน้า)
     * @param {number} page - เลขหน้าที่ต้องการ
     */
    function fetchLessonManagement(courseId, courseName, page = 1) {
      // [ใหม่] ตรวจสอบและอัปเดต state
      if (courseId && courseName) {
        currentManagingCourse = { id: courseId, name: courseName };
        // เมื่อเปลี่ยนคอร์สใหม่ ให้เคลียร์ช่องค้นหาของบทเรียน
        document.getElementById('lesson-search-input').value = ''; 
      }
      
      showView('admin-lesson-management-view');
      document.getElementById('lesson-mg-title').textContent = `บทเรียนใน: ${currentManagingCourse.name}`;
      const tbody = document.getElementById('lesson-table-body');
      tbody.innerHTML = '<tr><td colspan="3" class="text-center">กำลังโหลด...</td></tr>';
      
      // [ใหม่] ดึงค่า settings จาก UI
      const searchTerm = document.getElementById('lesson-search-input').value;
      const limit = document.getElementById('lesson-limit-select').value;
      const options = { page: page, limit: limit, searchTerm: searchTerm };

      // [แก้ไข] ส่ง options ไปยัง GAS
      google.script.run.withSuccessHandler(displayLessonPage)
        .getLessons(currentManagingCourse.id, options);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้าบทเรียน (ตาราง + pagination)
     * @param {Object} response - อ็อบเจกต์ที่ได้จาก GAS
     */
    function displayLessonPage(response) {
      const { data, totalItems, totalPages, currentPage, limit } = response;
      
      // 1. แสดงตาราง (ใช้ฟังก์ชันเดิมของคุณ)
      displayLessonTable(data);
      
      // 2. สร้าง Pagination
      buildPaginationControls('lesson', currentPage, totalPages, totalItems, limit, 'fetchLessonManagement');
    }

    /**
     * (ฟังก์ชันเดิม) แสดงตารางบทเรียน
     * @param {Array} lessons - ข้อมูลบทเรียน (เฉพาะหน้านี้)
     */
    function displayLessonTable(lessons) {
      const tbody = document.getElementById('lesson-table-body');
      tbody.innerHTML = lessons.map(lesson => `
            <tr>
                <td>${lesson.LessonID}</td>
                <td>${lesson.LessonName}</td>
                <td>
                    <button class="btn btn-sm btn-info me-2" onclick="fetchQuestionManagement('${lesson.LessonID}', '${lesson.LessonName}', 1)">จัดการคำถาม</button>
                    <button class="btn btn-sm btn-primary me-2" onclick='openEditLessonModal(${JSON.stringify(lesson)})'>แก้ไข</button>
                    <button class="btn btn-sm btn-danger" onclick="confirmDeleteLesson('${lesson.LessonID}')">ลบ</button>
                </td>
            </tr>
        `).join('') || '<tr><td colspan="3" class="text-center">ไม่พบบทเรียน</td></tr>';
    }

    function openAddLessonModal() {
        document.getElementById('addLessonModal').querySelector('form').reset();
        new bootstrap.Modal(document.getElementById('addLessonModal')).show();
    }

    function handleAddNewLesson(event) {
      event.preventDefault();
      const lessonData = {
        // lessonId: document.getElementById('add-lessonId').value,
        courseId: currentManagingCourse.id,
        lessonName: document.getElementById('add-lessonName').value,
        videoUrl: document.getElementById('add-videoUrl').value,
        docLinks: document.getElementById('add-docLinks').value
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังเพิ่มบทเรียน',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'เพิ่มสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
          bootstrap.Modal.getInstance(document.getElementById('addLessonModal')).hide();
          fetchLessonManagement(currentManagingCourse.id, currentManagingCourse.name);
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).addLesson(lessonData, currentUser.email); // <-- ส่งอีเมล
    }
    
    function openEditLessonModal(lesson) {
        // ดึงข้อมูลพื้นฐานมาแสดง (เหมือนเดิม)
        document.getElementById('edit-lessonId').value = lesson.LessonID;
        document.getElementById('edit-lessonName').value = lesson.LessonName;
        document.getElementById('edit-videoUrl').value = lesson.VideoURL;
        
        // [แก้ไข] เพิ่มการดึง DocumentLinks มาแสดงใน textarea
        document.getElementById('edit-docLinks').value = lesson.DocumentLinks || '';

        // แสดง Modal
        new bootstrap.Modal(document.getElementById('editLessonModal')).show();
    }

    function handleUpdateLesson(event) {
      event.preventDefault();
      const lessonData = {
        lessonId: document.getElementById('edit-lessonId').value,
        lessonName: document.getElementById('edit-lessonName').value,
        videoUrl: document.getElementById('edit-videoUrl').value,
        docLinks: document.getElementById('edit-docLinks').value
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังอัปเดตบทเรียน',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'อัปเดตสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
          bootstrap.Modal.getInstance(document.getElementById('editLessonModal')).hide();
          fetchLessonManagement(currentManagingCourse.id, currentManagingCourse.name);
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).updateLesson(lessonData, currentUser.email); // <-- ส่งอีเมล
    }
    
    function confirmDeleteLesson(lessonId) {
        // [เดิม] if (confirm(`ต้องการลบบทเรียน ID: ${lessonId} จริงหรือไม่?`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: `ต้องการลบบทเรียน ID: ${lessonId} จริงหรือไม่?`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message);
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if (res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        // [เดิม] fetchLessonManagement(...);
                        fetchLessonManagement(currentManagingCourse.id, currentManagingCourse.name);
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteLesson(lessonId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    /**
     * [แก้ไข] ดึงข้อมูลคำถามแบบมี Pagination
     * @param {string | null} lessonId - ID บทเรียน (ถ้ามี คือการเปลี่ยนหน้า)
     * @param {string | null} lessonName - ชื่อบทเรียน (ถ้ามี คือการเปลี่ยนหน้า)
     * @param {number} page - เลขหน้าที่ต้องการ
     */
    function fetchQuestionManagement(lessonId, lessonName, page = 1) {
      // [แก้ไข] ตรวจสอบว่า lessonId เป็นตัวเลขหรือไม่
      // (ถ้าใช่ แสดงว่าเป็นการเรียกจาก oninput/onchange ที่ส่งมาแค่ page)
      if (typeof lessonId === 'number' && lessonName === undefined) {
          page = lessonId; // กำหนด page ให้ถูกต้อง
          lessonId = null;   // เคลียร์ lessonId
          lessonName = null; // เคลียร์ lessonName
      }

      // 1. อัปเดต State (ถ้ามีการส่ง lessonId และ lessonName มา)
      if (lessonId && lessonName) {
        currentManagingLesson = { id: lessonId, name: lessonName };
        document.getElementById('question-search-input').value = '';
      }

      // 2. [แก้ไข] ตรวจสอบว่า currentManagingLesson มีอยู่จริงหรือไม่
      if (!currentManagingLesson || !currentManagingLesson.id) {
        // ถ้าไม่เคยมีการตั้งค่า (เช่น รีเฟรชหน้า) ให้หยุดทำงาน
        const tbody = document.getElementById('question-table-body');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">กรุณากลับไปเลือกบทเรียนก่อน</td></tr>';
        showView('admin-question-management-view');
        // ซ่อน pagination-info ถ้ายังไม่เลือกบทเรียน
        document.getElementById('question-pagination-info').textContent = '';
        document.getElementById('question-pagination-controls').innerHTML = '';
        return; // หยุดทำงานทันที
      }

      // (โค้ดส่วนที่เหลือทำงานตามปกติ)
      showView('admin-question-management-view');
      document.getElementById('question-mg-title').textContent = `คำถามใน: ${currentManagingLesson.name}`;
      const tbody = document.getElementById('question-table-body');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">กำลังโหลด...</td></tr>';
      
      const searchTerm = document.getElementById('question-search-input').value;
      const limit = document.getElementById('question-limit-select').value;
      
      // [แก้ไข] ใช้ 'page' ที่เราคำนวณไว้ด้านบน
      const options = { page: page, limit: limit, searchTerm: searchTerm }; 
      
      google.script.run.withSuccessHandler(displayQuestionPage)
        .getQuestionsForLessonAdmin(currentManagingLesson.id, options);
    }

    /**
         * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้าคำถาม (ตาราง + pagination)
         * [แก้ไข] เพิ่มการป้องกัน (Fallback) กรณี response ไม่ถูกต้อง
         */
    function displayQuestionPage(response) {
      // [แก้ไข] สร้างตัวแปร safeResponse เพื่อป้องกันกรณี response เป็น null หรือ undefined
      const safeResponse = response || {};

      // [แก้ไข] กำหนดค่าเริ่มต้น (Default Value) ให้กับทุกตัวแปร
      // หาก response ไม่มี 'data' (เช่น server ส่งมาเป็น array) 'data' จะกลายเป็น []
      const {
        data = [], // <-- จุดสำคัญ: หาก response.data เป็น undefined ให้ใช้ [] แทน
        totalItems = 0,
        totalPages = 1,
        currentPage = 1,
        limit = 10
      } = safeResponse;

      // 1. แสดงตาราง
      // 'data' จะเป็น [] (Array เปล่า) เสมอ (ไม่ใช่ undefined) จึงปลอดภัย
      displayQuestionTable(data);

      // 2. สร้าง Pagination
      buildPaginationControls('question', currentPage, totalPages, totalItems, limit, 'fetchQuestionManagement');
    }

    /**
     * (ฟังก์ชันแสดงตารางคำถาม)
     * [แก้ไข] เพิ่มการแสดงผล Badge สำหรับสถานะ 'both'
     */
    function displayQuestionTable(questions) {
        const tbody = document.getElementById('question-table-body');
        const safeQuestions = Array.isArray(questions) ? questions : [];

        tbody.innerHTML = safeQuestions.map(q => {
            // [เพิ่ม] Logic การเลือกสี Badge
            let badgeHtml = '';
            if (q.TestType === 'pre') {
                badgeHtml = '<span class="badge bg-primary">Pre-Test</span>';
            } else if (q.TestType === 'post') {
                badgeHtml = '<span class="badge bg-info text-dark">Post-Test</span>';
            } else if (q.TestType === 'both') {
                // สีส้ม หรือสีที่คุณต้องการสำหรับ ทั้งคู่
                badgeHtml = '<span class="badge bg-warning text-dark">Pre & Post</span>';
            } else {
                badgeHtml = `<span class="badge bg-secondary">${q.TestType}</span>`;
            }

            return `
                <tr>
                    <td>${q.QuestionID}</td>
                    <td>${badgeHtml}</td>
                    <td class="text-truncate" style="max-width: 300px;">${q.QuestionText}</td>
                    <td><strong>${q.CorrectAnswer}</strong></td>
                    <td>${q.Explanation ? '<i class="bi bi-check-circle-fill text-success"></i>' : ''}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" onclick='openEditQuestionModal(${JSON.stringify(q)})'>แก้ไข</button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteQuestion('${q.QuestionID}')">ลบ</button>
                    </td>
                </tr>
            `;
        }).join('') || '<tr><td colspan="6" class="text-center">ไม่พบคำถาม</td></tr>';
    }

        // [ใหม่] ฟังก์ชันสำหรับสร้างฟอร์มคำถาม (เพื่อลดโค้ดซ้ำซ้อน)
    // [แก้ไข] ฟังก์ชันสำหรับสร้างฟอร์มคำถาม
    function createQuestionFormHtml(prefix, data = {}) {
        const isAddMode = !data.QuestionID;

        return `
            <input type="hidden" id="${prefix}-questionId-hidden" value="${data.QuestionID || ''}">
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label class="form-label">Question ID</label>
                    <input type="text" class="form-control text-muted" id="${prefix}-questionId" 
                          value="${isAddMode ? 'ระบบสร้างให้อัตโนมัติ' : (data.QuestionID || '')}" 
                          disabled readonly>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Test Type</label>
                    <select class="form-select" id="${prefix}-testType" required>
                        <option value="pre" ${data.TestType === 'pre' ? 'selected' : ''}>Pre-Test</option>
                        <option value="post" ${data.TestType === 'post' ? 'selected' : ''}>Post-Test</option>
                        <option value="both" ${data.TestType === 'both' ? 'selected' : ''}>Pre & Post Test</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">คำถาม</label>
                <textarea class="form-control" id="${prefix}-questionText" rows="2" required>${data.QuestionText || ''}</textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Image URL (ถ้ามี)</label>
                <input type="url" class="form-control" id="${prefix}-imageUrl" value="${data.ImageURL || ''}">
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6 mb-3"><label class="form-label">ตัวเลือก A</label><input type="text" class="form-control" id="${prefix}-optionA" value="${data.OptionA || ''}" required></div>
                <div class="col-md-6 mb-3"><label class="form-label">ตัวเลือก B</label><input type="text" class="form-control" id="${prefix}-optionB" value="${data.OptionB || ''}" required></div>
                <div class="col-md-6 mb-3"><label class="form-label">ตัวเลือก C</label><input type="text" class="form-control" id="${prefix}-optionC" value="${data.OptionC || ''}" required></div>
                <div class="col-md-6 mb-3"><label class="form-label">ตัวเลือก D</label><input type="text" class="form-control" id="${prefix}-optionD" value="${data.OptionD || ''}" required></div>
            </div>
            <div class="mb-3">
                <label class="form-label">คำตอบที่ถูกต้อง</label>
                <select class="form-select" id="${prefix}-correctAnswer" required>
                    <option value="">-- เลือกคำตอบ --</option>
                    <option value="A" ${data.CorrectAnswer === 'A' ? 'selected' : ''}>A</option>
                    <option value="B" ${data.CorrectAnswer === 'B' ? 'selected' : ''}>B</option>
                    <option value="C" ${data.CorrectAnswer === 'C' ? 'selected' : ''}>C</option>
                    <option value="D" ${data.CorrectAnswer === 'D' ? 'selected' : ''}>D</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">คำอธิบายเฉลย (Explanation)</label>
                <textarea class="form-control" id="${prefix}-explanation" rows="3">${data.Explanation || ''}</textarea>
            </div>
        `;
    }

    function openAddQuestionModal() {
        document.getElementById('add-question-modal-body').innerHTML = createQuestionFormHtml('add');
        document.getElementById('add-question-form').reset();
        new bootstrap.Modal(document.getElementById('addQuestionModal')).show();
    }

    function handleAddNewQuestion(event) {
      event.preventDefault();
      const questionData = {
        // questionId: document.getElementById('add-questionId').value,
        lessonId: currentManagingLesson.id,
        testType: document.getElementById('add-testType').value,
        questionText: document.getElementById('add-questionText').value,
        optionA: document.getElementById('add-optionA').value,
        optionB: document.getElementById('add-optionB').value,
        optionC: document.getElementById('add-optionC').value,
        optionD: document.getElementById('add-optionD').value,
        correctAnswer: document.getElementById('add-correctAnswer').value,
        imageUrl: document.getElementById('add-imageUrl').value,
        explanation: document.getElementById('add-explanation').value
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังเพิ่มคำถาม',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'เพิ่มสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
          bootstrap.Modal.getInstance(document.getElementById('addQuestionModal')).hide();
          fetchQuestionManagement(currentManagingLesson.id, currentManagingLesson.name);
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).addQuestion(questionData, currentUser.email); // <-- ส่งอีเมล
    }
    
    function openEditQuestionModal(question) {
        document.getElementById('edit-question-modal-body').innerHTML = createQuestionFormHtml('edit', question);
        new bootstrap.Modal(document.getElementById('editQuestionModal')).show();
    }

    function handleUpdateQuestion(event) {
      event.preventDefault();
      const questionData = {
        questionId: document.getElementById('edit-questionId-hidden').value,
        testType: document.getElementById('edit-testType').value,
        questionText: document.getElementById('edit-questionText').value,
        optionA: document.getElementById('edit-optionA').value,
        optionB: document.getElementById('edit-optionB').value,
        optionC: document.getElementById('edit-optionC').value,
        optionD: document.getElementById('edit-optionD').value,
        correctAnswer: document.getElementById('edit-correctAnswer').value,
        imageUrl: document.getElementById('edit-imageUrl').value,
        explanation: document.getElementById('edit-explanation').value
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังอัปเดตคำถาม',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'อัปเดตสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
          bootstrap.Modal.getInstance(document.getElementById('editQuestionModal')).hide();
          fetchQuestionManagement(currentManagingLesson.id, currentManagingLesson.name);
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).updateQuestion(questionData, currentUser.email); // <-- ส่งอีเมล
    }

    function confirmDeleteQuestion(questionId) {
        // [เดิม] if (confirm(`ต้องการลบคำถาม ID: ${questionId} จริงหรือไม่?`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: `ต้องการลบคำถาม ID: ${questionId} จริงหรือไม่?`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message);
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if (res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        // [เดิม] fetchQuestionManagement(...);
                        fetchQuestionManagement(currentManagingLesson.id, currentManagingLesson.name);
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteQuestion(questionId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    // [ใหม่] ฟังก์ชัน Helper สำหรับสร้างตัวเลือก Limit
    function createLimitSelector(stateKey, fetchFunction) {
        const limits = [10, 25, 50, 100];
        const currentLimit = paginationState[stateKey].limit;
        
        let options = limits.map(limit => 
            `<option value="${limit}" ${currentLimit == limit ? 'selected' : ''}>${limit}</option>`
        ).join('');
        
        return `
            <label class="form-label me-2 small">แสดง</label>
            <select class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="changeLimit('${stateKey}', ${fetchFunction.name})">
                ${options}
            </select>
            <label class="form-label ms-2 small">รายการ</label>
        `;
    }

    // [ใหม่] ฟังก์ชัน Helper สำหรับสร้าง Pagination
    function createPaginationControls(totalPages, currentPage, stateKey, fetchFunction) {
        let li = '';
        const maxPagesToShow = 5; // จำนวนปุ่มสูงสุดที่จะแสดง
        let startPage, endPage;

        if (totalPages <= maxPagesToShow) {
            startPage = 1;
            endPage = totalPages;
        } else {
            const maxPagesBeforeCurrent = Math.floor(maxPagesToShow / 2);
            const maxPagesAfterCurrent = Math.ceil(maxPagesToShow / 2) - 1;
            if (currentPage <= maxPagesBeforeCurrent) {
                startPage = 1;
                endPage = maxPagesToShow;
            } else if (currentPage + maxPagesAfterCurrent >= totalPages) {
                startPage = totalPages - maxPagesToShow + 1;
                endPage = totalPages;
            } else {
                startPage = currentPage - maxPagesBeforeCurrent;
                endPage = currentPage + maxPagesAfterCurrent;
            }
        }

        // ปุ่ม "Previous"
        li += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); changePage('${stateKey}', ${currentPage - 1}, ${fetchFunction.name})">«</a>
              </li>`;

        // ปุ่มตัวเลข
        for (let i = startPage; i <= endPage; i++) {
            li += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); changePage('${stateKey}', ${i}, ${fetchFunction.name})">${i}</a>
                  </li>`;
        }

        // ปุ่ม "Next"
        li += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); changePage('${stateKey}', ${currentPage + 1}, ${fetchFunction.name})">»</a>
              </li>`;

        return li;
    }

    // [ใหม่] ฟังก์ชันจัดการการเปลี่ยนหน้า
    function changePage(stateKey, page, fetchFunction) {
        if (page < 1) page = 1;
        // ไม่ต้องเช็ค totalPages ที่นี่ เพราะ fetchFunction จะจัดการเอง
        fetchFunction(page);
    }

    // [ใหม่] ฟังก์ชันจัดการการเปลี่ยน Limit
    function changeLimit(stateKey, fetchFunction) {
        const selector = event.target;
        paginationState[stateKey].limit = parseInt(selector.value, 10);
        paginationState[stateKey].currentPage = 1; // กลับไปหน้า 1 เสมอเมื่อเปลี่ยน Limit
        fetchFunction(1);
    }

    function fetchCourseReportsView() {
      showView('admin-course-reports-view');
      fetchEnrollments(1); // โหลดแท็บแรก (Enrollments)

      if (courseTabListenerAdded) return;

      const dataTabs = document.querySelectorAll('#courseDataTabs button');
      dataTabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', event => {
          const targetId = event.target.id;
          if (targetId === 'enroll-tab') fetchEnrollments(1);
          if (targetId === 'scores-tab') fetchScores(1);
          if (targetId === 'logs-tab') fetchLogs(1);
          if (targetId === 'learning-history-tab') fetchLearningHistoryReport(1);
        });
      });
      courseTabListenerAdded = true;
    }

    function fetchExamReportsView() {
      showView('admin-exam-reports-view');
      fetchExamSubmissions(1); // โหลดแท็บแรก (Exam Submissions)

      if (examTabListenerAdded) return;

      const dataTabs = document.querySelectorAll('#examDataTabs button');
      dataTabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', event => {
          const targetId = event.target.id;
          if (targetId === 'exam-sub-tab') fetchExamSubmissions(1);
          if (targetId === 'final-sub-tab') fetchFinalSubmissions(1);
          if (targetId === 'exam-logs-tab') fetchExamLogs(1);
          if (targetId === 'exam-history-tab') fetchExamHistoryReport(1);
          if (targetId === 'exam-topic-history-tab') fetchExamTopicHistoryReport(1);
          if (targetId === 'pin-logs-tab') fetchPinLogs(1);
          if (targetId === 'cheating-logs-tab') fetchCheatingLogs(1);
        });
      });
      examTabListenerAdded = true;
    }

    function fetchSystemLogsView() {
      showView('admin-system-logs-view');
      fetchAdminLogs(1); // โหลดแท็บแรก (Admin Logs)

      if (logTabListenerAdded) return;

      const dataTabs = document.querySelectorAll('#logDataTabs button');
      dataTabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', event => {
          const targetId = event.target.id;
          if (targetId === 'admin-logs-tab') fetchAdminLogs(1);
          if (targetId === 'student-logs-tab') fetchStudentLogs(1);
        });
      });
      logTabListenerAdded = true;
    }

    // -- Enrollment Functions --
    function fetchEnrollments(page = 1) {
        const stateKey = 'enrollments';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;
        
        const tbody = document.getElementById('enrollment-table-body');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">กำลังโหลด...</td></tr>';
        
        google.script.run.withSuccessHandler(displayEnrollmentTable)
            .getAllEnrollments(currentUser.email, page, limit); // [แก้ไข]
    }

    function displayEnrollmentTable(response) {
        const tbody = document.getElementById('enrollment-table-body');
        const stateKey = 'enrollments';
        
        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('enroll-pagination-controls').innerHTML = '';
            document.getElementById('enroll-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(e => `
            <tr>
                <td>${e.Timestamp ? new Date(e.Timestamp).toLocaleString('th-TH') : 'N/A'}</td>
                <td>${e.FullName || 'N/A'}</td>
                <td>${e.UserEmail}</td>
                <td>${e.CourseName || 'N/A'}</td>
                <td>${e.CourseID}</td>
                <td><button class="btn btn-xs btn-danger" onclick="confirmDeleteRecord('Enrollments', '${e.EnrollmentID}', () => fetchEnrollments(paginationState.${stateKey}.currentPage))">ลบ</button></td>
            </tr>
        `).join('');
        
        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchEnrollments);
        document.getElementById('enroll-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchEnrollments);
        document.getElementById('enroll-pagination-controls').innerHTML = paginationControls;
    }

    function handleAddNewEnrollment(event) {
      event.preventDefault();
      const data = {
        email: document.getElementById('add-enroll-email').value,
        courseId: document.getElementById('add-enroll-courseId').value
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังเพิ่มการลงทะเบียน',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'เพิ่มสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });

          document.getElementById('add-enroll-email').value = '';
          document.getElementById('add-enroll-courseId').value = '';
          fetchEnrollments();
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).addEnrollment(data);
    }

    function confirmDeleteEnrollment(enrollmentId) {
        // [เดิม] if (confirm(`ต้องการลบ Enrollment ID: ${enrollmentId} หรือไม่?`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: `ต้องการลบ Enrollment ID: ${enrollmentId} หรือไม่?`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message); if(res.success) fetchEnrollments();
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if(res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        fetchEnrollments();
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteEnrollment(enrollmentId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    // -- Score Functions [ปรับปรุง] --

    function fetchScores(page = 1) {
        const stateKey = 'scores';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('score-table-body');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">กำลังโหลด...</td></tr>';
        google.script.run.withSuccessHandler(displayScoresTable)
            .getAllScores(currentUser.email, page, limit); // [แก้ไข]
    }

    function displayScoresTable(response) {
        const tbody = document.getElementById('score-table-body');
        const stateKey = 'scores';

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('scores-pagination-controls').innerHTML = '';
            document.getElementById('scores-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(s => `
            <tr>
                <td>${s.Timestamp ? new Date(s.Timestamp).toLocaleString('th-TH') : 'N/A'}</td>
                <td>${s.FullName || 'N/A'}</td>
                <td>${s.UserID}</td>
                <td>${s.LessonName || 'N/A'}</td>
                <td>${s.LessonID}</td>
                <td>${s.TestType}</td>
                <td>${s.Score}</td>
                <td>
                    <button class="btn btn-xs btn-primary me-1" onclick='openEditScoreModal(${JSON.stringify(s)})'>แก้ไข</button>
                    <button class="btn btn-xs btn-danger" onclick="confirmDeleteRecord('Scores', '${s.ScoreID}', () => fetchScores(paginationState.${stateKey}.currentPage))">ลบ</button>
                </td>
            </tr>
        `).join('');

        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchScores);
        document.getElementById('scores-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchScores);
        document.getElementById('scores-pagination-controls').innerHTML = paginationControls;
    }

    function openEditScoreModal(data) {
        // [แก้ไข] เปลี่ยน Key ให้ตรงกับข้อมูลจาก Backend (ตัวพิมพ์ใหญ่/เล็ก ต้องเป๊ะ)
        document.getElementById('edit-score-user').textContent = data.FullName || 'N/A'; // เปลี่ยน data.user เป็น data.FullName
        document.getElementById('edit-score-lesson').textContent = data.LessonName || 'N/A'; // เปลี่ยน data.lesson เป็น data.LessonName
        document.getElementById('edit-score-value').value = data.Score; // เปลี่ยน data.score เป็น data.Score (ตัว S ใหญ่)
        document.getElementById('edit-score-identifier').value = data.ScoreID; // เปลี่ยน data.scoreId เป็น data.ScoreID (ID ตัวใหญ่)
        
        new bootstrap.Modal(document.getElementById('editScoreModal')).show();
    }

    function handleUpdateScore(event) {
      event.preventDefault();
      const dataToSend = {
        scoreId: document.getElementById('edit-score-identifier').value,
        newScore: document.getElementById('edit-score-value').value
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังบันทึกคะแนน',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'บันทึกสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });

          bootstrap.Modal.getInstance(document.getElementById('editScoreModal')).hide();
          fetchScores();
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).updateScore(dataToSend);
    }

    function confirmDeleteScore(scoreId) {
        // [เดิม] if (confirm(`ต้องการลบ Score ID: ${scoreId} หรือไม่?`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: `ต้องการลบ Score ID: ${scoreId} หรือไม่?`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message); if(res.success) fetchScores();
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if(res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        fetchScores();
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteScore(scoreId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    // -- AnswerLog Functions [ปรับปรุง] --

    function fetchLogs(page = 1) {
        const stateKey = 'logs';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('log-table-body');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">กำลังโหลด...</td></tr>';
        google.script.run.withSuccessHandler(displayLogTable)
            .getAllAnswerLogs(currentUser.email, page, limit); // [แก้ไข]
    }

    function displayLogTable(response) {
        const tbody = document.getElementById('log-table-body');
        const stateKey = 'logs';

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('logs-pagination-controls').innerHTML = '';
            document.getElementById('logs-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(l => `
            <tr>
                <td>${l.Timestamp ? new Date(l.Timestamp).toLocaleString('th-TH') : 'N/A'}</td>
                <td>${l.FullName || 'N/A'}</td>
                <td>${l.UserEmail}</td>
                <td>${l.LessonName || 'N/A'}</td>
                <td>${l.LessonID}</td>
                <td class="text-truncate" style="max-width: 200px;">${l.QuestionText || 'N/A'}</td>
                <td>${l.QuestionID}</td>
                <td>${l.TestType}</td>
                <td>${l.SelectedAnswer}</td>
                <td><button class="btn btn-xs btn-danger" onclick="confirmDeleteRecord('AnswerLogs', '${l.LogID}', () => fetchLogs(paginationState.${stateKey}.currentPage))">ลบ</button></td>
            </tr>
        `).join('');

        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchLogs);
        document.getElementById('logs-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchLogs);
        document.getElementById('logs-pagination-controls').innerHTML = paginationControls;
    }

    function confirmDeleteLog(logId) {
        // [เดิม] if (confirm(`การลบ Log เป็นการกระทำที่ไม่แนะนำ...`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ Log',
            text: `การลบ Log เป็นการกระทำที่ไม่แนะนำ คุณแน่ใจหรือไม่ว่าต้องการลบ Log ID: ${logId}?`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message); if(res.success) fetchLogs();
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if(res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        fetchLogs();
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteAnswerLog(logId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    /**
     * [อัปเกรด V3] ดึงข้อมูลรายวิชาสอบ (แบบแบ่งหน้า)
     * @param {number} page - เลขหน้าที่ต้องการ
     */
    function fetchExamSubjects(page = 1) {
        // (ส่วนโค้ดเดิมของคุณสำหรับปิด Modal และรีเซ็ตสถานะ)
        const modalElement = document.getElementById('cheatLockModal');
        if (modalElement && modalElement.classList.contains('show')) {
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) modalInstance.hide();
        }
        isScreenLocked = false;
        if (examTimerInterval) clearInterval(examTimerInterval); 
        sessionStorage.removeItem('activeExamSubject');
        // (สิ้นสุดส่วนโค้ดเดิม)

        showView('exam-subject-list-view');
        const container = document.getElementById('exam-subject-list');
        container.innerHTML = `<div class="col-12"><p class="text-center text-muted p-5">กำลังโหลดรายวิชาสอบ...</p></div>`;
        
        // [ใหม่] รวบรวม options จาก UI
        const options = {
            page: page,
            limit: document.getElementById('exam-subject-limit').value,
            searchTerm: document.getElementById('exam-subject-search').value,
            status: document.getElementById('exam-subject-status-filter').value
        };
        
        google.script.run.withSuccessHandler(displayExamSubjectsPage)
            .getExamSubjectsWithStatus(currentUser.email, options);
    }

    // --- [ใหม่] ตรวจสอบสถานะการสอบที่ค้างอยู่เมื่อเปิดหน้าเว็บ ---
    (function checkActiveExamSession() {
        const storedSubject = sessionStorage.getItem('activeExamSubject');
        if (storedSubject) {
            currentExamSubject = JSON.parse(storedSubject);
            if (currentExamSubject && currentExamSubject.EndTime) {
                // ถ้ามีข้อมูลค้างอยู่ ให้เริ่มนับถอยหลังทันที
                startCountdown(currentExamSubject.EndTime, ['topic-list-timer', 'exam-timer']);
            }
        }
    })();

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้า "รายวิชาสอบ"
     * @param {Object} response - อ็อบเจกต์ pagination ที่ได้จาก GAS
     */
    function displayExamSubjectsPage(response) {
        const { data, totalItems, totalPages, currentPage, limit } = response;
        
        // 1. แสดงผลการ์ด (ใช้ฟังก์ชันเดิมของคุณ)
        displayExamSubjects(data);
        
        // 2. สร้าง Pagination
        buildPaginationControls('exam-subject', currentPage, totalPages, totalItems, limit, 'fetchExamSubjects');
    }

    /**
     * [ปรับปรุง] แสดงผลรายการรายวิชาสอบ (Minimalist Theme)
     */
    function displayExamSubjects(subjectsWithStatus) {
        const container = document.getElementById('exam-subject-list');
        
        // กรณีไม่พบรายวิชา: แสดง Empty State แบบคลีนๆ
        if (!subjectsWithStatus || subjectsWithStatus.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="mb-3">
                        <i class="bi bi-clipboard-x text-muted" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                    <p class="text-muted">ไม่พบรายวิชาสอบที่ตรงกับเงื่อนไข</p>
                </div>`;
            return;
        }

        container.innerHTML = subjectsWithStatus.map(subject => {
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            
            // 1. กำหนดตัวแปรสถานะ (สี, ข้อความ, ปุ่ม)
            let statusColor = 'var(--text-muted)'; // สี Default (เทา)
            let statusBorder = '#dfe6e9'; // สีขอบ Default
            let statusBadge = '';
            let btnHtml = '';
            let statusTextHtml = '';
            let cardOpacity = '1'; // ความโปร่งใส (ลดลงถ้าปิดสอบ)

            // --- Logic การแสดงผล ---
            
            if (subject.hasFinallySubmitted) {
                // [สถานะ: สอบเสร็จแล้ว] -> สีเขียว
                statusColor = 'var(--color-success)';
                statusBorder = 'var(--color-success)';
                statusBadge = `<span class="position-absolute top-0 end-0 m-3 badge rounded-pill bg-success bg-opacity-10 text-success"><i class="bi bi-check-circle-fill me-1"></i>สอบแล้ว</span>`;
                statusTextHtml = `<div class="d-flex align-items-center text-success small"><i class="bi bi-check-all me-2"></i>ส่งข้อสอบเรียบร้อย</div>`;
                
                if (subject.AnnounceScores === true) {
                    btnHtml = `<button class="btn btn-info w-100 rounded-pill shadow-btn text-white fw-bold" onclick='handleViewScores(${JSON.stringify(subject)})'><i class="bi bi-award-fill me-2"></i>ดูผลคะแนน</button>`;
                } else {
                    btnHtml = `<button class="btn btn-outline-success w-100 rounded-pill" disabled><i class="bi bi-check-lg me-2"></i>บันทึกผลแล้ว</button>`;
                }

            } else if (!subject.IsActive) { 
                // [สถานะ: ปิดการใช้งาน] -> สีเทา
                cardOpacity = '0.7';
                statusTextHtml = `<div class="d-flex align-items-center text-muted small"><i class="bi bi-lock-fill me-2"></i>ปิดรับการสอบ</div>`;
                btnHtml = `<button class="btn btn-light text-muted w-100 rounded-pill border" disabled>ไม่เปิดให้ทำ</button>`;

            } else if (!subject.isAllowedYear) {
                // [สถานะ: ผิดชั้นปี] -> สีเทา
                cardOpacity = '0.7';
                statusTextHtml = `<div class="d-flex align-items-center text-muted small"><i class="bi bi-person-x-fill me-2"></i>ไม่ได้รับอนุญาต</div>`;
                btnHtml = `<button class="btn btn-light text-muted w-100 rounded-pill border" disabled>เฉพาะปี ${subject.allowedYearsText}</button>`;

            } else if (subject.timeStatus === 'upcoming') { 
                // [สถานะ: ยังไม่ถึงเวลา] -> สีฟ้า/เทา
                statusColor = 'var(--color-info)';
                statusBorder = 'var(--color-info)';
                const startTime = new Date(subject.StartTime).toLocaleString('th-TH', options);
                statusTextHtml = `<div class="d-flex align-items-center text-info small"><i class="bi bi-clock me-2"></i>เริ่ม: ${startTime} น.</div>`;
                btnHtml = `<button class="btn btn-light text-info w-100 rounded-pill border border-info-subtle" disabled>รอเวลาสอบ</button>`;

            } else if (subject.timeStatus === 'ended') { 
                // [สถานะ: หมดเวลา] -> สีแดง
                statusColor = 'var(--color-danger)';
                statusBorder = 'var(--color-danger)';
                cardOpacity = '0.8';
                statusTextHtml = `<div class="d-flex align-items-center text-danger small"><i class="bi bi-hourglass-bottom me-2"></i>หมดเวลาสอบแล้ว</div>`;
                btnHtml = `<button class="btn btn-outline-danger w-100 rounded-pill" disabled>หมดเวลา</button>`;

            } else {
                // [สถานะ: พร้อมสอบ (Available)] -> สีม่วง (Primary)
                statusColor = 'var(--color-primary)';
                statusBorder = 'var(--color-primary)';
                statusBadge = `<span class="position-absolute top-0 end-0 m-3 badge rounded-pill bg-primary bg-opacity-10 text-primary px-3"><i class="bi bi-lightning-fill me-1"></i>พร้อมสอบ</span>`;
                statusTextHtml = `<div class="d-flex align-items-center small" style="color: var(--color-primary);"><i class="bi bi-play-circle-fill me-2"></i>เปิดระบบให้ทำแบบทดสอบ</div>`;
                btnHtml = `<button class="btn btn-primary w-100 rounded-pill shadow-btn fw-bold" onclick='promptForExamPIN(${JSON.stringify(subject)})'><i class="bi bi-pencil-square me-2"></i>เข้าห้องสอบ</button>`;
            }

            // 2. HTML Template (Minimal Card)
            return `
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 border-0 shadow-sm position-relative" 
                        style="border-radius: 16px; border-left: 5px solid ${statusBorder} !important; opacity: ${cardOpacity}; transition: transform 0.2s;">
                        
                        ${statusBadge}

                        <div class="card-body p-4 d-flex flex-column">
                            <div class="mb-2">
                                <span class="badge bg-light text-secondary border fw-normal" style="letter-spacing: 0.5px;">
                                    ${subject.SubjectCode || 'ไม่ระบุรหัส'}
                                </span>
                            </div>

                            <h5 class="card-title fw-bold mb-3 text-truncate-2" style="color: var(--text-main); min-height: 3rem;">
                                ${subject.SubjectName}
                            </h5>

                            <div class="mb-3">
                                <div class="d-flex align-items-center text-muted small mb-1">
                                    <i class="bi bi-people-fill me-2" style="color: ${statusColor}; opacity: 0.7;"></i>
                                    <span>สำหรับชั้นปี: <strong>${subject.allowedYearsText}</strong></span>
                                </div>
                                ${statusTextHtml}
                            </div>

                            <div class="mt-auto pt-2">
                                ${btnHtml}
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    function showExamInstructions(subject) {
        isScoreViewMode = false; // <-- ตั้งค่าเป็นโหมดทำข้อสอบ
        currentExamSubject = subject;
        document.getElementById('exam-title').textContent = `[${subject.SubjectCode || 'N/A'}] ${subject.SubjectName}`;
        document.getElementById('exam-description').textContent = subject.Description;
        document.getElementById('exam-agree-checkbox').checked = false;
        document.getElementById('exam-start-btn').disabled = true;
        showView('exam-instructions-view');
    }
    
    function toggleExamStartButton() {
        const checkbox = document.getElementById('exam-agree-checkbox');
        document.getElementById('exam-start-btn').disabled = !checkbox.checked;
    }

    /** [เวอร์ชันแก้ไข] ฟังก์ชันแสดงหัวข้อสอบ, เริ่มนับถอยหลัง และบันทึกสถานะการสอบ */
    function fetchExamTopics() {
        showView('exam-topic-list-view');
        document.getElementById('exam-topic-title').textContent = `หัวข้อในรายวิชา: ${currentExamSubject.SubjectName}`;
        const container = document.getElementById('exam-topic-list');
        container.innerHTML = `<p class="text-center">กำลังโหลด...</p>`;
        
        sessionStorage.setItem('activeExamSubject', JSON.stringify(currentExamSubject));

        google.script.run.logExamStart({
            userEmail: currentUser.email,
            subjectId: currentExamSubject.SubjectID
        });

        if (currentExamSubject.EndTime) {
            // [แก้ไข] ส่งอ็อบเจกต์ทั้งหมดไปแทนแค่เวลา
            startCountdown(currentExamSubject, ['topic-list-timer']);
        }

        google.script.run.withSuccessHandler(displayExamTopics)
            .getExamTopicsForSubject(currentExamSubject.SubjectID, currentUser.email);
    }

    /**
     * [อัปเกรดล่าสุด] แสดงผลหน้ารายการหัวข้อสอบ โดยทำงานได้ 2 โหมด: "ทำข้อสอบ" และ "ดูคะแนน"
     */
    function displayExamTopics(data) {
        if (!data) return;

        const { subject, topics, allTopicsCompleted } = data;
        
        // Header
        document.getElementById('exam-topic-title').innerHTML = `
            <span class="text-muted fs-6 d-block mb-1">รายวิชา</span>
            ${subject.SubjectName}
        `;
        
        const topicContainer = document.getElementById('exam-topic-list');
        const submissionContainer = document.getElementById('exam-final-submission-container');

        document.getElementById('exam-total-score-summary').classList.add('d-none');

        if (!topics || topics.length === 0) {
            topicContainer.innerHTML = `
                <div class="alert alert-light text-center border rounded-4">
                    <p class="mb-0 text-muted">ไม่พบหัวข้อสอบในรายวิชานี้</p>
                </div>`;
        } else {
            topicContainer.innerHTML = topics.map((topic, idx) => {
                if (topic.hasSubmitted) {
                    // แบบสอบแล้ว (Disabled Card)
                    return `
                        <div class="card border-0 bg-light mb-3 rounded-4 opacity-75">
                            <div class="card-body d-flex justify-content-between align-items-center p-4">
                                <div>
                                    <h6 class="fw-bold text-muted mb-1">${idx + 1}. ${topic.TopicName}</h6>
                                    <small class="text-success"><i class="bi bi-check-circle-fill me-1"></i>ส่งข้อสอบแล้ว</small>
                                </div>
                                <button class="btn btn-light border rounded-pill px-3" disabled>
                                    เรียบร้อย
                                </button>
                            </div>
                        </div>`;
                } else {
                    // แบบยังไม่สอบ (Active Card)
                    return `
                        <div class="card border-0 shadow-sm mb-3 rounded-4 course-card-hover cursor-pointer" 
                             onclick='startFinalExam(${JSON.stringify(topic)})' style="cursor: pointer;">
                            <div class="card-body d-flex justify-content-between align-items-center p-4">
                                <div>
                                    <h6 class="fw-bold text-main mb-1">${idx + 1}. ${topic.TopicName}</h6>
                                    <small class="text-primary"><i class="bi bi-play-circle-fill me-1"></i>กดเพื่อเริ่มทำข้อสอบ</small>
                                </div>
                                <button class="btn btn-primary rounded-circle shadow-sm" style="width: 40px; height: 40px; padding: 0;">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>`;
                }
            }).join('');
        }

        // ปุ่มส่งทั้งหมด
        if (allTopicsCompleted) {
            submissionContainer.innerHTML = `
                <div class="text-center mt-5">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-success bg-opacity-10 text-success mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-trophy-fill fs-3"></i>
                    </div>
                    <h5 class="fw-bold">ยอดเยี่ยม! คุณทำครบทุกหัวข้อแล้ว</h5>
                    <button class="btn btn-success btn-lg rounded-pill px-5 mt-3 shadow-btn fw-bold" onclick="handleFinalSubjectSubmission()">
                        <i class="bi bi-send-check-fill me-2"></i>ยืนยันการส่งข้อสอบทั้งหมด
                    </button>
                </div>`;
        } else {
            submissionContainer.innerHTML = '';
        }
    }
    
    /**
    * [เวอร์ชันแก้ไข] เริ่มทำข้อสอบ
    */
    function startFinalExam(topic) {
        Swal.fire({
            title: 'ยืนยันการเริ่มทำข้อสอบ',
            text: `คุณต้องการเริ่มทำข้อสอบสำหรับหัวข้อ "${topic.TopicName}" ใช่หรือไม่?`,
            icon: 'warning',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showCancelButton: true,
            confirmButtonColor: "#198754",
            cancelButtonColor: "#dc3545",
            confirmButtonText: "ตกลง",
            cancelButtonText: "ยกเลิก"
        }).then((result) => {
            if (result.isConfirmed) {
                // 1. เปิดระบบ Anti-Cheat และบันทึก Log
                activateAntiCheat();
                const logData = { userEmail: currentUser.email, topicId: topic.TopicID };
                google.script.run.logExamTopicEntry(logData);

                isFinalExamMode = true;
                currentExamTopic = topic;

                showView('exam-taking-view'); 
                
                // 2. [ใหม่] จัดการปุ่ม Info (แสดง/ซ่อน ตามการตั้งค่ารายวิชา)
                const infoBtn = document.getElementById('exam-info-btn');
                const showInfo = (currentExamSubject.ShowInfo === true || String(currentExamSubject.ShowInfo).toUpperCase() === 'TRUE');
                
                if (showInfo) {
                    infoBtn.classList.remove('d-none');
                } else {
                    infoBtn.classList.add('d-none');
                }

                // 3. แสดง Loading
                document.getElementById('exam-current-question-display').innerHTML = "<p class='text-center p-3'>กำลังโหลดข้อสอบ...</p>";
                document.getElementById('exam-alert-incomplete').classList.add('d-none');

                // 4. เรียกข้อมูลข้อสอบ
                google.script.run.withSuccessHandler(quizData => {
                    // จัดการ Timer
                    if (currentExamSubject.EndTime) {
                        startCountdown(currentExamSubject, ['topic-list-timer', 'exam-timer']);
                    } else {
                        if (examTimerInterval) clearInterval(examTimerInterval);
                        document.getElementById('exam-timer').textContent = '';
                        document.getElementById('topic-list-timer').textContent = '';
                    }

                    // เริ่ม Quiz
                    setupQuiz(quizData, 'exam');

                    // 5. [แก้ไข] การแสดง Title แบบใหม่ (ใส่ใน Container)
                    const titleContainer = document.getElementById('exam-title-container');
                    titleContainer.innerHTML = ''; // เคลียร์ title เก่า
                    
                    if (currentExamTopic) {
                        const titleElement = document.createElement('h3');
                        titleElement.className = 'mb-0';
                        titleElement.innerText = `กำลังทำข้อสอบ: ${currentExamTopic.TopicName}`;
                        titleContainer.appendChild(titleElement);
                    }
                }).getExamQuizData(currentUser.email, topic.TopicID);
            }
        });
    }

    function showExamSubmissionResult(result) {
        deactivateAntiCheat(); // <<< [เพิ่ม] ปิดระบบป้องกัน
        if (result.success) {
            document.getElementById('submission-time').textContent = new Date(result.timestamp).toLocaleString('th-TH');
            showView('exam-submitted-view');
        } else {
            // [เดิม] alert('เกิดข้อผิดพลาดในการส่งข้อสอบ: ' + result.message);
            // [ใหม่] เปลี่ยนเป็น SweetAlert2
            Swal.fire({
                title: 'เกิดข้อผิดพลาด',
                text: 'เกิดข้อผิดพลาดในการส่งข้อสอบ: ' + result.message,
                icon: 'error',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
        }
        isFinalExamMode = false;
    }

    /**
    * [ปรับปรุง] ยืนยันการส่งข้อสอบทั้งหมดสำหรับรายวิชา โดยรองรับการส่งอัตโนมัติ
    * (เพิ่มการตรวจสอบ Topic ค้าง เพื่อบันทึก ExamSubmissions ด้วย)
    */
    function handleFinalSubjectSubmission(isAutoSubmit = false) {

        // [แก้ไข] ลบตรรกะ check Topic ค้างออกไปเลย เพราะ Backend จะจัดการให้ชัวร์กว่า

        const submitAction = () => {
            // แสดง Loading
            Swal.fire({
                title: isAutoSubmit ? 'กำลังส่งอัตโนมัติ' : 'กำลังส่งข้อสอบ',
                text: 'ระบบกำลังประมวลผลและบันทึกคะแนน...',
                icon: 'info',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const submissionInfo = {
                userEmail: currentUser.email,
                subjectId: currentExamSubject.SubjectID
            };

            google.script.run.withSuccessHandler(res => {
                if (isAutoSubmit) Swal.close(); // ปิด Loading

                if (!isAutoSubmit) {
                    if (res.success) {
                        Swal.fire({
                            title: 'ส่งสำเร็จ!',
                            text: res.message,
                            icon: 'success'
                        });
                    } else {
                        Swal.fire({ title: 'เกิดข้อผิดพลาด', text: res.message, icon: 'error' });
                    }
                }

                if (res.success) {
                    if (examTimerInterval) clearInterval(examTimerInterval);
                    sessionStorage.removeItem('activeExamSubject');
                    currentExamTopic = null;
                    fetchExamSubjects();
                }
            }).recordFinalSubmission(submissionInfo);
        };

        // ข้ามการยืนยันถ้าเป็นการส่งอัตโนมัติ
        if (isAutoSubmit) {
            submitAction();
        } else {
            Swal.fire({
                title: 'ยืนยันการส่งข้อสอบ',
                text: `คุณแน่ใจว่าต้องการยืนยันการส่งข้อสอบทั้งหมดสำหรับรายวิชา "${currentExamSubject.SubjectName}" ใช่หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: "#198754",
                cancelButtonColor: "#dc3545",
                confirmButtonText: "ตกลง",
                cancelButtonText: "ยกเลิก"
            }).then((result) => {
                if (result.isConfirmed) {
                    submitAction();
                }
            });
        }
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับส่งข้อสอบหัวข้อปัจจุบันและยืนยันการส่งทั้งหมดต่อโดยอัตโนมัติ
     */
    function autoSubmitAndFinalize() {
        if (examTimerInterval) clearInterval(examTimerInterval);

        // ป้องกัน Error ถ้าไม่มี topic (แต่ปกติจะถูกเช็คจาก handleFinal มาแล้ว)
        if (!currentExamTopic) {
            handleFinalSubjectSubmission(true);
            return;
        }

        // สร้างข้อมูลสำหรับส่งข้อสอบหัวข้อที่ทำค้างอยู่
        const submissionData = {
            userEmail: currentUser.email,
            topicId: currentExamTopic.TopicID,
            userAnswersArray: userAnswers || []
        };

        // ส่งข้อสอบของหัวข้อปัจจุบันก่อน
        google.script.run.withSuccessHandler(() => {
            // --- [จุดแก้ไขสำคัญ] ---
            // เคลียร์ currentExamTopic เพื่อบอกว่า "ฉันส่งหัวข้อนี้เสร็จแล้วนะ"
            currentExamTopic = null;

            // เรียกฟังก์ชันเดิมอีกครั้ง (คราวนี้มันจะผ่านเงื่อนไข if ตัวบนสุด และไปบันทึก Final)
            handleFinalSubjectSubmission(true);
            // ----------------------
        }).submitExam(submissionData);
    }

    /**
     * [แก้ไข] ดึงข้อมูลรายวิชาสอบ (แบบมี Pagination)
     */
    function fetchExamSubjectManagement(page = 1) {
      showView('admin-exam-subject-management-view');
      const tbody = document.getElementById('exam-subject-table-body');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">กำลังโหลดข้อมูล...</td></tr>'; 

      const searchTerm = document.getElementById('exam-subject-search-input').value;
      const limit = document.getElementById('exam-subject-limit-select').value;
      const options = { page: page, limit: limit, searchTerm: searchTerm };

      google.script.run.withSuccessHandler(displayExamSubjectPage)
        .getExamSubjects(currentUser.email, options);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้ารายวิชาสอบ (ตาราง + pagination)
     */
    function displayExamSubjectPage(response) {
      if (!response || !response.data) {
        document.getElementById('exam-subject-table-body').innerHTML = '<tr><td colspan="6" class="text-center text-danger">โหลดข้อมูลไม่สำเร็จ</td></tr>';
        return;
      }
      const { data, totalItems, totalPages, currentPage, limit } = response;

      // 1. แสดงตาราง
      displayExamSubjectManagementTable(data);

      // 2. สร้าง Pagination
      buildPaginationControls('exam-subject', currentPage, totalPages, totalItems, limit, 'fetchExamSubjectManagement');
    }

    /** * [อัปเกรด] แสดงตารางจัดการรายวิชาสอบ
     * (แก้ไขบัคการตรวจสอบค่า Boolean/String และแก้ไข Callback ของปุ่มลบ)
     */
    function displayExamSubjectManagementTable(subjects) {
      const tbody = document.getElementById('exam-subject-table-body');
      if (!subjects || subjects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">ไม่พบข้อมูล</td></tr>';
        return;
      }

      tbody.innerHTML = subjects.map(sub => {
      
        // --- [จุดแก้ไขที่ 1] ---
        // สร้างตัวแปรที่ตรวจสอบค่าแบบชัดเจน (Explicit Check)
        // จะเป็น "จริง" ต่อเมื่อค่าเป็น Boolean true หรือ สตริง "TRUE" เท่านั้น
        const isActive = (sub.IsActive === true || String(sub.IsActive).toUpperCase() === 'TRUE');
        // --- [สิ้นสุดจุดแก้ไข] ---

        const switchHtml = `
                  <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" role="switch"
                            id="status-switch-${sub.SubjectID}"
                            ${isActive ? 'checked' : ''} onclick="handleToggleExamStatus('${sub.SubjectID}', this.checked)">
                      <label class="form-check-label" for="status-switch-${sub.SubjectID}">
                          ${isActive ? 'เปิด' : 'ปิด'}</label>
                  </div>`;

        return `
                  <tr>
                      <td><strong>${sub.SubjectID}</strong></td>
                      <td>${sub.SubjectCode || ''}</td> <td>${sub.SubjectName}</td>
                      <td>${sub.AllowedYears || 'ทุกชั้นปี'}</td>
                      <td>${switchHtml}</td>
                      <td>
                          <button class="btn btn-sm btn-success me-2" onclick="fetchSubjectScoreReport('${sub.SubjectID}')">ดูคะแนน</button>
                          <button class="btn btn-sm btn-info me-2" onclick="fetchExamTopicManagement('${sub.SubjectID}', '${sub.SubjectName}', 1)">จัดการหัวข้อ</button>
                          <button class="btn btn-sm btn-primary me-2" onclick='openEditExamSubjectModal(${JSON.stringify(sub)})'>แก้ไข</button>
                          <button class="btn btn-sm btn-danger" onclick="confirmDeleteRecord('ExamSubjects', '${sub.SubjectID}', () => fetchExamSubjectManagement(1))">ลบ</button>
                      </td>
                  </tr>`;
      }).join('');
    }

    /** [อัปเกรด] ฟังก์ชันสำหรับจัดการการกดสวิตช์ (แก้ไขบัค Race Condition) */
    function handleToggleExamStatus(subjectId, isActive) {
        const label = document.querySelector(`label[for="status-switch-${subjectId}"]`);
        const input = document.getElementById(`status-switch-${subjectId}`); // [เพิ่ม] 1. ดึงตัวสวิตช์ (input)
        const originalText = label.textContent.trim();

        label.textContent = 'กำลังเปลี่ยน...';
        input.disabled = true; // [เพิ่ม] 2. "ปิดการใช้งาน" สวิตช์ทันที

        // [เพิ่ม] สร้างฟังก์ชันสำหรับจัดการเมื่อ Backend ล้มเหลว (เช่น เน็ตตัด)
        const onFailure = (error) => {
            // [เดิม] alert("เกิดข้อผิดพลาดในการเชื่อมต่อ: " + error.message);
            // [ใหม่] เปลี่ยนเป็น SweetAlert2
            Swal.fire({
                title: 'เกิดข้อผิดพลาด',
                text: "เกิดข้อผิดพลาดในการเชื่อมต่อ: " + error.message,
                icon: 'error',
                allowOutsideClick: false,
                allowEscapeKey: false
            });

            // คืนค่าทุกอย่างกลับเหมือนเดิม
            label.textContent = originalText;
            input.checked = !isActive;
            input.disabled = false; // [เพิ่ม] 4. เปิดใช้งานสวิตช์คืน
        };

        google.script.run
            .withSuccessHandler(res => {
            if (res.success) {
                // สำเร็จ: อัปเดตข้อความ
                label.textContent = isActive ? 'เปิด' : 'ปิด';
            } else {
                // ล้มเหลว (Backend แจ้งกลับมา): คืนค่า
                    // [เดิม] alert(res.message);
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                Swal.fire({
                        title: 'เกิดข้อผิดพลาด',
                        text: res.message,
                        icon: 'error',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    });

                label.textContent = originalText;
                input.checked = !isActive;
            }
            input.disabled = false; // [เพิ่ม] 3. เปิดใช้งานสวิตช์คืน (ไม่ว่าจะสำเร็จหรือล้มเหลว)
        })
            .withFailureHandler(onFailure) // [เพิ่ม]
            .toggleExamSubjectStatus(subjectId, isActive);
    }

    function openAddExamSubjectModal() {
        document.querySelector('#addExamSubjectModal form').reset();
        createYearCheckboxes('add-allowedYears-checkboxes');

        // [แก้ไข] ตั้งค่า ID เป็น Auto และ Disabled (ใน HTML ควรมี disabled อยู่แล้ว หรือทำผ่าน JS ก็ได้)
        const idInput = document.getElementById('add-subjectId');
        idInput.value = 'ระบบสร้างให้อัตโนมัติ';
        idInput.disabled = true; // ป้องกันการแก้ไข

        // รีเซ็ต Quill Editor (ถ้ามี)
        if (typeof quillAddInfo !== 'undefined' && quillAddInfo) {
             quillAddInfo.root.innerHTML = '';
             toggleExamInfoEditor('add', false);
        }

        new bootstrap.Modal(document.getElementById('addExamSubjectModal')).show();
    }

    /** [ใหม่] ฟังก์ชันรวบรวมค่าจาก Checkbox ที่ถูกเลือก */
    function getSelectedYears(containerId) {
        const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`);
        const selected = Array.from(checkboxes).map(cb => cb.value);
        return selected.join(','); // แปลงเป็น String คั่นด้วย comma
    }

    function handleAddNewExamSubject(event) {
        event.preventDefault();
        
        // ตรวจสอบว่ามี Quill หรือไม่ ถ้าไม่มีให้กัน Error
        let infoContent = '';
        if (typeof quillAddInfo !== 'undefined' && quillAddInfo) {
            infoContent = quillAddInfo.root.innerHTML;
        }

        const subjectData = {
            // subjectId: ไม่ต้องส่ง เพราะ Backend จะสร้างให้
            subjectCode: document.getElementById('add-subject-code').value,
            subjectName: document.getElementById('add-subjectName').value,
            description: document.getElementById('add-subject-description').value,
            allowedYears: getSelectedYears('add-allowedYears-checkboxes'), // ตรวจสอบว่ามีฟังก์ชันนี้อยู่แล้ว
            startTime: document.getElementById('add-startTime').value,
            endTime: document.getElementById('add-endTime').value,
            examPIN: document.getElementById('add-exam-pin').value,
            unlockPIN: document.getElementById('add-unlock-pin').value,
            announceScores: document.getElementById('add-subject-announce-scores').checked,
            showAnswers: document.getElementById('add-subject-show-answers').checked,
            showInfo: document.getElementById('add-subject-show-info').checked,
            examInfoContent: infoContent
        };

        Swal.fire({
            title: 'กำลังเพิ่มรายวิชาสอบ',
            text: 'ระบบกำลังสร้าง Subject ID และบันทึกข้อมูล...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                Swal.fire({
                    title: 'เพิ่มสำเร็จ!',
                    // res.message จะส่งกลับมาบอกว่า ID อะไรที่ถูกสร้าง เช่น "เพิ่มรายวิชาสอบสำเร็จ (ID: S005)"
                    text: res.message, 
                    icon: 'success',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                bootstrap.Modal.getInstance(document.getElementById('addExamSubjectModal')).hide();

                // รีเซ็ตค่า Form
                document.getElementById('add-subject-code').value = '';
                document.getElementById('add-subjectName').value = '';
                document.getElementById('add-subject-description').value = '';
                // รีเซ็ตค่า Quill Editor
                if (typeof quillAddInfo !== 'undefined' && quillAddInfo) {
                    quillAddInfo.root.innerHTML = '';
                }
                toggleExamInfoEditor('add', false);

                // รีโหลดข้อมูลตาราง (ถ้ามีฟังก์ชันนี้)
                if(typeof fetchExamSubjectManagement === 'function') {
                    fetchExamSubjectManagement();
                }
            } else {
                Swal.fire('เกิดข้อผิดพลาด', res.message, 'error');
            }
        }).addExamSubject(subjectData, currentUser.email);
    }

    function openEditExamSubjectModal(subject) {
        document.getElementById('edit-subjectId').value = subject.SubjectID;
        document.getElementById('edit-subject-code').value = subject.SubjectCode || '';
        document.getElementById('edit-subjectName').value = subject.SubjectName;
        document.getElementById('edit-subject-description').value = subject.Description;

        createYearCheckboxes('edit-allowedYears-checkboxes');
        if (subject.AllowedYears) {
            const allowedYearsArr = String(subject.AllowedYears).split(',');
            allowedYearsArr.forEach(year => {
                const checkbox = document.getElementById(`edit-allowedYears-checkboxes-${year.trim()}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        document.getElementById('edit-startTime').value = subject.StartTime ? subject.StartTime.slice(0, 16) : '';
        document.getElementById('edit-endTime').value = subject.EndTime ? subject.EndTime.slice(0, 16) : '';

        document.getElementById('edit-exam-pin').value = subject.ExamPIN || '';
        document.getElementById('edit-unlock-pin').value = subject.UnlockPIN || '';

        document.getElementById('edit-subject-announce-scores').checked = subject.AnnounceScores;

        // [แก้ไข] ตรวจสอบและตั้งค่า ShowAnswers
        const showAnswers = (subject.ShowAnswers === true || String(subject.ShowAnswers).toUpperCase() === 'TRUE');
        document.getElementById('edit-subject-show-answers').checked = showAnswers;

        // [ใหม่] จัดการส่วน Info
        const showInfo = (subject.ShowInfo === true || String(subject.ShowInfo).toUpperCase() === 'TRUE');
        document.getElementById('edit-subject-show-info').checked = showInfo;

        // เติมค่าลง Quill Editor
        if (typeof quillEditInfo !== 'undefined' && quillEditInfo) {
            quillEditInfo.root.innerHTML = subject.ExamInfoContent || '';
        }

        // สั่ง Show/Hide ตามค่าเดิม
        toggleExamInfoEditor('edit', showInfo);

        new bootstrap.Modal(document.getElementById('editExamSubjectModal')).show();
    }

    function handleUpdateExamSubject(event) {
        event.preventDefault();
        const subjectData = {
            subjectId: document.getElementById('edit-subjectId').value,
            subjectCode: document.getElementById('edit-subject-code').value,
            subjectName: document.getElementById('edit-subjectName').value,
            description: document.getElementById('edit-subject-description').value,
            allowedYears: getSelectedYears('edit-allowedYears-checkboxes'),
            startTime: document.getElementById('edit-startTime').value,
            endTime: document.getElementById('edit-endTime').value,
            announceScores: document.getElementById('edit-subject-announce-scores').checked,
            showAnswers: document.getElementById('edit-subject-show-answers').checked,
            examPIN: document.getElementById('edit-exam-pin').value,
            unlockPIN: document.getElementById('edit-unlock-pin').value,

            // [ใหม่] ข้อมูล Info Content
            showInfo: document.getElementById('edit-subject-show-info').checked,
            examInfoContent: (typeof quillEditInfo !== 'undefined' && quillEditInfo) ? quillEditInfo.root.innerHTML : ''
        };

        Swal.fire({
            title: 'กำลังอัปเดตรายวิชาสอบ',
            text: 'กรุณารอสักครู่',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                Swal.fire({
                    title: 'อัปเดตสำเร็จ!',
                    text: res.message,
                    icon: 'success',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                bootstrap.Modal.getInstance(document.getElementById('editExamSubjectModal')).hide();
                fetchExamSubjectManagement();
            } else {
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: res.message,
                    icon: 'error',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            }
        }).updateExamSubject(subjectData, currentUser.email);
    }

    function confirmDeleteExamSubject(subjectId) {
        // [เดิม] if (confirm(`คุณแน่ใจว่าต้องการลบรายวิชา ID: ${subjectId}?...`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: `คุณแน่ใจว่าต้องการลบรายวิชา ID: ${subjectId}? คำเตือน: การกระทำนี้จะลบเฉพาะตัวรายวิชา แต่จะไม่ลบหัวข้อหรือคำถามที่เกี่ยวข้อง`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message); ...
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if (res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        fetchExamSubjectManagement();
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteExamSubject(subjectId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    /** [ใหม่] สร้างชุด Checkbox สำหรับเลือกชั้นปี */
    function createYearCheckboxes(containerId, maxYear = 8) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        for (let i = 1; i <= maxYear; i++) {
            container.innerHTML += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${i}" id="${containerId}-${i}">
                    <label class="form-check-label" for="${containerId}-${i}">ปีที่ ${i}</label>
                </div>
            `;
        }
    }

    /**
     * [แก้ไข] ดึงข้อมูลหัวข้อสอบ (แบบมี Pagination)
     */
    function fetchExamTopicManagement(subjectId, subjectName, page = 1) {
      // [แก้ไข] ตรวจสอบและอัปเดต state
      if (subjectId && subjectName) {
        currentManagingSubject = { id: subjectId, name: subjectName };
        document.getElementById('exam-topic-search-input').value = '';
      } else if (page === 1) {
        // (ถ้า page = 1 แสดงว่ามาจากการค้นหา/เปลี่ยน limit)
        // ไม่ต้องทำอะไร ปล่อยให้ใช้ currentManagingSubject เดิม
      } else if (!currentManagingSubject) {
        // (ป้องกัน Error กรณีผู้ใช้คลิกเลขหน้า แต่ state หายไป)
        alert("เกิดข้อผิดพลาด: ไม่พบข้อมูลรายวิชาหลัก");
        showView('admin-exam-subject-management-view');
        return;
      }

      showView('admin-exam-topic-management-view');
      document.getElementById('exam-topic-mg-title').textContent = `หัวข้อใน: ${currentManagingSubject.name}`;
      const tbody = document.getElementById('exam-topic-table-body');
      tbody.innerHTML = '<tr><td colspan="3" class="text-center">กำลังโหลด...</td></tr>';

      const searchTerm = document.getElementById('exam-topic-search-input').value;
      const limit = document.getElementById('exam-topic-limit-select').value;
      const options = { page: page, limit: limit, searchTerm: searchTerm };

      google.script.run.withSuccessHandler(displayExamTopicPage)
        .getExamTopics(currentManagingSubject.id, options);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้าหัวข้อสอบ (ตาราง + pagination)
     */
    function displayExamTopicPage(response) {
      if (!response || !response.data) {
        document.getElementById('exam-topic-table-body').innerHTML = '<tr><td colspan="3" class="text-center text-danger">โหลดข้อมูลไม่สำเร็จ</td></tr>';
        return;
      }
      const { data, totalItems, totalPages, currentPage, limit } = response;

      // 1. แสดงตาราง
      displayExamTopicTable(data);

      // 2. สร้าง Pagination
      buildPaginationControls('exam-topic', currentPage, totalPages, totalItems, limit, 'fetchExamTopicManagement');
    }

    /**
     * (ฟังก์ชันเดิม) แสดงตารางหัวข้อสอบ
     */
    function displayExamTopicTable(topics) {
      const tbody = document.getElementById('exam-topic-table-body');
      tbody.innerHTML = topics.map(topic => `
                <tr>
                    <td>${topic.TopicID}</td>
                    <td>${topic.TopicName}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-2" onclick="fetchExamQuestionManagement('${topic.TopicID}', '${topic.TopicName}', 1)">จัดการคำถาม</button>
                        <button class="btn btn-sm btn-primary me-2" onclick='openEditExamTopicModal(${JSON.stringify(topic)})'>แก้ไข</button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteExamTopic('${topic.TopicID}')">ลบ</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="3" class="text-center">ไม่พบหัวข้อ</td></tr>';
    }

    function openAddExamTopicModal() {
        document.querySelector('#addExamTopicModal form').reset();
        new bootstrap.Modal(document.getElementById('addExamTopicModal')).show();
    }

    function handleAddNewExamTopic(event) {
      event.preventDefault();
      const topicData = {
        // topicId: document.getElementById('add-topicId').value,
        subjectId: currentManagingSubject.id,
        topicName: document.getElementById('add-topicName').value,
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังเพิ่มหัวข้อสอบ',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'เพิ่มสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
          bootstrap.Modal.getInstance(document.getElementById('addExamTopicModal')).hide();
          fetchExamTopicManagement(currentManagingSubject.id, currentManagingSubject.name);
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).addExamTopic(topicData, currentUser.email); // <-- ส่งอีเมล
    }

    function openEditExamTopicModal(topic) {
        document.getElementById('edit-topicId').value = topic.TopicID;
        document.getElementById('edit-topicName').value = topic.TopicName;
        new bootstrap.Modal(document.getElementById('editExamTopicModal')).show();
    }

    function handleUpdateExamTopic(event) {
      event.preventDefault();
      const topicData = {
        topicId: document.getElementById('edit-topicId').value,
        topicName: document.getElementById('edit-topicName').value,
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังอัปเดตหัวข้อสอบ',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'อัปเดตสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
          bootstrap.Modal.getInstance(document.getElementById('editExamTopicModal')).hide();
          fetchExamTopicManagement(currentManagingSubject.id, currentManagingSubject.name);
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).updateExamTopic(topicData, currentUser.email); // <-- ส่งอีเมล
    }

    function confirmDeleteExamTopic(topicId) {
        // [เดิม] if (confirm(`ต้องการลบหัวข้อ ID: ${topicId} จริงหรือไม่?...`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: `ต้องการลบหัวข้อ ID: ${topicId} จริงหรือไม่? (คำเตือน: การกระทำนี้จะไม่ลบคำถามที่อยู่ภายใต้หัวข้อนี้)`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message); ...
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if (res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        // [เดิม] fetchExamTopicManagement(...);
                        fetchExamTopicManagement(currentManagingSubject.id, currentManagingSubject.name);
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteExamTopic(topicId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    /**
    * [แก้ไข] ดึงข้อมูลคำถามสอบ (แบบมี Pagination)
    */
    function fetchExamQuestionManagement(topicId, topicName, page = 1) {
      if (topicId && topicName) {
        currentManagingTopic = { id: topicId, name: topicName };
        document.getElementById('exam-question-search-input').value = '';
      } else if (page === 1) {
        // (ถ้า page = 1 แสดงว่ามาจากการค้นหา/เปลี่ยน limit)
        // ไม่ต้องทำอะไร ปล่อยให้ใช้ currentManagingTopic เดิม
      } else if (!currentManagingTopic) {
        // (ป้องกัน Error กรณีผู้ใช้คลิกเลขหน้า แต่ state หายไป)
            // [เดิม] alert("เกิดข้อผิดพลาด: ไม่พบข้อมูลหัวข้อหลัก");
            // [เดิม] showView('admin-exam-topic-management-view');
            // [เดิม] return;
            // [ใหม่] เปลี่ยนเป็น SweetAlert2
        Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: 'ไม่พบข้อมูลหัวข้อหลัก',
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then(() => {
            // [ใหม่] ย้าย showView มาไว้ใน .then()
            showView('admin-exam-topic-management-view');
        });
        return;
      }

      showView('admin-exam-question-management-view');
      document.getElementById('exam-question-mg-title').textContent = `คำถามใน: ${currentManagingTopic.name}`;
      const tbody = document.getElementById('exam-question-table-body');
      tbody.innerHTML = '<tr><td colspan="4" class="text-center">กำลังโหลด...</td></tr>';

      const searchTerm = document.getElementById('exam-question-search-input').value;
      const limit = document.getElementById('exam-question-limit-select').value;
      const options = { page: page, limit: limit, searchTerm: searchTerm };

      google.script.run.withSuccessHandler(displayExamQuestionPage)
        .getExamQuestionsForAdmin(currentManagingTopic.id, options);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้าคำถามสอบ (ตาราง + pagination)
     */
    function displayExamQuestionPage(response) {
      if (!response || !response.data) {
        document.getElementById('exam-question-table-body').innerHTML = '<tr><td colspan="4" class="text-center text-danger">โหลดข้อมูลไม่สำเร็จ</td></tr>';
        return;
      }
      const { data, totalItems, totalPages, currentPage, limit } = response;

      // 1. แสดงตาราง
      displayExamQuestionTable(data);

      // 2. สร้าง Pagination
      buildPaginationControls('exam-question', currentPage, totalPages, totalItems, limit, 'fetchExamQuestionManagement');
    }

    /**
     * (ฟังก์ชันเดิม) แสดงตารางคำถามสอบ
     */
    function displayExamQuestionTable(questions) {
      const tbody = document.getElementById('exam-question-table-body');
      tbody.innerHTML = questions.map(q => `
                <tr>
                    <td>${q.QuestionID}</td>
                    <td class="text-truncate" style="max-width: 400px;">${q.QuestionText}</td>
                    <td><strong>${q.CorrectAnswer}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" onclick='openEditExamQuestionModal(${JSON.stringify(q)})'>แก้ไข</button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteExamQuestion('${q.QuestionID}')">ลบ</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="text-center">ไม่พบคำถาม</td></tr>';
    }

    function createExamQuestionFormHtml(prefix, data = {}) {
        // กำหนดข้อความที่จะแสดงในช่อง ID
        // ถ้ามี ID (โหมดแก้ไข) ให้แสดง ID, ถ้าไม่มี (โหมดเพิ่ม) ให้แสดงข้อความ Auto
        const showIdText = data.QuestionID ? data.QuestionID : 'ระบบสร้างให้อัตโนมัติ (Auto)';

        // ฟังก์ชันนี้จะสร้างฟอร์มคำถาม 5 ตัวเลือก
        return `
            <input type="hidden" id="${prefix}-questionId-hidden" value="${data.QuestionID || ''}">
            <div class="mb-3">
                <label class="form-label">Question ID</label>
                <input type="text" class="form-control text-muted" id="${prefix}-questionId" value="${showIdText}" disabled>
            </div>
            <div class="mb-3">
                <label class="form-label">คำถาม</label>
                <textarea class="form-control" id="${prefix}-questionText" rows="2" required>${data.QuestionText || ''}</textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Image URL (ถ้ามี)</label>
                <input type="url" class="form-control" id="${prefix}-imageUrl" value="${data.ImageURL || ''}">
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6 mb-3"><label class="form-label">ตัวเลือก A</label><input type="text" class="form-control" id="${prefix}-optionA" value="${data.OptionA || ''}" required></div>
                <div class="col-md-6 mb-3"><label class="form-label">ตัวเลือก B</label><input type="text" class="form-control" id="${prefix}-optionB" value="${data.OptionB || ''}" required></div>
                <div class="col-md-6 mb-3"><label class="form-label">ตัวเลือก C</label><input type="text" class="form-control" id="${prefix}-optionC" value="${data.OptionC || ''}" required></div>
                <div class="col-md-6 mb-3"><label class="form-label">ตัวเลือก D</label><input type="text" class="form-control" id="${prefix}-optionD" value="${data.OptionD || ''}" required></div>
                <div class="col-md-6 mb-3"><label class="form-label">ตัวเลือก E</label><input type="text" class="form-control" id="${prefix}-optionE" value="${data.OptionE || ''}"></div>
            </div>
            <div class="mb-3">
                <label class="form-label">คำตอบที่ถูกต้อง</label>
                <select class="form-select" id="${prefix}-correctAnswer" required>
                    <option value="">-- เลือกคำตอบ --</option>
                    <option value="A" ${data.CorrectAnswer === 'A' ? 'selected' : ''}>A</option>
                    <option value="B" ${data.CorrectAnswer === 'B' ? 'selected' : ''}>B</option>
                    <option value="C" ${data.CorrectAnswer === 'C' ? 'selected' : ''}>C</option>
                    <option value="D" ${data.CorrectAnswer === 'D' ? 'selected' : ''}>D</option>
                    <option value="E" ${data.CorrectAnswer === 'E' ? 'selected' : ''}>E</option>
                </select>
            </div>
        `;
    }

    function openAddExamQuestionModal() {
        document.getElementById('add-exam-question-modal-body').innerHTML = createExamQuestionFormHtml('add-exam');
        document.querySelector('#addExamQuestionModal form').reset();
        new bootstrap.Modal(document.getElementById('addExamQuestionModal')).show();
    }

    function handleAddNewExamQuestion(event) {
      event.preventDefault();
      const questionData = {
        // questionId: document.getElementById('add-exam-questionId').value,
        topicId: currentManagingTopic.id,
        questionText: document.getElementById('add-exam-questionText').value,
        optionA: document.getElementById('add-exam-optionA').value,
        optionB: document.getElementById('add-exam-optionB').value,
        optionC: document.getElementById('add-exam-optionC').value,
        optionD: document.getElementById('add-exam-optionD').value,
        optionE: document.getElementById('add-exam-optionE').value,
        correctAnswer: document.getElementById('add-exam-correctAnswer').value,
        imageUrl: document.getElementById('add-exam-imageUrl').value,
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังเพิ่มคำถามสอบ',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'เพิ่มสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
          bootstrap.Modal.getInstance(document.getElementById('addExamQuestionModal')).hide();
          fetchExamQuestionManagement(currentManagingTopic.id, currentManagingTopic.name);
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).addExamQuestion(questionData, currentUser.email); // <-- ส่งอีเมล
    }

    function openEditExamQuestionModal(question) {
        document.getElementById('edit-exam-question-modal-body').innerHTML = createExamQuestionFormHtml('edit-exam', question);
        new bootstrap.Modal(document.getElementById('editExamQuestionModal')).show();
    }

    function handleUpdateExamQuestion(event) {
      event.preventDefault();
      const questionData = {
        questionId: document.getElementById('edit-exam-questionId-hidden').value,
        questionText: document.getElementById('edit-exam-questionText').value,
        optionA: document.getElementById('edit-exam-optionA').value,
        optionB: document.getElementById('edit-exam-optionB').value,
        optionC: document.getElementById('edit-exam-optionC').value,
        optionD: document.getElementById('edit-exam-optionD').value,
        optionE: document.getElementById('edit-exam-optionE').value,
        correctAnswer: document.getElementById('edit-exam-correctAnswer').value,
        imageUrl: document.getElementById('edit-exam-imageUrl').value,
      };

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลังอัปเดตคำถามสอบ',
        text: 'กรุณารอสักครู่',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run.withSuccessHandler(res => {
        // [เดิม] alert(res.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        if (res.success) {
          Swal.fire({
            title: 'อัปเดตสำเร็จ!',
            text: res.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
          bootstrap.Modal.getInstance(document.getElementById('editExamQuestionModal')).hide();
          fetchExamQuestionManagement(currentManagingTopic.id, currentManagingTopic.name);
        } else {
          Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: res.message,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
          });
        }
      }).updateExamQuestion(questionData, currentUser.email); // <-- ส่งอีเมล
    }

    function confirmDeleteExamQuestion(questionId) {
        // [เดิม] if (confirm(`ต้องการลบคำถาม ID: ${questionId} จริงหรือไม่?`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: `ต้องการลบคำถาม ID: ${questionId} จริงหรือไม่?`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message); ...
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if (res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        // [เดิม] fetchExamQuestionManagement(...);
                        fetchExamQuestionManagement(currentManagingTopic.id, currentManagingTopic.name);
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteExamQuestion(questionId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    // --- [ใหม่] ฟังก์ชันจัดการข้อมูลสอบ ---

    // -- Exam Submission Functions [ปรับปรุง] --

    function fetchExamSubmissions(page = 1) {
        const stateKey = 'examSubmissions';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('exam-submission-table-body');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">กำลังโหลด...</td></tr>';
        google.script.run.withSuccessHandler(displayExamSubmissionsTable)
            .getAllExamSubmissions(currentUser.email, page, limit); // [แก้ไข]
    }

    function displayExamSubmissionsTable(response) {
        const tbody = document.getElementById('exam-submission-table-body');
        const stateKey = 'examSubmissions';

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('exam-sub-pagination-controls').innerHTML = '';
            document.getElementById('exam-sub-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(s => `
            <tr>
                <td>${s.Timestamp ? new Date(s.Timestamp).toLocaleString('th-TH') : 'N/A'}</td>
                <td>${s.FullName || 'N/A'}</td>
                <td>${s.UserEmail}</td>
                <td>${s.TopicName || 'N/A'}</td>
                <td>${s.TopicID}</td>
                <td>${s.Score}</td>
                <td>
                    <button class="btn btn-xs btn-primary me-1" onclick='openEditExamScoreModal(${JSON.stringify(s)})'>แก้ไข</button>
                    <button class="btn btn-xs btn-danger" onclick="confirmDeleteRecord('ExamSubmissions', '${s.SubmissionID}', () => fetchExamSubmissions(paginationState.${stateKey}.currentPage))">ลบ</button>
                </td>
            </tr>
        `).join('');

        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchExamSubmissions);
        document.getElementById('exam-sub-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchExamSubmissions);
        document.getElementById('exam-sub-pagination-controls').innerHTML = paginationControls;
    }

    function openEditExamScoreModal(submission) {
        document.getElementById('edit-exam-score-subId').textContent = submission.SubmissionID;
        document.getElementById('edit-exam-score-identifier').value = submission.SubmissionID;
        document.getElementById('edit-exam-score-value').value = submission.Score;
        new bootstrap.Modal(document.getElementById('editExamScoreModal')).show();
    }

    function handleUpdateExamScore(event) {
        event.preventDefault();
        const dataToSend = {
            submissionId: document.getElementById('edit-exam-score-identifier').value,
            newScore: document.getElementById('edit-exam-score-value').value
        };
        google.script.run.withSuccessHandler(res => {
            alert(res.message);
            if(res.success) {
                bootstrap.Modal.getInstance(document.getElementById('editExamScoreModal')).hide();
                fetchExamSubmissions();
            }
        }).updateExamScore(dataToSend);
    }

    // -- Exam Log Functions [ปรับปรุง] --

    function fetchExamLogs(page = 1) {
        const stateKey = 'examLogs';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('exam-log-table-body');
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">กำลังโหลด...</td></tr>';
        google.script.run.withSuccessHandler(displayExamLogsTable)
            .getAllExamAnswerLogs(currentUser.email, page, limit); // [แก้ไข]
    }

    function displayExamLogsTable(response) {
        const tbody = document.getElementById('exam-log-table-body');
        const stateKey = 'examLogs';

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('exam-logs-pagination-controls').innerHTML = '';
            document.getElementById('exam-logs-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(l => `
            <tr>
                <td>${l.Timestamp ? new Date(l.Timestamp).toLocaleString('th-TH') : 'N/A'}</td>
                <td>${l.FullName || 'N/A'}</td>
                <td>${l.UserEmail}</td>
                <td>${l.TopicName || 'N/A'}</td>
                <td>${l.TopicID}</td>
                <td class="text-truncate" style="max-width: 200px;">${l.QuestionText || 'N/A'}</td>
                <td>${l.QuestionID}</td>
                <td>${l.SelectedAnswer}</td>
                <td><button class="btn btn-xs btn-danger" onclick="confirmDeleteRecord('ExamAnswerLogs', '${l.LogID}', () => fetchExamLogs(paginationState.${stateKey}.currentPage), true)">ลบ</button></td>
            </tr>
        `).join('');

        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchExamLogs);
        document.getElementById('exam-logs-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchExamLogs);
        document.getElementById('exam-logs-pagination-controls').innerHTML = paginationControls;
    }

    // -- Final Submission Functions [ปรับปรุง] --

    function fetchFinalSubmissions(page = 1) {
        const stateKey = 'finalSubmissions';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('final-submission-table-body');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">กำลังโหลด...</td></tr>';
        google.script.run.withSuccessHandler(displayFinalSubmissionsTable)
            .getAllFinalSubmissions(currentUser.email, page, limit); // [แก้ไข]
    }

    function displayFinalSubmissionsTable(response) {
        const tbody = document.getElementById('final-submission-table-body');
        const stateKey = 'finalSubmissions';

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('final-sub-pagination-controls').innerHTML = '';
            document.getElementById('final-sub-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(f => `
            <tr>
                <td>${f.Timestamp ? new Date(f.Timestamp).toLocaleString('th-TH') : 'N/A'}</td>
                <td>${f.FullName || 'N/A'}</td>
                <td>${f.UserEmail}</td>
                <td>${f.SubjectName}</td>
                <td>${f.SubjectID}</td>
                <td><button class="btn btn-xs btn-danger" onclick="confirmDeleteRecord('FinalSubmissions', '${f.FinalSubmissionID}', () => fetchFinalSubmissions(paginationState.${stateKey}.currentPage))">ลบ</button></td>
            </tr>
        `).join('');

        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchFinalSubmissions);
        document.getElementById('final-sub-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchFinalSubmissions);
        document.getElementById('final-sub-pagination-controls').innerHTML = paginationControls;
    }

    /** [ใหม่] ฟังก์ชันกลางสำหรับยืนยันการลบ */
    function confirmDeleteRecord(sheetName, recordId, refreshFunction, isLog = false) {
        let warning = isLog ? 'การลบ Log อาจทำให้ข้อมูลไม่สอดคล้องกัน คุณแน่ใจหรือไม่?' : `คุณต้องการลบรายการ ID: ${recordId} ใช่หรือไม่?`;
        let title = isLog ? 'ยืนยันการลบ Log' : 'ยืนยันการลบ'; // [ใหม่] เพิ่ม Title

        // [เดิม] if (confirm(warning)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: title,
            text: warning,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message); if(res.success) refreshFunction();
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if(res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        refreshFunction(); // เรียกฟังก์ชัน refresh เมื่อสำเร็จ
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteRecordById(sheetName, recordId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    // --- [ใหม่] Announcement Functions ---

    // -- Student side --
    function fetchAnnouncements() {
        const container = document.getElementById('announcements-container');
        container.innerHTML = '';
        google.script.run.withSuccessHandler(announcements => {
            if (announcements && announcements.length > 0) {
                // [แก้ไข] เรียกใช้ฟังก์ชันกลาง
                container.innerHTML = announcements.map(createAnnouncementHtml).join('');
            }
        }).getAnnouncements();
    }

    // --- [ใหม่] Announcement Functions (Admin side) ---

    /**
     * [แก้ไข] ดึงข้อมูลประกาศ (แบบมี Pagination)
     * @param {number} page - เลขหน้าที่ต้องการ
     */
    function fetchAnnouncementManagement(page = 1) {
        showView('admin-announcement-management-view');
        const tbody = document.getElementById('announcement-table-body');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">กำลังโหลด...</td></tr>';
        
        // [ใหม่] ดึงค่า settings จาก UI
        const searchTerm = document.getElementById('announcement-search-input').value;
        const limit = document.getElementById('announcement-limit-select').value;
        const options = { page: page, limit: limit, searchTerm: searchTerm };

        // [แก้ไข] ส่ง options ไปยัง GAS และเรียกฟังก์ชัน displayPage
        google.script.run.withSuccessHandler(displayAnnouncementPage)
          .getAdminAnnouncements(options);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้าประกาศ (ตาราง + pagination)
     * @param {Object} response - อ็อบเจกต์ที่ได้จาก GAS (มี data, totalItems, totalPages, ...)
     */
    function displayAnnouncementPage(response) {
      const { data, totalItems, totalPages, currentPage, limit } = response;
      
      // 1. แสดงตาราง (ใช้ฟังก์ชันเดิม)
      displayAnnouncementTable(data);
      
      // 2. สร้าง Pagination
      buildPaginationControls('announcement', currentPage, totalPages, totalItems, limit, 'fetchAnnouncementManagement');
    }

    /**
     * (ฟังก์ชันเดิม) แสดงตารางประกาศ
     * @param {Array} announcements - ข้อมูลประกาศ (เฉพาะหน้านี้)
     */
    function displayAnnouncementTable(announcements) {
        const tbody = document.getElementById('announcement-table-body');
        tbody.innerHTML = announcements.map(ann => {
            // [แก้ไข] ตรวจสอบ IsActive ที่ส่งมาจาก GAS (แปลงเป็น boolean ก่อน)
            const isActive = String(ann.IsActive).toLowerCase() === 'true';
            const statusBadge = isActive
                ? `<span class="badge bg-success">Active</span>` 
                : `<span class="badge bg-secondary">Inactive</span>`;
            
            return `
                <tr>
                    <td>${ann.Title}</td>
                    <td>${ann.Author}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" onclick='openEditAnnouncementModal(${JSON.stringify(ann)})'>แก้ไข</button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteAnnouncement('${ann.AnnouncementID}')">ลบ</button>
                    </td>
                </tr>
            `;
        }).join('') || '<tr><td colspan="4" class="text-center">ไม่พบประกาศ</td></tr>';
    }

    function openAddAnnouncementModal() {
        document.querySelector('#addAnnouncementModal form').reset();
        new bootstrap.Modal(document.getElementById('addAnnouncementModal')).show();
    }

    function handleAddNewAnnouncement(event) {
        event.preventDefault();
        const annData = {
            title: document.getElementById('add-ann-title').value,
            content: document.getElementById('add-ann-content').value,
            type: document.getElementById('add-ann-type').value, // <-- เพิ่ม
            author: document.getElementById('add-ann-author').value
        };

        // [ใหม่] แสดงหน้าต่าง Loading
        Swal.fire({
            title: 'กำลังเพิ่มประกาศ',
            text: 'กรุณารอสักครู่',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        google.script.run.withSuccessHandler(res => {
            // [เดิม] alert(res.message);
            // [ใหม่] เปลี่ยนเป็น SweetAlert2
            if (res.success) {
                Swal.fire({
                    title: 'เพิ่มสำเร็จ!',
                    text: res.message,
                    icon: 'success',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                bootstrap.Modal.getInstance(document.getElementById('addAnnouncementModal')).hide();
                fetchAnnouncementManagement();
            } else {
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: res.message,
                    icon: 'error',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            }
        }).addAnnouncement(annData);
    }

    function openEditAnnouncementModal(ann) {
        document.getElementById('edit-ann-id').value = ann.AnnouncementID;
        document.getElementById('edit-ann-title').value = ann.Title;
        document.getElementById('edit-ann-content').value = ann.Content;
        document.getElementById('edit-ann-type').value = ann.Type || 'Info'; // <-- เพิ่ม (ใส่ Info เป็น default)
        document.getElementById('edit-ann-author').value = ann.Author;
        document.getElementById('edit-ann-isActive').checked = ann.IsActive;
        
        new bootstrap.Modal(document.getElementById('editAnnouncementModal')).show();
    }

    function handleUpdateAnnouncement(event) {
        event.preventDefault();
        const annData = {
            announcementId: document.getElementById('edit-ann-id').value,
            title: document.getElementById('edit-ann-title').value,
            content: document.getElementById('edit-ann-content').value,
            type: document.getElementById('edit-ann-type').value, // <-- เพิ่ม
            author: document.getElementById('edit-ann-author').value,
            isActive: document.getElementById('edit-ann-isActive').checked
        };

        // [ใหม่] แสดงหน้าต่าง Loading
        Swal.fire({
            title: 'กำลังอัปเดตประกาศ',
            text: 'กรุณารอสักครู่',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        google.script.run.withSuccessHandler(res => {
            // [เดิม] alert(res.message);
            // [ใหม่] เปลี่ยนเป็น SweetAlert2
            if (res.success) {
                Swal.fire({
                    title: 'อัปเดตสำเร็จ!',
                    text: res.message,
                    icon: 'success',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                bootstrap.Modal.getInstance(document.getElementById('editAnnouncementModal')).hide();
                fetchAnnouncementManagement();
            } else {
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: res.message,
                    icon: 'error',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            }
        }).updateAnnouncement(annData);
    }

    function confirmDeleteAnnouncement(announcementId) {
        // [เดิม] if (confirm(`คุณแน่ใจว่าต้องการลบประกาศ ID: ${announcementId}?`)) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: `คุณแน่ใจว่าต้องการลบประกาศ ID: ${announcementId}?`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    // [เดิม] alert(res.message); ...
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if (res.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        fetchAnnouncementManagement();
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteAnnouncement(announcementId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    /**
     * [ปรับปรุง] ฟังก์ชันกลางสำหรับสร้าง HTML ของประกาศตาม Type (Minimalist Theme)
     * @param {object} ann - ข้อมูลประกาศ 1 รายการ
     * @return {string} โค้ด HTML ของประกาศ
     */
    function createAnnouncementHtml(ann) {
        // 1. กำหนดตัวแปรสีและไอคอนตามธีม CSS Variables
        let colorVar = 'var(--color-info)'; // Default Info
        let iconClass = 'bi-info-circle-fill';
        
        // แปลง Type เป็น Style
        switch (ann.Type) {
            case 'Success':
                colorVar = 'var(--color-success)';
                iconClass = 'bi-check-circle-fill';
                break;
            case 'Warning':
                colorVar = 'var(--color-warning)';
                iconClass = 'bi-exclamation-triangle-fill';
                break;
            case 'Error':
                colorVar = 'var(--color-danger)';
                iconClass = 'bi-x-octagon-fill';
                break;
            case 'Help':
                colorVar = 'var(--color-primary)'; // ใช้สีม่วงหลักแทน
                iconClass = 'bi-question-circle-fill';
                break;
        }

        // จัดรูปแบบวันที่
        const dateStr = new Date(ann.Timestamp).toLocaleString('th-TH', {
            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        // 2. สร้าง HTML แบบ Minimal Card
        // - ใช้ border-left สีตามประเภท
        // - ใช้พื้นหลังขาวสะอาด (bg-white) และเงาบางๆ (shadow-sm)
        return `
            <div class="card border-0 shadow-sm mb-4" 
                style="border-radius: 16px; border-left: 5px solid ${colorVar} !important; overflow: hidden; background: #fff;">
                
                <div class="card-body p-4">
                    <div class="d-flex align-items-start">
                        
                        <div class="flex-shrink-0 me-3">
                            <div class="d-flex align-items-center justify-content-center rounded-circle" 
                                style="width: 50px; height: 50px; background-color: color-mix(in srgb, ${colorVar}, white 90%); color: ${colorVar};">
                                <i class="bi ${iconClass} fs-4"></i>
                            </div>
                        </div>

                        <div class="flex-grow-1">
                            
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start mb-2">
                                <h5 class="fw-bold mb-1" style="color: var(--text-main);">${ann.Title}</h5>
                                <small class="text-muted d-flex align-items-center mt-1 mt-md-0">
                                    <i class="bi bi-clock me-1"></i> ${dateStr}
                                </small>
                            </div>

                            <div class="text-muted mb-3" style="line-height: 1.7; font-size: 0.95rem;">
                                ${ann.Content || ''}
                            </div>

                            <div class="d-flex align-items-center">
                                <div class="badge rounded-pill px-3 py-2 border" 
                                      style="background-color: var(--bg-light); color: var(--text-muted); font-weight: 500;">
                                    <i class="bi bi-person-circle me-2"></i>ผู้ประกาศ: ${ann.Author}
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>`;
    }

    /**
     * [แก้ไข] ดึงข้อมูลประวัติการสอบ (แบบแบ่งหน้า)
     * @param {number} page - เลขหน้าที่ต้องการ
     */
    function fetchExamHistory(page = 1) {
        if (!currentUser) { return; }
        showView('exam-history-view');
        const container = document.getElementById('exam-history-table-body');
        container.innerHTML = `<tr><td colspan="6" class="text-center">กำลังโหลดประวัติ...</td></tr>`;
        
        // [ใหม่] รวบรวม options จาก UI
        const options = {
            page: page,
            limit: document.getElementById('exam-history-limit').value,
            searchTerm: document.getElementById('exam-history-search').value
        };
        
        // [แก้ไข] เรียกใช้ฟังก์ชัน Backend ที่อัปเกรดแล้ว และส่ง options ไปด้วย
        google.script.run.withSuccessHandler(displayExamHistoryPage)
            .getExamHistoryDetails(currentUser.email, options);
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับจัดการเมื่อผู้ใช้กดปุ่ม "ดูผลคะแนน" จากหน้าประวัติ
     */
    function handleViewScores(subject) {
        showView('exam-score-announcement-view');
        
        // 1. ตั้งชื่อหัวข้อชั่วคราว
        const header = document.getElementById('score-announcement-header');
        if (header) header.innerText = `ผลการสอบ: ${subject.SubjectName || 'กำลังโหลด...'}`;

        // 2. แสดง Loading เฉพาะใน Container (ไม่ลบปุ่มย้อนกลับ ไม่ลบหัวข้อ)
        const container = document.getElementById('score-announcement-container');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p class="text-muted">กำลังโหลดผลคะแนน...</p>
                </div>`;
        }

        // 3. เรียก Backend
        google.script.run.withSuccessHandler(displayScoreAnnouncementPage)
            .getExamTopicsForSubject(subject.SubjectID, currentUser.email);
    }

    /**
     * [อัปเกรด] สร้างการ์ดเฉลยข้อสอบ (Minimalist Style - Consistent with Answer Key)
     */
    function renderExamReviewCards(reviewData) {
        if (!reviewData || reviewData.length === 0) {
            return `
                <div class="alert alert-light text-center border rounded-4 py-4">
                    <p class="text-muted mb-0">ไม่พบข้อมูลเฉลยสำหรับชุดข้อสอบนี้</p>
                </div>`;
        }

        return `<div class="row g-4">` + reviewData.map((q, index) => {
            const isCorrect = q.UserAnswer === q.CorrectAnswer;
            const options = ['A', 'B', 'C', 'D'];
            if (q.OptionE) options.push('E'); // Check Option E

            // Theme Colors
            const borderColor = isCorrect ? 'var(--color-success)' : 'var(--color-danger)';
            const statusIcon = isCorrect 
                ? '<i class="bi bi-check-circle-fill text-success fs-4"></i>' 
                : '<i class="bi bi-x-circle-fill text-danger fs-4"></i>';

            // Collapse ID
            const collapseId = `exam-explain-${index}`;
            const hasExplanation = q.Explanation && q.Explanation.trim() !== '';

            // Render Options
            const optionsHtml = options.map(opt => {
                const optText = q['Option' + opt] || ''; // Handle formatting
                let optClass = "border border-light-subtle bg-light text-muted";
                let iconHtml = "";

                if (opt === q.CorrectAnswer) {
                    optClass = "border-success bg-success bg-opacity-10 text-success fw-bold";
                    iconHtml = '<i class="bi bi-check-lg ms-auto"></i>';
                }
                
                if (opt === q.UserAnswer && opt !== q.CorrectAnswer) {
                    optClass = "border-danger bg-danger bg-opacity-10 text-danger fw-bold";
                    iconHtml = '<i class="bi bi-x-lg ms-auto"></i>';
                } else if (opt === q.UserAnswer && opt === q.CorrectAnswer) {
                    optClass = "border-success bg-success bg-opacity-10 text-success fw-bold";
                    iconHtml = '<i class="bi bi-check-circle-fill ms-auto"></i>';
                }

                return `
                    <div class="d-flex align-items-center p-3 rounded-3 mb-2 ${optClass}" style="transition: all 0.2s;">
                        <span class="me-3" style="min-width: 25px;">${opt}.</span>
                        <span class="flex-grow-1">${optText}</span>
                        ${iconHtml}
                    </div>
                `;
            }).join('');

            return `
                <div class="col-12 col-lg-10 mx-auto">
                    <div class="card border-0 shadow-sm h-100" 
                        style="border-radius: 16px; border-left: 6px solid ${borderColor} !important;">
                        
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <span class="badge rounded-pill bg-light text-secondary border mb-2">ข้อที่ ${index + 1}</span>
                                    <h5 class="card-title fw-bold" style="line-height: 1.6;">${q.QuestionText}</h5>
                                </div>
                                <div class="ps-3">${statusIcon}</div>
                            </div>

                            <div class="mb-3">
                                ${optionsHtml}
                            </div>

                            ${hasExplanation ? `
                                <button class="btn btn-sm btn-light w-100 rounded-pill py-2 text-primary fw-bold border-0" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#${collapseId}" 
                                        style="background-color: var(--bg-light);">
                                    <i class="bi bi-lightbulb-fill me-2"></i>ดูคำอธิบาย
                                </button>
                                
                                <div class="collapse mt-2" id="${collapseId}">
                                    <div class="p-3 rounded-3 bg-white border border-light-subtle shadow-sm d-flex align-items-start">
                                        
                                        <i class="bi bi-info-circle-fill text-primary fs-5 me-3 flex-shrink-0 mt-1"></i>
                                        
                                        <div class="text-muted small" style="line-height: 1.6;">
                                            ${q.Explanation}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('') + `</div>`;
    }

    /**
     * [ปรับปรุง] ฟังก์ชันสำหรับแสดงผลหน้าประกาศคะแนน (เพิ่มการ์ดสถิติ และเฉลยรายข้อ)
     */
    function displayScoreAnnouncementPage(data) {
        const container = document.getElementById('score-announcement-container');
        const header = document.getElementById('score-announcement-header');

        // Error handling ถ้าหา Container ไม่เจอ
        if (!container) {
            console.error("Error: 'score-announcement-container' not found in DOM");
            return;
        }

        // กรณี Error หรือไม่พบข้อมูลจาก Backend
        if (!data || !data.subject) {
            container.innerHTML = `
                <div class="alert alert-light text-center border rounded-4 py-5 shadow-sm">
                    <i class="bi bi-exclamation-circle text-danger fs-1 mb-3 d-block"></i>
                    <h4 class="text-danger fw-bold">ไม่พบข้อมูลผลการสอบ</h4>
                    <p class="text-muted">อาจเกิดข้อผิดพลาดในการเชื่อมต่อ หรือยังไม่มีการประกาศคะแนน</p>
                    <button class="btn btn-secondary rounded-pill mt-3" onclick="fetchExamHistory()">
                        <i class="bi bi-arrow-left me-2"></i> กลับ
                    </button>
                </div>`;
            return;
        }

        // 1. อัปเดต Header
        if (header) {
            header.innerText = `ผลการสอบ: ${data.subject.SubjectName}`;
        }

        // 2. ส่วนแสดงคะแนนรวม (Hero Score)
        const scoreHtml = `
            <div class="row justify-content-center mb-5">
                <div class="col-12 col-md-8 col-lg-6">
                    <div class="card border-0 shadow-sm text-center position-relative overflow-hidden" 
                        style="border-radius: 24px; background: #fff;">
                        <div class="card-body py-5">
                            <h6 class="text-uppercase fw-bold text-muted mb-3" style="letter-spacing: 1px;">คะแนนของคุณ</h6>
                            <div class="display-1 fw-bold mb-2" style="color: var(--color-primary); line-height: 1;">
                                ${data.totalScoreInfo.userTotal}
                            </div>
                            <div class="badge rounded-pill px-3 py-2 mb-0" 
                                style="background-color: var(--bg-light); color: var(--text-muted); font-weight: 500; font-size: 0.9rem;">
                                จากคะแนนเต็ม ${data.totalScoreInfo.maxTotal} คะแนน
                            </div>
                        </div>
                        <div class="position-absolute top-0 start-100 translate-middle rounded-circle" 
                            style="width: 150px; height: 150px; background: var(--color-primary); opacity: 0.05;"></div>
                        <div class="position-absolute bottom-0 start-0 translate-middle rounded-circle" 
                            style="width: 100px; height: 100px; background: var(--color-warning); opacity: 0.05;"></div>
                    </div>
                </div>
            </div>
        `;

        // 3. ส่วนสถิติ (Stats)
        const statsHtml = `
            <div class="mb-5">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-bar-chart-line-fill me-2 text-secondary"></i>
                    <h5 class="fw-bold m-0 text-secondary">สถิติภาพรวม</h5>
                </div>
                <div class="row g-3">
                    ${renderStatBox('Mean', data.subjectStats.mean, 'bi-graph-up', 'text-primary')}
                    ${renderStatBox('Max', data.subjectStats.max, 'bi-trophy', 'text-success')}
                    ${renderStatBox('Min', data.subjectStats.min, 'bi-arrow-down', 'text-danger')}
                    ${renderStatBox('S.D.', data.subjectStats.stdDev, 'bi-activity', 'text-info')}
                </div>
            </div>
        `;

        // 4. ส่วนคะแนนรายหัวข้อ (Topics)
        const topicsHtml = `
            <div class="mb-5">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-list-task me-2 text-secondary"></i>
                    <h5 class="fw-bold m-0 text-secondary">คะแนนจำแนกตามหัวข้อ</h5>
                </div>
                <div class="list-group border-0">
                    ${data.topics.map(topic => `
                        <div class="d-flex justify-content-between align-items-center p-3 mb-2 rounded-3 border shadow-sm bg-white" 
                            style="border-color: var(--border-color) !important;">
                            <span class="fw-medium" style="color: var(--text-main);">${topic.TopicName}</span>
                            <span class="badge rounded-pill px-3 py-2" 
                                  style="background-color: var(--bg-light); color: var(--color-primary); border: 1px solid var(--color-primary);">
                                ${topic.userScore} / ${topic.TotalScore}
                            </span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        // 5. [แก้ไข] ส่วนเฉลย (Review) - เพิ่มปุ่ม Toggle (Collapse)
        // ตรวจสอบก่อนว่ามีข้อมูลเฉลยหรือไม่
        let reviewHtml = '';
        if (data.answerReviewData && data.answerReviewData.length > 0) {
            reviewHtml = `
            <div class="mt-5 border-top pt-4">
                <div class="text-center mb-4">
                     <button class="btn btn-outline-primary rounded-pill px-4 py-2 fw-bold shadow-sm" 
                             type="button" 
                             data-bs-toggle="collapse" 
                             data-bs-target="#examAnswerReviewCollapse" 
                             aria-expanded="false" 
                             aria-controls="examAnswerReviewCollapse">
                        <i class="bi bi-eye-fill me-2"></i> ดูเฉลยข้อสอบละเอียด
                    </button>
                </div>
                
                <div class="collapse" id="examAnswerReviewCollapse">
                    <div class="d-flex align-items-center mb-4">
                        <div class="rounded-pill me-3" style="width: 5px; height: 30px; background-color: var(--color-primary);"></div>
                        <h4 class="fw-bold m-0" style="color: var(--text-main);">เฉลยข้อสอบละเอียด</h4>
                    </div>
                    ${renderExamReviewCards(data.answerReviewData)}
                </div>
            </div>
            `;
        } else {
             // กรณีไม่มีเฉลย (เช่น ยังไม่ถึงเวลาประกาศ หรือผู้สอนปิดไว้)
             reviewHtml = `
                 <div class="mt-5 text-center text-muted">
                    <small>ไม่มีข้อมูลเฉลยสำหรับรายวิชานี้</small>
                 </div>
             `;
        }

        // รวม HTML และแสดงผล
        container.innerHTML = scoreHtml + statsHtml + topicsHtml + reviewHtml;
        
        showView('exam-score-announcement-view');
    }

    /**
     * [Helper] สร้างกล่องสถิติเล็กๆ
     */
    function renderStatBox(label, value, icon, colorClass) {
        return `
            <div class="col-6 col-md-3">
                <div class="p-3 rounded-4 bg-white shadow-sm border h-100 text-center" style="border-color: var(--border-color) !important;">
                    <i class="bi ${icon} ${colorClass} fs-4 mb-2 d-block"></i>
                    <div class="text-muted small text-uppercase mb-1">${label}</div>
                    <h4 class="fw-bold mb-0" style="color: var(--text-main);">${value}</h4>
                </div>
            </div>
        `;
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงผลหน้า "ประวัติการสอบ" (ตาราง + pagination)
     * @param {Object} response - อ็อบเจกต์ pagination ที่ได้จาก GAS
     */
    function displayExamHistoryPage(response) {
        const { data, totalItems, totalPages, currentPage, limit } = response;

        // 1. คำนวณลำดับเริ่มต้น
        const startItemIndex = (currentPage - 1) * limit;

        // 2. แสดงตาราง (ส่งลำดับเริ่มต้นไปด้วย)
        displayExamHistoryTable(data, startItemIndex);

        // 3. สร้าง Pagination
        buildPaginationControls('exam-history', currentPage, totalPages, totalItems, limit, 'fetchExamHistory');
    }

    /**
     * [แก้ไข] แสดงผลประวัติการสอบในรูปแบบตาราง
     * @param {Array} historyData - ข้อมูลประวัติ (เฉพาะหน้านี้)
     * @param {number} startItemIndex - ลำดับเริ่มต้นของรายการ
     */
    function displayExamHistoryTable(historyData, startItemIndex = 0) {
        const container = document.getElementById('exam-history-table-body');
        if (!historyData || historyData.length === 0) {
            container.innerHTML = `<tr><td colspan="6" class="text-center">ไม่พบข้อมูลประวัติการสอบ</td></tr>`;
            return;
        }

        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };

        container.innerHTML = historyData.map((item, index) => {
            const itemNumber = startItemIndex + index + 1; // [แก้ไข] คำนวณลำดับที่ถูกต้อง
            const startDate = item.startTimestamp ? new Date(item.startTimestamp).toLocaleString('th-TH', options) : 'N/A';
            const endDate = item.endTimestamp ? new Date(item.endTimestamp).toLocaleString('th-TH', options) : 'N/A';
            
            let actionButtonHtml = '';
            if (item.AnnounceScores === true && item.SubjectObject) {
                actionButtonHtml = `<button class="btn btn-sm btn-info" onclick='handleViewScores(${JSON.stringify(item.SubjectObject)})'>ดูผลคะแนน</button>`;
            } else {
                actionButtonHtml = `<span class="text-muted small">ไม่มีการประกาศ</span>`;
            }

            return `
                <tr>
                    <th scope="row">${itemNumber}</th> <td>${item.subjectName}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td>${item.totalTime}</td>
                    <td>${actionButtonHtml}</td>
                </tr>`;
        }).join('');
    }

    // --- [ใหม่] History Report Functions ---
    function fetchLearningHistoryReport(page = 1) {
        const stateKey = 'learningHistory';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('learning-history-report-body');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">กำลังโหลด...</td></tr>';
        google.script.run.withSuccessHandler(displayLearningHistoryReport)
            .getAllLearningHistory(currentUser.email, page, limit); // [แก้ไข]
    }

    function displayLearningHistoryReport(response) {
        const tbody = document.getElementById('learning-history-report-body');
        const stateKey = 'learningHistory';
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('learning-history-pagination-controls').innerHTML = '';
            document.getElementById('learning-history-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(item => `
            <tr>
                <td>${item.FullName}</td><td>${item.UserEmail}</td><td>${item.CourseName}</td>
                <td>${item.EnrollmentTimestamp ? new Date(item.EnrollmentTimestamp).toLocaleString('th-TH', options) : 'N/A'}</td>
                <td>${item.CompletionTimestamp ? new Date(item.CompletionTimestamp).toLocaleString('th-TH', options) : 'N/A'}</td>
                <td>${item.TotalTime}</td>
            </tr>`).join('');
            
        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchLearningHistoryReport);
        document.getElementById('learning-history-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchLearningHistoryReport);
        document.getElementById('learning-history-pagination-controls').innerHTML = paginationControls;
    }

    function fetchExamHistoryReport(page = 1) {
        const stateKey = 'examHistory';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('exam-history-report-body');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">กำลังโหลด...</td></tr>';
        google.script.run.withSuccessHandler(displayExamHistoryReport)
            .getAllExamHistory(currentUser.email, page, limit); // [แก้ไข]
    }

    function displayExamHistoryReport(response) {
        const tbody = document.getElementById('exam-history-report-body');
        const stateKey = 'examHistory';
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('exam-history-pagination-controls').innerHTML = '';
            document.getElementById('exam-history-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(item => `
            <tr>
                <td>${item.FullName}</td><td>${item.UserEmail}</td><td>${item.SubjectName}</td>
                <td>${item.StartTimestamp ? new Date(item.StartTimestamp).toLocaleString('th-TH', options) : 'N/A'}</td>
                <td>${item.EndTimestamp ? new Date(item.EndTimestamp).toLocaleString('th-TH', options) : 'N/A'}</td>
                <td>${item.TotalTime}</td>
            </tr>`).join('');
            
        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchExamHistoryReport);
        document.getElementById('exam-history-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchExamHistoryReport);
        document.getElementById('exam-history-pagination-controls').innerHTML = paginationControls;
    }

    function fetchExamTopicHistoryReport(page = 1) {
        const stateKey = 'examTopicHistory';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('exam-topic-history-report-body');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">กำลังโหลด...</td></tr>';
        google.script.run.withSuccessHandler(displayExamTopicHistoryReport)
            .getAllExamTopicHistory(currentUser.email, page, limit); // [แก้ไข]
    }

    function displayExamTopicHistoryReport(response) {
        const tbody = document.getElementById('exam-topic-history-report-body');
        const stateKey = 'examTopicHistory';
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('exam-topic-history-pagination-controls').innerHTML = '';
            document.getElementById('exam-topic-history-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(item => `
            <tr>
                <td>${item.FullName}</td><td>${item.UserEmail}</td><td>${item.SubjectName}</td><td>${item.TopicName}</td>
                <td>${item.StartTimestamp ? new Date(item.StartTimestamp).toLocaleString('th-TH', options) : 'N/A'}</td>
                <td>${item.EndTimestamp ? new Date(item.EndTimestamp).toLocaleString('th-TH', options) : 'N/A'}</td>
                <td>${item.TotalTime}</td>
            </tr>`).join('');

        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchExamTopicHistoryReport);
        document.getElementById('exam-topic-history-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchExamTopicHistoryReport);
        document.getElementById('exam-topic-history-pagination-controls').innerHTML = paginationControls;
    }

    /**
    * [อัปเกรด] เริ่มนับถอยหลังโดยอ้างอิงกับรายวิชา (Subject-aware)
    * @param {object} subject - อ็อบเจกต์ของรายวิชาที่กำลังนับถอยหลัง
    * @param {string[]} timerElementIds - массив ID ของ element ที่จะแสดงนาฬิกา
    */
    function startCountdown(subject, timerElementIds) {
        if (!subject || !subject.EndTime) return; // ตรวจสอบว่ามีข้อมูลรายวิชาและเวลาสิ้นสุดหรือไม่

        const endTime = new Date(subject.EndTime).getTime();
        const timerDisplays = timerElementIds.map(id => document.getElementById(id)).filter(el => el);

        if (examTimerInterval) clearInterval(examTimerInterval);

        examTimerInterval = setInterval(() => {
            const now = new Date().getTime();
            const distance = endTime - now;

            if (distance < 0) {
                clearInterval(examTimerInterval);
                timerDisplays.forEach(display => display.textContent = "หมดเวลา!");

                // --- [จุดแก้ไขสำคัญ] ---
                // ตรวจสอบก่อนว่าผู้ใช้ยังอยู่ในบริบทของรายวิชานี้หรือไม่
                if (!currentExamSubject || currentExamSubject.SubjectID !== subject.SubjectID) {
                    // ถ้าผู้ใช้ไม่ได้อยู่ในหน้ารายวิชานี้แล้ว ให้หยุดการทำงานทันที
                    console.log(`Timer for subject ${subject.SubjectID} ended, but user is now in subject ${currentExamSubject?.SubjectID}. No action taken.`);
                    return;
                }

                // ถ้าเงื่อนไขข้างบนไม่เป็นจริง แสดงว่าผู้ใช้ยังอยู่ในรายวิชาที่หมดเวลา
                // [เดิม] alert("หมดเวลาทำข้อสอบ ระบบจะทำการส่งคำตอบทั้งหมดของคุณโดยอัตโนมัติ");
                // [ใหม่] เปลี่ยนเป็น SweetAlert2
                Swal.fire({
                    title: 'หมดเวลา!',
                    text: 'หมดเวลาทำข้อสอบ ระบบจะทำการส่งคำตอบทั้งหมดของคุณโดยอัตโนมัติ',
                    icon: 'warning',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    confirmButtonText: 'ตกลง'
                }).then(() => {
                    // [ใหม่] ย้าย Logic การส่งอัตโนมัติมาไว้ใน .then()
                        const isTakingExam = document.getElementById('exam-taking-view').style.display !== 'none';
                        if (isTakingExam) {
                            if(typeof autoSubmitAndFinalize === 'function') autoSubmitAndFinalize();
                        } else {
                            if(typeof handleFinalSubjectSubmission === 'function') handleFinalSubjectSubmission(true);
                        }
                });

                // [เดิม] (Logic ส่วนนี้ถูกย้ายไปใน .then() แล้ว)
                // const isTakingExam = ...
                // ...

                return;
            }

            // (ส่วนของการแสดงเวลาที่เหลือ เหมือนเดิม)
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            const timeLeftString = String(hours).padStart(2, '0') + ":" + String(minutes).padStart(2, '0') + ":" + String(seconds).padStart(2, '0');

            timerDisplays.forEach(display => display.textContent = timeLeftString);
        }, 1000);
    }

    // ฟังก์ชันป้องกันการกระทำอื่นๆ
    const preventCheatingActions = (event) => {
        // ตรวจสอบว่ากำลังอยู่ในหน้าทำข้อสอบหรือไม่
        if (document.getElementById('exam-taking-view').style.display !== 'none') {
            event.preventDefault();
            // ไม่ต้อง alert แล้ว เพื่อไม่ให้รบกวนสมาธิเกินไป แค่ป้องกันก็พอ
        }
    };

    /**
     * [อัปเกรด] จัดการเมื่อนักเรียนสลับแท็บ (ป้องกันการล็อคซ้ำ)
     */
    const handleVisibilityChange = () => {
        if (!isAntiCheatActive || isScreenLocked) return;

        if (document.getElementById('exam-taking-view').style.display !== 'none' && document.hidden) {
            isScreenLocked = true;
            // [จุดแก้ไข] ใส่ข้อมูลสำหรับส่งไป Log ให้ครบถ้วน
            google.script.run.logCheatingAttempt({
                userEmail: currentUser.email,
                subjectId: currentExamSubject.SubjectID,
                action: 'Left Screen - Locked',
                details: 'User switched to another tab or minimized the window.'
            });
            const modal = new bootstrap.Modal(document.getElementById('cheatLockModal'));
            modal.show();
        }
    };

    /**
    * [อัปเกรด] จัดการเมื่อหน้าต่างเสียโฟกัส (ป้องกันการล็อคซ้ำ)
    */
    const handleWindowBlur = () => {
        if (!isAntiCheatActive || isScreenLocked) return;

        if (document.getElementById('exam-taking-view').style.display !== 'none') {
            isScreenLocked = true;
            // [จุดแก้ไข] ใส่ข้อมูลสำหรับส่งไป Log ให้ครบถ้วน
            google.script.run.logCheatingAttempt({
                userEmail: currentUser.email,
                subjectId: currentExamSubject.SubjectID,
                action: 'Window Lost Focus (Blur)',
                details: 'User clicked outside the exam window.'
            });
            const modal = new bootstrap.Modal(document.getElementById('cheatLockModal'));
            modal.show();
        }
    };

    /**
    * [อัปเกรด] จัดการเมื่อหน้าต่างปรับขนาด (ป้องกันการล็อคซ้ำ)
    */
    const handleWindowResize = () => {
        if (!isAntiCheatActive || isScreenLocked) return;

        if (document.getElementById('exam-taking-view').style.display !== 'none') {
            if (window.innerWidth < (screen.width * 0.95) || window.innerHeight < (screen.height * 0.95)) {
                isScreenLocked = true;
                // [จุดแก้ไข] ใส่ข้อมูลสำหรับส่งไป Log ให้ครบถ้วน
                google.script.run.logCheatingAttempt({
                    userEmail: currentUser.email,
                    subjectId: currentExamSubject.SubjectID,
                    action: 'Window Resized - Locked',
                    details: `Window size: ${window.innerWidth}x${window.innerHeight}`
                });
                const modal = new bootstrap.Modal(document.getElementById('cheatLockModal'));
                modal.show();
            }
        }
    };

    /**
     * [อัปเกรด] จัดการและ "บันทึก Log" เมื่อผู้ใช้พยายามรีเฟรชขณะหน้าจอถูกล็อค
     */
    const handleBeforeUnload = (event) => {
        // ตรวจสอบว่าหน้าจอถูกล็อคอยู่หรือไม่
        if (isScreenLocked) {
            // [จุดแก้ไข] เพิ่มการบันทึก Log ไปยัง Backend
            google.script.run.logCheatingAttempt({
                userEmail: currentUser.email,
                subjectId: currentExamSubject.SubjectID,
                action: 'Refresh/Close Attempt',
                details: 'User tried to refresh or close the page while the screen was locked.'
            });

            // ทำให้เบราว์เซอร์แสดง Pop-up ยืนยัน (เหมือนเดิม)
            event.preventDefault();
            event.returnValue = '';
        }
    };

    /**
     * [อัปเกรด] เปิดใช้งานระบบป้องกันทั้งหมด (เพิ่มการดักจับ Refresh)
     */
    function activateAntiCheat() {
        isAntiCheatActive = false;
        // ติดตั้ง Listener ทั้งหมด
        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('blur', handleWindowBlur);
        window.addEventListener('resize', handleWindowResize);
        document.addEventListener('contextmenu', preventCheatingActions);
        document.body.addEventListener('copy', preventCheatingActions);
        document.body.addEventListener('paste', preventCheatingActions);
        window.addEventListener('beforeunload', handleBeforeUnload); // <<< [เพิ่ม] เริ่มดักจับการรีเฟรช

        // ตั้งเวลา 3 วินาทีเพื่อ "เปิดการทำงาน" ของระบบตรวจจับ
        setTimeout(() => {
            isAntiCheatActive = true;
            console.log("Anti-cheat system is now active.");
        }, 3000);
    }

    /**
    * [อัปเกรด] ปิดการใช้งานระบบป้องกันทั้งหมด (เพิ่มการดักจับ Refresh)
    */
    function deactivateAntiCheat() {
        // หยุดการทำงานของ Listener ทั้งหมด
        document.removeEventListener('visibilitychange', handleVisibilityChange);
        window.removeEventListener('blur', handleWindowBlur);
        window.removeEventListener('resize', handleWindowResize);
        document.removeEventListener('contextmenu', preventCheatingActions);
        document.body.removeEventListener('copy', preventCheatingActions);
        document.body.removeEventListener('paste', preventCheatingActions);
        window.removeEventListener('beforeunload', handleBeforeUnload); // <<< [เพิ่ม] หยุดดักจับการรีเฟรช
    }

    /**
     * [อัปเกรด] จัดการเมื่อปลดล็อค (ส่ง userEmail ไปด้วยเพื่อบันทึก Log)
     * พร้อม SweetAlert2 และ Loading state
     */
    function handleUnlockSubmit() {
        const enteredPin = document.getElementById('unlock-pin-input').value;
        
        // 1. ตรวจสอบว่ามีการกรอกข้อมูลหรือไม่
        if (!enteredPin) {
            Swal.fire({
                icon: 'warning',
                text: 'กรุณากรอกรหัส PIN',
                confirmButtonColor: "#198754",
                confirmButtonText: "ตกลง"
            });
            return;
        }

        // 2. แสดง Loading (กำลังตรวจสอบ)
        Swal.fire({
            title: 'กำลังตรวจสอบ...',
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // 3. ส่งข้อมูลไปตรวจสอบที่ Google Script
        google.script.run
            .withSuccessHandler(isCorrect => {
                if (isCorrect) {
                    // --- กรณีรหัสถูกต้อง (Success) ---
                    Swal.fire({
                        icon: 'success',
                        title: 'ปลดล็อคสำเร็จ',
                        timer: 1000, // แสดง 1 วินาทีแล้วปิดเอง
                        showConfirmButton: false,
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then(() => {
                        // ปิด Modal
                        const modalEl = document.getElementById('cheatLockModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalEl);
                        if (modalInstance) modalInstance.hide();

                        // ล้างค่า Input
                        document.getElementById('unlock-pin-input').value = '';
                        
                        // ซ่อน Error div ของเดิม (ถ้ามีค้างอยู่)
                        const errorDiv = document.getElementById('unlock-error');
                        if (errorDiv) errorDiv.classList.add('d-none');

                        // ปลดล็อคสถานะตัวแปร
                        isScreenLocked = false; 
                    });

                } else {
                    // --- กรณีรหัสผิด (Error) ---
                    Swal.fire({
                        icon: 'error',
                        title: 'รหัส PIN ไม่ถูกต้อง',
                        text: 'กรุณาลองใหม่อีกครั้ง',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        confirmButtonColor: "#198754",
                        confirmButtonText: "ตกลง"
                    }).then(() => {
                        // ล้างค่าเพื่อให้กรอกใหม่สะดวก
                        document.getElementById('unlock-pin-input').value = '';
                    });
                }
            })
            .withFailureHandler(error => {
                // กรณี Server Error
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message,
                    confirmButtonColor: "#198754",
                    confirmButtonText: "ตกลง"
                });
            })
            .verifyAndLogUnlockPIN(currentExamSubject.SubjectID, enteredPin, currentUser.email);
    }

    // --- [ใหม่] Login/Logout Log Report Functions ---
    function fetchAdminLogs(page = 1) {
        const stateKey = 'adminLogs';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('admin-log-table-body');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">กำลังโหลด...</td></tr>';
        google.script.run.withSuccessHandler(displayAdminLogs)
            .getAllAdminLogs(page, limit); // [แก้ไข]
    }

    function displayAdminLogs(response) {
        const tbody = document.getElementById('admin-log-table-body');
        const stateKey = 'adminLogs';
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('admin-logs-pagination-controls').innerHTML = '';
            document.getElementById('admin-logs-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(log => `
            <tr>
                <td>${log.Timestamp ? new Date(log.Timestamp).toLocaleString('th-TH', options) : 'N/A'}</td>
                <td>${log.FullName}</td>
                <td>${log.UserEmail}</td>
                <td><span class="badge bg-${log.Action === 'LOGIN' ? 'success' : 'secondary'}">${log.Action}</span></td>
                <td>${log.IPAddress || 'N/A'}</td>
                <td>${log.Browser || 'N/A'}</td>
                <td>${log.OS || 'N/A'}</td>
            </tr>`).join('');
            
        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchAdminLogs);
        document.getElementById('admin-logs-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchAdminLogs);
        document.getElementById('admin-logs-pagination-controls').innerHTML = paginationControls;
    }

    function fetchStudentLogs(page = 1) {
        const stateKey = 'studentLogs';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('student-log-table-body');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">กำลังโหลด...</td></tr>';
        google.script.run.withSuccessHandler(displayStudentLogs)
            .getAllStudentLogs(page, limit); // [แก้ไข]
    }

    function displayStudentLogs(response) {
        const tbody = document.getElementById('student-log-table-body');
        const stateKey = 'studentLogs';
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">ไม่มีข้อมูล</td></tr>';
            document.getElementById('student-logs-pagination-controls').innerHTML = '';
            document.getElementById('student-logs-limit-selector-container').innerHTML = '';
            return;
        }

        tbody.innerHTML = response.data.map(log => `
            <tr>
                <td>${log.Timestamp ? new Date(log.Timestamp).toLocaleString('th-TH', options) : 'N/A'}</td>
                <td>${log.FullName}</td>
                <td>${log.UserEmail}</td>
                <td><span class="badge bg-${log.Action === 'LOGIN' ? 'success' : 'secondary'}">${log.Action}</span></td>
                <td>${log.IPAddress || 'N/A'}</td>
                <td>${log.Browser || 'N/A'}</td>
                <td>${log.OS || 'N/A'}</td>
            </tr>`).join('');

        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchStudentLogs);
        document.getElementById('student-logs-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchStudentLogs);
        document.getElementById('student-logs-pagination-controls').innerHTML = paginationControls;
    }

    // --- [ใหม่] Exam Analysis Functions ---

    /** แสดงหน้าวิเคราะห์และโหลดรายวิชาใส่ Dropdown */
    function fetchExamAnalysisView() {
        showView('exam-analysis-view');
        const select = document.getElementById('subject-analysis-select');
        select.innerHTML = '<option selected>กำลังโหลดรายวิชา...</option>';
        
        // ปรับปรุง: เพิ่ม text-center, font-size และไอคอน
        document.getElementById('analysis-results-container').innerHTML = 
            '<div class="alert alert-info text-center" style="font-size: 20px;">' + 
            '<i class="fas fa-info-circle" style="margin-right: 8px;"></i> ' + 
            'กรุณาเลือกรายวิชาเพื่อดูผลการวิเคราะห์</div>';
        
        google.script.run.withSuccessHandler(populateAnalysisDropdown).getAdminExamSubjects(currentUser.email);
    }

    /** นำรายวิชาที่ Admin ดูแลมาใส่ใน Dropdown */
    function populateAnalysisDropdown(subjects) {
        const select = document.getElementById('subject-analysis-select');
        if (!subjects || subjects.length === 0) {
            select.innerHTML = '<option selected>ไม่พบรายวิชาที่คุณดูแล</option>';
            return;
        }
        select.innerHTML = '<option value="" selected>--- กรุณาเลือกรายวิชา ---</option>';
        subjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject.SubjectID;
            // [แก้ไข] เพิ่ม SubjectCode เข้าไปในการแสดงผล
            option.textContent = `[${subject.SubjectCode || 'N/A'}] ${subject.SubjectName}`;
            select.appendChild(option);
        });
    }

    /** [ปรับปรุง] จัดการเมื่อมีการเลือกรายวิชา (เรียกฟังก์ชันวิเคราะห์ตัวใหม่) */
    function handleSubjectSelectionForAnalysis() {
        const subjectId = document.getElementById('subject-analysis-select').value;
        const resultsContainer = document.getElementById('analysis-results-container');
        _currentAnalysisData = null; // [เพิ่ม] รีเซ็ตข้อมูลเมื่อเลือกวิชาใหม่
        
        if (!subjectId) {
            // ปรับปรุง: เพิ่ม text-center, font-size และไอคอน (เมื่อไม่ได้เลือกวิชา หรือเลือกกลับเป็นค่าว่าง)
            resultsContainer.innerHTML = 
                '<div class="alert alert-info text-center" style="font-size: 20px;">' + 
                '<i class="fas fa-info-circle" style="margin-right: 8px;"></i> ' + 
                'กรุณาเลือกรายวิชาเพื่อดูผลการวิเคราะห์</div>';
            return;
        }
        
        resultsContainer.innerHTML = '<div class="text-center p-4"><h4><div class="spinner-border spinner-border-sm"></div> กำลังวิเคราะห์ข้อมูล...</h4></div>';
        // เรียกใช้ฟังก์ชันใหม่ที่ Backend
        google.script.run.withSuccessHandler(displayComprehensiveExamAnalysis).getComprehensiveExamAnalysis(subjectId);
    }

    /** ทำลายกราฟเก่าทั้งหมดทิ้งก่อนสร้างใหม่ */
    function destroyActiveCharts() {
        activeCharts.forEach(chart => chart.destroy());
        activeCharts = [];
    }

    /** [อัปเกรด] ฟังก์ชันวาดกราฟการกระจายคะแนน (เพิ่ม Grace และ Datalabels) */
    function renderScoreDistributionChart(scoreData) {
        const ctx = document.getElementById('score-distribution-chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: scoreData.labels,
                datasets: [{
                    label: 'จำนวนผู้สอบ',
                    data: scoreData.data,
                    backgroundColor: 'rgba(78, 115, 223, 0.8)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#444',
                        font: { weight: 'bold' }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: 'จำนวนผู้สอบ (คน)' },
                        grace: '10%' // <-- [เพิ่ม] เพิ่มช่องว่างที่แกน Y 10%
                    },
                    x: { 
                        title: { display: true, text: 'คะแนน (จำนวนข้อที่ถูก)' } 
                    }
                }
            }
        });
        activeCharts.push(chart);
    }

    /** [อัปเกรด] ฟังก์ชันวาดกราฟประสิทธิภาพรายข้อ (เพิ่ม Grace และ Datalabels) */
    function renderQuestionPerformanceChart(itemAnalysis) {
        const ctx = document.getElementById('question-performance-chart').getContext('2d');
        const labels = itemAnalysis.map((_, index) => `ข้อ ${index + 1}`);
        const data = itemAnalysis.map(item => (item.difficultyIndex * 100).toFixed(1));

        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '% ตอบถูก',
                    data: data,
                    backgroundColor: 'rgba(25, 135, 84, 0.8)',
                    borderColor: 'rgba(25, 135, 84, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#444',
                        font: { weight: 'bold' },
                        formatter: function(value) {
                            return value + '%';
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: 120, // ยังคง max ไว้ที่ 100%
                        grace: '10%', // <-- [เพิ่ม] เพิ่มช่องว่างที่แกน Y 10%
                        title: { display: true, text: 'เปอร์เซ็นต์การตอบถูก (%)' } 
                    },
                    x: { 
                        title: { display: true, text: 'ข้อที่' } 
                    }
                }
            }
        });
        activeCharts.push(chart);
    }

    /** [อัปเกรดล่าสุด V3] แสดงผลการวิเคราะห์ข้อสอบพร้อมกราฟสรุป */
    function displayComprehensiveExamAnalysis(data) {
        const resultsContainer = document.getElementById('analysis-results-container');
        destroyActiveCharts(); // ทำลายกราฟเก่าทิ้งก่อนเสมอ
        _currentAnalysisData = data; // [เพิ่ม] เก็บข้อมูลไว้สำหรับ Export

        if (!data || !data.overallStats || !data.itemAnalysis) {
            _currentAnalysisData = null; // [เพิ่ม] เคลียร์ข้อมูลถ้าไม่สำเร็จ
            
            // ปรับปรุง: เพิ่ม text-center, font-size และไอคอนเตือน (Exclamation Triangle)
            resultsContainer.innerHTML = 
                '<div class="alert alert-warning text-center" style="font-size: 20px;">' + 
                '<i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i> ' + 
                'ไม่พบข้อมูลการสอบสำหรับรายวิชานี้ หรือยังไม่มีผู้เข้าสอบ' + 
                '</div>';
            return;
        }

        const { overallStats, itemAnalysis, scoreDistribution } = data;

        // --- [อัปเกรด] ส่วนแสดงผลภาพรวม (เพิ่ม Canvas สำหรับกราฟ 2 ตัว) ---
        const overallHtml = `
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4>ภาพรวมการสอบ</h4>
                    
                    <div class="btn-group">
                        <button id="export-analysis-btn-main" type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-earmark-arrow-down-fill"></i> Export ข้อมูล
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a id="export-sheet-btn" class="dropdown-item" href="#" onclick="event.preventDefault(); handleExportAnalysis('SHEET')">
                                    <i class="bi bi-file-earmark-spreadsheet-fill me-2"></i> Export to Google Sheets
                                </a>
                            </li>
                            <li>
                                <a id="export-csv-btn" class="dropdown-item" href="#" onclick="event.preventDefault(); handleExportAnalysis('CSV')">
                                    <i class="bi bi-filetype-csv me-2"></i> Export to CSV
                                </a>
                            </li>
                        </ul>
                    </div>
                    </div>
                <div class="card-body">
                    <div class="row text-center border-bottom pb-3 mb-3">
                        <div class="col"><p class="mb-0 text-muted">ผู้เข้าสอบ</p><h4 class="fw-bold">${overallStats.totalTakers}</h4></div>
                        <div class="col"><p class="mb-0 text-muted">คะแนนเฉลี่ย</p><h4 class="fw-bold">${overallStats.mean}</h4></div>
                        <div class="col"><p class="mb-0 text-muted">คะแนนสูงสุด</p><h4 class="fw-bold">${overallStats.max}</h4></div>
                        <div class="col"><p class="mb-0 text-muted">คะแนนต่ำสุด</p><h4 class="fw-bold">${overallStats.min}</h4></div>
                        <div class="col"><p class="mb-0 text-muted">S.D.</p><h4 class="fw-bold">${overallStats.stdDev}</h4></div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6>การกระจายคะแนน</h6>
                            <div style="height: 300px;"><canvas id="score-distribution-chart"></canvas></div>
                        </div>
                        <div class="col-md-6">
                            <h6>ประสิทธิภาพรายข้อ (% การตอบถูก)</h6>
                            <div style="height: 300px;"><canvas id="question-performance-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>`;

        // --- ส่วนแสดงผลรายข้อ (ไม่มีการเปลี่ยนแปลง) ---
        const itemsHtml = itemAnalysis.map((item, index) => {
            // ... (โค้ดส่วนนี้เหมือนเดิมทุกประการ) ...
            const choices = ['A', 'B', 'C', 'D', 'E'];
            const choicesHtml = choices.map(choice => {
                const isCorrect = choice === item.CorrectAnswer;
                const count = item.choiceDistribution[choice] || 0;
                return `
                    <li class="list-group-item d-flex justify-content-between align-items-center ${isCorrect ? 'list-group-item-success fw-bold' : ''}">
                        ตัวเลือก ${choice} ${isCorrect ? '<i class="bi bi-check-circle-fill text-success ms-2"></i>' : ''}
                        <span class="badge bg-primary rounded-pill">${count} คน</span>
                    </li>`;
            }).join('');
            
            const pStatus = item.difficultyIndex >= 0.8 ? 'ง่าย' : item.difficultyIndex <= 0.3 ? 'ยาก' : 'ปานกลาง';
            const dStatus = item.discriminationIndex >= 0.3 ? 'ดีมาก' : item.discriminationIndex >= 0.1 ? 'พอใช้' : 'ควรปรับปรุง';
            const dColor = item.discriminationIndex >= 0.3 ? 'success' : item.discriminationIndex >= 0.1 ? 'info' : 'warning';
            const percentCorrect = (item.difficultyIndex * 100).toFixed(1);

            return `
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>ข้อที่ ${index + 1}:</strong> ${item.QuestionText}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3 mb-md-0 border-end">
                                <h6>สถิติการตอบ</h6>
                                <p class="mb-2">
                                    ตอบถูก: <strong class="text-success">${item.correctCount}</strong> คน |
                                    ตอบผิด: <strong class="text-danger">${item.incorrectCount}</strong> คน |
                                    ตอบทั้งหมด: <strong>${item.totalResponses}</strong> คน
                                </p>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" style="width: ${percentCorrect}%;" aria-valuenow="${percentCorrect}" aria-valuemin="0" aria-valuemax="100">
                                        ${percentCorrect}%
                                    </div>
                                </div>
                                <hr>
                                <h6>ดัชนีชี้วัดคุณภาพข้อสอบ</h6>
                                <p class="mb-1">
                                    <strong>ความยากง่าย (P-value):</strong> ${item.difficultyIndex} 
                                    <span class="badge bg-secondary">${pStatus}</span>
                                </p>
                                <p>
                                    <strong>อำนาจจำแนก (D-value):</strong> ${item.discriminationIndex}
                                    <span class="badge bg-${dColor}">${dStatus}</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6>การกระจายของตัวเลือก (คำตอบที่ถูก: ${item.CorrectAnswer})</h6>
                                <ul class="list-group">
                                    ${choicesHtml}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');

        resultsContainer.innerHTML = overallHtml + `<h4>การวิเคราะห์รายข้อ</h4>` + itemsHtml;

        // --- [เพิ่ม] ส่วนวาดกราฟหลังจากที่ HTML ถูกสร้างเสร็จแล้ว ---
        if (scoreDistribution && scoreDistribution.labels && scoreDistribution.data) {
            renderScoreDistributionChart(scoreDistribution);
        }
        renderQuestionPerformanceChart(itemAnalysis);
    }

    /** [แก้ไข] จัดการการ Export ข้อมูลวิเคราะห์ (รองรับ 'SHEET' และ 'CSV') */
    function handleExportAnalysis(exportType) { // [เพิ่ม] รับ parameter
      const subjectId = document.getElementById('subject-analysis-select').value;
      const adminEmail = currentUser.email; // สมมติว่ามีตัวแปร currentUser.email อยู่แล้ว

      if (!subjectId || !adminEmail) {
        // [เดิม] alert("เกิดข้อผิดพลาด: ไม่สามารถระบุรายวิชาหรืออีเมลผู้ใช้ได้");
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        Swal.fire({
          title: 'ข้อมูลไม่ครบถ้วน',
          text: 'เกิดข้อผิดพลาด: ไม่สามารถระบุรายวิชาหรืออีเมลผู้ใช้ได้',
          icon: 'error',
          allowOutsideClick: false,
          allowEscapeKey: false
        });
        return;
      }

      if (!_currentAnalysisData) {
        // [เดิม] alert("เกิดข้อผิดพลาด: ไม่พบข้อมูลการวิเคราะห์ที่จะ Export");
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        Swal.fire({
          title: 'ไม่พบข้อมูล',
          text: 'เกิดข้อผิดพลาด: ไม่พบข้อมูลการวิเคราะห์ที่จะ Export',
          icon: 'error',
          allowOutsideClick: false,
          allowEscapeKey: false
        });
        return;
      }

      // [แก้ไข] อัปเดตสถานะปุ่ม (ปุ่มหลัก และลิงก์ย่อย)
      const mainBtn = document.getElementById('export-analysis-btn-main');
      const sheetBtn = document.getElementById('export-sheet-btn');
      const csvBtn = document.getElementById('export-csv-btn');

      mainBtn.disabled = true;
      mainBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> กำลัง Export...';
      sheetBtn.classList.add('disabled');
      csvBtn.classList.add('disabled');

      // [ใหม่] แสดงหน้าต่าง Loading
      Swal.fire({
        title: 'กำลัง Export',
        text: 'กรุณารอสักครู่ ระบบกำลังสร้างไฟล์...',
        icon: 'info',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // [แก้ไข] ส่ง exportType ไปยัง Backend
      google.script.run
        .withSuccessHandler(onExportSuccess) // ใช้ Success Handler ตัวเดียว
        .withFailureHandler(onExportFailure) // ใช้ Failure Handler ตัวเดียว
        .exportExamAnalysisToSheet(subjectId, adminEmail, exportType); // [เพิ่ม] ส่ง parameter ตัวที่ 3
    }

    /** [แก้ไข] เมื่อ Export สำเร็จ (รองรับ Sheet และ CSV) */
    function onExportSuccess(response) {
      // [แก้ไข] คืนค่าปุ่ม (เหมือนเดิม)
      const mainBtn = document.getElementById('export-analysis-btn-main');
      const sheetBtn = document.getElementById('export-sheet-btn');
      const csvBtn = document.getElementById('export-csv-btn');

      mainBtn.disabled = false;
      mainBtn.innerHTML = '<i class="bi bi-file-earmark-arrow-down-fill"></i> Export ข้อมูล';
      sheetBtn.classList.remove('disabled');
      csvBtn.classList.remove('disabled');

      if (response.success) {

        // [เพิ่ม] ตรวจสอบว่าเป็นผลลัพธ์แบบ Sheet หรือ CSV
        if (response.sheetUrl) {
          // --- กรณี Google Sheet ---
          // [เดิม] alert(`Export Google Sheet สำเร็จ!...`);
          // [ใหม่] เปลี่ยนเป็น SweetAlert2 และเปิดแท็บใหม่เมื่อกด "ตกลง"
          Swal.fire({
            title: 'Export Google Sheet สำเร็จ!',
            html: `ไฟล์ถูกสร้างที่:<br><a href="${response.sheetUrl}" target="_blank">${response.sheetUrl}</a><br><br>กำลังเปิดไฟล์ในแท็บใหม่...`,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false,
            confirmButtonText: 'ตกลง'
          }).then(() => {
            window.open(response.sheetUrl, '_blank');
          });

        } else if (response.csvContent) {
          // --- กรณี CSV ---
          try {
            const csvContent = response.csvContent;
            const fileName = response.fileName;

            // สร้าง <a> element ชั่วคราวเพื่อดาวน์โหลด (เหมือนเดิม)
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            if (link.download !== undefined) {
              const url = URL.createObjectURL(blob);
              link.setAttribute("href", url);
              link.setAttribute("download", fileName);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
            } else {
              navigator.msSaveBlob(blob, fileName);
            }

            // [เดิม] alert('Export CSV สำเร็จ! กำลังเริ่มดาวน์โหลด...');
            // [ใหม่] เปลี่ยนเป็น SweetAlert2
            Swal.fire({
              title: 'Export CSV สำเร็จ!',
              text: 'กำลังเริ่มดาวน์โหลด...',
              icon: 'success',
              allowOutsideClick: false,
              allowEscapeKey: false
            });

          } catch (e) {
            // เรียก onExportFailure (ซึ่งตอนนี้ใช้ Swal แล้ว)
            onExportFailure({ message: `เกิดข้อผิดพลาดขณะสร้างไฟล์ CSV: ${e.message}` });
          }
        } else {
          // กรณีไม่รู้จัก response
          onExportFailure({ message: 'ได้รับการตอบกลับที่ไม่รู้จักจากเซิร์ฟเวอร์' });
        }

      } else {
        // กรณี Backend ส่ง success: false กลับมา
        onExportFailure({ message: response.message });
      }
    }

    /** [แก้ไข] เมื่อ Export ล้มเหลว */
    function onExportFailure(error) {
      // [แก้ไข] คืนค่าปุ่ม (เหมือนเดิม)
      const mainBtn = document.getElementById('export-analysis-btn-main');
      const sheetBtn = document.getElementById('export-sheet-btn');
      const csvBtn = document.getElementById('export-csv-btn');

      if (mainBtn) {
        mainBtn.disabled = false;
        mainBtn.innerHTML = '<i class="bi bi-file-earmark-arrow-down-fill"></i> Export ข้อมูล';
      }
      if (sheetBtn) {
        sheetBtn.classList.remove('disabled');
      }
      if (csvBtn) {
        csvBtn.classList.remove('disabled');
      }

      // [เดิม] alert(`Export ล้มเหลว: ...`);
      // [ใหม่] เปลี่ยนเป็น SweetAlert2
      Swal.fire({
        title: 'Export ล้มเหลว',
        text: error.message || 'เกิดข้อผิดพลาดไม่ทราบสาเหตุ',
        icon: 'error',
        allowOutsideClick: false,
        allowEscapeKey: false
      });
    }

    /**
     * [ปรับปรุง] เปิด Modal แก้ไขข้อมูลส่วนตัว พร้อมดึงข้อมูลผู้ใช้ปัจจุบันมาแสดง
     */
    function openEditProfileModal() {
        const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
        if (currentUser) {
            // กรอกข้อมูลพื้นฐาน
            document.getElementById('edit-profile-email').value = currentUser.email;
            document.getElementById('edit-profile-prefix').value = currentUser.prefix;
            document.getElementById('edit-profile-firstname').value = currentUser.firstName;
            document.getElementById('edit-profile-lastname').value = currentUser.lastName;
            document.getElementById('edit-profile-phone').value = currentUser.phone;

            const studentFields = document.getElementById('student-only-fields');
            if (currentUser.role === 'Student') {
                // ถ้าเป็น Student: แสดงช่องและกรอกข้อมูล
                studentFields.classList.remove('d-none');
                document.getElementById('edit-profile-studentid').value = currentUser.studentId;
                document.getElementById('edit-profile-year').value = currentUser.year;
            } else {
                // ถ้าเป็น Admin หรืออื่นๆ: ซ่อนช่อง
                studentFields.classList.add('d-none');
            }

            modal.show();
        } else {
            // [เดิม] alert('ไม่พบข้อมูลผู้ใช้ กรุณาล็อกอินใหม่อีกครั้ง');
            // [ใหม่] เปลี่ยนเป็น SweetAlert2
            Swal.fire({
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่พบข้อมูลผู้ใช้ กรุณาล็อกอินใหม่อีกครั้ง',
                icon: 'error',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
        }
    }

    /**
     * [แก้ไข] ฟังก์ชันสำหรับเรียก Backend ให้ส่ง OTP
     * @param {HTMLElement} buttonElement - ปุ่มที่ถูกกด (รับค่า this มาจาก HTML)
     */
    function requestPasswordChangeOTP(buttonElement) {
        const email = document.getElementById('edit-profile-email').value;

        if (!email) {
            Swal.fire({
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่พบอีเมลผู้ใช้',
                icon: 'error',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
            return;
        }

        // [จุดแก้ไข] ใช้ buttonElement โดยตรง (ไม่ต้องใช้ event.target)
        const sendButton = buttonElement;
        const originalText = sendButton.textContent; // เก็บข้อความเดิมไว้ ("ส่ง OTP")

        sendButton.disabled = true;
        sendButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> กำลังส่ง...';

        // ซ่อน Reference Code ของเก่าก่อน
        const refContainer = document.getElementById('otp-reference-container');
        if (refContainer) refContainer.classList.add('d-none');

        google.script.run.withSuccessHandler(response => {
            Swal.fire({
                title: response.success ? 'ดำเนินการสำเร็จ' : 'เกิดข้อผิดพลาด',
                text: response.message,
                icon: response.success ? 'success' : 'error',
                allowOutsideClick: false,
                allowEscapeKey: false
            });

            // ถ้าสำเร็จและมี Reference Code ให้แสดงผล
            if (response.success && response.referenceCode) {
                const refCodeEl = document.getElementById('otp-reference-code');
                if (refCodeEl) refCodeEl.textContent = response.referenceCode;
                if (refContainer) refContainer.classList.remove('d-none');
            }

            sendButton.disabled = false;
            sendButton.textContent = originalText; // คืนค่าข้อความเดิม
        }).generateAndSendOTP(email);
    }

    /**
     * [อัปเกรดสูงสุด] จัดการการส่งฟอร์มแก้ไขข้อมูล พร้อมรหัสผ่านและ OTP
     */
    function handleUpdateProfile(event) {
        event.preventDefault();

        // 1. อ่านข้อมูลโปรไฟล์ (เหมือนเดิม)
        const profileData = {
            email: document.getElementById('edit-profile-email').value,
            prefix: document.getElementById('edit-profile-prefix').value,
            firstName: document.getElementById('edit-profile-firstname').value,
            lastName: document.getElementById('edit-profile-lastname').value,
            phone: document.getElementById('edit-profile-phone').value,
            role: currentUser.role
        };
        if (currentUser.role === 'Student') {
            profileData.studentId = document.getElementById('edit-profile-studentid').value;
            profileData.year = document.getElementById('edit-profile-year').value;
        }

        // 2. อ่านข้อมูลรหัสผ่านและ OTP (เหมือนเดิม)
        const newPassword = document.getElementById('edit-profile-new-password').value;
        const confirmPassword = document.getElementById('edit-profile-confirm-password').value;
        const otp = document.getElementById('edit-profile-otp').value;

        if (newPassword) {
            if (newPassword.length < 6) {
                // [เดิม] alert('รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร');
                // [ใหม่] เปลี่ยนเป็น SweetAlert2
                Swal.fire({
                    title: 'ข้อมูลไม่ถูกต้อง',
                    text: 'รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร',
                    icon: 'warning',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                return;
            }
            if (newPassword !== confirmPassword) {
                // [เดิม] alert('รหัสผ่านใหม่และการยืนยันไม่ตรงกัน');
                // [ใหม่] เปลี่ยนเป็น SweetAlert2
                Swal.fire({
                    title: 'ข้อมูลไม่ถูกต้อง',
                    text: 'รหัสผ่านใหม่และการยืนยันไม่ตรงกัน',
                    icon: 'warning',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                return;
            }
            if (!otp || otp.length !== 6 || !/^\d{6}$/.test(otp)) {
                // [เดิม] alert('กรุณากรอก OTP ที่เป็นตัวเลข 6 หลักให้ถูกต้อง');
                // [ใหม่] เปลี่ยนเป็น SweetAlert2
                Swal.fire({
                    title: 'ข้อมูลไม่ถูกต้อง',
                    text: 'กรุณากรอก OTP ที่เป็นตัวเลข 6 หลักให้ถูกต้อง',
                    icon: 'warning',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                return;
            }
            profileData.newPassword = newPassword;
            profileData.otp = otp;
        }

        // [ใหม่] แสดงหน้าต่าง Loading
        Swal.fire({
            title: 'กำลังอัปเดตข้อมูล',
            text: 'กรุณารอสักครู่',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // 3. ส่งข้อมูลไปอัปเดตที่ Backend (เหมือนเดิม)
        google.script.run.withSuccessHandler(response => {
            // [เดิม] alert(response.message); (ย้ายไปรวมข้างล่าง)

            if (response.success) {
                const newFullName = `${profileData.prefix} ${profileData.firstName} ${profileData.lastName}`.trim();
                currentUser.fullName = newFullName;
                document.getElementById('welcome-message').textContent = newFullName;

                const editProfileModal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                if (editProfileModal) {
                    editProfileModal.hide();
                }

                if (profileData.newPassword) {
                    // [เดิม] alert("เปลี่ยนรหัสผ่านสำเร็จ! กรุณาเข้าสู่ระบบใหม่อีกครั้ง");
                    // [ใหม่] รวม Alert และบังคับ Logout หลังกด "ตกลง"
                    Swal.fire({
                        title: 'เปลี่ยนรหัสผ่านสำเร็จ!',
                        text: `${response.message} กรุณาเข้าสู่ระบบใหม่อีกครั้ง`,
                        icon: 'success',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then(() => {
                        handleLogout(); // บังคับให้ Logout เพื่อ Login ใหม่
                    });
                } else {
                    // [ใหม่] กรณีอัปเดตข้อมูลส่วนตัว (ไม่เปลี่ยนรหัสผ่าน)
                    Swal.fire({
                        title: 'อัปเดตสำเร็จ!',
                        text: response.message,
                        icon: 'success',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    });
                }
            } else {
                // [ใหม่] กรณีที่ Backend ตอบกลับว่าไม่สำเร็จ
                 Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: response.message,
                    icon: 'error',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            }
        }).updateUserProfile(profileData);
    }

    /**
     * [ใหม่] ตรวจสอบว่าวิชาต้องใช้ PIN หรือไม่ ก่อนเข้าสอบ
     */
    function promptForExamPIN(subject) {
        // ถ้าวิชาไม่มี PIN หรือ PIN เป็นค่าว่าง ให้เข้าสอบได้เลย
        if (!subject.ExamPIN) {
            showExamInstructions(subject);
            return;
        }
        
        // ถ้ามี PIN ให้เปิด Modal ขึ้นมา
        document.getElementById('pin-modal-subject-name').textContent = subject.SubjectName;
        document.getElementById('pin-modal-subject-data').value = JSON.stringify(subject);
        document.getElementById('pin-modal-input').value = '';
        document.getElementById('pin-modal-error').classList.add('d-none');
        
        new bootstrap.Modal(document.getElementById('examPinModal')).show();
    }

    // /**
    //  * [อัปเกรด] จัดการการส่งฟอร์ม PIN พร้อมส่งอีเมลผู้ใช้ไปบันทึก Log
    //  */
    // function handlePinSubmit(event) {
    //     event.preventDefault();
    //     const enteredPin = document.getElementById('pin-modal-input').value;
    //     const subject = JSON.parse(document.getElementById('pin-modal-subject-data').value);

    //     // [จุดแก้ไข] เพิ่ม currentUser.email เป็น parameter ตัวที่สาม
    //     google.script.run.withSuccessHandler(response => {
    //         if (response.success) {
    //             bootstrap.Modal.getInstance(document.getElementById('examPinModal')).hide();
    //             showExamInstructions(subject); // ถ้า PIN ถูกต้อง ให้เข้าสอบ
    //         } else {
    //             document.getElementById('pin-modal-error').classList.remove('d-none'); // ถ้าผิด ให้แสดง Error
    //         }
    //     }).verifyExamPIN(subject.SubjectID, enteredPin, currentUser.email);
    // }

    /**
     * [อัปเกรด] จัดการการส่งฟอร์ม PIN + Loading + ส่งอีเมลผู้ใช้
     */
    function handlePinSubmit(event) {
        event.preventDefault();
        const enteredPin = document.getElementById('pin-modal-input').value;
        const subject = JSON.parse(document.getElementById('pin-modal-subject-data').value);

        // 1. แสดง Loading ทันทีเมื่อกดปุ่ม
        Swal.fire({
            title: 'กำลังตรวจสอบ...',
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading(); // คำสั่งแสดง Animation หมุนๆ
            }
        });

        // 2. ส่งข้อมูลไปตรวจสอบที่ Backend
        google.script.run.withSuccessHandler(response => {
            
            if (response.success) {
                // กรณีสำเร็จ: เปลี่ยน Loading เป็นเครื่องหมายถูก (Success)
                Swal.fire({
                    icon: 'success',
                    title: 'รหัสถูกต้อง',
                    text: 'กำลังเข้าสู่หน้าคำชี้แจงการสอบ...',
                    timer: 1500, // โชว์ 1.5 วิ แล้วไปต่อ
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('examPinModal')).hide();
                    showExamInstructions(subject);
                });
            } else {
                // กรณีผิดพลาด: เปลี่ยน Loading เป็นเครื่องหมายกากบาท (Error)
                Swal.fire({
                    icon: 'error',
                    title: 'รหัส PIN ไม่ถูกต้อง',
                    text: response.message || 'กรุณาตรวจสอบแล้วลองใหม่อีกครั้ง',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    confirmButtonColor: "#198754",
                    confirmButtonText: "ตกลง"
                }).then(() => {
                    // ล้างช่อง Input ให้กรอกใหม่สะดวกๆ
                    document.getElementById('pin-modal-input').value = '';
                });
            }

        })
        .withFailureHandler(error => {
            // กรณี Google Script พัง (Network Error / Server Error)
            Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error.message,
                allowOutsideClick: false,
                confirmButtonColor: "#198754",
                confirmButtonText: "ตกลง"
            });
        })
        .verifyExamPIN(subject.SubjectID, enteredPin, currentUser.email);
    }

    // --- [เวอร์ชันสร้างใหม่] โค้ดสำหรับหน้าติดตามความคืบหน้า ---
    let progressInterval_Grid = null;
    let lastProgressData_Grid = null; // [เพิ่มใหม่] สร้างตัวแปรเก็บข้อมูลล่าสุด

    function fetchExamProgressView() {
        showView('admin-exam-progress-view');
        if (progressInterval_Grid) clearInterval(progressInterval_Grid);
        document.getElementById('progress-table-container').innerHTML = '<p class="text-center text-muted">กรุณาเลือกรายวิชาเพื่อดูความคืบหน้า</p>';

        // [เพิ่มใหม่] รีเซ็ตและซ่อนตัวกรองหัวข้อ
        document.getElementById('progress-topic-filter-container').style.display = 'none';
        document.getElementById('progress-topic-select').innerHTML = '<option value="all">-- แสดงทุกหัวข้อ --</option>';
        lastProgressData_Grid = null; // ล้างข้อมูลเก่า
        
        // [จุดแก้ไข] เปลี่ยนฟังก์ชันที่เรียกเป็น getExamSubjectsForDropdown
        google.script.run.withSuccessHandler(subjects => {
            // 'subjects' ตอนนี้จะเป็น Array ที่ถูกต้องแล้ว
            const select = document.getElementById('progress-subject-select');
            select.innerHTML = '<option value="">-- กรุณาเลือกรายวิชา --</option>';

            // ลูปนี้จะทำงานได้ปกติ
            subjects.forEach(subject => {
                if (subject.IsActive) {
                    // [ปรับปรุง] เพิ่ม SubjectCode เพื่อให้เลือกง่ายขึ้น
                    select.innerHTML += `<option value="${subject.SubjectID}">[${subject.SubjectCode || 'N/A'}] ${subject.SubjectName}</option>`;
                }
            });
        }).getExamSubjectsForDropdown(currentUser.email); // <-- [แก้ไข] เรียกใช้ฟังก์ชันใหม่
    }

    function handleProgressSubjectSelect_Grid() {
        const subjectId = document.getElementById('progress-subject-select').value;
        const container = document.getElementById('progress-table-container');

        // [เพิ่มใหม่] รีเซ็ตและซ่อนตัวกรองหัวข้อ เมื่อเลือกวิชาใหม่
        document.getElementById('progress-topic-filter-container').style.display = 'none';
        document.getElementById('progress-topic-select').innerHTML = '<option value="all">-- แสดงทุกหัวข้อ --</option>';
        lastProgressData_Grid = null; 

        if (progressInterval_Grid) clearInterval(progressInterval_Grid);
        if (!subjectId) {
            container.innerHTML = '<p class="text-center text-muted">กรุณาเลือกรายวิชาเพื่อดูความคืบหน้า</p>';
            return;
        }
        
        const fetchAndDisplay = () => {
            // --- [จุดแก้ไข] เพิ่ม new Date().getTime() เข้าไปเป็น parameter ตัวที่สอง ---
            google.script.run.withSuccessHandler(displayExamProgressGrid)
                .getExamProgressGridView(subjectId, new Date().getTime());
            // --------------------------------------------------------------------
        };

        container.innerHTML = '<p class="text-center">กำลังโหลดข้อมูล...</p>';
        fetchAndDisplay();
        progressInterval_Grid = setInterval(fetchAndDisplay, 7000); // อัปเดตทุก 7 วินาที
    }

    /**
     * [เพิ่มใหม่]
     * ฟังก์ชันนี้จะถูกเรียกเมื่อผู้ใช้เปลี่ยน "ตัวกรองหัวข้อ"
     * มันจะ re-render ตารางใหม่ทันทีโดยใช้ข้อมูลล่าสุดที่ดึงมา (lastProgressData_Grid) โดยไม่ต้องเรียก server ใหม่
     */
    function handleProgressTopicSelect_Grid() {
        if (lastProgressData_Grid) {
            renderProgressGrid(lastProgressData_Grid); // เรียก render ใหม่ด้วยข้อมูลเดิม
        }
    }

    /**
     * [ปรับปรุง]
     * หน้าที่หลักของฟังก์ชันนี้คือรับข้อมูลจาก Server, 
     * เก็บข้อมูลไว้ใน lastProgressData_Grid, 
     * และเรียกฟังก์ชัน renderProgressGrid เพื่อแสดงผล
     */
    function displayExamProgressGrid(data) {
        // [เพิ่มใหม่] เก็บข้อมูลล่าสุดไว้ในตัวแปร global
        lastProgressData_Grid = data; 

        const container = document.getElementById('progress-table-container');
        if (!data || !data.success) {
            container.innerHTML = `<p class="text-center text-danger">เกิดข้อผิดพลาดในการดึงข้อมูล: ${data ? data.message : 'No data returned'}</p>`;
            // [เพิ่มใหม่] ซ่อนตัวกรองหัวข้อถ้ามีปัญหา
            document.getElementById('progress-topic-filter-container').style.display = 'none';
            return;
        }

        // [เพิ่มใหม่] อัปเดตตัวเลือกใน "ตัวกรองหัวข้อ"
        populateTopicFilter(data.topics);
        
        // [ปรับปรุง] เรียกใช้ฟังก์ชัน render แยกต่างหาก
        renderProgressGrid(data);
    }

    /**
     * [เพิ่มใหม่]
     * ฟังก์ชันสำหรับอัปเดตตัวเลือกใน Dropdown ของหัวข้อ
     */
    function populateTopicFilter(topics) {
        const topicSelect = document.getElementById('progress-topic-select');
        const topicContainer = document.getElementById('progress-topic-filter-container');
        
        // เก็บค่าที่เลือกไว้ก่อนหน้า (สำคัญมาก เพราะฟังก์ชันนี้จะรันทุก 7 วินาที)
        const previouslySelectedTopic = topicSelect.value;
        
        topicSelect.innerHTML = '<option value="all">-- แสดงทุกหัวข้อ --</option>'; // เริ่มต้นด้วย "แสดงทั้งหมด"
        
        if (topics && topics.length > 0) {
            topics.forEach(topic => {
                topicSelect.innerHTML += `<option value="${topic.topicId}">${topic.topicName}</option>`;
            });
            
            // คืนค่าที่เลือกไว้ ถ้ายังมีอยู่
            topicSelect.value = previouslySelectedTopic;
            
            // แสดงตัวกรอง
            topicContainer.style.display = 'block';
        } else {
            // ซ่อนตัวกรองถ้าไม่มีหัวข้อ
            topicContainer.style.display = 'none';
        }
    }

    /**
     * [เพิ่มใหม่]
     * ฟังก์ชันสำหรับ Render ตาราง (แยกตรรกะมาจาก displayExamProgressGrid)
     * ฟังก์ชันนี้จะอ่านค่าจาก "ตัวกรองหัวข้อ" เพื่อตัดสินใจว่าจะแสดงผลตารางไหนบ้าง
     */
    function renderProgressGrid(data) {
        const container = document.getElementById('progress-table-container');
        const { topics, students } = data;

        if (!students || students.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">ยังไม่มีนักเรียนที่เริ่มทำข้อสอบในรายวิชานี้</p>';
            return;
        }

        // [เพิ่มใหม่] อ่านค่าปัจจุบันจาก "ตัวกรองหัวข้อ"
        const selectedTopicId = document.getElementById('progress-topic-select').value;

        // [เพิ่มใหม่] กรอง topics ที่จะแสดงผล
        let topicsToDisplay = topics;
        if (selectedTopicId && selectedTopicId !== 'all') {
            topicsToDisplay = topics.filter(t => t.topicId === selectedTopicId);
        }
        // ------------------------------------

        // --- [จุดแก้ไข] เรียงลำดับข้อมูลนักเรียนตามรหัสนักศึกษา (น้อยไปมาก) ---
        students.sort((a, b) => a.studentId.localeCompare(b.studentId));
        // ----------------------------------------------------------------

        // [ปรับปรุง] เปลี่ยนจาก topics เป็น topicsToDisplay
        const allTablesHtml = topicsToDisplay.map(topic => {
            if (topic.questions.length === 0) return '';

            const questionHeaders = topic.questions.map(q => `<th class="text-center">${q.number}</th>`).join('');
            const finalHeaders = `<tr><th style="min-width: 250px; position: sticky; left: 0; background-color: #f8f9fa; z-index: 1;">รายชื่อผู้เข้าสอบ</th>${questionHeaders}<th class="text-center bg-light text-primary">ส่งหัวข้อ</th></tr>`;

            const tableRows = students.map(student => {
                const studentAnswers = student.answers;
                const submittedTopicSet = new Set(student.submittedTopicIds);
                const questionCells = topic.questions.map(q => {
                    const answerData = studentAnswers[q.id];
                    let cellContent = '';
                    if (answerData) {
                        const formattedTime = new Date(answerData.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                        cellContent = `<div><i class="bi bi-circle-fill text-success me-1"></i><span class="fw-bold text-dark">${answerData.answer}</span></div><div class="text-muted" style="font-size: 0.75em;">${formattedTime}</div>`;
                    } else {
                        cellContent = '<i class="bi bi-circle-fill text-danger"></i>';
                    }
                    return `<td class="text-center">${cellContent}</td>`;
                }).join('');
                const isSubmitted = submittedTopicSet.has(topic.topicId);
                const submissionCell = `<td class="text-center bg-light">${isSubmitted ? '<i class="bi bi-check-square-fill text-primary"></i>' : '-'}</td>`;

                return `
                    <tr class="${student.isFinished ? 'bg-light' : ''}">
                        <td class="text-nowrap" style="position: sticky; left: 0; background-color: white; z-index: 1;">
                            <strong>${student.studentId} - ${student.name}</strong><br>
                            <small class="text-muted">${student.email}</small>
                        </td>
                        ${questionCells}
                        ${submissionCell}
                    </tr>
                `;
            }).join('');

            return `<h4 class="mt-5 mb-3">หัวข้อ: ${topic.topicName}</h4><div class="table-responsive"><table class="table table-bordered table-hover align-middle"><thead class="table-light" style="position: sticky; top: 0; z-index: 2;">${finalHeaders}</thead><tbody>${tableRows}</tbody></table></div>`;
        }).join('');

        // --- ส่วนของตารางสรุป (เหมือนเดิม) ---
        const finalSubmissionHeader = `<thead class="table-light"><tr><th style="min-width: 250px;">รายชื่อผู้เข้าสอบ</th><th class="text-center table-success">ส่งสมบูรณ์</th></tr></thead>`;
        const finalSubmissionRows = students.map(student => {
            let finalSubmissionCell = `<td class="text-center">-</td>`;
            if (student.isFinished) {
                const formattedTime = student.finalSubmissionTimestamp ? new Date(student.finalSubmissionTimestamp).toLocaleString('th-TH', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
                finalSubmissionCell = `<td class="text-center"><i class="bi bi-patch-check-fill fs-5 text-success"></i><div class="text-muted" style="font-size: 0.75em;">${formattedTime}</div></td>`;
            }
            return `
                <tr class="${student.isFinished ? 'bg-light' : ''}">
                    <td>
                        <strong>${student.studentId} - ${student.name}</strong><br>
                        <small class="text-muted">${student.email}</small>
                    </td>
                    ${finalSubmissionCell}
                </tr>
            `;
        }).join('');

        const finalSubmissionTable = `<h4 class="mt-5 mb-3">สถานะการส่งข้อสอบฉบับสมบูรณ์</h4><table class="table table-bordered align-middle" style="width: 500px; max-width: 100%;">${finalSubmissionHeader}<tbody>${finalSubmissionRows}</tbody></table>`;
        // --- สิ้นสุดส่วนตารางสรุป ---

        // [ปรับปรุง] ตรวจสอบว่ามีตารางจะแสดงหรือไม่
        if (allTablesHtml.length > 0) {
            container.innerHTML = allTablesHtml + finalSubmissionTable;
        } else {
            // กรณีเลือกหัวข้อเฉพาะ และหัวข้อนั้นไม่มี (หรือไม่มีคำถาม)
            if (selectedTopicId !== 'all') {
                container.innerHTML = `<p class="text-center text-muted">ไม่พบข้อมูลสำหรับหัวข้อที่เลือก หรือหัวข้อนี้ไม่มีคำถาม</p>` + finalSubmissionTable;
            } else {
                // กรณีเลือก "แสดงทั้งหมด" แต่ไม่มีหัวข้อใดเลยที่มีคำถาม
                container.innerHTML = `<p class="text-center text-muted">รายวิชานี้ยังไม่มีการตั้งค่าคำถามในหัวข้อใดๆ</p>` + finalSubmissionTable;
            }
        }
    }

    /**
     * [ปรับปรุง] ดึงข้อมูล PIN Entry Logs โดยส่งอีเมลของ Admin ไปด้วย
     */
    function fetchPinLogs(page = 1) {
        const stateKey = 'pinLogs';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('pin-log-table-body');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">กำลังโหลดข้อมูล...</td></tr>';
        google.script.run.withSuccessHandler(displayPinLogTable)
            .getExamPINEntryLogs(currentUser.email, page, limit); // [แก้ไข]
    }

    /**
     * [อัปเกรด Pagination] แสดงผลตาราง PIN Entry Logs
     */
    function displayPinLogTable(response) {
        const tbody = document.getElementById('pin-log-table-body');
        const stateKey = 'pinLogs';

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">ยังไม่มีข้อมูล Log</td></tr>';
            document.getElementById('pin-logs-pagination-controls').innerHTML = '';
            document.getElementById('pin-logs-limit-selector-container').innerHTML = '';
            return;
        }

        const rowsHtml = response.data.map(log => {
            const statusBadge = log.Status === 'Success' 
                ? '<span class="badge bg-success">Success</span>' 
                : '<span class="badge bg-danger">Failed</span>';

            return `
                <tr>
                    <td>${new Date(log.Timestamp).toLocaleString('th-TH')}</td>
                    <td>${log.FullName}</td>
                    <td>${log.UserEmail}</td>
                    <td>${log.SubjectName}</td>
                    <td>${log.EnteredPIN}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-xs btn-danger" onclick="confirmDeleteRecord('ExamPINEntryLogs', '${log.LogID}', () => fetchPinLogs(paginationState.${stateKey}.currentPage))">ลบ</button>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rowsHtml;

        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchPinLogs);
        document.getElementById('pin-logs-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchPinLogs);
        document.getElementById('pin-logs-pagination-controls').innerHTML = paginationControls;
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับแสดงรูปภาพใน Modal (Lightbox)
     * @param {string} imageUrl - URL ของรูปภาพที่จะแสดง
     */
    function showImageModal(imageUrl) {
        const modalImageElement = document.getElementById('imageModalContent');
        if (modalImageElement) {
            modalImageElement.src = imageUrl; // กำหนด URL ให้กับรูปภาพใน Modal
            const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            imageModal.show(); // สั่งให้ Modal แสดงผล
        }
    }

    /**
     * [ใหม่] ดึงและแสดงข้อมูล Cheating Logs
     */
    function fetchCheatingLogs(page = 1) {
        const stateKey = 'cheatingLogs';
        paginationState[stateKey].currentPage = page;
        const limit = paginationState[stateKey].limit;

        const tbody = document.getElementById('cheating-log-table-body');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">กำลังโหลดข้อมูล...</td></tr>';
        google.script.run.withSuccessHandler(displayCheatingLogsTable)
            .getCheatingLogs(page, limit); // [แก้ไข]
    }

    /**
     * [อัปเกรด Pagination] แสดงผลตารางข้อมูล Cheating Logs
     */
    function displayCheatingLogsTable(response) {
        const tbody = document.getElementById('cheating-log-table-body');
        const stateKey = 'cheatingLogs';

        if (!response || !response.data || response.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">ยังไม่มีข้อมูล Log การทุจริต</td></tr>';
            document.getElementById('cheating-logs-pagination-controls').innerHTML = '';
            document.getElementById('cheating-logs-limit-selector-container').innerHTML = '';
            return;
        }

        const rowsHtml = response.data.map(log => {
            return `
                <tr>
                    <td>${new Date(log.Timestamp).toLocaleString('th-TH')}</td>
                    <td>${log.FullName}</td>
                    <td>${log.UserEmail}</td>
                    <td>${log.SubjectName}</td>
                    <td><span class="badge bg-warning text-dark">${log.Action}</span></td>
                    <td>${log.Details}</td>
                    <td>
                        <button class="btn btn-xs btn-danger" onclick="confirmDeleteCheatingLog('${log.LogID}', () => fetchCheatingLogs(paginationState.${stateKey}.currentPage))">ลบ</button>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rowsHtml;

        // [ใหม่] Render controls
        const limitSelector = createLimitSelector(stateKey, fetchCheatingLogs);
        document.getElementById('cheating-logs-limit-selector-container').innerHTML = limitSelector;
        
        const paginationControls = createPaginationControls(response.totalPages, response.currentPage, stateKey, fetchCheatingLogs);
        document.getElementById('cheating-logs-pagination-controls').innerHTML = paginationControls;
    }

    /**
     * [ใหม่] ฟังก์ชันสำหรับยืนยันการลบ Cheating Log
     */
    function confirmDeleteCheatingLog(recordId) {
        // [เดิม] if (confirm("คุณแน่ใจว่าต้องการลบ Log นี้ใช่หรือไม่?")) { ... }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: "คุณแน่ใจว่าต้องการลบ Log นี้ใช่หรือไม่?",
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [ใหม่] แสดงหน้าต่าง Loading ขณะลบ
                Swal.fire({
                    title: 'กำลังลบข้อมูล',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(response => {
                    // [เดิม] alert(response.message); ...
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    if (response.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: response.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        fetchCheatingLogs(); // โหลดข้อมูลตารางใหม่
                    } else {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: response.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).deleteCheatingLog(recordId);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    /**
     * [แก้ไข] สร้าง HTML หน้า Access Denied (ใช้ CSS denied-wrapper ที่เตรียมไว้)
     */
    function getAccessDeniedHtml() {
        return `
            <div class="d-flex justify-content-center align-items-center" style="min-height: 70vh;">
                <div class="denied-wrapper">
                    
                    <div class="denied-row">
                        <div class="mb-3">
                            <div class="d-inline-flex justify-content-center align-items-center rounded-circle" 
                                 style="width: 80px; height: 80px; background-color: rgba(255, 118, 117, 0.1);">
                                <i class="bi bi-shield-lock-fill" style="font-size: 2.5rem; color: var(--color-danger);"></i>
                            </div>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: var(--text-main);">เข้าถึงถูกปฏิเสธ</h3>
                        <div class="text-uppercase fw-bold text-danger" style="font-size: 0.75rem; letter-spacing: 2px;">
                            Access Denied
                        </div>
                    </div>

                    <div class="denied-row">
                        <p class="text-muted fs-5 mb-0" style="line-height: 1.6;">
                            คุณไม่มีสิทธิ์ <span class="badge rounded-pill bg-danger bg-opacity-10 text-danger px-3">Super Admin</span><br>
                            ในการเข้าถึงหน้านี้
                        </p>
                    </div>

                    <div class="denied-row">
                        <div class="p-3 rounded-4 bg-light border border-light-subtle d-inline-block w-100 mb-3">
                            <p class="text-muted small mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                โปรดติดต่อผู้ดูแลระบบหลักหากคุณต้องการสิทธิ์นี้
                            </p>
                        </div>
                    </div>

                </div>
            </div>
        `;
    }

    /**
     * [อัปเกรด] 1. (Entry Point) ดึงข้อมูลหน้าตั้งค่าระบบ
     * [แก้ไข] เพิ่ม .withFailureHandler เพื่อจัดการข้อผิดพลาดเซิร์ฟเวอร์
     */
    function fetchSystemSettingsPage() {
        showView('admin-system-settings-view');
        const contentContainer = document.getElementById('system-settings-content');

        // แสดงสถานะกำลังโหลด
        contentContainer.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">กำลังตรวจสอบสิทธิ์...</p>
            </div>`;

        // เรียก Backend เพื่อตรวจสอบสิทธิ์และดึงข้อมูล
        google.script.run
            .withSuccessHandler(displaySystemSettingsPage)
            .withFailureHandler(handleSystemSettingsFailure) // <--- เพิ่มตัวนี้
            .getSystemSettingsPageData(currentUser.email);
    }

    /**
     * [ใหม่] 0. จัดการข้อผิดพลาดที่ไม่สามารถเรียกฟังก์ชัน Apps Script ได้
     */
    function handleSystemSettingsFailure(error) {
        const contentContainer = document.getElementById('system-settings-content');
        
        console.error("Server Execution Failed:", error);

        contentContainer.innerHTML = `
            <div class="alert alert-danger text-center p-4">
                <i class="bi bi-x-octagon-fill me-2"></i> 
                <strong>เกิดข้อผิดพลาดร้ายแรงในการเรียกใช้เซิร์ฟเวอร์</strong>
                <p class="mt-2 mb-0 small">โปรดตรวจสอบ Apps Script (Logs/Deployments) หรือติดต่อผู้พัฒนา</p>
                <code class="d-block mt-2 small text-break">${error.message || 'Unknown Error'}</code>
            </div>`;
    }

    /**
     * [อัปเกรด] 2. แสดงผลหน้าตั้งค่าระบบ (ตามสิทธิ์ที่ได้รับ)
     */
    function displaySystemSettingsPage(response) {
        const contentContainer = document.getElementById('system-settings-content');
        
        if (!response.authorized) {
            contentContainer.innerHTML = getAccessDeniedHtml();
        } else {
            // [แก้ไข] ส่ง response.data.lastBackup ไปด้วย
            contentContainer.innerHTML = getSystemSettingsCardsHtml(response.permissions, response.data.lastBackup);
            
            if(response.data.adminList) {
                renderSuperAdminList(response.data.adminList); 
            }
        }
    }

    /**
     * [ใหม่] 3. (Helper) วาดรายชื่อ Super Admin ใน <ul>
     */
    function renderSuperAdminList(adminList) {
        const listContainer = document.getElementById('super-admin-list');
        if (!adminList || adminList.length === 0) {
            listContainer.innerHTML = '<li class="list-group-item text-danger">ไม่พบข้อมูล (โปรดติดต่อผู้พัฒนา)</li>';
            return;
        }

        listContainer.innerHTML = adminList.map(email => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                ${email}
                <button 
                    class="btn btn-sm btn-outline-danger" 
                    onclick="handleRemoveSuperAdmin('${email}')"
                    ${(email.toLowerCase() === currentUser.email.toLowerCase() || adminList.length <= 1) ? 'disabled' : ''}> 
                    <i class="bi bi-trash"></i>
                </button>
            </li>
        `).join('');
    }

    /**
     * [อัปเกรด] 4. จัดการการเปลี่ยนรหัสผ่านหลัก (ต้องส่ง currentUser.email)
     */
    function handleChangeSystemPassword(event) {
        event.preventDefault();
        
        const oldPass = document.getElementById('old-system-password').value;
        const newPass = document.getElementById('new-system-password').value;
        const confirmPass = document.getElementById('confirm-new-password').value;
        const alertContainer = document.getElementById('system-pass-alert-container');
        alertContainer.innerHTML = ''; // ล้างข้อความเก่า

        if (newPass !== confirmPass) {
            alertContainer.innerHTML = 
                `<div class="alert alert-danger text-center" style="font-size: 20px;">` +
                `<i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i> ` +
                `รหัสผ่านใหม่และการยืนยันไม่ตรงกัน` +
                `</div>`;
            return;
        }
        
        if (newPass.length < 8) {
            alertContainer.innerHTML = 
                `<div class="alert alert-danger text-center" style="font-size: 20px;">` +
                `<i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i> ` +
                `รหัสผ่านใหม่ต้องมีความยาวอย่างน้อย 8 ตัวอักษร` +
                `</div>`;
            return;
        }

        // ใช้ไอคอน spinner หมุนๆ ตอนกำลังประมวลผล
        alertContainer.innerHTML = 
            `<div class="alert alert-info text-center" style="font-size: 20px;">` +
            `<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> ` +
            `กำลังประมวลผล...` +
            `</div>`;

        // [จุดแก้ไข] ส่ง currentUser.email เป็นพารามิเตอร์ตัวที่ 3
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                // กรณีสำเร็จ ใช้ไอคอนติ๊กถูก สีเขียว
                alertContainer.innerHTML = 
                    `<div class="alert alert-success text-center" style="font-size: 20px;">` +
                    `<i class="fas fa-check-circle" style="margin-right: 8px;"></i> ` +
                    `${res.message}` +
                    `</div>`;
                document.querySelector('#admin-system-settings-view form').reset();
            } else {
                // กรณี error จาก server
                alertContainer.innerHTML = 
                    `<div class="alert alert-danger text-center" style="font-size: 20px;">` +
                    `<i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i> ` +
                    `${res.message}` +
                    `</div>`;
            }
        }).updateSystemPassword(oldPass, newPass, currentUser.email); // <-- ส่งอีเมลผู้ใช้ปัจจุบัน
    }

    /**
     * [ใหม่] 5. จัดการการเพิ่ม Super Admin
     */
    function handleAddSuperAdmin(event) {
        event.preventDefault();
        const emailInput = document.getElementById('add-super-admin-email');
        const emailToAdd = emailInput.value;
        const alertContainer = document.getElementById('super-admin-alert-container');

        if (!emailToAdd) return;

        // ปรับปรุง: Loading + Spinner
        alertContainer.innerHTML = 
            `<div class="alert alert-info text-center" style="font-size: 20px;">` +
            `<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> ` +
            `กำลังเพิ่ม...` +
            `</div>`;

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                // ปรับปรุง: Success + Check Icon
                alertContainer.innerHTML = 
                    `<div class="alert alert-success text-center" style="font-size: 20px;">` +
                    `<i class="fas fa-check-circle" style="margin-right: 8px;"></i> ` +
                    `${res.message}` +
                    `</div>`;
                renderSuperAdminList(res.adminList); // อัปเดตรายชื่อ
                emailInput.value = ''; // ล้างช่องกรอก
            } else {
                // ปรับปรุง: Error + Exclamation Icon
                alertContainer.innerHTML = 
                    `<div class="alert alert-danger text-center" style="font-size: 20px;">` +
                    `<i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i> ` +
                    `${res.message}` +
                    `</div>`;
            }
        }).addSuperAdmin(emailToAdd, currentUser.email);
    }

    /**
     * [ใหม่] 6. จัดการการลบ Super Admin
     */
    function handleRemoveSuperAdmin(emailToRemove) {
        // [เดิม] if (!confirm(`...`)) { return; }
        // [ใหม่] เปลี่ยนเป็น SweetAlert2 แบบยืนยัน
        Swal.fire({
            title: 'ยืนยันการลบสิทธิ์',
            text: `คุณแน่ใจหรือไม่ว่าต้องการลบสิทธิ์ Super Admin ของ ${emailToRemove}?`,
            icon: 'warning',

            allowOutsideClick: false, // ตามที่คุณกำหนด
            allowEscapeKey: false,  // ตามที่คุณกำหนด

            showCancelButton: true,      // ตามที่คุณกำหนด
            confirmButtonColor: "#198754", // ตามที่คุณกำหนด
            cancelButtonColor: "#dc3545",  // ตามที่คุณกำหนด
            confirmButtonText: "ตกลง",   // ตามที่คุณกำหนด
            cancelButtonText: "ยกเลิก"   // ตามที่คุณกำหนด

        }).then((result) => {
            // ถ้าผู้ใช้กดยืนยัน (ตกลง)
            if (result.isConfirmed) {

                // [เดิม] const alertContainer = ... ; alertContainer.innerHTML = `<div class="alert alert-info">กำลังลบ...</div>`;
                // [ใหม่] แสดงหน้าต่าง Loading
                Swal.fire({
                    title: 'กำลังลบ...',
                    text: 'กรุณารอสักครู่',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                google.script.run.withSuccessHandler(res => {
                    if (res.success) {
                        // [เดิม] alertContainer.innerHTML = `<div class="alert alert-success">${res.message}</div>`;
                        // [ใหม่] เปลี่ยนเป็น SweetAlert2
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: res.message,
                            icon: 'success',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                        renderSuperAdminList(res.adminList); // อัปเดตรายชื่อ
                    } else {
                        // [เดิม] alertContainer.innerHTML = `<div class="alert alert-danger">${res.message}</div>`;
                        // [ใหม่] เปลี่ยนเป็น SweetAlert2
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            icon: 'error',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        });
                    }
                }).removeSuperAdmin(emailToRemove, currentUser.email);
            }
            // (ถ้าผู้ใช้กด "ยกเลิก" ก็ไม่ต้องทำอะไร)
        });
    }

    /**
     * [ใหม่] จัดการการ "รีเซ็ต" รหัสผ่านหลัก (กรณีลืมรหัสผ่านเดิม)
     */
    function handleResetSystemPassword(event) {
        event.preventDefault();

        const newPass = document.getElementById('reset-new-password').value;
        const confirmPass = document.getElementById('reset-confirm-password').value;
        const alertContainer = document.getElementById('system-reset-alert-container');
        alertContainer.innerHTML = ''; // ล้างข้อความเก่า

        if (newPass !== confirmPass) {
            // ปรับปรุง: Error
            alertContainer.innerHTML = 
                `<div class="alert alert-danger text-center" style="font-size: 20px;">` +
                `<i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i> ` +
                `รหัสผ่านใหม่และการยืนยันไม่ตรงกัน` +
                `</div>`;
            return;
        }
        if (newPass.length < 8) {
            // ปรับปรุง: Error
            alertContainer.innerHTML = 
                `<div class="alert alert-danger text-center" style="font-size: 20px;">` +
                `<i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i> ` +
                `รหัสผ่านใหม่ต้องมีความยาวอย่างน้อย 8 ตัวอักษร` +
                `</div>`;
            return;
        }

        // ปรับปรุง: Processing + Spinner
        alertContainer.innerHTML = 
            `<div class="alert alert-info text-center" style="font-size: 20px;">` +
            `<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> ` +
            `กำลังประมวลผล...` +
            `</div>`;

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                // ปรับปรุง: Success
                alertContainer.innerHTML = 
                    `<div class="alert alert-success text-center" style="font-size: 20px;">` +
                    `<i class="fas fa-check-circle" style="margin-right: 8px;"></i> ` +
                    `${res.message}` +
                    `</div>`;
                document.querySelector('#system-reset-form').reset();
            } else {
                // ปรับปรุง: Error
                alertContainer.innerHTML = 
                    `<div class="alert alert-danger text-center" style="font-size: 20px;">` +
                    `<i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i> ` +
                    `${res.message}` +
                    `</div>`;
            }
        }).resetSystemPassword(newPass, currentUser.email); // เรียกฟังก์ชันใหม่
    }

    /**
     * [อัปเกรด] สร้าง HTML หน้าตั้งค่า (ปรับปรุง UI ปุ่มและการแสดงผลประวัติ)
     */
    function getSystemSettingsCardsHtml(permissions, lastBackup) {
        const showResetTab = permissions && permissions.canReset;
        const isSuperAdmin = permissions && permissions.isSuperAdmin;
        const showDataManagement = permissions && permissions.canManageData;

        // --- ส่วนแสดงผลประวัติ Backup (ดีไซน์ใหม่) ---
        let lastBackupHtml = `
            <div class="d-flex align-items-center text-muted mt-3 p-3 bg-light rounded-3 border border-dashed">
                <i class="bi bi-info-circle me-2"></i> 
                <small>ยังไม่มีประวัติการสำรองข้อมูลในระบบ</small>
            </div>`;

        if (lastBackup) {
            // รองรับการแปลงวันที่
            let dateStr = lastBackup.timestamp;
            try {
                const dateObj = new Date(lastBackup.timestamp);
                if (!isNaN(dateObj.getTime())) {
                    dateStr = dateObj.toLocaleString('th-TH', { 
                        year: 'numeric', month: 'short', day: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    });
                }
            } catch (e) {
                console.warn("Date parsing error:", e);
            }

            // [New Design] เปลี่ยนจาก Alert เป็น Card แบบ Minimal
            lastBackupHtml = `
                <div class="mt-3 bg-white p-3 rounded-3 shadow-sm border-start border-4 border-primary position-relative overflow-hidden">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-uppercase text-muted fw-bold" style="font-size: 0.65rem; letter-spacing: 0.5px;">
                                <i class="bi bi-clock-history"></i> สำรองข้อมูลล่าสุด
                            </div>
                            <div class="fw-bold text-dark fs-5 mt-1">${dateStr}</div>
                            <div class="text-secondary small">
                                <i class="bi bi-person-circle text-muted me-1"></i>${lastBackup.userEmail}
                            </div>
                        </div>
                        <a href="${lastBackup.fileUrl}" target="_blank" class="btn btn-sm btn-primary px-3 rounded-pill shadow-sm">
                            <i class="bi bi-box-arrow-up-right me-1"></i> เปิดไฟล์
                        </a>
                    </div>
                </div>
            `;
        }

        return `
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100 border-warning shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <i class="bi bi-key-fill me-2"></i>จัดการรหัสผ่านหลัก
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">รหัสผ่านนี้ใช้ยืนยันการลบข้อมูลสำคัญ</p>
                            <ul class="nav nav-tabs" id="sysPassTabs" role="tablist">
                                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#change-pass-pane">เปลี่ยนรหัสผ่าน</button></li>
                                ${showResetTab ? `<li class="nav-item"><button class="nav-link text-danger" data-bs-toggle="tab" data-bs-target="#reset-pass-pane">ลืมรหัสผ่าน (Reset)</button></li>` : ''}
                            </ul>
                            <div class="tab-content p-3 border border-top-0">
                                <div class="tab-pane fade show active" id="change-pass-pane">
                                    <form onsubmit="handleChangeSystemPassword(event)">
                                        <div class="mb-2"><input type="password" class="form-control form-control-sm" id="old-system-password" placeholder="รหัสผ่านเดิม" required></div>
                                        <div class="mb-2"><input type="password" class="form-control form-control-sm" id="new-system-password" placeholder="รหัสผ่านใหม่" required></div>
                                        <div class="mb-3"><input type="password" class="form-control form-control-sm" id="confirm-new-password" placeholder="ยืนยัน" required></div>
                                        <div id="system-pass-alert-container"></div>
                                        <button type="submit" class="btn btn-warning w-100">บันทึก</button>
                                    </form>
                                </div>
                                ${showResetTab ? `
                                <div class="tab-pane fade" id="reset-pass-pane">
                                    <div class="alert alert-danger small py-2"><strong>ระวัง!</strong> ทับรหัสเดิมทันที</div>
                                    <form id="system-reset-form" onsubmit="handleResetSystemPassword(event)">
                                        <div class="mb-2"><input type="password" class="form-control form-control-sm" id="reset-new-password" placeholder="รหัสใหม่" required></div>
                                        <div class="mb-3"><input type="password" class="form-control form-control-sm" id="reset-confirm-password" placeholder="ยืนยัน" required></div>
                                        <div id="system-reset-alert-container"></div>
                                        <button type="submit" class="btn btn-danger w-100">รีเซ็ตทันที</button>
                                    </form>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                ${isSuperAdmin ? `
                <div class="col-md-6">
                    <div class="card h-100 border-info shadow-sm">
                        <div class="card-header bg-info text-white">
                            <i class="bi bi-person-badge-fill me-2"></i>จัดการสิทธิ์ Super Admin
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">จัดการรายชื่อผู้ดูแลระบบสูงสุด</p>
                            <form onsubmit="handleAddSuperAdmin(event)" class="mb-3">
                                <div class="input-group">
                                    <input type="email" class="form-control" id="add-super-admin-email" placeholder="ระบุอีเมล..." required>
                                    <button class="btn btn-success" type="submit"><i class="bi bi-plus-lg"></i> เพิ่ม</button>
                                </div>
                                <div id="super-admin-alert-container" class="mt-2"></div>
                            </form>
                            <ul class="list-group list-group-flush" id="super-admin-list" style="max-height: 200px; overflow-y: auto;">
                                <li class="list-group-item text-center text-muted">กำลังโหลด...</li>
                            </ul>
                        </div>
                    </div>
                </div>` : ''}

                ${showDataManagement ? `
                <div class="col-12">
                    <div class="card border-danger shadow-sm h-100">
                        <div class="card-header bg-danger d-flex justify-content-between align-items-center" style="color: white !important;">
                            <span><i class="bi bi-database-fill-gear me-2"></i>จัดการข้อมูลระบบ (Maintenance)</span>
                            
                            <span class="badge bg-white text-danger">Super Admin Only</span>
                        </div>

                        <div class="card-body bg-light bg-opacity-10">
                            <div class="row align-items-center">
                                <div class="col-md-8 mb-3 mb-md-0">
                                    <h5 class="card-title text-danger fw-bold">
                                        <i class="bi bi-arrow-clockwise"></i> สำรองและรีเซ็ตข้อมูล
                                    </h5>
                                    <p class="card-text text-muted">
                                        กดปุ่มด้านขวาเพื่อทำการสำรองข้อมูล (Backup) ไฟล์ Google Sheet ปัจจุบัน<br>
                                        หลังจากสำรองเสร็จ ระบบจะถามคุณว่าต้องการ <strong>"ล้างข้อมูลเก่า"</strong> (เช่น คะแนน, Log, ประวัติการสอบ) เพื่อเริ่มปีการศึกษาใหม่หรือไม่
                                        <br><small class="text-danger">*ข้อมูลผู้ใช้, รายวิชา, และคำถาม จะไม่ถูกลบ</small>
                                    </p>
                                    
                                    ${lastBackupHtml}
                                </div>

                                <div class="col-md-4 text-center text-md-end">
                                    <div class="p-3 rounded-3 bg-white border border-danger border-opacity-25 shadow-sm d-inline-block w-100">
                                        <button class="btn btn-outline-danger w-100 py-2 fw-bold" onclick="handleSystemBackup()">
                                            <i class="bi bi-cloud-arrow-up-fill me-1"></i> สำรองข้อมูลเดี๋ยวนี้
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>` : ''}
            </div>
        `;
    }

    /**
     * [Helper] ฟังก์ชันวาดปุ่ม Pagination (Generic)
     */
    function renderPaginationControls(containerId, totalPages, currentPage, functionName, preventDefault = true) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if (totalPages <= 1) return;

        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        if (endPage - startPage + 1 < maxButtons) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }
        const clickEvent = (page) => `${preventDefault ? 'event.preventDefault();' : ''} ${functionName}(${page});`;

        // ปุ่ม "Previous"
        container.innerHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" aria-label="Previous" onclick="${clickEvent(currentPage - 1)}"><span aria-hidden="true">&laquo;</span></a></li>`;

        // ปุ่มตัวเลข
        if (startPage > 1) {
            container.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="${clickEvent(1)}">1</a></li>`;
            if (startPage > 2) container.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        for (let i = startPage; i <= endPage; i++) {
            container.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="${clickEvent(i)}">${i}</a></li>`;
        }
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) container.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            container.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="${clickEvent(totalPages)}">${totalPages}</a></li>`;
        }

        // ปุ่ม "Next"
        container.innerHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" aria-label="Next" onclick="${clickEvent(currentPage + 1)}"><span aria-hidden="true">&raquo;</span></a></li>`;
    }

    /**
     * [Helper] ฟังก์ชันสำหรับดักจับ Error (ถ้ายังไม่มี)
     */
    function handleGenericError(error) {
        console.error("Backend Error:", error);
        // [เดิม] alert("เกิดข้อผิดพลาดในการติดต่อเซิร์ฟเวอร์: " + error.message);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: "เกิดข้อผิดพลาดในการติดต่อเซิร์ฟเวอร์: " + (error.message || "ไม่ทราบสาเหตุ"),
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
        });
    }

    /**
     * [ไฟล์ .js]
     * (โค้ดนี้ควรวางไว้ในส่วน <script> ของ HTML)
     *
     * [จำเป็น] ฟังก์ชันตัวช่วยสร้างปุ่ม Pagination
     * (ฟังก์ชันนี้เหมือนกับที่ใช้ในหน้า Admin แต่เรียกใช้ฟังก์ชัน fetch... ที่ต่างกัน)
     */
    function buildPaginationControls(prefix, currentPage, totalPages, totalItems, limit, fetchFunctionName) {
        const container = document.getElementById(`${prefix}-pagination-container`);
        const infoEl = document.getElementById(`${prefix}-pagination-info`);
        const controlsEl = document.getElementById(`${prefix}-pagination-controls`);

        if (!container || !infoEl || !controlsEl) return;

        if (totalItems === 0) {
            infoEl.textContent = 'ไม่พบข้อมูล';
            controlsEl.innerHTML = '';
            container.style.display = 'none'; // ซ่อนแถบ pagination ถ้าไม่มีข้อมูล
            return;
        }
        
        container.style.display = 'flex'; // แสดงแถบ pagination
        const startItem = (currentPage - 1) * limit + 1;
        const endItem = Math.min(startItem + limit - 1, totalItems);
        infoEl.textContent = `แสดง ${startItem} - ${endItem} จาก ${totalItems}`;

        let html = '';
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage > 1 ? `${fetchFunctionName}(1)` : ''}">&laquo;</a>
              </li>`;
        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage > 1 ? `${fetchFunctionName}(${currentPage - 1})` : ''}">&lsaquo;</a>
              </li>`;

        if (startPage > 1) html += '<li class="page-item disabled"><a class="page-link" href="#">...</a></li>';
        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                  <a class="page-link" href="#" onclick="event.preventDefault(); ${i !== currentPage ? `${fetchFunctionName}(${i})` : ''}">${i}</a>
                </li>`;
        }
        if (endPage < totalPages) html += '<li class="page-item disabled"><a class="page-link" href="#">...</a></li>';

        html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage < totalPages ? `${fetchFunctionName}(${currentPage + 1})` : ''}">&rsaquo;</a>
              </li>`;
        html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage < totalPages ? `${fetchFunctionName}(${totalPages})` : ''}">&raquo;</a>
              </li>`;

        controlsEl.innerHTML = html;
    }

    /**
     * [ใหม่] 1. เปิด Modal และกระตุ้นตัวเลือกไฟล์
     */
    function openImportModal(importType) {
        currentImportType = importType;

        if (!importStatusModal) {
            importStatusModal = new bootstrap.Modal(document.getElementById('importStatusModal'));
        }
        
        // Reset UI
        document.getElementById('import-modal-title').innerHTML = `<i class="bi bi-cloud-upload me-2"></i>Import ${importType}`;
        document.getElementById('import-status-loading').classList.add('d-none');
        document.getElementById('import-status-result').classList.add('d-none');
        document.getElementById('import-status-result').innerHTML = '';

        // Trigger File Input
        document.getElementById('csv-file-input').click();
    }

    /**
    * [ใหม่] 2. จัดการไฟล์ที่ผู้ใช้เลือก
    */
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.type && !file.type.includes('csv') && !file.name.endsWith('.csv')) {
            Swal.fire({
                title: 'ไฟล์ไม่ถูกต้อง',
                text: 'กรุณาเลือกไฟล์นามสกุล .csv เท่านั้น',
                icon: 'warning',
                confirmButtonColor: 'var(--color-warning)',
                confirmButtonText: 'ตกลง',
                customClass: { popup: 'rounded-4' }
            });
            event.target.value = null; // Reset
            return;
        }

        // Show Loading UI
        document.getElementById('import-modal-title').innerHTML = `<i class="bi bi-hourglass-split me-2"></i>กำลังนำเข้า ${currentImportType}`;
        document.getElementById('import-status-loading').classList.remove('d-none');
        document.getElementById('import-status-result').classList.add('d-none');
        importStatusModal.show();

        const reader = new FileReader();
        reader.onload = function(e) {
            callBackendImport(e.target.result);
        };
        reader.onerror = function(e) {
            handleImportResponse({ success: false, message: 'อ่านไฟล์ผิดพลาด: ' + e.target.error });
        };
        reader.readAsText(file, 'UTF-8');
        
        event.target.value = null; // Reset input
    }

    /**
     * [อัปเกรด] (Helper) เรียกใช้ Google Script ตามประเภทการ Import
     * (เพิ่ม Case สำหรับ ExamSubjects, ExamTopics, ExamQuestions)
     */
    function callBackendImport(csvData) {
      let runner = google.script.run.withSuccessHandler(handleImportResponse).withFailureHandler(handleGenericError);

      // ใช้ 'switch' เพื่อเลือกฟังก์ชัน Backend ที่ถูกต้อง
      switch (currentImportType) {
        case 'Courses':
          runner.importCoursesFromCSV(csvData, currentUser.email);
          break;
        case 'Lessons':
          if (!currentManagingCourse || !currentManagingCourse.id) {
            handleImportResponse({ success: false, message: "ไม่พบข้อมูลคอร์สที่กำลังจัดการ" });
            return;
          }
          runner.importLessonsFromCSV(csvData, currentManagingCourse.id, currentUser.email);
          break;
        case 'Questions':
          if (!currentManagingLesson || !currentManagingLesson.id) {
            handleImportResponse({ success: false, message: "ไม่พบข้อมูลบทเรียนที่กำลังจัดการ" });
            return;
          }
          runner.importQuestionsFromCSV(csvData, currentManagingLesson.id, currentUser.email);
          break;

        // --- [เพิ่มส่วนนี้] ---
        case 'ExamSubjects':
          runner.importExamSubjectsFromCSV(csvData, currentUser.email);
          break;
        case 'ExamTopics':
          if (!currentManagingSubject || !currentManagingSubject.id) {
            handleImportResponse({ success: false, message: "ไม่พบข้อมูลรายวิชาที่กำลังจัดการ" });
            return;
          }
          runner.importExamTopicsFromCSV(csvData, currentManagingSubject.id, currentUser.email);
          break;
        case 'ExamQuestions':
          if (!currentManagingTopic || !currentManagingTopic.id) {
            handleImportResponse({ success: false, message: "ไม่พบข้อมูลหัวข้อสอบที่กำลังจัดการ" });
            return;
          }
          runner.importExamQuestionsFromCSV(csvData, currentManagingTopic.id, currentUser.email);
          break;
        // --- [สิ้นสุดส่วนที่เพิ่ม] ---

        default:
          handleImportResponse({ success: false, message: `ไม่รู้จักประเภทการ Import: ${currentImportType}` });
      }
    }

    /**
     * [อัปเกรด] 4. แสดงผลลัพธ์การ Import และรีเฟรชตารางที่ถูกต้อง
     * (เพิ่ม Case สำหรับ ExamSubjects, ExamTopics, ExamQuestions)
     */
    function handleImportResponse(response) {
        const loadingDiv = document.getElementById('import-status-loading');
        const resultDiv = document.getElementById('import-status-result');
        const titleElem = document.getElementById('import-modal-title');

        loadingDiv.classList.add('d-none');
        resultDiv.classList.remove('d-none');

        if (response.success) {
            // --- Success UI ---
            titleElem.innerHTML = `<span class="text-success"><i class="bi bi-check-circle-fill me-2"></i>เสร็จสิ้น</span>`;
            
            resultDiv.innerHTML = `
                <div class="text-center py-3">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3" 
                         style="width: 70px; height: 70px; background-color: rgba(0, 184, 148, 0.1);">
                        <i class="bi bi-check-lg" style="font-size: 2.5rem; color: var(--color-success);"></i>
                    </div>
                    
                    <h5 class="fw-bold mb-2" style="color: var(--text-main);">นำเข้าข้อมูลสำเร็จ!</h5>
                    
                    <div class="alert alert-light border rounded-4 d-inline-block px-4 py-2 mb-0">
                        <span class="text-muted small">${response.message}</span>
                    </div>
                </div>`;

            // Refresh Tables (Logic เดิม)
            if (currentImportType === 'Courses') fetchCourseManagement(1);
            else if (currentImportType === 'Lessons') fetchLessonManagement(currentManagingCourse.id, currentManagingCourse.name);
            else if (currentImportType === 'Questions') fetchQuestionManagement(currentManagingLesson.id, currentManagingLesson.name);
            else if (currentImportType === 'ExamSubjects') fetchExamSubjectManagement(1);
            else if (currentImportType === 'ExamTopics') fetchExamTopicManagement(null, null, 1);
            else if (currentImportType === 'ExamQuestions') fetchExamQuestionManagement(null, null, 1);

        } else {
            // --- Error UI ---
            titleElem.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>เกิดข้อผิดพลาด</span>`;
            
            resultDiv.innerHTML = `
                <div class="text-center py-3">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3" 
                         style="width: 70px; height: 70px; background-color: rgba(255, 118, 117, 0.1);">
                        <i class="bi bi-x-lg" style="font-size: 2.5rem; color: var(--color-danger);"></i>
                    </div>
                    
                    <h5 class="fw-bold mb-2" style="color: var(--text-main);">นำเข้าไม่สำเร็จ</h5>
                    
                    <div class="alert alert-danger border-0 rounded-4 d-inline-block px-4 py-2 mb-0 bg-danger bg-opacity-10 text-danger">
                        <i class="bi bi-info-circle me-1"></i>
                        <span class="small fw-bold">${response.message}</span>
                    </div>
                </div>`;
        }
    }

    function fetchSubjectScoreReport(subjectId) {
        currentReportSubjectId = subjectId;
        showView('admin-exam-score-report-view');
        document.getElementById('score-report-table-body').innerHTML = '<tr><td colspan="6" class="text-center">กำลังโหลดรายงานคะแนน...</td></tr>';
        document.getElementById('score-report-title').textContent = 'รายงานคะแนน';
        document.getElementById('score-report-max-score').textContent = 'N/A';

        google.script.run
            .withSuccessHandler(displaySubjectScoreReport)
            .withFailureHandler(handleGenericError) // (คุณต้องมีฟังก์ชัน handleGenericError)
            .getScoreReportForSubject(subjectId, currentUser.email);
    }

    function displaySubjectScoreReport(response) {
        const tbody = document.getElementById('score-report-table-body');

        // [เพิ่ม] รีเซ็ตค่า Stats ก่อน
        document.getElementById('stat-count').textContent = '0';
        document.getElementById('stat-max').textContent = 'N/A';
        document.getElementById('stat-min').textContent = 'N/A';
        document.getElementById('stat-mean').textContent = 'N/A';
        document.getElementById('stat-sd').textContent = 'N/A';
        document.getElementById('score-report-max-score').textContent = 'N/A';

        // --- [จุดอัปเกรดที่ 1] ---
        // เคลียร์ Cache เพื่อให้ปุ่ม Export CSV/Sheet ทำงานถูกต้อง
        _currentReportDataCache = []; 
        _currentReportMaxScore = 0;   
        // --- [สิ้นสุดการอัปเกรด] ---

        if (!response || !response.success) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">เกิดข้อผิดพลาด: ${response.message || 'ไม่ทราบสาเหตุ'}</td></tr>`;
            return;
        }

        // [แก้ไข] ดึงข้อมูล stats ออกมาจาก response
        const { subjectName, subjectCode, maxTotalScore, reportData, statistics } = response;

        // --- [จุดอัปเกรดที่ 2] ---
        // บันทึกข้อมูลลง Cache เพื่อใช้ Export
        _currentReportDataCache = reportData || []; // (ใช้ || [] เพื่อความปลอดภัย)
        _currentReportMaxScore = maxTotalScore || 0;
        // --- [สิ้นสุดการอัปเกรด] ---
        
        document.getElementById('score-report-title').textContent = `รายงานคะแนน: [${subjectCode || 'N/A'}] ${subjectName}`;
        document.getElementById('score-report-max-score').textContent = maxTotalScore;

        if (!reportData || reportData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">ยังไม่มีผู้ทำแบบทดสอบในรายวิชานี้</td></tr>';
            return;
        }

        // [เพิ่ม] อัปเดตค่าสถิติ
        if (statistics) {
            document.getElementById('stat-count').textContent = reportData.length; // จำนวนคน
            document.getElementById('stat-max').textContent = statistics.max.toFixed(2);
            document.getElementById('stat-min').textContent = statistics.min.toFixed(2);
            document.getElementById('stat-mean').textContent = statistics.mean.toFixed(2);
            document.getElementById('stat-sd').textContent = statistics.stdDev.toFixed(2);
        }

        tbody.innerHTML = reportData.map((user, index) => {
            const statusBadge = user.hasFinished 
                ? '<span class="badge bg-success">ส่งแล้ว</span>' 
                : '<span class="badge bg-warning text-dark">ยังไม่ส่ง</span>';

            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${user.studentId || 'N/A'}</td>
                    <td>${user.userName}</td>
                    <td>${user.userEmail}</td>
                    <td><strong>${user.totalScore} / ${maxTotalScore}</strong></td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        }).join('');
    }

    /**
    * [อัปเกรด] เรียกใช้ Backend เพื่อ Export to Google Sheet
    */
    function exportScoreReportToSheet() {
        if (!currentReportSubjectId) {
            // [เดิม] alert("ไม่พบข้อมูลรายวิชาที่จะ Export");
            // [ใหม่] เปลี่ยนเป็น SweetAlert2
            Swal.fire({
                title: 'ไม่พบข้อมูล',
                text: 'ไม่พบข้อมูลรายวิชาที่จะ Export',
                icon: 'warning',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
            return;
        }

        const btn = document.getElementById('export-to-sheet-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังสร้าง...';

        // [ใหม่] แสดงหน้าต่าง Loading
        Swal.fire({
            title: 'กำลัง Export',
            text: 'กรุณารอสักครู่ ระบบกำลังสร้างไฟล์ Google Sheet...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        google.script.run
            .withSuccessHandler(res => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-file-earmark-spreadsheet-fill"></i> Export to Sheet';

                if (res.success) {
                    // [เดิม] alert("สร้างไฟล์ Google Sheet สำเร็จ!");
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    Swal.fire({
                        title: 'สร้างไฟล์สำเร็จ!',
                        html: `สร้างไฟล์ Google Sheet สำเร็จ! <br/><a href="${res.sheetUrl}" target="_blank">คลิกที่นี่เพื่อเปิดไฟล์</a>`,
                        icon: 'success',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then(() => {
                        // [เดิม] window.open(res.sheetUrl, '_blank');
                        // [ใหม่] เปิดไฟล์หลังจากผู้ใช้กด "ตกลง"
                        window.open(res.sheetUrl, '_blank'); 
                    });
                } else {
                    // [เดิม] alert("เกิดข้อผิดพลาด: " + res.message);
                    // [ใหม่] เปลี่ยนเป็น SweetAlert2
                    Swal.fire({
                        title: 'เกิดข้อผิดพลาด',
                        text: res.message,
                        icon: 'error',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    });
                }
            })
            .withFailureHandler(handleGenericError) // (คุณต้องมีฟังก์ชันนี้)
            .exportScoreReportToSheet(currentReportSubjectId, currentUser.email);
    }

    /**
     * [ใหม่] Export ข้อมูลในตารางเป็นไฟล์ .csv (Client-side)
     */
    function exportReportToCSV() {
        if (!_currentReportDataCache || _currentReportDataCache.length === 0) {
            // [เดิม] alert("ไม่มีข้อมูลให้ Export");
            // [ใหม่] เปลี่ยนเป็น SweetAlert2
            Swal.fire({
                title: 'ไม่พบข้อมูล',
                text: 'ไม่มีข้อมูลให้ Export',
                icon: 'warning',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
            return;
        }

        const data = _currentReportDataCache;
        const maxScore = _currentReportMaxScore;
        const headers = ["อันดับ", "รหัสนักศึกษา", "ชื่อ - นามสกุล", "อีเมล", "คะแนนที่ได้", "คะแนนเต็ม", "สถานะการส่ง"];

        // 1. สร้างเนื้อหา CSV
        let csvContent = headers.join(',') + '\n'; // เพิ่ม Headers

        data.forEach((user, index) => {
            const status = user.hasFinished ? 'ส่งแล้ว' : 'ยังไม่ส่ง';
            const row = [
                index + 1,
                `"${user.studentId || 'N/A'}"`, // ใส่ "" ครอบ (เผื่อมี ,)
                `"${user.userName}"`,
                `"${user.userEmail}"`,
                user.totalScore,
                maxScore,
                `"${status}"`
            ];
            csvContent += row.join(',') + '\n';
        });

        // 2. สร้างไฟล์และดาวน์โหลด
        const bom = '\uFEFF'; // [สำคัญ] BOM สำหรับให้ Excel เปิดภาษาไทยได้
        const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);

        link.setAttribute("href", url);
        link.setAttribute("download", `score-report-${currentReportSubjectId}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ====================================================================
    // CHEATING MONITOR DASHBOARD FUNCTIONS
    // ====================================================================

    // ตัวแปรนี้จะเก็บข้อมูลรายวิชาไว้ เพื่อไม่ต้องดึงซ้ำ
    let cachedExamSubjects = null;

    // --- [ใหม่] ตัวแปรสำหรับ Real-time Polling ---
    let monitorRefreshInterval = null; // ตัวแปรเก็บ Timer
    let currentMonitorPage = 1; // ตัวแปรติดตามว่าผู้ใช้ดูหน้าไหน
    const MONITOR_REFRESH_RATE = 30000; // 30 วินาที (30000 ms)

    /**
     * 1. ฟังก์ชันเริ่มต้นเมื่อคลิกที่เมนู Cheating Monitor
     */
    function setupCheatingMonitorView() {
        console.log("ตั้งค่าหน้า Cheating Monitor...");
        
        stopCheatingMonitorPolling();

        document.getElementById('dashboard-details-container').classList.add('d-none');
        document.getElementById('subject-monitor-select').disabled = true;
        document.getElementById('monitor-loading-subjects').style.display = 'block';
        document.getElementById('event-log-table-body').innerHTML = '<tr><td colspan="4" class="text-center">กรุณาเลือกรายวิชาก่อน...</td></tr>';
        document.getElementById('monitor-pagination-container').classList.add('d-none');

        const selectEl = document.getElementById('subject-monitor-select');
        selectEl.removeEventListener('change', handleSubjectMonitorChange);
        selectEl.addEventListener('change', handleSubjectMonitorChange);

        if (!cachedExamSubjects) {
            google.script.run
                .withSuccessHandler(populateSubjectDropdown)
                .withFailureHandler(handleMonitorFailure)
                .getActiveExamSubjects();
        } else {
            populateSubjectDropdown(cachedExamSubjects);
        }
    }

    /**
     * [ใหม่] 1.1 ฟังก์ชันหยุด Polling
     */
    function stopCheatingMonitorPolling() {
        if (monitorRefreshInterval) {
            clearInterval(monitorRefreshInterval);
            monitorRefreshInterval = null;
            console.log("Stopped monitor auto-refresh.");
        }
    }


    /**
     * 2. เติมรายชื่อวิชาลงใน Dropdown
     */
    function populateSubjectDropdown(subjects) {
        console.log("ได้รับข้อมูลรายวิชา:", subjects);
        cachedExamSubjects = subjects;
        
        const selectElement = document.getElementById('subject-monitor-select');
        selectElement.innerHTML = '<option selected disabled value="">--- กรุณาเลือกรายวิชา ---</option>';
        
        if (subjects && subjects.length > 0) {
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.SubjectID;
                option.textContent = subject.SubjectName;
                option.dataset.startTime = subject.StartTime;
                option.dataset.endTime = subject.EndTime;
                selectElement.appendChild(option);
            });
            selectElement.disabled = false;
        } else {
            selectElement.innerHTML = '<option selected disabled value="">--- ไม่พบรายวิชาที่เปิดใช้งาน ---</option>';
        }
        document.getElementById('monitor-loading-subjects').style.display = 'none';
    }

    /**
     * 3. เมื่อผู้ใช้เลือกวิชาจาก Dropdown
     */
    function handleSubjectMonitorChange() {
        const selectElement = document.getElementById('subject-monitor-select');
        const selectedSubjectId = selectElement.value;
        
        stopCheatingMonitorPolling();

        if (!selectedSubjectId) {
            document.getElementById('dashboard-details-container').classList.add('d-none');
            document.getElementById('monitor-pagination-container').classList.add('d-none'); 
            return;
        }

        console.log("เลือกวิชา:", selectedSubjectId);
        fetchMonitorData(1);
    }

    /**
     * 3.1 ฟังก์ชันดึงข้อมูลสำหรับ Monitor (อัปเดต: รีเซ็ต KPI)
     */
    function fetchMonitorData(page = 1) {
      currentMonitorPage = parseInt(page);
      stopCheatingMonitorPolling();

      const selectElement = document.getElementById('subject-monitor-select');
      const selectedSubjectId = selectElement.value;
      const limit = document.getElementById('monitor-limit-select').value || 10;
      
      const options = {
        page: parseInt(page),
        limit: parseInt(limit)
      };

      if (!selectedSubjectId) return;

      document.getElementById('dashboard-details-container').classList.remove('d-none');
      
      const isInitialLoad = (page === 1 && !document.getElementById('kpi-total-starts').textContent.includes('-'));
      
      if (page === 1 || isInitialLoad) {
          document.getElementById('monitor-loading-logs').style.display = 'block';
          document.getElementById('event-log-table-body').innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm"></div> กำลังโหลด...</td></tr>';
          
          if (page === 1) {
            document.getElementById('subject-name-display').textContent = "กำลังโหลด...";
            document.getElementById('subject-start-time-display').textContent = "...";
            document.getElementById('subject-end-time-display').textContent = "...";
            document.getElementById('kpi-total-starts').textContent = "-";
            document.getElementById('kpi-cheating-events').textContent = "-";
            document.getElementById('kpi-failed-unlocks').textContent = "-";
            
            // [แก้ไข] รีเซ็ต KPI Card ใหม่
            document.getElementById('kpi-total-submissions').textContent = "-"; 
            document.getElementById('kpi-submissions-breakdown').innerHTML = '<div>ส่งเอง: -</div><div>อัตโนมัติ: -</div>';
            
            document.getElementById('cheat-users-count').textContent = '0';
            document.getElementById('cheat-users-list').style.display = 'none'; 
            document.getElementById('cheat-users-placeholder').style.display = 'block'; 
            document.getElementById('cheat-users-placeholder').innerHTML = '<small class="text-muted">กำลังโหลด...</small>';
            
            document.getElementById('failed-unlock-users-count').textContent = '0';
            document.getElementById('failed-unlock-users-list').style.display = 'none'; 
            document.getElementById('failed-unlock-placeholder').style.display = 'block';
            document.getElementById('failed-unlock-placeholder').innerHTML = '<small class="text-muted">กำลังโหลด...</small>';

            document.getElementById('live-status-count').textContent = '0';
            document.getElementById('live-status-list').innerHTML = '';
            document.getElementById('live-status-placeholder').style.display = 'block';
            document.getElementById('live-status-placeholder').innerHTML = '<small class="text-muted">กำลังโหลด...</small>';
          }
      }
      
      document.getElementById('monitor-pagination-container').classList.add('d-none');

      google.script.run
        .withSuccessHandler(updateDashboardUI) 
        .withFailureHandler(handleMonitorFailure)
        .getDashboardDataForSubject(selectedSubjectId, options);
    }


    /**
     * 4. อัปเดตหน้าจอด้วยข้อมูลที่ได้จาก Server (อัปเกรด V11: ลบ Activity)
     */
    function updateDashboardUI(data) {
        console.log("ได้รับข้อมูลแดชบอร์ด:", data);
        
        stopCheatingMonitorPolling();

        // 1. อัปเดตข้อมูลวิชา
        document.getElementById('subject-name-display').textContent = data.subjectInfo.SubjectName;
        document.getElementById('subject-start-time-display').textContent = data.subjectInfo.StartTime;
        document.getElementById('subject-end-time-display').textContent = data.subjectInfo.EndTime;

        // 2. อัปเดต KPI Cards
        document.getElementById('kpi-total-starts').textContent = data.kpis.totalStarts;
        document.getElementById('kpi-cheating-events').textContent = data.kpis.cheatingEvents;
        document.getElementById('kpi-failed-unlocks').textContent = data.kpis.failedUnlocks;
        
        const totalSubmissions = data.kpis.totalManualSubmissions + data.kpis.totalAutoSubmissions;
        document.getElementById('kpi-total-submissions').textContent = totalSubmissions;
        document.getElementById('kpi-submissions-breakdown').innerHTML = `
            <div>ส่งเอง: ${data.kpis.totalManualSubmissions}</div>
            <div>อัตโนมัติ: ${data.kpis.totalAutoSubmissions}</div>
        `;
        
        
        // --- 3. อัปเดต Accordion สรุปรายชื่อ ---
        
        // 3.1 ผู้ใช้ที่ทุจริต
        const cheatList = data.suspiciousActivity.cheating;
        const cheatCountEl = document.getElementById('cheat-users-count');
        const cheatListDiv = document.getElementById('cheat-users-list');
        const cheatPlaceholderEl = document.getElementById('cheat-users-placeholder');
        
        cheatListDiv.innerHTML = '';
        cheatCountEl.textContent = cheatList.length;
        
        if (cheatList.length > 0) {
            cheatPlaceholderEl.style.display = 'none';
            cheatListDiv.style.display = 'flex';
            cheatList.forEach(user => {
                const dataString = JSON.stringify(user).replace(/'/g, "&apos;");
                const userName = `${user.firstName} ${user.lastName}`;
                const studentID = user.studentID || 'N/A';
                cheatListDiv.innerHTML += `
                    <div class="card border-danger mb-3" style="flex: 1 1 250px; min-width: 250px;">
                      <div class="card-header bg-danger text-white"><i class="bi bi-person-x-fill"></i> ${userName}</div>
                      <div class="card-body text-danger pt-2 pb-2">
                        <p class="card-text mb-1" style="font-size: 0.9em;"><strong>ID:</strong> ${studentID}</p>
                        <p class="card-text mb-2" style="font-size: 0.9em; word-wrap: break-word;"><strong>Email:</strong> ${user.email}</p>
                        <button class="btn btn-danger btn-sm w-100" onclick='showUserCheatDetails(this)' data-log-data='${dataString}'><i class="bi bi-eye"></i> ดู ${user.count} รายละเอียด</button>
                      </div>
                    </div>
                `;
            });
        } else {
            cheatPlaceholderEl.style.display = 'block';
            cheatListDiv.style.display = 'none';
            cheatPlaceholderEl.innerHTML = '<small class="text-muted">-- ไม่พบ --</small>';
        }

        // 3.2 ผู้ใช้ที่ปลดล็อคล้มเหลว
        const failedList = data.suspiciousActivity.failedUnlocks;
        const failedCountEl = document.getElementById('failed-unlock-users-count');
        const failedListDiv = document.getElementById('failed-unlock-users-list');
        const failedPlaceholderEl = document.getElementById('failed-unlock-placeholder');

        failedListDiv.innerHTML = '';
        failedCountEl.textContent = failedList.length;

        if (failedList.length > 0) {
            failedPlaceholderEl.style.display = 'none';
            failedListDiv.style.display = 'flex';
            failedList.forEach(user => {
                const dataString = JSON.stringify(user).replace(/'/g, "&apos;");
                const userName = `${user.firstName} ${user.lastName}`;
                const studentID = user.studentID || 'N/A';
                failedListDiv.innerHTML += `
                    <div class="card border-warning mb-3" style="flex: 1 1 250px; min-width: 250px;">
                      <div class="card-header bg-warning text-dark"><i class="bi bi-person-slash-fill"></i> ${userName}</div>
                      <div class="card-body text-dark pt-2 pb-2">
                        <p class="card-text mb-1" style="font-size: 0.9em;"><strong>ID:</strong> ${studentID}</p>
                        <p class="card-text mb-2" style="font-size: 0.9em; word-wrap: break-word;"><strong>Email:</strong> ${user.email}</p>
                        <button class="btn btn-warning btn-sm w-100 text-dark" onclick='showUserUnlockDetails(this)' data-log-data='${dataString}'><i class="bi bi-eye"></i> ดู ${user.count} รายละเอียด</button>
                      </div>
                    </div>
                `;
            });
        } else {
            failedPlaceholderEl.style.display = 'block';
            failedListDiv.style.display = 'none';
            failedPlaceholderEl.innerHTML = '<small class="text-muted">-- ไม่พบ --</small>';
        }

        // --- [แก้ไข] 4. อัปเดต Accordion สถานะนักเรียน (แบบกระชับ) ---
        const liveList = data.liveStudentStatus;
        const liveCountEl = document.getElementById('live-status-count');
        const liveListDiv = document.getElementById('live-status-list');
        const livePlaceholderEl = document.getElementById('live-status-placeholder');
        
        liveListDiv.innerHTML = '';
        liveCountEl.textContent = liveList.length;

        if (liveList.length > 0) {
            livePlaceholderEl.style.display = 'none';
            liveListDiv.style.display = 'block';
            
            liveList.forEach(user => {
                // [แก้ไข] ลบตรรกะ Activity และแสดงผลแค่ชื่อ
                liveListDiv.innerHTML += `
                    <div class="list-group-item">
                        <h6 class="mb-0">${user.firstName} ${user.lastName} (${user.studentID || 'N/A'})</h6>
                    </div>
                `;
            });

        } else {
            livePlaceholderEl.style.display = 'block';
            liveListDiv.style.display = 'none';
            livePlaceholderEl.innerHTML = '<small class="text-muted">-- ไม่พบนักเรียนที่กำลังสอบ --</small>';
        }


        // --- 5. อัปเดตตาราง Event Log ---
        const tableBody = document.getElementById('event-log-table-body');
        tableBody.innerHTML = ''; 

        const paginationContainer = document.getElementById('monitor-pagination-container');
        const paginationInfo = document.getElementById('monitor-pagination-info');
        const paginationControls = document.getElementById('monitor-pagination-controls');
        paginationInfo.innerHTML = "";
        paginationControls.innerHTML = "";

        if (data.eventLog && data.eventLog.length > 0) {
          
          // 5.1 สร้างแถวในตาราง
          data.eventLog.forEach(log => {
            const row = document.createElement('tr');
            let rowClass = '';
            if (log.eventType.includes('🔴')) rowClass = 'table-danger';
            else if (log.eventType.includes('🟡')) rowClass = 'table-warning';
            else if (log.eventType.includes('🟠')) rowClass = 'table-warning';
            else if (log.eventType.includes('🏁')) rowClass = 'table-success'; 
            else if (log.eventType.includes('📑')) rowClass = 'table-info';    

            row.className = rowClass;

            let detailsCellHtml = log.details;
            if (log.logData && log.logData.type === 'suspiciousLogins') {
                const dataString = JSON.stringify(log.logData).replace(/'/g, "&apos;");
                detailsCellHtml = `
                    <span>${log.details}</span>
                    <button 
                        class="btn btn-outline-primary btn-sm ms-2 py-0 px-1" 
                        onclick='showSuspiciousLoginModal(this)' 
                        data-log-data='${dataString}'>
                        <i class="bi bi-eye"></i> ดู
                    </button>
                `;
            }

            row.innerHTML = `
              <td>${log.timestamp}</td>
              <td>${log.email}</td>
              <td>${log.eventType}</td>
              <td>${detailsCellHtml}</td>
            `;
            tableBody.appendChild(row);
          });

          // 5.2 สร้าง Pagination
          paginationContainer.classList.remove('d-none');
          const { totalItems, totalPages, currentPage, limit } = data;
          const startItem = (currentPage - 1) * limit + 1;
          const endItem = Math.min(currentPage * limit, totalItems);
          paginationInfo.textContent = `แสดง ${startItem} - ${endItem} จาก ${totalItems} รายการ`;
          paginationControls.innerHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); fetchMonitorData(${currentPage - 1})">ก่อนหน้า</a></li>`;
          const maxPagesToShow = 5;
          let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
          let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
          if (endPage - startPage + 1 < maxPagesToShow) startPage = Math.max(1, endPage - maxPagesToShow + 1);
          if (startPage > 1) {
            paginationControls.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); fetchMonitorData(1)">1</a></li>`;
            if (startPage > 2) paginationControls.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          for (let i = startPage; i <= endPage; i++) {
            paginationControls.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); fetchMonitorData(${i})">${i}</a></li>`;
          }
          if (endPage < totalPages) {
            if (endPage < totalPages - 1) paginationControls.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            paginationControls.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); fetchMonitorData(${totalPages})">${totalPages}</a></li>`;
          }
          paginationControls.innerHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); fetchMonitorData(${currentPage + 1})">ถัดไป</a></li>`;


        } else {
          tableBody.innerHTML = '<tr><td colspan="4" class="text-center">--- ไม่พบเหตุการณ์ใดๆ ในช่วงเวลาสอบของวิชานี้ ---</td></tr>';
          paginationContainer.classList.add('d-none');
        }

        document.getElementById('monitor-loading-logs').style.display = 'none';

        // 6. [ใหม่] เริ่มการ Polling (ถ้าอยู่หน้า 1)
        if (currentMonitorPage === 1) {
            monitorRefreshInterval = setInterval(() => {
                console.log("Auto-refreshing monitor data (Page 1)...");
                fetchMonitorData(1);
            }, MONITOR_REFRESH_RATE);
        }
    }

    /**
     * 5. จัดการข้อผิดพลาด
     */
    function handleMonitorFailure(error) {
        stopCheatingMonitorPolling();

        console.error("เกิดข้อผิดพลาด (Cheating Monitor):", error);

        const errorMessage = (typeof error === 'object' && error.message) ? error.message : String(error);

        // [เดิม] alert("เกิดข้อผิดพลาดในการโหลดข้อมูล: " + errorMessage);
        // [ใหม่] เปลี่ยนเป็น SweetAlert2
        Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: "เกิดข้อผิดพลาดในการโหลดข้อมูล: " + errorMessage,
            icon: 'error',
            allowOutsideClick: false,
            allowEscapeKey: false
        });

        document.getElementById('monitor-loading-subjects').style.display = 'none';
        document.getElementById('monitor-loading-logs').style.display = 'none';
        document.getElementById('event-log-table-body').innerHTML = `<tr><td colspan="4" class="text-center text-danger"><strong>เกิดข้อผิดพลาด:</strong> ${errorMessage}</td></tr>`;
    }

    // [ใหม่] ฟังก์ชันโชว์/ซ่อน Editor ตามการติ๊ก Toggle
    function toggleExamInfoEditor(mode, isChecked) {
        const container = document.getElementById(`${mode}-exam-info-container`);
        if (isChecked) {
            container.classList.remove('d-none');
        } else {
            container.classList.add('d-none');
        }
    }

    /**
     * ฟังก์ชันแสดงรายละเอียดใน Modal (สำหรับ Login > 4 ครั้ง)
     */
    function showSuspiciousLoginModal(buttonElement) {
        try {
            const dataString = buttonElement.dataset.logData;
            const data = JSON.parse(dataString); 
            
            if (!data || data.type !== 'suspiciousLogins') {
                console.error("Invalid data for modal");
                return;
            }

            const modalTitle = document.getElementById('detailsModalLabel');
            const modalBody = document.getElementById('detailsModalBody');
            
            modalTitle.textContent = `รายละเอียดการเข้าสู่ระบบ (${data.email})`;
            
            let timeListHtml = data.times.map(isoString => {
                const d = new Date(isoString);
                return `<li>${d.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'medium' })}</li>`;
            }).join('');

            modalBody.innerHTML = `
                <p>พบการเข้าสู่ระบบ <strong>${data.times.length} ครั้ง</strong> ในช่วงเวลาสอบ:</p>
                <ul class="list-unstyled">
                    ${timeListHtml}
                </ul>
            `;

            if (detailsModalInstance) detailsModalInstance.show();
        } catch (e) {
            console.error("Failed to show modal:", e);
            alert("ไม่สามารถแสดงรายละเอียดได้: " + e.message);
        }
    }

    /**
     * [ใหม่] ฟังก์ชันแสดง Modal สำหรับรายละเอียดการทุจริต
     */
    function showUserCheatDetails(buttonElement) {
        try {
            const dataString = buttonElement.dataset.logData;
            const data = JSON.parse(dataString); // { email, firstName, lastName, studentID, count, logs: [{timestamp, details}] }
            
            const modalTitle = document.getElementById('detailsModalLabel');
            const modalBody = document.getElementById('detailsModalBody');
            
            modalTitle.textContent = `รายละเอียดการทุจริต (${data.firstName} ${data.lastName})`;
            
            // สร้างรายการเวลา
            let timeListHtml = data.logs.map(log => {
                const d = new Date(log.timestamp);
                return `<li>${d.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'medium' })}: <strong>${log.details}</strong></li>`;
            }).join('');

            modalBody.innerHTML = `
                <p><strong>ผู้ใช้:</strong> ${data.firstName} ${data.lastName} (${data.studentID || 'N/A'})</p>
                <p><strong>Email:</strong> ${data.email}</p>
                <hr>
                <p>พบการแจ้งเตือนทุจริต <strong>${data.count} ครั้ง</strong>:</p>
                <ul>
                    ${timeListHtml}
                </ul>
            `;

            if (detailsModalInstance) detailsModalInstance.show();
        } catch (e) {
            console.error("Failed to show user cheat modal:", e);
        }
    }

    /**
     * [ใหม่] ฟังก์ชันแสดง Modal สำหรับรายละเอียดการปลดล็อคล้มเหลว
     */
    function showUserUnlockDetails(buttonElement) {
        try {
            const dataString = buttonElement.dataset.logData;
            const data = JSON.parse(dataString); // { email, firstName, lastName, studentID, count, logs: [{timestamp, enteredPIN}] }
            
            const modalTitle = document.getElementById('detailsModalLabel');
            const modalBody = document.getElementById('detailsModalBody');
            
            modalTitle.textContent = `รายละเอียดการปลดล็อคล้มเหลว (${data.firstName} ${data.lastName})`;
            
            // สร้างรายการเวลา
            let timeListHtml = data.logs.map(log => {
                const d = new Date(log.timestamp);
                return `<li>${d.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'medium' })} - รหัสที่ป้อน: <strong>${log.enteredPIN}</strong></li>`;
            }).join('');

            modalBody.innerHTML = `
                <p><strong>ผู้ใช้:</strong> ${data.firstName} ${data.lastName} (${data.studentID || 'N/A'})</p>
                <p><strong>Email:</strong> ${data.email}</p>
                <hr>
                <p>พบการปลดล็อคล้มเหลว <strong>${data.count} ครั้ง</strong>:</p>
                <ul>
                    ${timeListHtml}
                </ul>
            `;

            if (detailsModalInstance) detailsModalInstance.show();
        } catch (e) {
            console.error("Failed to show user unlock modal:", e);
        }
    }

    function fetchAntiCheatDashboard() {
        showView('admin-cheat-dashboard-view');
        if (cheatDashboardRefreshInterval) clearInterval(cheatDashboardRefreshInterval); // หยุดการรีเฟรชอัตโนมัติเก่า

        // 1. รีเซ็ตหน้าจอ
        document.getElementById('cheat-dashboard-session-info').classList.add('d-none');
        document.getElementById('cheat-dashboard-timeline-container').innerHTML = `
            <div class="text-center p-5">
                <i class="bi bi-search fs-1 text-muted"></i>
                <p class="text-muted mt-2">กรุณาเลือกรายวิชาเพื่อเริ่มการตรวจสอบ</p>
            </div>`;

        // 2. ดึงรายชื่อวิชามาสร้าง Dropdown
        const subjectSelect = document.getElementById('cheat-dashboard-subject-select');
        subjectSelect.innerHTML = '<option value="">-- กำลังโหลดรายวิชา --</option>'; 
        subjectSelect.disabled = true;

        google.script.run
            .withSuccessHandler(populateCheatDashboardDropdown)
            .withFailureHandler(handleGenericError) // (คุณควรมีฟังก์ชันนี้)
            .getExamSessionsForLogFilter(); // <--- เรียกใช้ฟังก์ชันนี้
    }

    /**
     * [ใหม่] 2. (Helper) เติมรายชื่อวิชาลงใน Dropdown
     */
    function populateCheatDashboardDropdown(subjects) {
        const subjectSelect = document.getElementById('cheat-dashboard-subject-select');
        subjectSelect.innerHTML = '<option value="">-- กรุณาเลือกรายวิชา --</option>'; 

        if (subjects && subjects.length > 0) {
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.SubjectID;
                // [สำคัญ] เก็บข้อมูลเวลาไว้ใน option เพื่อใช้ในภายหลัง
                option.dataset.startTime = subject.StartTime || ''; 
                option.dataset.endTime = subject.EndTime || '';
                option.textContent = `[${subject.SubjectCode || 'N/A'}] ${subject.SubjectName}`;
                subjectSelect.appendChild(option);
            });
        }
        subjectSelect.disabled = false;
    }

    /**
     * [ใหม่] 3. ถูกเรียกเมื่อผู้ใช้เลือกรายวิชา, ค้นหา, หรือเปลี่ยนจำนวนแสดงผล
     */
    function handleCheatSubjectSelect(page = 1) { // <-- [แก้ไข] รับ page number
      const select = document.getElementById('cheat-dashboard-subject-select');
      const selectedOption = select.options[select.selectedIndex];
      const subjectId = selectedOption.value;
      const infoCard = document.getElementById('cheat-dashboard-session-info');
      const timelineContainer = document.getElementById('cheat-dashboard-timeline-container');

      // [ใหม่] อ่านค่าจาก Controls
      const searchTerm = document.getElementById('cheat-search-input').value || "";
      const limit = document.getElementById('cheat-limit-select').value || 10;
      const controlsContainer = document.getElementById('cheat-dashboard-controls');
      const paginationContainer = document.getElementById('cheat-pagination-container');

      // หยุดการรีเฟรชอัตโนมัติ (ถ้ามี)
      if (cheatDashboardRefreshInterval) clearInterval(cheatDashboardRefreshInterval);

      if (!subjectId) {
        // ถ้าผู้ใช้เลือก "-- กรุณาเลือกรายวิชา --"
        infoCard.classList.add('d-none');
        controlsContainer.classList.add('d-none'); // [ใหม่] ซ่อน controls
        paginationContainer.classList.add('d-none'); // [ใหม่] ซ่อน pagination
        timelineContainer.innerHTML = `
            <div class="text-center p-5">
                <i class="bi bi-search fs-1 text-muted"></i>
                <p class="text-muted mt-2">กรุณาเลือกรายวิชาเพื่อเริ่มการตรวจสอบ</p>
            </div>`;
        return;
      }

      // 1. แสดงข้อมูลรายวิชาทันที (จาก data-* ที่เราเก็บไว้)
      const startTime = selectedOption.dataset.startTime;
      const endTime = selectedOption.dataset.endTime;
      const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
      
      document.getElementById('session-info-name').textContent = selectedOption.textContent;
      document.getElementById('session-info-id').textContent = subjectId;
      document.getElementById('session-info-time').textContent = 
        `${startTime ? new Date(startTime).toLocaleString('th-TH', options) : 'N/A'} - ${endTime ? new Date(endTime).toLocaleString('th-TH', options) : 'N/A'}`;
      
      infoCard.classList.remove('d-none');
      controlsContainer.classList.remove('d-none'); // [ใหม่] แสดง controls

      // 2. แสดงสถานะกำลังโหลด Timeline
      timelineContainer.innerHTML = `
          <div class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">กำลังดึงข้อมูลเหตุการณ์...</p>
          </div>`;
      
      // [ใหม่] ซ่อน pagination ชั่วคราว
      paginationContainer.classList.add('d-none');

      // 3. [ใหม่] รวบรวม Options ที่จะส่งไป Backend
      const requestOptions = {
          page: parseInt(page),
          limit: parseInt(limit),
          searchTerm: searchTerm
      };

      // 4. เรียก Backend (ฟังก์ชันใหม่)
      google.script.run
        .withSuccessHandler(displayCheatTimeline) // <--- ใช้ฟังก์ชันที่อัปเดตใหม่
        .withFailureHandler(handleGenericError) // (คุณควรมีฟังก์ชันนี้)
        // [แก้ไข] ส่ง requestOptions ไปด้วย
        .getCheatDashboardDataForSubject(subjectId, currentUser.email, requestOptions); 
      
      // 5. เริ่มการรีเฟรชอัตโนมัติสำหรับรายวิชานี้
      // (การรีเฟรชจะกลับไปหน้า 1 เสมอ แต่ยังคงค่า search และ limit ไว้)
      cheatDashboardRefreshInterval = setInterval(() => handleCheatSubjectSelect(1), 30000); // 30 วินาที
    }

    /**
     * [ใหม่ V2] 4. แสดงผลข้อมูลเป็น Timeline และสร้าง Pagination
     */
    function displayCheatTimeline(response) {
      const timelineContainer = document.getElementById('cheat-dashboard-timeline-container');
      
      // [ใหม่] ดึง Element ของ Pagination
      const paginationContainer = document.getElementById('cheat-pagination-container');
      const paginationInfo = document.getElementById('cheat-pagination-info');
      const paginationControls = document.getElementById('cheat-pagination-controls');

      // [ใหม่] ล้างข้อมูล Pagination เก่า
      paginationInfo.innerHTML = "";
      paginationControls.innerHTML = "";

      if (!response || !response.success) {
        // ปรับปรุง: เพิ่ม text-center, font-size และไอคอนตกใจ (Exclamation Circle)
        timelineContainer.innerHTML = 
            `<div class="alert alert-danger text-center" style="font-size: 20px;">` +
            `<i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i> ` +
            `โหลดข้อมูลล้มเหลว: ${response.message || 'Unknown error'}` +
            `</div>`;
            
        paginationContainer.classList.add('d-none');
        return;
      }
      
      // [ใหม่] ดึงข้อมูล pagination จาก response
      const { reportData: logs, totalItems, totalPages, currentPage, limit } = response;

      // 1. ตรวจสอบว่ามี Log หรือไม่
      if (logs.length === 0) {
        timelineContainer.innerHTML = `
            <div class="text-center p-5">
                <i class="bi bi-search fs-1 text-muted"></i>
                <p class="text-muted mt-2">ไม่พบข้อมูลที่ตรงกับการค้นหา</p>
            </div>`;
        paginationContainer.classList.add('d-none'); // ซ่อน pagination ถ้าไม่มีข้อมูล
        return;
      }

      // [ใหม่] ฟังก์ชัน Helper สำหรับกำหนดสีและไอคอน
      const getEventStyle = (eventType) => {
          if (eventType.includes('🔴')) return { color: 'danger', icon: 'bi-shield-exclamation' };
          if (eventType.includes('🟡')) return { color: 'warning', icon: 'bi-key' };
          if (eventType.includes('🟠')) return { color: 'warning', icon: 'bi-box-arrow-right' }; // [ใหม่] สำหรับ Login
          if (eventType.includes('⚪')) return { color: 'secondary', icon: 'bi-box-arrow-left' }; // [ใหม่] สำหรับ Logout
          if (eventType.includes('🟢')) return { color: 'success', icon: 'bi-play-fill' };
          if (eventType.includes('🔵')) return { color: 'info', icon: 'bi-box-arrow-in-right' };
          return { color: 'secondary', icon: 'bi-question-circle' };
      };

      // 2. สร้าง HTML สำหรับ Timeline
      timelineContainer.innerHTML = '<ul class="timeline">' + logs.map(event => {
        const style = getEventStyle(event.eventType); // <--- [ใหม่]
        
        // [แก้ไข] แปลง ISO String ที่มาจาก Backend กลับเป็น Date Object
        const eventTimestamp = new Date(event.timestamp); 
        
        const timeString = eventTimestamp.toLocaleString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        return `
            <li>
                <div class="timeline-badge ${style.color}"><i class="bi ${style.icon}"></i></div>
                <div class="timeline-panel">
                    <div class="timeline-heading">
                        <h5 class="timeline-title">${event.title}</h5>
                        <p><small class="text-muted"><i class="bi bi-clock"></i> ${timeString} (${eventTimestamp.toLocaleDateString('th-TH')})</small></p>
                    </div>
                    <div class="timeline-body">
                        <p>${event.details}</p>
                    </div>
                </div>
            </li>
        `;
      }).join('') + '</ul>';

      // 3. [ใหม่] สร้าง Pagination
      paginationContainer.classList.remove('d-none');
      
      // 3.1 ข้อมูล Info
      const startItem = (currentPage - 1) * limit + 1;
      const endItem = Math.min(currentPage * limit, totalItems);
      paginationInfo.textContent = `แสดง ${startItem} - ${endItem} จาก ${totalItems} รายการ`;

      // 3.2 สร้างปุ่ม
      // Prev
      paginationControls.innerHTML += `
          <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
              <a class="page-link" href="#" onclick="event.preventDefault(); handleCheatSubjectSelect(${currentPage - 1})">ก่อนหน้า</a>
          </li>
      `;

      // Page Numbers (แบบย่อ)
      const maxPagesToShow = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
      let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

      if (endPage - startPage + 1 < maxPagesToShow) {
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
      }

      if (startPage > 1) {
          paginationControls.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); handleCheatSubjectSelect(1)">1</a></li>`;
          if (startPage > 2) paginationControls.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      }

      for (let i = startPage; i <= endPage; i++) {
          paginationControls.innerHTML += `
              <li class="page-item ${i === currentPage ? 'active' : ''}">
                  <a class="page-link" href="#" onclick="event.preventDefault(); handleCheatSubjectSelect(${i})">${i}</a>
              </li>
          `;
      }

      if (endPage < totalPages) {
          if (endPage < totalPages - 1) paginationControls.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          paginationControls.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); handleCheatSubjectSelect(${totalPages})">${totalPages}</a></li>`;
      }

      // Next
      paginationControls.innerHTML += `
          <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
              <a class="page-link" href="#" onclick="event.preventDefault(); handleCheatSubjectSelect(${currentPage + 1})">ถัดไป</a>
          </li>
      `;
    }

    // --- [ใหม่] Student Login History Functions ---

    /** * 1. เรียกดูหน้าประวัติการเข้าสู่ระบบ 
     */
    function fetchMyLoginHistoryView() {
        showView('student-login-history-view');
        fetchMyLoginHistory(1);
    }

    /**
     * 2. ดึงข้อมูลจาก Backend
     */
    function fetchMyLoginHistory(page = 1) {
        const stateKey = 'myLoginHistory';
        const container = document.getElementById('my-login-history-body');
        
        container.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary spinner-border-sm"></div> กำลังโหลดข้อมูล...</td></tr>`;

        const options = { 
            page: page, 
            limit: 10, // กำหนดไว้ 10 รายการต่อหน้า
            searchTerm: '' 
        };

        google.script.run
            .withSuccessHandler(displayMyLoginHistory)
            .withFailureHandler(handleGenericError)
            .getMyLoginHistory(currentUser.email, options);
    }

    /**
     * 3. แสดงผลตาราง
     */
    function displayMyLoginHistory(response) {
        const container = document.getElementById('my-login-history-body');
        const stateKey = 'myLoginHistory';

        if (!response || !response.data || response.data.length === 0) {
            container.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">ไม่พบประวัติการเข้าสู่ระบบ</td></tr>`;
            document.getElementById('my-login-history-info').textContent = '';
            document.getElementById('my-login-history-pagination').innerHTML = '';
            return;
        }

        const { data, totalItems, totalPages, currentPage, limit } = response;
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };

        container.innerHTML = data.map(log => {
            // ตกแต่ง Icon ตาม OS/Browser (ถ้ามีข้อมูล)
            let osIcon = '<i class="bi bi-display"></i>';
            if (log.OS && log.OS.includes('Win')) osIcon = '<i class="bi bi-microsoft"></i>';
            if (log.OS && log.OS.includes('Mac')) osIcon = '<i class="bi bi-apple"></i>';
            if (log.OS && log.OS.includes('Android')) osIcon = '<i class="bi bi-android2"></i>';
            if (log.OS && log.OS.includes('iOS')) osIcon = '<i class="bi bi-phone"></i>';

            return `
                <tr>
                    <td>${new Date(log.Timestamp).toLocaleString('th-TH', options)}</td>
                    <td>${osIcon} ${log.OS || 'Unknown'}</td>
                    <td>${log.Browser || 'Unknown'}</td>
                    <td>${log.IP || '-'}</td>
                    <td><span class="badge bg-success rounded-pill">สำเร็จ</span></td>
                </tr>
            `;
        }).join('');

        // Update Pagination Info
        const startItem = (currentPage - 1) * limit + 1;
        const endItem = Math.min(currentPage * limit, totalItems);
        document.getElementById('my-login-history-info').textContent = `แสดง ${startItem}-${endItem} จาก ${totalItems} รายการ`;

        // Render Pagination Buttons
        document.getElementById('my-login-history-pagination').innerHTML = createPaginationControls(totalPages, currentPage, stateKey, fetchMyLoginHistory);
    }

    /**
     * [ใหม่] จัดการการส่งฟอร์มลืมรหัสผ่าน
     */
    function handleForgotPassword(event) {
        event.preventDefault();
        const email = document.getElementById('forgot-email').value;

        // แสดง Loading
        Swal.fire({
            title: 'กำลังดำเนินการ',
            text: 'กรุณารอสักครู่ ระบบกำลังส่งรหัสผ่านใหม่...',
            icon: 'info',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                Swal.fire({
                    title: 'ส่งเรียบร้อย!',
                    text: res.message,
                    icon: 'success'
                }).then(() => {
                    // เคลียร์ค่าและกลับไปหน้า Login
                    document.getElementById('forgot-email').value = '';
                    showView('login-view');
                });
            } else {
                Swal.fire({
                    title: 'ไม่สำเร็จ',
                    text: res.message,
                    icon: 'error'
                });
            }
        }).withFailureHandler(error => {
            Swal.fire({
                title: 'เกิดข้อผิดพลาด',
                text: error.message,
                icon: 'error'
            });
        }).resetUserPassword(email);
    }

    /** [ใหม่] แสดง Modal ข้อมูลรายวิชา */
    function showExamInfoModal() {
        if (currentExamSubject) {
            // แสดง ExamInfoContent แทน Description
            document.getElementById('exam-info-content').innerHTML = currentExamSubject.ExamInfoContent || 'ไม่มีข้อมูลเพิ่มเติม';
            new bootstrap.Modal(document.getElementById('examInfoModal')).show();
        }
    }

    /**
     * [แก้ไข] ฟังก์ชันจัดการการอัปโหลดรูปภาพและแทรกลง Quill Editor
     */
    function handleImageUpload(mode) {
        const fileInput = document.getElementById(`${mode}-image-upload`);
        const file = fileInput.files[0];

        if (!file) {
            Swal.fire({ icon: 'warning', title: 'กรุณาเลือกไฟล์รูปภาพ', timer: 1500, showConfirmButton: false });
            return;
        }

        // แสดง Loading
        const btn = fileInput.nextElementSibling;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> กำลังอัปโหลด...';

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            // แยก Header ออกจาก Data
            const base64Data = content.split(',')[1]; 
            const contentType = content.split(',')[0].split(':')[1].split(';')[0];

            google.script.run
                .withSuccessHandler(imageUrl => {
                    // [Debug] ตรวจสอบ URL ที่ได้มา
                    console.log("Image URL from Drive:", imageUrl);

                    // 1. เลือก Editor ที่ถูกต้อง
                    const quill = (mode === 'add') ? quillAddInfo : quillEditInfo;
                    
                    // 2. หาตำแหน่ง Cursor ปัจจุบัน (ถ้าไม่มีให้ไปท้ายสุด)
                    let range = quill.getSelection(true);
                    if (!range) {
                        range = { index: quill.getLength() };
                    }
                    
                    // 3. [สำคัญ] แทรกรูปภาพลงไป (ใช้ URL ที่ได้มา)
                    // ตรวจสอบว่า imageUrl ไม่ว่างเปล่า
                    if (imageUrl) {
                        quill.insertEmbed(range.index, 'image', imageUrl);
                    } else {
                        Swal.fire({ icon: 'error', title: 'ไม่ได้รับลิงก์รูปภาพจาก Server' });
                    }
                    
                    // 4. ขยับ Cursor ไปหลังรูป (เพื่อไม่ให้รูปโดนแทนที่ถ้าพิมพ์ต่อ)
                    quill.setSelection(range.index + 1);

                    // 5. เคลียร์และแจ้งเตือน
                    fileInput.value = '';
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    Swal.fire({ icon: 'success', title: 'แทรกรูปภาพสำเร็จ', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                })
                .withFailureHandler(err => {
                    console.error("Upload Error:", err);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    Swal.fire({ icon: 'error', title: 'อัปโหลดล้มเหลว', text: err.message });
                })
                .uploadImageToDrive(base64Data, contentType, file.name);
        };
        reader.readAsDataURL(file);
    }

    /**
     * ฟังก์ชันจัดการปุ่มย้อนกลับ
     * ตรวจสอบว่า user เป็น admin หรือ student
     */
    function handleBackFromHistory() {
        // ตรวจสอบ Role ของผู้ใช้งานปัจจุบัน
        // หมายเหตุ: ตรวจสอบตัวแปร currentUser ว่าเก็บ role ไว้ที่ property ใด (เช่น .role หรือ .type)
        
        if (currentUser && currentUser.role === 'Admin') {
            // ถ้าเป็น Admin ให้กลับไป Dashboard
            showView('admin-dashboard-view');
        } else {
            // ถ้าเป็น Student หรืออื่นๆ ให้กลับไปหน้า Home
            showView('home-view');
        }
    }

    /**
     * [อัปเกรด] จัดการกระบวนการสำรองข้อมูล (เลือกประเภทได้)
     */
    function handleSystemBackup() {
        // 1. ให้ผู้ใช้เลือกประเภทการสำรองข้อมูล
        Swal.fire({
            title: 'เลือกประเภทการสำรองข้อมูล',
            input: 'select',
            inputOptions: {
                'full': '1. สำรองข้อมูลทั้งหมด (Full System)',
                'course': '2. สำรองเฉพาะส่วนเรียนออนไลน์ (Courses Only)',
                'exam': '3. สำรองเฉพาะส่วนสอบออนไลน์ (Exams Only)'
            },
            inputPlaceholder: 'กรุณาเลือกประเภท...',
            showCancelButton: true,
            confirmButtonText: 'ถัดไป',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            inputValidator: (value) => {
                if (!value) {
                    return 'กรุณาเลือกประเภทก่อนดำเนินการ';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const selectedType = result.value;
                const typeLabel = selectedType === 'full' ? 'ทั้งหมด' : (selectedType === 'course' ? 'เรียนออนไลน์' : 'สอบออนไลน์');

                // 2. ยืนยันการดำเนินการ
                Swal.fire({
                    title: `ยืนยันการสำรองข้อมูล (${typeLabel})`,
                    text: "ระบบจะสร้างไฟล์สำเนาเก็บไว้ใน Drive",
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'เริ่มสำรองข้อมูล',
                    cancelButtonText: 'ยกเลิก',
                    showLoaderOnConfirm: true, // แสดง Loading ที่ปุ่ม
                    preConfirm: () => {
                        // เรียก Backend และคืนค่า Promise เพื่อให้ Swal รอ
                        return new Promise((resolve, reject) => {
                             google.script.run
                                .withSuccessHandler(res => resolve(res))
                                .withFailureHandler(err => reject(err))
                                .backupSystemData(currentUser.email, selectedType); // ส่ง type ไปด้วย
                        });
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                }).then((apiResult) => {
                    if (apiResult.isConfirmed) {
                        const res = apiResult.value;
                        if (res.success) {
                            // รีเฟรชหน้าเพื่อแสดงประวัติล่าสุด
                            fetchSystemSettingsPage();

                            // 3. ถามต่อว่าจะล้างข้อมูลหรือไม่ (ส่ง selectedType ไปด้วย)
                            askToClearData(res, selectedType, typeLabel);
                        } else {
                            Swal.fire('เกิดข้อผิดพลาด', res.message, 'error');
                        }
                    }
                }).catch(error => {
                    Swal.fire('Error', error.message, 'error');
                });
            }
        });
    }

    /**
     * [ใหม่] ฟังก์ชันถามเพื่อล้างข้อมูล (แยกออกมาเพื่อความสะอาด)
     */
    function askToClearData(backupRes, type, typeLabel) {
        Swal.fire({
            title: 'สำรองข้อมูลเสร็จสิ้น!',
            html: `ไฟล์ Backup ถูกสร้างแล้ว: <a href="${backupRes.backupUrl}" target="_blank">${backupRes.backupName}</a><br><br>` +
                  `<hr>` +
                  `<strong class="text-danger">คุณต้องการ "ล้างข้อมูลเก่า" ในส่วน "${typeLabel}" หรือไม่?</strong><br>` +
                  `<small class="text-muted">(จะลบเฉพาะ Logs, คะแนน, ประวัติ ของส่วน "${typeLabel}" เท่านั้น เพื่อเริ่มระบบใหม่)</small>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33', 
            cancelButtonColor: '#3085d6',
            confirmButtonText: `ล้างข้อมูล ${typeLabel} เดี๋ยวนี้`,
            cancelButtonText: 'ไม่, เก็บข้อมูลไว้'
        }).then((clearResult) => {
            if (clearResult.isConfirmed) {
                performClearData(type); // ส่ง type ไปเพื่อล้างเฉพาะส่วน
            }
        });
    }

    /**
     * [อัปเกรด] สั่งล้างข้อมูล (รับ parameter type)
     */
    function performClearData(type) {
        Swal.fire({
            title: 'กำลังล้างข้อมูล...',
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                Swal.fire('เสร็จสิ้น!', res.message, 'success');
            } else {
                Swal.fire('เกิดข้อผิดพลาด', res.message, 'error');
            }
        }).clearTransactionalData(currentUser.email, type); // ส่ง type ไปด้วย
    }

    // รวมทุกอย่างไว้ใน Event Listener เดียว เพื่อความเป็นระเบียบและทำงานตามลำดับ
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- 1. เริ่มต้น Bootstrap Modal ---
        const modalEl = document.getElementById('detailsModal');
        if (modalEl) {
            // ตรวจสอบว่ามี Instance อยู่แล้วหรือไม่
            detailsModalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        }

        // --- 2. เริ่มต้น Quill Editor (Rich Text) ---
        const toolbarOptions = [
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link', 'image'],
            ['clean']
        ];

        // สำหรับหน้าเพิ่ม (Add)
        if (document.getElementById('add-exam-info-editor')) {
            quillAddInfo = new Quill('#add-exam-info-editor', {
                theme: 'snow',
                modules: { toolbar: toolbarOptions },
                placeholder: 'พิมพ์รายละเอียด...'
            });
        }

        // สำหรับหน้าแก้ไข (Edit)
        if (document.getElementById('edit-exam-info-editor')) {
            quillEditInfo = new Quill('#edit-exam-info-editor', {
                theme: 'snow',
                modules: { toolbar: toolbarOptions },
                placeholder: 'แก้ไขรายละเอียด...'
            });
        }

        // --- 3. จัดการ Sidebar Menu (Admin Dashboard) ---
        const menuLinks = document.querySelectorAll('#dashboard-menu a');
        if (menuLinks.length > 0) {
            menuLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // จัดการ class 'active'
                    menuLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    // ซ่อน/แสดง section
                    const targetId = link.getAttribute('data-target');
                    document.querySelectorAll('.dashboard-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                    }
                });
            });
        }

        // --- 4. ตรวจสอบ Session และ Routing (ส่วนที่สำคัญที่สุด) ---
        try {
            const storedUser = sessionStorage.getItem('activeUserSession');
            const parsedUser = storedUser ? JSON.parse(storedUser) : null;

            if (parsedUser && parsedUser.role === 'Admin') {
                // [เคส 1] มีเซสชัน Admin -> รีสโตร์ User และไปหน้า Dashboard
                currentUser = parsedUser;
                updateNavbar(); 
                handleNavHomeClick(); // ฟังก์ชันนี้จะพาไป admin-dashboard-view เอง
            } else {
                // [เคส 2] ไม่มีเซสชัน หรือเป็น Student -> เคลียร์และไปหน้า Home
                sessionStorage.removeItem('activeUserSession'); 
                currentUser = null; // รีเซ็ต currentUser ด้วย
                updateNavbar();
                showView('home-view');
                if (typeof fetchAnnouncements === 'function') {
                    fetchAnnouncements();
                }
            }
        } catch (e) {
            console.error("Error during initialization:", e);
            // Fallback กรณีเกิด Error
            sessionStorage.removeItem('activeUserSession');
            currentUser = null;
            updateNavbar();
            showView('home-view');
            if (typeof fetchAnnouncements === 'function') {
                fetchAnnouncements();
            }
        }
    });

    // เพิ่ม function นี้เพื่อให้ Navbar หุบอัตโนมัติเมื่อกด Link
    const navLinks = document.querySelectorAll('.nav-link:not(.dropdown-toggle), .btn:not(.dropdown-toggle)');
    const menuToggle = document.getElementById('navbarNav');
    const bsCollapse = new bootstrap.Collapse(menuToggle, {toggle: false});

    navLinks.forEach((l) => {
        l.addEventListener('click', () => {
            if (menuToggle.classList.contains('show')) {
                bsCollapse.hide();
            }
        })
    })

    // ==========================================
    // ส่วนดักจับการกด Refresh (แบบไม่มีปุ่มกดเอง)
    // ==========================================
    
    // ==========================================
    // ส่วนดักจับการกด Refresh (ปรับปรุงสำหรับ Safari)
    // ==========================================
    // window.addEventListener('beforeunload', function (e) {
    //     // 1. ถ้ากดปุ่มแดงที่เราทำไว้ (Authorized) ให้ปล่อยผ่าน
    //     if (typeof isAuthorizedRefresh !== 'undefined' && isAuthorizedRefresh) {
    //         return; 
    //     }

    //     // 2. เช็คสถานะ Lock
    //     var lockModal = document.getElementById('cheatLockModal');
    //     var isLocked = lockModal && (lockModal.classList.contains('show') || lockModal.style.display === 'block');

    //     if (isLocked) {
    //         // 3. พยายามส่ง Log ทันที (หวังว่า Server จะรับทันก่อนหน้าเว็บดับ)
    //         logRefreshAttempt();

    //         // 4. คำสั่งแจ้งเตือน Browser
    //         e.preventDefault(); // มาตรฐาน
            
    //         // ข้อความนี้ Browser สมัยใหม่มักไม่แสดง (จะใช้ข้อความ default แทน) 
    //         // แต่จำเป็นต้องใส่เพื่อให้ Safari/Legacy Browser ทำงาน
    //         var confirmationMessage = 'มีการสอบค้างอยู่ การรีเฟรชอาจทำให้ถูกบันทึกการทุจริต';

    //         e.returnValue = confirmationMessage; // สำหรับ Chrome, Edge, Firefox
    //         return confirmationMessage;          // สำหรับ Safari และ Browser รุ่นเก่า
    //     }
    // });

    // ============================================================
    // ระบบดักจับการ Refresh (รองรับ iOS/iPad/PC แบบสมบูรณ์)
    // แก้ไข: บันทึกข้อมูล User/Subject ไว้ก่อน เพื่อไม่ให้เป็น Unknown
    // ============================================================

    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. ตรวจสอบทันทีที่เข้าหน้าเว็บ: เมื่อกี้กดรีเฟรชหนีมาหรือไม่?
        // -------------------------------------------------------
        const wasLocked = sessionStorage.getItem('cheatLockActive');
        
        if (wasLocked === 'true') {
            console.warn('ตรวจพบการรีเฟรชหน้าจอขณะล็อค (iOS/PC Detected)');
            
            // ส่ง Log เข้าระบบทันที โดยใช้ข้อมูลที่ฝากไว้
            logRefreshIncident();
        }

        // 2. เริ่มวางกับดัก: เฝ้าดูตัว Modal ว่าเปิดหรือปิดอยู่
        // -------------------------------------------------------
        const lockModalEl = document.getElementById('cheatLockModal');
        if (lockModalEl) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'class' || mutation.attributeName === 'style') {
                        const isShown = lockModalEl.classList.contains('show') || lockModalEl.style.display === 'block';
                        
                        if (isShown) {
                            // Modal เปิดแล้ว -> วางกับดัก และ "ฝากข้อมูลสำคัญ"
                            sessionStorage.setItem('cheatLockActive', 'true');
                            
                            // บันทึก Email
                            if (typeof currentUser !== 'undefined' && currentUser) {
                                sessionStorage.setItem('cheatLockUser', currentUser.email);
                            }
                            
                            // บันทึก SubjectID
                            if (typeof currentExamSubject !== 'undefined' && currentExamSubject) {
                                sessionStorage.setItem('cheatLockSubject', currentExamSubject.SubjectID);
                            }
                            
                        } else {
                            // Modal ถูกปิดอย่างถูกต้อง -> ปลดกับดักและลบข้อมูลฝาก
                            sessionStorage.removeItem('cheatLockActive');
                            sessionStorage.removeItem('cheatLockUser');
                            sessionStorage.removeItem('cheatLockSubject');
                        }
                    }
                });
            });

            // เริ่มเฝ้าดูการเปลี่ยนแปลงของ Modal
            observer.observe(lockModalEl, { attributes: true });
        }
    });

    // 3. ฟังก์ชันบันทึก Log (ดึงข้อมูลจากที่ฝากไว้)
    // -------------------------------------------------------
    function logRefreshIncident() {
        // ดึงข้อมูลจาก SessionStorage แทนตัวแปร Global ที่หายไป
        const savedUser = sessionStorage.getItem('cheatLockUser');
        const savedSubject = sessionStorage.getItem('cheatLockSubject');
        
        const uEmail = savedUser ? savedUser : 'Unknown (Data Lost)';
        const subId = savedSubject ? savedSubject : 'Unknown Subject';

        google.script.run.withFailureHandler(function(e){ console.error(e); })
            .logCheatingAttempt({
                userEmail: uEmail,
                subjectId: subId,
                action: 'Browser Refresh Detected', 
                details: 'User refreshed/closed browser while Cheat Lock was active (Restored Context)'
            });
            
        // หลังจากบันทึกแล้ว ให้เคลียร์ค่าทิ้ง
        sessionStorage.removeItem('cheatLockActive');
        sessionStorage.removeItem('cheatLockUser');
        sessionStorage.removeItem('cheatLockSubject');
    }

    // 4. ส่วนเสริม: ยังคงใช้ beforeunload ไว้กันเหนียวสำหรับ PC
    // -------------------------------------------------------
    window.addEventListener('beforeunload', function (e) {
        if (sessionStorage.getItem('cheatLockActive') === 'true') {
            e.preventDefault();
            e.returnValue = 'การรีเฟรชหน้าจออาจถูกบันทึกการทุจริต';
            return 'การรีเฟรชหน้าจออาจถูกบันทึกการทุจริต';
        }
    });

    // ฟังก์ชันย่อยสำหรับส่ง Log (ยิงแล้วไม่ต้องรอผล)
    function logRefreshAttempt() {
        try {
            // 1. ดึง Email
            var uEmail = (typeof currentUser !== 'undefined' && currentUser) ? currentUser.email : 'Unknown';
            
            // 2. ดึง SubjectID (แก้ไขตรงนี้)
            // เช็คว่าตัวแปร currentExamSubject มีอยู่จริงและไม่เป็นค่าว่าง
            var subId = (typeof currentExamSubject !== 'undefined' && currentExamSubject) ? currentExamSubject.SubjectID : 'Unknown';
            
            // 3. ส่งข้อมูล
            google.script.run.withFailureHandler(function(err){ console.log(err); })
                .logCheatingAttempt({
                    userEmail: uEmail,
                    subjectId: subId,
                    action: 'Browser Refresh Attempt', 
                    details: 'User tried to refresh/close browser while Locked'
                });
        } catch (err) {
            console.log('Error logging refresh attempt');
        }
    }
    </script>
</body>
</html>
